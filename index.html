<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms — Panel</title>
<link rel="icon" href="Logo.webp"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{
  --blue:#0f3a78;--lime:#9be22d;--ink:#0f172a;--mut:#64748b;
  --b:#e2e8f0;--bg:#f7f8fa;--ok:#d9f99d;--mid:#fef9c3;--no:#fee2e2;
  --card:#ffffff;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:inherit}
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.top{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.brand{display:flex;gap:10px;align-items:center}
.brand img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
.nav .tab.active{background:var(--blue);color:#fff}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:var(--card);border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 20px #0000000a;padding:12px}
.kpi h3{margin:0;color:var(--mut);font-size:14px}
.kpi .n{font-size:22px;font-weight:800}
.list{margin:8px 0 0 16px;padding:0}
.list li{margin:4px 0}

/* Sections visibility */
section{display:none}
#v-dash{display:block}

/* Responsive */
@media (max-width: 900px){
  .grid{grid-template-columns:1fr}
}

/* ===== (el resto de vistas reutiliza tu estilo por compatibilidad) ===== */
.filters-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
.cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;position:sticky;top:114px;z-index:5;background:#fff;padding:6px 0;border-bottom:1px solid var(--b)}
.cal-head>div{text-align:center;font-weight:700;color:#0f3a78}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.cal-cell{min-height:140px;background:#fff;border:1px solid var(--b);border-radius:12px;padding:8px;overflow:hidden}
footer{margin-top:40px;text-align:center;padding:16px;color:var(--mut);font-size:14px}
</style>
</head>
<body>

<!-- Top -->
<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM"/>
    <div><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div class="nav">
    <button class="tab active" data-view="dash">Dashboard</button>
    <button class="tab" data-view="events">Eventos</button>
    <button class="tab" data-view="roster">Plantel</button>
    <button class="tab" data-view="track">Seguimiento</button>
  </div>
</div>

<div class="container">
  <!-- DASHBOARD -->
  <section id="v-dash">
    <div class="grid" id="kpiRow">
      <div class="card kpi" style="grid-column:span 3">
        <h3>Próximos eventos</h3><div class="n" id="kEvents">0</div>
      </div>
      <div class="card kpi" style="grid-column:span 3">
        <h3>Plantel</h3><div class="n" id="kRoster">0</div>
      </div>
      <div class="card kpi" style="grid-column:span 3">
        <h3>Partidos jugados</h3><div class="n" id="kGames">0</div>
      </div>
      <div class="card kpi" style="grid-column:span 3">
        <h3>Cumpleaños (hoy)</h3><div class="n" id="kBdayToday">—</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <strong>📅 Hoy</strong>
      <ul id="todayEvents" class="list"></ul>
    </div>

    <div class="card" style="margin-top:12px">
      <strong>🗓️ Eventos de la semana</strong>
      <ul id="weekEvents" class="list"></ul>
    </div>

    <div class="card" style="margin-top:12px">
      <strong>🎂 Próximos cumpleaños</strong>
      <ul id="upBirth" class="list"></ul>
    </div>
  </section>

  <!-- EVENTOS -->
  <section id="v-events">
    <div class="card">
      <div class="filters-row">
        <button class="btn p" id="btnNewEvent">Nuevo Evento</button>
      </div>
      <div class="cal-head"><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div></div>
      <div id="calGrid" class="cal-grid"></div>
    </div>
  </section>

  <!-- PLANTEL -->
  <section id="v-roster">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Plantel</strong>
        <button id="btnAddPlayer" class="btn s">Agregar jugadora</button>
      </div>
      <div id="rosterGrid" class="grid"></div>
    </div>
  </section>

  <!-- SEGUIMIENTO -->
  <section id="v-track">
    <div class="card">
      <strong>Seguimiento de partidos</strong>
      <div id="trackList"></div>
    </div>
  </section>
</div>

<footer>Golden Moms · hecho con 💚 lima & azul</footer>

<script>
/* ========= SUPABASE ========= */
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};
const supa = supabase.createClient(SUPA.url, SUPA.key);

/* ========= Tabs ========= */
document.querySelectorAll('.nav .tab').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    ['dash','events','roster','track'].forEach(id=>document.getElementById('v-'+id).style.display='none');
    document.getElementById('v-'+btn.dataset.view).style.display='block';
    if(btn.dataset.view==='dash') renderDash();
    if(btn.dataset.view==='events') renderEvents();
    if(btn.dataset.view==='roster') renderRoster();
    if(btn.dataset.view==='track') renderTrack();
  };
});

/* ========= Helpers fecha ========= */
const tzOffsetMs = new Date().getTimezoneOffset() * 60000;
const toUTCISO = d => new Date(d.getTime() - tzOffsetMs).toISOString();
const fmt = d => d.toLocaleDateString("es-CL",{weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"});

/* Lunes como inicio de semana */
function startOfWeek(d=new Date()){
  const x = new Date(d);
  const dow = (x.getDay()+6)%7;  // lun=0..dom=6
  x.setDate(x.getDate()-dow);
  x.setHours(0,0,0,0);
  return x;
}
function endOfWeek(d=new Date()){
  const s = startOfWeek(d);
  const e = new Date(s);
  e.setDate(s.getDate()+7);
  e.setHours(0,0,0,0);
  return e;
}
function startOfDay(d=new Date()){
  const x=new Date(d); x.setHours(0,0,0,0); return x;
}
function endOfDay(d=new Date()){
  const x=new Date(d); x.setDate(x.getDate()+1); x.setHours(0,0,0,0); return x;
}

/* ========= Eventos (vista) — mantiene tu implementación base ========= */
async function renderEvents(){
  const {data}=await supa.from("events").select("*").order("datetime",{ascending:true});
  const grid=document.getElementById('calGrid'); grid.innerHTML="";
  (data||[]).forEach(e=>{
    const d=new Date(e.datetime);
    const c=document.createElement("div"); c.className="cal-cell";
    c.innerHTML=`
      <div style="font-size:12px;color:#0f3a78;font-weight:700">${d.toLocaleString("es-CL",{weekday:'short',hour:'2-digit',minute:'2-digit'})}</div>
      <div style="font-weight:600">${e.title}</div>
      <div style="font-size:12px;color:#475569">${e.team||""}</div>`;
    grid.appendChild(c);
  });
}

/* ========= Plantel ========= */
async function renderRoster(){
  const {data}=await supa.from("players").select("*").order("nombre");
  const grid=document.getElementById('rosterGrid'); grid.innerHTML="";
  (data||[]).forEach(p=>{
    const c=document.createElement("div"); c.className="card";
    c.innerHTML=`<strong>${p.nombre}</strong><br/>${p.apodo||""}<br/><span>${p.posicion||""}</span>`;
    grid.appendChild(c);
  });
}

/* ========= Seguimiento ========= */
async function renderTrack(){
  const {data}=await supa.from("matches").select("*").order("datetime",{ascending:false});
  const wrap=document.getElementById("trackList"); wrap.innerHTML="";
  (data||[]).forEach(m=>{
    const d=new Date(m.datetime);
    const div=document.createElement("div"); div.className="card";
    div.innerHTML=`<strong>${m.title||"Partido"}</strong><br/>
      ${d.toLocaleDateString("es-CL",{weekday:'short',day:'2-digit',month:'short'})}<br/>
      Goleadora: ${m.Goleadora||"-"}`;
    wrap.appendChild(div);
  });
}

/* ========= Crear Evento (simple) ========= */
document.getElementById("btnNewEvent").onclick = async () => {
  const title = prompt("Título del evento:");
  const datetime = prompt("Fecha y hora (YYYY-MM-DD HH:MM):");
  const type = prompt("Tipo (Entrenamiento o Partido):");
  const team = prompt("Equipo:");
  const cancha = prompt("Lugar:");
  if(!title || !datetime) return alert("Faltan datos");
  const { error } = await supa.from("events").insert([{ title, datetime, type, team, location: cancha }]);
  if(error){ alert("❌ Error al guardar: " + error.message); }
  else { alert("✅ Evento guardado"); renderEvents(); renderDash(); }
};

/* ========= Dashboard ========= */
async function renderDash(){
  const now = new Date();

  // KPIs básicos
  const {data:events}=await supa.from("events").select("*").gte("datetime", toUTCISO(now));
  const {data:players}=await supa.from("players").select("id,nombre,apodo,fecha_nacimiento");
  document.getElementById('kEvents').textContent = events?.length||0;
  document.getElementById('kRoster').textContent = players?.length||0;
  document.getElementById('kGames').textContent = 0;

  /* Cumpleaños HOY (tarjeta KPI) */
  const mdToday = (d)=> `${d.getMonth()+1}-${d.getDate()}`;
  const todayKey = mdToday(now);
  const bdayToday = (players||[]).filter(p=>{
    if(!p.fecha_nacimiento) return false;
    const d=new Date(p.fecha_nacimiento);
    return mdToday(d)===todayKey;
  });
  document.getElementById('kBdayToday').textContent =
    bdayToday.length ? bdayToday.map(p=>p.apodo||p.nombre).join(", ") : "—";

  /* Hoy */
  const tStart = startOfDay(now), tEnd=endOfDay(now);
  const {data:today}=await supa.from("events").select("*")
    .gte("datetime", toUTCISO(tStart)).lt("datetime", toUTCISO(tEnd)).order("datetime",{ascending:true});
  const listToday=document.getElementById('todayEvents'); listToday.innerHTML="";
  (today||[]).forEach(e=>{
    const d=new Date(e.datetime);
    listToday.innerHTML += `<li>${e.title} — ${fmt(d)}</li>`;
  });

  /* Semana actual (lun-dom) */
  const wStart=startOfWeek(now), wEnd=endOfWeek(now);
  const {data:week}=await supa.from("events").select("*")
    .gte("datetime", toUTCISO(wStart)).lt("datetime", toUTCISO(wEnd))
    .order("datetime",{ascending:true});
  const listWeek=document.getElementById('weekEvents'); listWeek.innerHTML="";
  (week||[]).forEach(e=>{
    const d=new Date(e.datetime);
    listWeek.innerHTML += `<li>${e.title} — ${fmt(d)}</li>`;
  });

  /* Próximos cumpleaños (abajo) — próximos 5 según vista */
  const { data: birthdays } = await supa
    .from("vw_upcoming_birthdays")
    .select("*")
    .order("proximo_cumple", { ascending: true })
    .limit(5);

  const bList = document.getElementById("upBirth"); bList.innerHTML="";
  (birthdays||[]).forEach(p=>{
    if(!p.proximo_cumple) return;
    const bd = new Date(p.proximo_cumple);
    bList.innerHTML += `<li>${p.apodo || p.nombre} — ${bd.toLocaleDateString("es-CL",{day:"2-digit",month:"short"})}</li>`;
  });
}

/* ========= Inicial ========= */
renderDash();
</script>

</body>
</html>
