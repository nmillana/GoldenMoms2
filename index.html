<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms — Panel</title>
<link rel="icon" href="Logo.webp"/>
<style>
:root{--blue:#0f3a78;--lime:#9be22d;--ink:#0f172a;--mut:#64748b;--b:#e2e8f0;--bg:#f7f8fa}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink)}
.top{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#fff;border-bottom:1px solid var(--b)}
.brand{display:flex;gap:8px;align-items:center}.brand img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)}
.nav{display:flex;gap:8px}.nav .tab{padding:8px 12px;border:1px solid var(--b);border-radius:999px;background:#fff;cursor:pointer}
.nav .tab.active{background:var(--blue);color:#fff}
.container{max-width:1000px;margin:20px auto;padding:12px}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;padding:16px;margin-bottom:12px}
.kpi h3{margin:0;color:var(--mut);font-size:14px}.kpi .n{font-size:22px;font-weight:800}
.error{color:red;font-weight:bold;margin:10px 0;padding:6px;background:#fee;border:1px solid red}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--b);padding:6px;text-align:left}
th{background:#f1f5f9}
</style>
<script src="https://unpkg.com/@supabase/supabase-js@2.39.8/dist/umd/supabase.js"></script>
</head>
<body>

<div class="top">
  <div class="brand"><img src="Logo.webp" alt="GM"/> <strong>Golden Moms</strong></div>
  <div class="nav">
    <button class="tab active" data-view="dash">Dashboard</button>
    <button class="tab" data-view="roster">Plantel</button>
    <button class="tab" data-view="events">Eventos</button>
    <button class="tab" data-view="att">Asistencia</button>
    <button class="tab" data-view="results">Resultados</button>
    <button class="tab" data-view="goals">Goles</button>
  </div>
</div>

<div class="container"></div>
  
<!-- Cargar SDK de Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"   // ⚠️ revisa que sea la correcta
};
const supa = supabase.createClient(SUPA.url, SUPA.key);

function showError(err) {
  document.querySelector(".container").innerHTML = `<div class="error">❌ ${err.message||err}</div>`;
  console.error(err);
}

// Dashboard
async function renderDashboard() {
  try {
    const { data: players, error: e1 } = await supa.from("players").select("id");
    if (e1) throw e1;
    const { data: events, error: e2 } = await supa.from("events").select("id");
    if (e2) throw e2;
    const { data: top, error: e3 } = await supa.from("vw_top_scorers").select("*").limit(3);
    if (e3) throw e3;

    document.querySelector(".container").innerHTML = `
      <div class="card kpi"><h3>Jugadoras</h3><div class="n">${players.length}</div></div>
      <div class="card kpi"><h3>Eventos</h3><div class="n">${events.length}</div></div>
      <div class="card"><h3>Top Goleadoras</h3>
        <ul>${top.map(p=>`<li>${p.nombre} (${p.goles})</li>`).join("")}</ul>
      </div>
    `;
  } catch(err) { showError(err); }
}

// Roster
async function renderRoster() {
  try {
    const { data, error } = await supa.from("players").select("*").order("nombre");
    if (error) throw error;
    if (!data.length) { document.querySelector(".container").innerHTML="<p>No hay jugadoras.</p>"; return; }
    document.querySelector(".container").innerHTML = `
      <div class="card"><h3>Plantel</h3>
      <table><tr><th>Nombre</th><th>Apodo</th><th>N°</th><th>Rol</th></tr>
      ${data.map(p=>`<tr><td>${p.nombre}</td><td>${p.apodo||""}</td><td>${p.numero_camiseta||""}</td><td>${p.rol}</td></tr>`).join("")}
      </table></div>`;
  } catch(err) { showError(err); }
}

// Eventos
async function renderEvents() {
  try {
    const { data, error } = await supa.from("events").select("*").order("datetime",{ascending:true});
    if (error) throw error;
    if (!data.length) { document.querySelector(".container").innerHTML="<p>No hay eventos.</p>"; return; }
    document.querySelector(".container").innerHTML = `
      <div class="card"><h3>Eventos</h3>
      <table><tr><th>Tipo</th><th>Título</th><th>Fecha</th><th>Lugar</th><th>Uniforme</th></tr>
      ${data.map(ev=>`<tr><td>${ev.type}</td><td>${ev.title}</td><td>${new Date(ev.datetime).toLocaleString()}</td><td>${ev.location||""}</td><td>${ev.uniform||""}</td></tr>`).join("")}
      </table></div>`;
  } catch(err) { showError(err); }
}

// Asistencia (con join manual)
async function renderAttendance() {
  try {
    const { data: att, error } = await supa.from("attendance").select("*").limit(20);
    if (error) throw error;
    if (!att.length) { document.querySelector(".container").innerHTML="<p>No hay registros de asistencia.</p>"; return; }

    // Traer jugadoras y eventos para resolver nombres
    const { data: players } = await supa.from("players").select("id,nombre");
    const { data: events } = await supa.from("events").select("id,title");
    const playerMap = Object.fromEntries(players.map(p=>[p.id,p.nombre]));
    const eventMap = Object.fromEntries(events.map(e=>[e.id,e.title]));

    document.querySelector(".container").innerHTML = `
      <div class="card"><h3>Asistencia</h3>
      <table><tr><th>Evento</th><th>Jugadora</th><th>Estado</th></tr>
      ${att.map(a=>`<tr><td>${eventMap[a.event_id]||""}</td><td>${playerMap[a.player_id]||""}</td><td>${a.status}</td></tr>`).join("")}
      </table></div>`;
  } catch(err) { showError(err); }
}

// Resultados
async function renderResults() {
  try {
    const { data, error } = await supa.from("results").select("*, event_id").order("created_at",{ascending:false});
    if (error) throw error;
    if (!data.length) { document.querySelector(".container").innerHTML="<p>No hay resultados.</p>"; return; }

    const { data: events } = await supa.from("events").select("id,title");
    const eventMap = Object.fromEntries(events.map(e=>[e.id,e.title]));

    document.querySelector(".container").innerHTML = `
      <div class="card"><h3>Resultados</h3>
      <table><tr><th>Evento</th><th>Goles GM</th><th>Goles Rival</th><th>Notas</th></tr>
      ${data.map(r=>`<tr><td>${eventMap[r.event_id]||""}</td><td>${r.goals_home}</td><td>${r.goals_away}</td><td>${r.notes||""}</td></tr>`).join("")}
      </table></div>`;
  } catch(err) { showError(err); }
}

// Goles
async function renderGoals() {
  try {
    const { data, error } = await supa.from("vw_top_scorers").select("*");
    if (error) throw error;
    if (!data.length) { document.querySelector(".container").innerHTML="<p>No hay goles.</p>"; return; }
    document.querySelector(".container").innerHTML = `
      <div class="card"><h3>Ranking Goleadoras</h3>
      <table><tr><th>Nombre</th><th>Goles</th></tr>
      ${data.map(p=>`<tr><td>${p.nombre}</td><td>${p.goles}</td></tr>`).join("")}
      </table></div>`;
  } catch(err) { showError(err); }
}

// Router
function renderAll() {
  const view = document.querySelector(".nav .tab.active").dataset.view;
  if (view==="dash") renderDashboard();
  if (view==="roster") renderRoster();
  if (view==="events") renderEvents();
  if (view==="att") renderAttendance();
  if (view==="results") renderResults();
  if (view==="goals") renderGoals();
}

document.addEventListener("DOMContentLoaded", () => {
  renderAll();
  document.querySelectorAll(".nav .tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".nav .tab").forEach(t=>t.classList.remove("active"));
      btn.classList.add("active");
      renderAll();
    });
  });
});
</script>
</body>
</html>
