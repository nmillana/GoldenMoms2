<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms â€” Panel</title>
<link rel="icon" href="Logo.webp"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{
  --blue:#0f3a78;--lime:#9be22d;--ink:#0f172a;--mut:#64748b;
  --b:#e2e8f0;--bg:#f7f8fa;--ok:#d9f99d;--mid:#fef9c3;--no:#fee2e2;
  --card:#ffffff;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:inherit;text-decoration:none}
.btn{border:1px solid var(--b);border-radius:12px;padding:8px 12px;background:#fff;cursor:pointer}
.btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
.btn.s{background:#f8fafc}
.badge{font-size:11px;border:1px solid var(--b);border-radius:999px;padding:2px 8px;background:#f8fafc}
.top{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.brand{display:flex;gap:10px;align-items:center}
.brand img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
.nav .tab.active{background:var(--blue);color:#fff}
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:var(--card);border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 20px #0000000a;padding:12px}
.kpi h3{margin:0;color:var(--mut);font-size:14px}.kpi .n{font-size:22px;font-weight:800}
/* ============ Eventos (Calendario mensual) ============ */
.cal-toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap}
.cal-title{font-weight:900;font-size:22px;letter-spacing:.3px}
.cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;position:sticky;top:114px;z-index:5;background:#fff;padding:6px 0;border-bottom:1px solid var(--b)}
.cal-head>div{text-align:center;font-weight:700;color:var(--blue)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.day{min-height:150px;background:#fff;border:1px solid var(--b);border-radius:14px;padding:8px;display:flex;flex-direction:column}
.day-muted{opacity:.45}
.day-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.day-num{font-weight:800}
.day-week{font-size:11px;color:var(--mut)}
.ev{font-size:12px;border:1px dashed #cfd8e3;border-radius:10px;padding:8px;margin-top:6px;line-height:1.25;cursor:pointer}
.ev .t{font-weight:800}
.ev .time{font-weight:700;color:var(--blue);font-size:12px}
.ev .team{font-size:10px;background:#eaf7d7;border:1px solid #c8ef7a;border-radius:999px;padding:1px 6px;display:inline-block;margin-top:4px;font-weight:700}
.ev.match{background:#eaf1ff;border-color:#cfe0ff}
.ev.train{background:#eefce0;border-color:#d6f7a5}
.today{outline:2px solid #2563eb33}
/* ============ Modal simple ============ */
.modal-back{position:fixed;inset:0;background:#0006;display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal{width:min(520px,100%);background:#fff;border:1px solid var(--b);border-radius:14px;padding:14px;box-shadow:0 20px 40px #00000022}
.modal h3{margin:0 0 10px 0}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.form-row .full{grid-column:1/-1}
.input{width:100%;padding:10px;border:1px solid var(--b);border-radius:10px}
/* ============ Responsive ============ */
@media (max-width: 900px){
  .grid{grid-template-columns:1fr}
  .cal-head{display:none}               /* evitamos solapes en mÃ³vil */
  .cal-grid{grid-template-columns:1fr}  /* dÃ­as apilados */
  .cal-title{font-size:20px}
  .ev{font-size:13px}
  .day{min-height:auto}
  .day-week{display:block}
}
</style>
</head>
<body>

<!-- Top -->
<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM"/>
    <div><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div class="nav">
    <button class="tab" data-view="dash">Dashboard</button>
    <button class="tab active" data-view="events">Eventos</button>
    <button class="tab" data-view="roster">Plantel</button>
    <button class="tab" data-view="track">Seguimiento</button>
  </div>
</div>

<div class="container">
  <!-- DASHBOARD -->
  <section id="v-dash" style="display:none">
    <div class="grid">
      <div class="card kpi" style="grid-column:span 3"><h3>PrÃ³ximos eventos</h3><div class="n" id="kEvents">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h3>Plantel</h3><div class="n" id="kRoster">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h3>Convocadas (prÃ³x.)</h3><div class="n" id="kOk">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h3>Partidos jugados</h3><div class="n" id="kGames">0</div></div>
    </div>
    <div class="card" style="margin-top:12px">
      <strong>ðŸŽ‚ PrÃ³ximos cumpleaÃ±os</strong>
      <ul id="upBirth" style="margin:8px 0 0 16px"></ul>
    </div>
    <div class="card" style="margin-top:12px">
      <strong>ðŸ“… Eventos de la semana</strong>
      <ul id="weekEvents" style="margin:8px 0 0 16px"></ul>
    </div>
  </section>

  <!-- EVENTOS (vista mensual) -->
  <section id="v-events">
    <div class="card">
      <div class="cal-toolbar">
        <div style="display:flex;gap:6px;align-items:center">
          <button class="btn" id="prevMonth">â€¹</button>
          <div class="cal-title" id="calTitle">Mes AAAA</div>
          <button class="btn" id="nextMonth">â€º</button>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn s" id="btnToday">Hoy</button>
          <button class="btn p" id="btnNewEvent">Nuevo Evento</button>
        </div>
      </div>
      <div class="cal-head"><div>Lun</div><div>Mar</div><div>MiÃ©</div><div>Jue</div><div>Vie</div><div>SÃ¡b</div><div>Dom</div></div>
      <div id="calGrid" class="cal-grid"></div>
    </div>
  </section>

  <!-- PLANTEL -->
  <section id="v-roster" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Plantel</strong>
        <button id="btnAddPlayer" class="btn s">Agregar jugadora</button>
      </div>
      <div id="rosterGrid" class="grid"></div>
    </div>
  </section>

  <!-- SEGUIMIENTO -->
  <section id="v-track" style="display:none">
    <div class="card">
      <strong>Seguimiento de partidos</strong>
      <div id="trackList"></div>
    </div>
  </section>
</div>

<footer style="text-align:center;color:#64748b;margin:18px 0">Golden Moms Â· hecho con ðŸ’š lima & azul</footer>

<!-- ===== Modal editar/crear ===== -->
<div class="modal-back" id="modalBack">
  <div class="modal">
    <h3 id="mTitle">Editar evento</h3>
    <div class="form-row">
      <input class="input full" id="fTitle" placeholder="TÃ­tulo"/>
      <div>
        <label style="font-size:12px;color:var(--mut)">Fecha y hora</label>
        <input class="input" id="fDateTime" type="datetime-local"/>
      </div>
      <div>
        <label style="font-size:12px;color:var(--mut)">Tipo</label>
        <select class="input" id="fType">
          <option>Entrenamiento</option>
          <option>Partido</option>
        </select>
      </div>
      <div>
        <label style="font-size:12px;color:var(--mut)">Equipo</label>
        <input class="input" id="fTeam" placeholder="Golden Moms"/>
      </div>
      <div>
        <label style="font-size:12px;color:var(--mut)">Lugar</label>
        <input class="input" id="fLocation" placeholder="Colegio / Cancha"/>
      </div>
      <div class="full" style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn s" id="btnClose">Cancelar</button>
        <button class="btn p" id="btnSave">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= SUPABASE ========= */
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};
const supa = supabase.createClient(SUPA.url, SUPA.key);

/* ========= NavegaciÃ³n ========= */
document.querySelectorAll('.nav .tab').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    showView(btn.dataset.view);
  };
});
function showView(v){
  ['dash','events','roster','track'].forEach(id=>document.getElementById('v-'+id).style.display='none');
  document.getElementById('v-'+v).style.display='block';
  if(v==='dash') renderDash();
  if(v==='events') renderMonth();
  if(v==='roster') renderRoster();
  if(v==='track') renderTrack();
}

/* ========= Utiles ========= */
const fmtTime = (d)=> d.toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'});
const fmtDate = (d)=> d.toLocaleDateString('es-CL',{weekday:'short',day:'2-digit',month:'short'});

/* ========= Dashboard (resumen) ========= */
async function renderDash(){
  const {data:events}=await supa.from("events").select("*").gte("datetime", new Date().toISOString());
  const {data:players}=await supa.from("players").select("*");
  document.getElementById('kEvents').textContent=events?.length||0;
  document.getElementById('kRoster').textContent=players?.length||0;
  document.getElementById('kOk').textContent=0;
  document.getElementById('kGames').textContent=0;

  // CumpleaÃ±os (vista de prÃ³ximos)
  try {
    const { data: birthdays } = await supa
      .from("vw_upcoming_birthdays").select("*")
      .order("proximo_cumple", { ascending: true }).limit(5);
    const list=document.getElementById('upBirth'); list.innerHTML="";
    (birthdays||[]).forEach(p=>{
      if(p.proximo_cumple){
        const bd=new Date(p.proximo_cumple);
        list.innerHTML += `<li>${p.apodo || p.nombre} â€” ${bd.toLocaleDateString("es-CL",{day:"2-digit",month:"short"})}</li>`;
      }
    });
  } catch(e){ console.error(e); }

  // Eventos de la semana (vista SQL si la tienes creada)
  try {
    const { data: weekEvents } = await supa
      .from("vw_events_this_week").select("*")
      .order("datetime",{ascending:true});
    const ul=document.getElementById('weekEvents'); ul.innerHTML="";
    (weekEvents||[]).forEach(ev=>{
      const d=new Date(ev.datetime);
      ul.innerHTML += `<li><strong>${ev.title}</strong> â€” ${fmtDate(d)} ${fmtTime(d)}</li>`;
    });
  } catch(e){
    const ul=document.getElementById('weekEvents');
    ul.innerHTML = "<li>Error al cargar eventos</li>";
    console.error(e);
  }
}

/* ========= Plantel ========= */
async function renderRoster(){
  const {data}=await supa.from("players").select("*").order("nombre");
  const grid=document.getElementById('rosterGrid'); grid.innerHTML="";
  (data||[]).forEach(p=>{
    const c=document.createElement("div"); c.className="card";
    c.innerHTML=`<strong>${p.nombre}</strong><br/>${p.apodo||""}<br/><span>${p.rol||""}</span>`;
    grid.appendChild(c);
  });
}

/* ========= Seguimiento (placeholder) ========= */
async function renderTrack(){
  const wrap=document.getElementById("trackList"); wrap.innerHTML="";
  wrap.innerHTML = "<div class='card'>PrÃ³ximamenteâ€¦</div>";
}

/* ========= Calendario mensual ========= */
let current = new Date(); // mes visible

document.getElementById('prevMonth').onclick = ()=>{ current.setMonth(current.getMonth()-1); renderMonth(); };
document.getElementById('nextMonth').onclick = ()=>{ current.setMonth(current.getMonth()+1); renderMonth(); };
document.getElementById('btnToday').onclick  = ()=>{ current = new Date(); renderMonth(); };

async function renderMonth(){
  // tÃ­tulo
  const title = current.toLocaleDateString('es-CL',{month:'long',year:'numeric'});
  document.getElementById('calTitle').textContent = title.charAt(0).toUpperCase()+title.slice(1);

  // rango del mes
  const first = new Date(current.getFullYear(), current.getMonth(), 1);
  const last  = new Date(current.getFullYear(), current.getMonth()+1, 0);

  // fetch de eventos del mes
  const { data: events } = await supa
    .from('events')
    .select('*')
    .gte('datetime', first.toISOString())
    .lte('datetime', new Date(current.getFullYear(), current.getMonth()+1, 0, 23,59,59).toISOString())
    .order('datetime', { ascending: true });

  // map por dÃ­a (YYYY-MM-DD)
  const map = {};
  (events||[]).forEach(ev=>{
    const d = new Date(ev.datetime);
    const k = d.toISOString().slice(0,10);
    (map[k] ||= []).push(ev);
  });

  // construir celdas
  const grid = document.getElementById('calGrid'); grid.innerHTML="";
  // offset para iniciar en Lunes
  const offset = (first.getDay()+6)%7; // 0 = lunes
  const daysCount = offset + last.getDate();
  const totalCells = Math.ceil(daysCount/7)*7;

  for(let i=0;i<totalCells;i++){
    const cell = document.createElement('div');
    cell.className = 'day';
    const dayNum = i-offset+1;
    const inMonth = dayNum>=1 && dayNum<=last.getDate();

    let dateObj=null, ymd=null, weekStr='';
    if(inMonth){
      dateObj = new Date(current.getFullYear(), current.getMonth(), dayNum);
      ymd = dateObj.toISOString().slice(0,10);
      weekStr = dateObj.toLocaleDateString('es-CL',{weekday:'short'});
    }else{
      cell.classList.add('day-muted');
    }

    // header del dÃ­a
    cell.innerHTML = `
      <div class="day-header">
        <div>
          <div class="day-num">${inMonth ? dayNum : ''}</div>
          <div class="day-week">${inMonth ? weekStr : ''}</div>
        </div>
        ${inMonth && isToday(dateObj) ? '<span class="badge">Hoy</span>' : ''}
      </div>
    `;

    // eventos del dÃ­a
    if(inMonth && map[ymd]){
      map[ymd].forEach(ev=>{
        const d = new Date(ev.datetime);
        const div = document.createElement('div');
        div.className = 'ev ' + (ev.type==='Partido'?'match':'train');
        div.innerHTML = `
          <div class="time">${fmtTime(d)}</div>
          <div class="t">${ev.title}</div>
          <div class="team">${ev.team||''}</div>
        `;
        div.onclick = ()=> openModal(ev); // editar
        cell.appendChild(div);
      });
    }

    // marca de hoy
    if(inMonth && isToday(dateObj)) cell.classList.add('today');

    grid.appendChild(cell);
  }
}

function isToday(d){
  const t=new Date();
  return d.getFullYear()===t.getFullYear() && d.getMonth()===t.getMonth() && d.getDate()===t.getDate();
}

/* ====== Crear / Editar evento (modal) ====== */
const $back = document.getElementById('modalBack');
const $fTitle = document.getElementById('fTitle');
const $fDateTime = document.getElementById('fDateTime');
const $fType = document.getElementById('fType');
const $fTeam = document.getElementById('fTeam');
const $fLocation = document.getElementById('fLocation');
const $mTitle = document.getElementById('mTitle');
let editing = null;

function openModal(ev=null){
  editing = ev;
  $mTitle.textContent = ev ? 'Editar evento' : 'Nuevo evento';
  $fTitle.value = ev?.title || '';
  $fType.value  = ev?.type || 'Entrenamiento';
  $fTeam.value  = ev?.team || 'Golden Moms';
  $fLocation.value = ev?.location || '';
  // datetime-local requiere formato 'YYYY-MM-DDTHH:MM'
  $fDateTime.value = ev ? new Date(ev.datetime).toISOString().slice(0,16) : '';
  $back.style.display='flex';
}
document.getElementById('btnClose').onclick=()=>{$back.style.display='none';}
document.getElementById('btnNewEvent').onclick=()=>openModal(null);

document.getElementById('btnSave').onclick=async()=>{
  const payload = {
    title: $fTitle.value.trim(),
    type: $fType.value,
    team: $fTeam.value.trim(),
    location: $fLocation.value.trim(),
    datetime: new Date($fDateTime.value).toISOString()
  };
  if(!payload.title || !payload.datetime){
    alert('TÃ­tulo y fecha/hora son obligatorios'); return;
  }
  if(editing){
    await supa.from('events').update(payload).eq('id', editing.id);
  }else{
    await supa.from('events').insert([payload]);
  }
  $back.style.display='none';
  renderMonth(); // refresca calendario
};

/* ========= Inicial ========= */
document.querySelector('[data-view="events"]').classList.add('active');
showView('events'); // abre la pestaÃ±a Eventos por defecto
</script>

</body>
</html>
