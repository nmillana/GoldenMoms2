<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms â€” Panel</title>
<link rel="icon" href="Logo.webp"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{
  --blue:#0f3a78; --lime:#9be22d; --ink:#0f172a; --mut:#64748b;
  --b:#e2e8f0; --bg:#f7f8fa;
  --lime-strong:#7fd410; --blue-strong:#0a2a58;
  --content-size:10px; --kpi-number-size:22px;
  --card-radius:12px;
}

/* base */
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:inherit;text-decoration:none}

/* Buttons */
.btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer;font-size:var(--content-size)}
.btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
.btn.s{background:#f8fafc}

/* Top bar */
.top{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px;overflow:visible}
.brand{display:flex;gap:10px;align-items:center}
.brand img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)}
.brand div{font-size:var(--content-size)}
.nav{display:flex;gap:8px;flex-wrap:nowrap;align-items:center;overflow-x:auto;padding-bottom:4px}
.nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer;white-space:nowrap;font-size:var(--content-size)}
.nav .tab.active{background:var(--blue);color:#fff}

/* Layout */
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:#fff;border:1px solid var(--b);border-radius:var(--card-radius);box-shadow:0 8px 20px #0000000a;padding:12px; overflow:visible}
.card h4{margin:0 0 8px;font-size:14px;font-weight:700}
.section-note{font-size:12px;color:var(--mut);margin-top:8px;border-left:3px solid #e6edf7;padding-left:8px}

/* matches area */
.matches-wrap{display:flex;flex-direction:column;gap:14px}
.upcoming-title{font-weight:800;margin:8px 0}
.month-accordion{border:1px solid var(--b);border-radius:10px;overflow:hidden;background:#fff}
.month-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer;background:#f8fafc;border-bottom:1px solid var(--b)}
.month-body{padding:12px;display:block}
.month-count{font-size:12px;color:var(--mut)}

/* match card */
.match-row{
  border:1px solid var(--b); border-radius:10px; padding:12px; margin-bottom:10px;
  display:grid; grid-template-columns: 1fr 360px; gap:12px; align-items:start;
}
.match-head{font-weight:700}
.match-meta{font-size:12px;color:var(--mut);margin-top:4px}
.match-right{display:flex; flex-direction:column; gap:8px; align-items:flex-end}
.match-form{display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; width:100%;}
.match-form input[type="number"], .match-form select, .match-form textarea { width:100%; box-sizing:border-box; }
.match-form textarea{grid-column: 1 / -1; min-height:80px; resize:vertical}
.match-actions{display:flex; gap:8px; justify-content:flex-end; width:100%}

/* visual read-only details */
.match-compact { font-size:13px; margin-top:8px; color:var(--mut) }

/* responsive: single-column on small screens */
@media (max-width:900px){
  .match-row{ grid-template-columns: 1fr; }
  .match-right{ align-items:stretch; }
  .match-form{ grid-template-columns: 1fr 1fr; }
}

/* mobile: make inputs bigger and selects comfortable */
@media (max-width:480px){
  .match-row{ padding:10px; }
  .match-form textarea{ min-height:70px; }
  .match-actions{ flex-direction:row; justify-content:flex-start; gap:8px}
  .match-right{ margin-top:8px }
}

/* select multiple sizing */
select[multiple]{ min-height:120px; }

/* small helpers */
.small-muted{ font-size:12px; color:var(--mut) }
.empty-msg{ color:var(--mut); padding:12px; text-align:center }

/* Accordion chevron */
.chev { transition: transform .18s ease; }
.chev.open { transform: rotate(180deg); }
</style>
</head>
<body>

<!-- Top -->
<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM"/>
    <div><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <div class="nav" role="tablist" aria-label="NavegaciÃ³n">
      <button class="tab active" data-view="dash">Dashboard</button>
      <button class="tab" data-view="events">Eventos</button>
      <button class="tab" data-view="roster">Plantel</button>
      <button class="tab" data-view="matches">Partidos</button>
    </div>
  </div>
</div>

<div class="container">
  <!-- DASHBOARD -->
  <section id="v-dash">
    <div class="grid" style="align-items:stretch">
      <div class="card kpi" style="grid-column:span 6;display:flex;flex-direction:column;justify-content:space-between">
        <div>
          <h4>Plantel</h4>
          <div class="n" id="kRoster">0</div>
          <div style="font-size:12px;color:var(--mut)">Integrantes registrados</div>
        </div>
      </div>

      <div class="card kpi" style="grid-column:span 6;display:flex;flex-direction:column;justify-content:space-between">
        <div>
          <h4>Partidos jugados</h4>
          <div class="n" id="kGames">0</div>
          <div id="lastMatchSummary" style="font-size:12px;color:var(--mut)"></div>
        </div>
        <div style="margin-top:8px;display:flex;justify-content:flex-end">
          <button class="btn s" onclick="showView('matches')">Ir a partidos</button>
        </div>
      </div>
    </div>

    <!-- smaller dashboard blocks... (same as before) -->
    <div style="margin-top:12px">
      <div class="card">
        <h4>ðŸ“… Hoy</h4>
        <div class="section-note">Eventos que ocurren hoy (fecha local).</div>
        <ul id="todayEvents" style="margin:8px 0 0 16px"></ul>
      </div>
    </div>
  </section>

  <!-- EVENTOS -->
  <section id="v-events" style="display:none">
    <div class="card">
      <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
        <div class="month-title" id="monthTitle">Mes</div>
        <div>
          <button class="btn s" id="btnPrevMonth">â—€</button>
          <button class="btn s" id="btnToday">Hoy</button>
          <button class="btn s" id="btnNextMonth">â–¶</button>
          <button class="btn p" id="btnNewEventTop">Nuevo Evento</button>
        </div>
      </div>
      <div style="margin-top:10px" id="monthGrid"></div>
    </div>
  </section>

  <!-- PLANTEL -->
  <section id="v-roster" style="display:none">
    <div class="card">
      <h4>Plantel</h4>
      <div class="section-note">Listado del plantel (tabla <code>players</code>) â€” toca una tarjeta para ver/editar.</div>
      <div id="rosterGrid" class="grid" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- PARTIDOS -->
  <section id="v-matches" style="display:none">
    <div class="card">
      <h4>Partidos jugados</h4>
      <div class="section-note">Registro de partidos: goles, diferencia, goleadoras y observaciones. </div>

      <div id="matchesArea" class="matches-wrap" style="margin-top:12px">
        <!-- upcoming + history will be injected here -->
      </div>
    </div>
  </section>

</div>

<footer style="text-align:center;padding:16px;color:var(--mut);font-size:12px">Golden Moms Â· hecho con ðŸ’š lima & azul</footer>

<!-- MODAL (sin cambios funcionales en eventos) -->
<div class="modal-bg" id="modalBg" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Nuevo evento</h3>
    <!-- (mantengo tu modal original, recortado por brevedad; el cÃ³digo JS del modal sigue igual abajo) -->
    <div class="form-row">
      <div>
        <label>TÃ­tulo</label>
        <input id="f_title" class="input" placeholder="Ej: Entrenamiento Colegio">
      </div>
      <div>
        <label>Tipo</label>
        <select id="f_type" class="input">
          <option>Entrenamiento</option>
          <option>Partido</option>
        </select>
      </div>
    </div>
    <!-- resto del modal conservado -->
    <div style="height:8px"></div>
    <div class="modal-actions">
      <button class="btn s" id="btnCancel">Cancelar</button>
      <button class="btn p" id="btnSave">Guardar</button>
    </div>
  </div>
</div>

<!-- PLAYER modal (sin cambios relevantes) -->
<div class="modal-bg" id="playerModalBg" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="playerModalTitle">
    <h3 id="playerModalTitle">Jugadora</h3>
    <!-- body omitido por brevedad; el JS lo maneja como antes -->
    <div style="height:16px"></div>
    <div class="modal-actions">
      <button class="btn s" id="btnCancelPlayer">Cancelar</button>
      <button class="btn p" id="btnSavePlayer">Guardar cambios</button>
    </div>
  </div>
</div>

<script>
/* ---------- Supabase config & init ---------- */
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};
let supa = null;
async function initSupabase(timeoutMs = 8000){
  try{
    if(typeof createClient === 'function'){ supa = createClient(SUPA.url, SUPA.key); return supa; }
    if(window.supabase && typeof window.supabase.createClient === 'function'){ supa = window.supabase.createClient(SUPA.url, SUPA.key); return supa; }
    await new Promise((resolve,reject)=>{
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js';
      s.async = true;
      let done=false;
      const to=setTimeout(()=>{ if(!done){ done=true; reject(new Error('timeout cargando supabase')); }}, timeoutMs);
      s.onload=()=>{ if(done) return; done=true; clearTimeout(to); resolve(); };
      s.onerror=()=>{ if(done) return; done=true; clearTimeout(to); reject(new Error('error cargando supabase')); };
      document.head.appendChild(s);
    });
    if(typeof createClient === 'function'){ supa = createClient(SUPA.url, SUPA.key); return supa; }
    if(window.supabase && typeof window.supabase.createClient === 'function'){ supa = window.supabase.createClient(SUPA.url, SUPA.key); return supa; }
    throw new Error('SDK cargado pero no se encontrÃ³ createClient');
  }catch(err){ console.error('initSupabase error:', err); supa = null; return null; }
}

/* ---------- Helpers ---------- */
function pad(n){return n.toString().padStart(2,'0');}
function localDateYMD(d){ const D=new Date(d); return `${D.getFullYear()}-${pad(D.getMonth()+1)}-${pad(D.getDate())}`; }

/* ---------- simple modal hooks (keeps your modal functionality elsewhere) ---------- */
const btnCancel = document.getElementById('btnCancel');
btnCancel && btnCancel.addEventListener('click', ()=>{ document.getElementById('modalBg').style.display='none'; });

/* ---------- PLAYERS CACHE for scorer select ---------- */
let PLAYERS_CACHE = null;
let PLAYERS_MAP = null;
async function loadPlayersCache(){
  if(PLAYERS_CACHE) return PLAYERS_CACHE;
  if(!supa) return [];
  try{
    const { data, error } = await supa.from('players').select('id, apodo, nombre').order('apodo',{ascending:true});
    if(error){ console.warn('loadPlayersCache error', error); return []; }
    PLAYERS_CACHE = (data||[]).map(p=>{
      const label = (p.apodo && p.apodo.trim()) || (p.nombre && p.nombre.trim()) || 'Sin nombre';
      return { id: p.id, label, nombre: p.nombre||'', apodo: p.apodo||'' };
    });
    PLAYERS_MAP = Object.fromEntries(PLAYERS_CACHE.map(p=>[p.id, p.label]));
    return PLAYERS_CACHE;
  }catch(err){ console.error(err); return []; }
}

/* upsert matches by event_id */
async function upsertMatchByEventId(eventId, payload){
  if(!supa) throw new Error('No conectado a Supabase');
  const { data:existing, error:selErr } = await supa.from('matches').select('id').eq('event_id', eventId).limit(1);
  if(selErr){ console.warn('select matches error', selErr); }
  if(existing && existing.length){
    const { error } = await supa.from('matches').update(payload).eq('event_id', eventId);
    return { error };
  } else {
    const { error } = await supa.from('matches').insert([{ event_id: eventId, ...payload }]);
    return { error };
  }
}

/* ---------- NEW renderMatches: upcoming + historical per month accordion ---------- */
async function renderMatches(){
  const area = document.getElementById('matchesArea');
  area.innerHTML = 'Cargando...';
  if(!supa){ area.innerHTML = '<div class="empty-msg">Sin conexiÃ³n â€” no se pueden cargar partidos</div>'; return; }

  try{
    // 1) traer eventos tipo Partido (todos)
    const { data: events = [], error: evErr } = await supa.from('events')
      .select('id, title, datetime, team, opponent, location, type')
      .eq('type','Partido')
      .order('datetime', { ascending: true }); // asc para facilitar upcoming (mÃ¡s cercano primero)
    if(evErr){ throw evErr; }

    // 2) traer matches (registros)
    const { data: matches = [] } = await supa.from('matches').select('id, event_id, goals_for, goals_against, goal_difference, observation, scorer_ids, scorers');

    const matchByEvent = {};
    (matches||[]).forEach(m => { matchByEvent[m.event_id] = m; });

    // 3) separar upcoming vs past
    const now = new Date();
    const upcoming = (events || []).filter(e => {
      if(!e.datetime) return true;
      return new Date(e.datetime) >= now;
    }).sort((a,b)=> new Date(a.datetime) - new Date(b.datetime)); // nearest first

    const past = (events || []).filter(e => e.datetime && new Date(e.datetime) < now)
      .sort((a,b)=> new Date(b.datetime) - new Date(a.datetime)); // most recent first

    // 4) prepare players cache
    await loadPlayersCache();

    // 5) render upcoming header + items
    area.innerHTML = '';
    const upWrap = document.createElement('div');
    upWrap.innerHTML = `<div class="upcoming-title">PrÃ³ximos partidos</div>`;
    if(upcoming.length === 0){
      const empty = document.createElement('div'); empty.className='empty-msg'; empty.innerText = 'No hay partidos prÃ³ximos.';
      upWrap.appendChild(empty);
    } else {
      for(const ev of upcoming){
        const m = matchByEvent[ev.id] || {};
        upWrap.appendChild(createMatchRow(ev, m, /*isPast=*/false));
      }
    }
    area.appendChild(upWrap);

    // 6) historical accordion by month (group past by YYYY-MM)
    const histWrap = document.createElement('div');
    histWrap.style.marginTop = '8px';
    histWrap.innerHTML = `<div class="upcoming-title">HistÃ³rico (por mes)</div>`;

    if(past.length === 0){
      const empty = document.createElement('div'); empty.className='empty-msg'; empty.innerText = 'No hay partidos en el histÃ³rico.';
      histWrap.appendChild(empty);
    } else {
      const groups = {};
      for(const ev of past){
        const d = new Date(ev.datetime);
        const key = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
        if(!groups[key]) groups[key] = { events: [], date: d };
        groups[key].events.push(ev);
      }
      // sort keys descending (most recent month first)
      const sortedKeys = Object.keys(groups).sort((a,b) => (a < b ? 1 : -1));
      for(const i=0;i<sortedKeys.length;i++){
        const key = sortedKeys[i];
        const group = groups[key];
        const d = group.date;
        const monthLabel = d.toLocaleDateString('es-CL',{month:'short', year:'numeric'}); // ej "dic 2025"
        const monthNode = document.createElement('div');
        monthNode.className = 'month-accordion';

        // header
        const header = document.createElement('div');
        header.className = 'month-header';
        header.innerHTML = `<div><strong>${monthLabel}</strong> <span class="month-count">Â· ${group.events.length} partido(s)</span></div>
          <div style="display:flex;align-items:center;gap:8px">
            <button class="btn s" aria-expanded="false">Expandir</button>
            <span class="chev">&#9660;</span>
          </div>`;
        // body
        const body = document.createElement('div');
        body.className = 'month-body';
        // initially collapse all except the most recent month (i==0 -> expanded)
        const expanded = i === 0;
        body.style.display = expanded ? 'block' : 'none';
        const chev = header.querySelector('.chev');
        const btnExp = header.querySelector('button');
        if(expanded){ btnExp.textContent = 'Colapsar'; chev.classList.add('open'); btnExp.setAttribute('aria-expanded','true'); }

        // add events in group (already in descending date order)
        group.events.sort((a,b)=> new Date(b.datetime) - new Date(a.datetime));
        for(const ev of group.events){
          const m = matchByEvent[ev.id] || {};
          body.appendChild(createMatchRow(ev, m, /*isPast=*/true));
        }

        // toggle
        header.addEventListener('click', ()=>{
          const visible = body.style.display !== 'none';
          body.style.display = visible ? 'none' : 'block';
          btnExp.textContent = visible ? 'Expandir' : 'Colapsar';
          if(chev) chev.classList.toggle('open', !visible);
          btnExp.setAttribute('aria-expanded', String(!visible));
          // smooth scroll to header when collapsing/expanding on mobile
          header.scrollIntoView({ behavior:'smooth', block:'center' });
        });

        monthNode.appendChild(header);
        monthNode.appendChild(body);
        histWrap.appendChild(monthNode);
      }
    }

    area.appendChild(histWrap);

  }catch(err){
    console.error('renderMatches error', err);
    area.innerHTML = '<div class="empty-msg">Error cargando partidos</div>';
  }
}

/* ---------- createMatchRow: builds DOM for a single event (reusable) ---------- */
function createMatchRow(ev, m, isPast){
  const row = document.createElement('div');
  row.className = 'match-row';

  const d = ev.datetime ? new Date(ev.datetime) : null;
  const dateTxt = d ? d.toLocaleDateString('es-CL',{weekday:'short', day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'}) : '';

  // left: info + current stored values (read-only)
  const left = document.createElement('div');
  left.innerHTML = `
    <div class="match-head">${ev.title || ((ev.team||'GM') + (ev.opponent? (' vs '+ev.opponent) : ''))}</div>
    <div class="match-meta">${dateTxt}${ev.location ? ' Â· ' + ev.location : ''}</div>
    <div class="match-compact">
      <div><strong>Marcador</strong>: ${m.goals_for ?? 'â€”'} : ${m.goals_against ?? 'â€”'} ${m.goal_difference!=null ? '(Dif: '+m.goal_difference+')' : ''}</div>
      <div style="margin-top:6px"><strong>Goleadoras</strong>: ${renderScorersText(m)}</div>
      <div style="margin-top:6px"><strong>ObservaciÃ³n</strong>: ${m.observation ? escapeHtml(m.observation) : 'â€”'}</div>
    </div>
  `;

  // right: editor (goles, selecciÃ³n de goleadoras del plantel, observaciÃ³n) - always editable even en futuro
  const right = document.createElement('div');
  right.className = 'match-right';
  const form = document.createElement('div');
  form.className = 'match-form';

  const inputGF = document.createElement('input');
  inputGF.type = 'number'; inputGF.min = '0'; inputGF.placeholder = 'Goles a favor';
  inputGF.value = (m.goals_for != null) ? m.goals_for : '';

  const inputGA = document.createElement('input');
  inputGA.type = 'number'; inputGA.min = '0'; inputGA.placeholder = 'Goles en contra';
  inputGA.value = (m.goals_against != null) ? m.goals_against : '';

  // scorer select (multiple) - build options from PLAYERS_CACHE
  const scorerSel = document.createElement('select');
  scorerSel.multiple = true;
  scorerSel.setAttribute('aria-label', 'Seleccionar goleadoras');
  // preselected ids from m.scorer_ids (array)
  const preIds = Array.isArray(m.scorer_ids) ? m.scorer_ids : [];
  // if there are legacy names (m.scorers), we'll not attempt mapping here except show them in read-only area
  (PLAYERS_CACHE || []).forEach(p=>{
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.label;
    if(preIds.includes(p.id)) opt.selected = true;
    scorerSel.appendChild(opt);
  });

  const obs = document.createElement('textarea');
  obs.placeholder = 'ObservaciÃ³n del partido';
  obs.value = m.observation || '';

  // actions
  const actions = document.createElement('div');
  actions.className = 'match-actions';
  const btnClear = document.createElement('button');
  btnClear.className = 'btn s'; btnClear.textContent = 'Borrar marcador';
  btnClear.onclick = async ()=>{
    try{
      await upsertMatchByEventId(ev.id, { goals_for: null, goals_against: null, goal_difference: null, observation: null, scorer_ids: [] });
      await renderMatches();
      await renderDash();
    }catch(err){ alert('Error borrando: ' + (err.message || err)); console.error(err); }
  };

  const btnSave = document.createElement('button');
  btnSave.className = 'btn p'; btnSave.textContent = 'Guardar';
  btnSave.onclick = async ()=>{
    try{
      const gf = inputGF.value === '' ? null : Number(inputGF.value);
      const ga = inputGA.value === '' ? null : Number(inputGA.value);
      const diff = (gf != null && ga != null) ? (gf - ga) : null;
      const ids = Array.from(scorerSel.selectedOptions).map(o=>o.value);
      const payload = {
        goals_for: gf,
        goals_against: ga,
        goal_difference: diff,
        observation: obs.value.trim() || null,
        scorer_ids: ids
      };
      const { error } = await upsertMatchByEventId(ev.id, payload);
      if(error){ alert('Error al guardar: ' + error.message); return; }
      await renderMatches();
      await renderDash();
    }catch(err){ alert('Error guardando: '+(err.message || err)); console.error(err); }
  };

  actions.appendChild(btnClear);
  actions.appendChild(btnSave);

  // append inputs to form
  form.appendChild(inputGF);
  form.appendChild(inputGA);
  form.appendChild(scorerSel);
  form.appendChild(obs);

  right.appendChild(form);
  right.appendChild(actions);

  row.appendChild(left);
  row.appendChild(right);

  return row;
}

/* small helper to render scorers text from match record */
function renderScorersText(m){
  if(!m) return 'â€”';
  if(Array.isArray(m.scorer_ids) && m.scorer_ids.length && PLAYERS_MAP){
    return m.scorer_ids.map(id => PLAYERS_MAP[id] || id).join(', ');
  }
  if(Array.isArray(m.scorers) && m.scorers.length) return m.scorers.join(', ');
  return 'â€”';
}

/* sanitize very small */
function escapeHtml(s){ if(!s) return s; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------- renderDash (refresh KPIs) ---------- */
async function renderDash(){
  try{
    const now = new Date();
    const weekStart = new Date(now);
    weekStart.setDate(weekStart.getDate() - ((weekStart.getDay()+6)%7));
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate()+6);

    let evs = [];
    if(supa){
      const {data:events} = await supa.from("events").select("*").gte("datetime", weekStart.toISOString()).lte("datetime", weekEnd.toISOString()).order("datetime",{ascending:true});
      evs = events || [];
    }
    let players = [];
    if(supa){
      try{ const resPlayers = await supa.from("players").select("*"); players = resPlayers.data || []; }catch(e){ players = []; }
    }
    document.getElementById('kRoster').textContent = (players||[]).length || 0;
    const matchesPlayed = evs.filter(e=> e.type==='Partido' && new Date(e.datetime) < new Date());
    document.getElementById('kGames').textContent = matchesPlayed.length;
    if(matchesPlayed.length>0){
      const last = matchesPlayed.sort((a,b)=> new Date(b.datetime)-new Date(a.datetime))[0];
      const d = new Date(last.datetime);
      document.getElementById('lastMatchSummary').textContent = `${last.title} â€” ${d.toLocaleDateString('es-CL',{day:'2-digit',month:'short'})}`;
    } else document.getElementById('lastMatchSummary').textContent = 'Sin partidos jugados aÃºn';
  }catch(err){
    console.error(err);
  }
}

/* ---------- init wiring ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  await initSupabase();
  // nav
  document.querySelectorAll('.nav .tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const view = btn.dataset.view;
      try{ localStorage.setItem('gm_view', view); }catch(e){}
      showView(view);
    });
  });
  const persisted = (function(){ try{return localStorage.getItem('gm_view');}catch(e){return null;} })();
  const activeTab = document.querySelector('.nav .tab.active');
  const initialView = persisted || (activeTab ? activeTab.dataset.view : 'dash');
  document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
  const btnToActivate = document.querySelector(`.nav .tab[data-view="${initialView}"]`);
  if(btnToActivate) btnToActivate.classList.add('active');
  showView(initialView);
});

/* showView routing */
function showView(v){
  ['dash','events','roster','matches'].forEach(id=>{
    const el = document.getElementById('v-'+id);
    if(el) el.style.display='none';
  });
  const target = document.getElementById('v-'+v) || document.getElementById('v-matches');
  if(target) target.style.display='block';
  if(v==='dash') renderDash();
  if(v==='events') {/* implement your month render if you have it */ }
  if(v==='matches') renderMatches();
  if(v==='roster') renderDash();
}
</script>
</body>
</html>
