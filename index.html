<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Golden Moms — Panel</title>
<link rel="icon" type="image/webp" href="Logo.webp"/>
<style>
:root{--blue:#0f3a78;--lime:#9BE22D;--ink:#0f172a;--b:#e2e8f0;--bg:#f7f8fa;--mut:#64748b;--red:#ef4444}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
a{color:inherit}
.top{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--b);z-index:10}
.topin{display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
.brand{display:flex;gap:10px;align-items:center}
.logo-img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue);object-fit:cover;object-position:center;background:#fff}
nav{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border:1px solid var(--b);border-radius:999px;background:#f8fafc;cursor:pointer}
.tab.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.container{max-width:1200px;margin:12px auto;padding:0 12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 20px #0000000a;padding:12px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{border:1px solid var(--b);background:#0f3a78;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.s{background:#f8fafc;color:var(--ink)}
.btn.d{background:var(--red);border-color:var(--red)}
.badge{font-size:11px;border:1px solid #cbd5e1;border-radius:999px;padding:2px 6px;background:#f8fafc;margin-right:4px}
input,select,textarea{padding:10px;border:1px solid var(--b);border-radius:10px;width:100%}
label{font-size:12px;color:#334155;font-weight:600}
hr{border:none;border-top:1px solid var(--b);margin:10px 0}
.chip{padding:6px 10px;border-radius:999px;border:1px solid var(--b);background:#f8fafc;font-weight:700;font-size:12px;margin:3px 4px;display:inline-flex;align-items:center;gap:6px}
.small{font-size:12px;color:#64748b}
/* Pages */
.page{display:none}
.page.active{display:block}
/* Calendar */
.grid7{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cell{background:#fff;border:1px solid var(--b);min-height:110px;border-radius:12px;padding:8px;position:relative}
.day{position:absolute;right:8px;top:6px;font-size:11px;color:#94a3b8}
.tag{font-size:10px;border:1px solid #0001;border-radius:999px;padding:2px 6px;display:inline-block;margin-bottom:4px}
.match{background:#e0edff;border-color:#b7d1ff;color:#0f3a78}
.train{background:#e9fbd0;border-color:#c6f28a;color:#2d5a00}
.event{font-size:13px;margin-bottom:6px;cursor:pointer}
.team{font-size:10px;background:#eaf7d7;border:1px solid #c8ef7a;border-radius:999px;padding:1px 6px;margin-left:6px;font-weight:700}
/* Modal */
.overlay{display:none;position:fixed;inset:0;background:#0006;align-items:center;justify-content:center;padding:12px;z-index:9999;overflow:auto}
.modal{max-width:900px;width:100%;background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 10px 30px #0003;padding:10px;max-height:92vh;overflow:auto}
.tabs{display:flex;gap:6px;margin-bottom:8px;position:sticky;top:0;background:#fff;padding-top:4px}
.tab2{padding:8px 12px;border:1px solid var(--b);border-radius:10px;background:#f8fafc;cursor:pointer}
.tab2.active{background:var(--blue);color:#fff;border-color:var(--blue)}
/* Roster */
.roster-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.player{border:1px solid var(--b);border-radius:12px;padding:10px}
.player h4{margin:4px 0}
/* Login */
.login-ov{display:flex;position:fixed;inset:0;background:#0b1220e6;align-items:center;justify-content:center;z-index:10000}
.login{max-width:420px;width:100%;background:#fff;border-radius:12px;border:1px solid var(--b);padding:16px;box-shadow:0 20px 60px #0006;text-align:center}
.login img{width:72px;height:72px;border-radius:12px;border:2px solid var(--blue);background:#fff;margin-bottom:8px}
</style>
</head>
<body>
<header class="top">
  <div class="topin">
    <div class="brand"><img class="logo-img" src="Logo.webp" alt="Golden Moms"/><strong>Golden <span style="color:var(--lime)">Moms</span></strong></div>
    <nav>
      <button class="tab active" data-page="dash">Dashboard</button>
      <button class="tab" data-page="events">Eventos</button>
      <button class="tab" data-page="roster">Plantel</button>
      <button class="tab" data-page="tracker">Seguimiento</button>
      <button class="tab" data-page="config">Configuración</button>
    </nav>
  </div>
</header>

<main class="container">

  <!-- Dashboard -->
  <section id="page-dash" class="page active">
    <div class="grid">
      <div class="card" style="grid-column:span 3"><h3>Próximos</h3><div id="kUp">0</div></div>
      <div class="card" style="grid-column:span 3"><h3>Plantel</h3><div id="kPlayers">0</div></div>
      <div class="card" style="grid-column:span 3"><h3>Capitanas</h3><div id="kCap">0</div></div>
      <div class="card" style="grid-column:span 3"><h3>Partidos jugados</h3><div id="kMatches">0</div></div>
    </div>
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button class="btn s" id="prev">&larr;</button>
          <div id="mlabel" style="min-width:200px;text-align:center;font-weight:800;color:#0f3a78"></div>
          <button class="btn s" id="next">&rarr;</button>
          <select id="fType"><option value="Todos">Todos</option><option value="Partido">Partidos</option><option value="Entrenamiento">Entrenamientos</option></select>
          <select id="fTeam"><option value="Todos">Todos</option><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select>
        </div>
        <div class="row">
          <button class="btn s" id="btnNew">Nuevo Evento</button>
        </div>
      </div>
      <div class="grid7"><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div></div>
      <div id="grid" class="grid7"></div>
    </div>
  </section>

  <!-- Eventos -->
  <section id="page-events" class="page">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Eventos</strong>
        <button class="btn" id="btnNew2">Nuevo Evento</button>
      </div>
      <div id="elist"></div>
    </div>
  </section>

  <!-- Plantel -->
  <section id="page-roster" class="page">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Plantel — Administración</strong>
        <div class="row">
          <select id="fltTeam"><option value="Todos">Todos</option><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select>
          <select id="fltRole"><option value="Todos">Rol: Todos</option><option>Jugadora</option><option>Capitana</option></select>
          <button class="btn" id="btnAddPlayer">Agregar Jugadora</button>
        </div>
      </div>
      <div id="players" class="roster-grid"></div>
    </div>
  </section>

  <!-- Seguimiento -->
  <section id="page-tracker" class="page">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Seguimiento de Partidos</strong>
        <button class="btn s" id="btnAddMatch">Registrar resultado</button>
      </div>
      <div id="matches"></div>
    </div>
  </section>

  <!-- Config -->
  <section id="page-config" class="page">
    <div class="card">
      <strong>Configuración</strong>
      <div class="row" style="margin-top:8px">
        <div style="min-width:220px">
          <label>Rol actual</label>
          <select id="currentRole"><option>Jugadora</option><option>Capitana</option></select>
        </div>
        <div style="min-width:220px">
          <label>Nombre de equipo</label>
          <input id="teamName"/>
        </div>
        <div style="min-width:220px">
          <label>Código de acceso (solo equipo)</label>
          <input id="accessCode"/>
          <span class="small">Compártelo sólo con jugadoras/capitanas.</span>
        </div>
        <div class="row"><button class="btn s" id="btnReset">Reiniciar todo (local)</button></div>
      </div>
    </div>
  </section>

</main>

<!-- Modal Evento -->
<div id="ov" class="overlay">
  <div class="modal">
    <div class="row" style="justify-content:space-between"><strong id="evTitle">Evento</strong><button class="btn s" id="closeEv">Cerrar</button></div>
    <div class="tabs">
      <button class="tab2 active" data-pane="att">Asistencia</button>
      <button class="tab2" data-pane="det">Detalles</button>
      <button class="tab2" data-pane="conv">Convocatoria</button>
    </div>
    <div id="pane-att">
      <div class="row" style="justify-content:space-between">
        <div id="attCounts" class="row"></div>
        <label class="chip"><input type="checkbox" id="hideNo" checked> Ocultar ❌</label>
      </div>
      <div id="attGrid"></div>
    </div>
    <div id="pane-det" style="display:none">
      <div class="row">
        <div style="flex:1;min-width:180px"><label>Tipo</label><select id="eType"><option>Partido</option><option>Entrenamiento</option></select></div>
        <div style="flex:2;min-width:220px"><label>Título</label><input id="eTitle"/></div>
        <div style="flex:1;min-width:180px"><label>Equipo</label><select id="eTeam"><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select></div>
      </div>
      <div class="row">
        <div style="flex:1;min-width:180px"><label>Fecha y hora</label><input id="eDT" type="datetime-local"/></div>
        <div style="flex:1;min-width:180px"><label>Lugar</label><input id="eLoc"/></div>
        <div style="flex:1;min-width:180px"><label>Rival</label><input id="eOpp"/></div>
        <div style="flex:1;min-width:180px"><label>Uniforme</label><select id="eUni"><option value="">—</option><option>Polera azul</option><option>Polera verde lima</option></select></div>
      </div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <button class="btn d" id="btnDel">Eliminar</button>
        <span class="small">Solo <strong>Capitana</strong> puede editar detalles</span>
      </div>
    </div>
    <div id="pane-conv" style="display:none">
      <div class="row">
        <label>Filtrar por etiquetas de equipo:</label>
        <label class="chip"><input type="checkbox" id="cvMoms" checked> Moms</label>
        <label class="chip"><input type="checkbox" id="cvDreams" checked> Dreams</label>
        <label class="chip"><input type="checkbox" id="cvPower" checked> Power</label>
      </div>
      <div class="row">
        <button class="btn s" id="btnCopyWA">Copiar WhatsApp</button>
        <button class="btn s" id="btnRSVP">Link convocatoria</button>
        <button class="btn s" id="btnICS">.ics</button>
      </div>
      <div class="small" id="convInfo"></div>
    </div>
  </div>
</div>

<!-- Modal Jugadora -->
<div id="ovP" class="overlay">
  <div class="modal">
    <div class="row" style="justify-content:space-between"><strong id="pTitle">Nueva jugadora</strong><button class="btn s" id="closeP">Cerrar</button></div>
    <div class="row">
      <div style="flex:2;min-width:240px"><label>Nombre</label><input id="pName"/></div>
      <div style="flex:1;min-width:160px"><label>Apodo</label><input id="pNick"/></div>
      <div style="flex:1;min-width:120px"><label>Número</label><input id="pNum" type="number"/></div>
    </div>
    <div class="row">
      <div style="flex:1;min-width:160px"><label>Fecha Nacimiento</label><input id="pBirth" type="date"/></div>
      <div style="flex:1;min-width:220px"><label>Rol</label><select id="pRole"><option>Jugadora</option><option>Capitana</option></select></div>
    </div>
    <div class="row">
      <label>Equipos:</label>
      <label class="chip">Moms <input type="checkbox" id="tMoms" checked></label>
      <label class="chip">Dreams <input type="checkbox" id="tDreams"></label>
      <label class="chip">Power <input type="checkbox" id="tPower"></label>
    </div>
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <button class="btn d" id="pDelete" style="display:none">Eliminar</button>
      <button class="btn" id="pSave">Guardar</button>
    </div>
  </div>
</div>

<!-- Login -->
<div id="loginOv" class="login-ov" style="display:none">
  <div class="login">
    <img src="Logo.webp" alt="Logo"/>
    <h3>Golden Moms — Acceso</h3>
    <div class="row"><input id="lgName" placeholder="Tu nombre (opcional)"></div>
    <div class="row">
      <select id="lgRole"><option>Jugadora</option><option>Capitana</option></select>
      <input id="lgCode" placeholder="Código de acceso"/>
    </div>
    <div class="row" style="justify-content:center"><button class="btn" id="lgEnter">Entrar</button></div>
    <div class="small" id="lgHint"></div>
  </div>
</div>

<script>
// --- State ---
const KEY="gm-roster-v3";
let S={
  team:"Golden Moms",
  currentRole:"Capitana",
  accessCode:"GOLDEN2025",
  players:[],
  events:[],
  att:{},
  matches:[],
  auth:{ok:false,name:"",role:"Jugadora"}
};
try{const t=JSON.parse(localStorage.getItem(KEY)||"{}"); S={...S,...t};}catch{}
function save(){localStorage.setItem(KEY,JSON.stringify(S));}

// Seed players if empty
if(!S.players.length){
  const base=["Ale V","Andre","Antonella","Aurora","Carla","Caro G","Caro N","Cata","Celsa","Chica","Consu","Consu S","Cote","Dani C","Dani J","Fabi","Fran","Gaby","Isa","Jandi","Janga","Javiera A","Javi C","Jean","Maca","Male","Marce","Myle","Paz","Pia","Pili","Vale","Vero"];
  S.players = base.map((n,i)=>({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),name:n,nick:"",number:(i%30)+1,birth:"",teams:["Moms"],role:"Jugadora"}));
  ["Dani J","Chica","Caro G"].forEach(n=>{const p=S.players.find(x=>x.name===n); if(p) p.role="Capitana";});
  save();
}
// Seed schedule if empty
if(!S.events.length){
  function mk(y,m,d,h,mi){const t=new Date(y,m-1,d,h,mi);return new Date(t.getTime()-t.getTimezoneOffset()*60000).toISOString();}
  function nextDow(dow){const n=new Date(), g=(dow-n.getDay()+7)%7||7;const d=new Date(n);d.setDate(n.getDate()+g);return d;}
  const tue=nextDow(2), wed=nextDow(3), thu=nextDow(4), fri=nextDow(5);
  for(let i=0;i<10;i++){
    const T=new Date(tue);T.setDate(tue.getDate()+7*i);
    const Th=new Date(thu);Th.setDate(thu.getDate()+7*i);
    const W=new Date(wed);W.setDate(wed.getDate()+7*i);
    const F=new Date(fri);F.setDate(fri.getDate()+7*i);
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:mk(T.getFullYear(),T.getMonth()+1,T.getDate(),19,30),location:"Colegio",opponent:"",uniform:""});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:mk(Th.getFullYear(),Th.getMonth()+1,Th.getDate(),19,30),location:"Colegio",opponent:"",uniform:""});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Partido",title:"Wonder Mom’s Cup",team:"Golden Moms",datetime:mk(W.getFullYear(),W.getMonth()+1,W.getDate(),20,0),location:"Universidad de los Andes",opponent:"—",uniform:""});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Partido",title:"Liga LIFA",team:"Golden Moms",datetime:mk(F.getFullYear(),F.getMonth()+1,F.getDate(),20,0),location:"Cancha Oriente, Las Condes",opponent:"—",uniform:""});
  }
  save();
}

// --- Helpers ---
const q=(s)=>document.querySelector(s);
const qa=(s)=>Array.from(document.querySelectorAll(s));
function fmtMonth(d){return d.toLocaleDateString("es-CL",{month:"long",year:"numeric"})}
function toInput(iso){const d=new Date(iso);const p=n=>String(n).padStart(2,"0");return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`}
function fromInput(val){const d=new Date(val);return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString()}
function chipsTeams(arr){return arr.map(t=>`<span class="badge">${t}</span>`).join("")}

// --- Navigation ---
qa(".tab").forEach(b=>b.onclick=()=>{qa(".tab").forEach(x=>x.classList.remove("active")); b.classList.add("active"); qa(".page").forEach(p=>p.classList.remove("active")); q("#page-"+b.dataset.page).classList.add("active"); if(b.dataset.page==='dash') renderCal(); if(b.dataset.page==='events') renderEventList(); if(b.dataset.page==='roster') renderRoster(); if(b.dataset.page==='tracker') renderMatches(); if(b.dataset.page==='config') renderConfig();});

// --- Dashboard calendar ---
let view=new Date(); view.setDate(1);
function buildCells(y,m){const first=new Date(y,m,1),start=(first.getDay()+6)%7,days=new Date(y,m+1,0).getDate();const cells=[];for(let i=0;i<start;i++)cells.push(null);for(let d=1;d<=days;d++)cells.push(new Date(y,m,d));while(cells.length%7)cells.push(null);return cells;}
function renderCal(){
  q("#mlabel").textContent=fmtMonth(view);
  const FT=q("#fType").value, TM=q("#fTeam").value;
  const grid=q("#grid"); grid.innerHTML="";
  buildCells(view.getFullYear(),view.getMonth()).forEach(dd=>{
    const c=document.createElement("div"); c.className="cell";
    if(dd){
      c.innerHTML=`<div class="day">${dd.getDate()}</div>`;
      S.events.filter(e=>{const d=new Date(e.datetime);return d.getFullYear()==dd.getFullYear()&&d.getMonth()==dd.getMonth()&&d.getDate()==dd.getDate();})
        .filter(e=>(FT=="Todos"||e.type==FT)&&(TM=="Todos"||(e.team||"Golden Moms")==TM))
        .forEach(e=>{
          const t=document.createElement("div"); t.className="tag "+(e.type=="Partido"?"match":"train"); t.textContent=e.type; c.appendChild(t);
          const r=document.createElement("div"); r.className="event"; const d=new Date(e.datetime);
          r.innerHTML=`<strong>${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}</strong> ${e.title} <span class="team">${e.team||"Golden Moms"}</span>`;
          r.onclick=()=>openEvent(e.id); c.appendChild(r);
        });
    }
    grid.appendChild(c);
  });
  // KPIs
  q("#kUp").textContent=S.events.filter(e=>new Date(e.datetime)>=new Date()).length;
  q("#kPlayers").textContent=S.players.length;
  q("#kCap").textContent=S.players.filter(p=>p.role=="Capitana").length;
  q("#kMatches").textContent=S.matches.length;
}
q("#prev").onclick=()=>{view.setMonth(view.getMonth()-1);renderCal();}
q("#next").onclick=()=>{view.setMonth(view.getMonth()+1);renderCal();}
q("#fType").onchange=renderCal; q("#fTeam").onchange=renderCal;
q("#btnNew").onclick=()=>newEvent(); q("#btnNew2").onclick=()=>newEvent();

// --- Event modal with tabs & roles ---
let cur=null;
function lockBody(){document.body.style.overflow='hidden';}
function unlockBody(){document.body.style.overflow='';}
function openEvent(id){cur=id; renderEventModal(); q("#ov").style.display="flex"; lockBody();}
q("#closeEv").onclick=()=>{q("#ov").style.display="none"; unlockBody();}
q("#ov").addEventListener("click",(e)=>{ if(e.target.id==="ov"){ q("#ov").style.display="none"; unlockBody(); } });
qa(".tab2").forEach(b=>b.onclick=()=>{qa(".tab2").forEach(x=>x.classList.remove("active")); qa("#pane-att,#pane-det,#pane-conv").forEach(p=>p.style.display="none"); b.classList.add("active"); q("#pane-"+b.dataset.pane).style.display="block";});

function renderEventModal(){
  const E=S.events.find(e=>e.id==cur); if(!E) return;
  q("#evTitle").textContent=`${E.type} — ${E.title}`;
  const hideNo=q("#hideNo").checked;
  const A=S.att[E.id]||{};
  const counts={ok:0,mid:0,no:0,blank:0};
  const list=document.createElement("div"); list.style.display="grid"; list.style.gridTemplateColumns="repeat(auto-fill,minmax(260px,1fr))"; list.style.gap="8px";
  S.players.forEach(p=>{
    const v=A[p.name]||"";
    if(v=="Asiste") counts.ok++; else if(v=="Duda") counts.mid++; else if(v=="No asiste") counts.no++; else counts.blank++;
    if(hideNo && v=="No asiste") return; // ocultar de la vista
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<div class="row" style="justify-content:space-between"><div><strong>${p.name}</strong> <span class="small">(${p.nick||'—'})</span><br><span class="small">#${p.number} ${chipsTeams(p.teams)}</span></div><div class="small">${p.role}</div></div>
    <div class="row"><button class="btn s">✅</button><button class="btn s">❔</button><button class="btn s">❌</button></div>`;
    const [b1,b2,b3]=card.querySelectorAll("button");
    function set(val){const AA=S.att[E.id]||{}; AA[p.name]=val; S.att[E.id]=AA; save(); renderEventModal();}
    b1.onclick=()=>set("Asiste"); b2.onclick=()=>set("Duda"); b3.onclick=()=>set("No asiste");
    if(v=="Asiste") b1.style.background="#d9f99d"; if(v=="Duda") b2.style.background="#fef9c3"; if(v=="No asiste") b3.style.background="#fee2e2";
    list.appendChild(card);
  });
  q("#attGrid").innerHTML=""; q("#attGrid").appendChild(list);
  q("#attCounts").innerHTML=`<span class="chip">✅ ${counts.ok}</span><span class="chip">❔ ${counts.mid}</span><span class="chip">❌ ${counts.no}</span><span class="chip">▫️ ${counts.blank}</span>`;
  q("#hideNo").onchange=()=>renderEventModal();

  // detalles (capitana only)
  ["eType","eTitle","eDT","eLoc","eOpp","eUni","eTeam"].forEach(id=>q("#"+id).disabled=(S.currentRole!=="Capitana"));
  q("#eType").value=E.type; q("#eTitle").value=E.title; q("#eDT").value=toInput(E.datetime); q("#eLoc").value=E.location||""; q("#eOpp").value=E.opponent||""; q("#eUni").value=E.uniform||""; q("#eTeam").value=E.team||"Golden Moms";
  q("#btnDel").style.display=(S.currentRole==="Capitana")?"inline-block":"none";
  ["eType","eTitle","eLoc","eOpp","eUni","eTeam"].forEach(id=>q("#"+id).onchange=()=>{ if(S.currentRole!=="Capitana") return; E[id.slice(1).toLowerCase()]=q("#"+id).value; save(); renderCal(); renderEventList();});
  q("#eDT").onchange=()=>{ if(S.currentRole!=="Capitana") return; E.datetime=fromInput(q("#eDT").value); save(); renderCal(); renderEventList();};
  q("#btnDel").onclick=()=>{ if(!confirm("Eliminar evento?")) return; S.events=S.events.filter(x=>x.id!==E.id); delete S.att[E.id]; save(); q("#ov").style.display="none"; unlockBody(); renderCal(); renderEventList();};

  // convocatoria
  const selTeams = [];
  if(q("#cvMoms").checked) selTeams.push("Moms");
  if(q("#cvDreams").checked) selTeams.push("Dreams");
  if(q("#cvPower").checked) selTeams.push("Power");
  const convocadas=S.players.filter(p=>p.teams.some(t=>selTeams.includes(t)));
  const when=new Date(E.datetime).toLocaleString('es-CL',{weekday:'long',day:'2-digit',month:'long',hour:'2-digit',minute:'2-digit'});
  q("#convInfo").textContent = `Convocatoria a ${convocadas.length} jugadoras (${selTeams.join(", ")}) — ${when} ${E.location? " · "+E.location:""}`;
  q("#btnCopyWA").onclick=()=>{
    const L=[`*${E.type}: ${E.title}* (${E.team||'Golden Moms'})`,`${when} — ${E.location||''}`,`Uniforme: ${E.uniform||'—'} · Calcetines: verde lima`,"","*Convocadas*"];
    convocadas.forEach(p=>L.push("▫️ "+p.name+(p.nick? " (“"+p.nick+"”)": "")));
    navigator.clipboard.writeText(L.join("\n")); alert("Resumen copiado");
  };
  q("#btnRSVP").onclick=()=>{
    const url=location.origin+location.pathname+'#rsvp='+encodeURIComponent(JSON.stringify({id:E.id,t:S.team}));
    navigator.clipboard.writeText(url); alert("Link copiado (nota: en Pages el estado es local por navegador)");
  };
  q("#btnICS").onclick=()=>{
    const st=new Date(E.datetime), mins=(E.type=="Partido"?120:90), en=new Date(st.getTime()+mins*60000);
    const icsDate=(d)=>new Date(d).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z");
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//GM//Org//ES','CALSCALE:GREGORIAN','BEGIN:VEVENT',
      'UID:'+E.id+'@gm','DTSTAMP:'+icsDate(new Date()),'DTSTART:'+icsDate(st),'DTEND:'+icsDate(en),
      'SUMMARY:'+E.title+' ('+(E.team||'Golden Moms')+')','LOCATION:'+(E.location||'').replace(/,/g,'\\,'),
      'DESCRIPTION:Uniforme '+(E.uniform||'—')+' | Calcetines: verde lima','END:VEVENT','END:VCALENDAR'].join('\r\n');
    const u=URL.createObjectURL(new Blob([lines],{type:"text/calendar"})); const a=document.createElement("a"); a.href=u; a.download=(E.title||"evento")+".ics"; a.click(); URL.revokeObjectURL(u);
  };
}

// Event list page
function renderEventList(){
  const box=q("#elist"); box.innerHTML="";
  [...S.events].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)).forEach(E=>{
    const when=new Date(E.datetime).toLocaleString('es-CL',{weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
    const div=document.createElement("div"); div.className="card";
    div.innerHTML=`<div class="row" style="justify-content:space-between"><div><span class="badge">${E.type}</span> <strong>${E.title}</strong> <span class="badge">${E.team}</span><br><span class="small">${when} · ${E.location||''}</span></div><div class="row"><button class="btn s">Abrir</button></div></div>`;
    div.querySelector("button").onclick=()=>openEvent(E.id);
    box.appendChild(div);
  });
}

// New event
function newEvent(){
  const id=crypto.randomUUID?.()||(""+Math.random()).slice(2);
  const now=new Date(); now.setMinutes(0,0,0);
  const E={id,type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString(),location:"",opponent:"",uniform:""};
  S.events.push(E); save(); renderCal(); renderEventList(); openEvent(id);
}

// --- Roster page ---
function chips(arr){return arr.map(t=>`<span class="badge">${t}</span>`).join("")}
function renderRoster(){
  const box=q("#players"); box.innerHTML="";
  const tf=q("#fltTeam").value, rf=q("#fltRole").value;
  S.players.filter(p=>(tf=="Todos"||p.teams.includes(tf.replace("Golden ","")))&&(rf=="Todos"||p.role==rf))
    .sort((a,b)=>a.name.localeCompare(b.name))
    .forEach(p=>{
      const d=document.createElement("div"); d.className="player";
      d.innerHTML=`<h4>${p.name} <span class="small">(${p.nick||"—"})</span></h4>
      <div class="small">#${p.number} · ${p.birth||"—"} · Rol: ${p.role}</div>
      <div>${chipsTeams(p.teams)}</div>
      <div class="row" style="margin-top:6px"><button class="btn s">Editar</button></div>`;
      d.querySelector("button").onclick=()=>openPlayer(p.id);
      box.appendChild(d);
    });
}
q("#fltTeam").onchange=renderRoster; q("#fltRole").onchange=renderRoster;
q("#btnAddPlayer").onclick=()=>openPlayer(null);

let curP=null;
function openPlayer(id){
  curP=id;
  const p=id? S.players.find(x=>x.id==id) : {id:null,name:"",nick:"",number:"",birth:"",teams:["Moms"],role:"Jugadora"};
  q("#pTitle").textContent=id? "Editar jugadora":"Nueva jugadora";
  q("#pName").value=p.name||""; q("#pNick").value=p.nick||""; q("#pNum").value=p.number||""; q("#pBirth").value=p.birth||""; q("#pRole").value=p.role||"Jugadora";
  q("#tMoms").checked=p.teams.includes("Moms"); q("#tDreams").checked=p.teams.includes("Dreams"); q("#tPower").checked=p.teams.includes("Power");
  q("#pDelete").style.display=id? "inline-block":"none";
  q("#ovP").style.display="flex"; lockBody();
}
q("#closeP").onclick=()=>{q("#ovP").style.display="none"; unlockBody();}
q("#pDelete").onclick=()=>{ if(!confirm("¿Eliminar jugadora?")) return; S.players=S.players.filter(x=>x.id!==curP); save(); q("#ovP").style.display="none"; unlockBody(); renderRoster();};
q("#pSave").onclick=()=>{
  const getTeams=()=>{const arr=[]; if(q("#tMoms").checked)arr.push("Moms"); if(q("#tDreams").checked)arr.push("Dreams"); if(q("#tPower").checked)arr.push("Power"); return arr;}
  if(curP){ const p=S.players.find(x=>x.id==curP); p.name=q("#pName").value.trim(); p.nick=q("#pNick").value.trim(); p.number=q("#pNum").value; p.birth=q("#pBirth").value; p.role=q("#pRole").value; p.teams=getTeams(); }
  else{ const p={id:crypto.randomUUID?.()||(""+Math.random()).slice(2),name:q("#pName").value.trim(),nick:q("#pNick").value.trim(),number:q("#pNum").value,birth:q("#pBirth").value,role:q("#pRole").value,teams:getTeams()}; S.players.push(p); }
  save(); q("#ovP").style.display="none"; unlockBody(); renderRoster();
}

// --- Seguimiento de partidos ---
function renderMatches(){
  const box=q("#matches"); box.innerHTML="";
  if(!S.matches.length){ box.innerHTML='<div class="small">Aún sin resultados cargados.</div>'; }
  [...S.matches].sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(M=>{
    const res = M.our>M.their? "Victoria" : M.our<M.their? "Derrota" : "Empate";
    const d=document.createElement("div"); d.className="card";
    d.innerHTML=`<div class="row" style="justify-content:space-between">
      <div><strong>${new Date(M.date).toLocaleDateString('es-CL')} · ${M.opponent}</strong> <span class="badge">${res}</span><br><span class="small">${M.our} - ${M.their}</span><br><span class="small">${M.notes||''}</span></div>
      <div class="row"><button class="btn s">Editar</button><button class="btn d">Borrar</button></div>
    </div>`;
    const [eDel,eBor]=d.querySelectorAll("button"); eDel.onclick=()=>editMatch(M.id); eBor.onclick=()=>{if(confirm('¿Eliminar?')){S.matches=S.matches.filter(x=>x.id!==M.id); save(); renderMatches();}};
    box.appendChild(d);
  });
}
q("#btnAddMatch").onclick=()=>editMatch(null);
function editMatch(id){
  const M=id? S.matches.find(x=>x.id==id) : {id:null,date:new Date().toISOString().slice(0,10),opponent:"",our:0,their:0,notes:""};
  const html=`<div class="modal"><div class="row" style="justify-content:space-between"><strong>${id?'Editar':'Registrar'} partido</strong><button class="btn s" id="x">Cerrar</button></div>
    <div class="row"><div style="flex:1"><label>Fecha</label><input id="mDate" type="date" value="${M.date.slice(0,10)}"/></div>
    <div style="flex:1"><label>Rival</label><input id="mOpp" value="${M.opponent}"/></div>
    <div style="flex:1"><label>Nosotras</label><input id="mOur" type="number" value="${M.our}"/></div>
    <div style="flex:1"><label>Ellas</label><input id="mTheir" type="number" value="${M.their}"/></div></div>
    <div><label>Notas</label><textarea id="mNotes">${M.notes||''}</textarea></div>
    <div class="row" style="justify-content:space-between;margin-top:8px"><button class="btn s" id="mSave">Guardar</button><button class="btn d" id="mDel" ${id?'':'style="display:none"'}>Eliminar</button></div></div>`;
  const ov=document.createElement("div"); ov.className="overlay"; ov.style.display="flex"; ov.innerHTML=html; document.body.appendChild(ov); lockBody();
  ov.querySelector("#x").onclick=()=>{document.body.removeChild(ov); unlockBody();};
  ov.querySelector("#mSave").onclick=()=>{ if(id){ M.date=ov.querySelector('#mDate').value; M.opponent=ov.querySelector('#mOpp').value; M.our=+ov.querySelector('#mOur').value; M.their=+ov.querySelector('#mTheir').value; M.notes=ov.querySelector('#mNotes').value; } else { const N={id:crypto.randomUUID?.()||(""+Math.random()).slice(2),date:ov.querySelector('#mDate').value,opponent:ov.querySelector('#mOpp').value,our:+ov.querySelector('#mOur').value,their:+ov.querySelector('#mTheir').value,notes:ov.querySelector('#mNotes').value}; S.matches.push(N);} save(); document.body.removeChild(ov); unlockBody(); renderMatches(); };
  ov.querySelector("#mDel")?.addEventListener('click',()=>{ if(confirm('¿Eliminar?')){ S.matches=S.matches.filter(x=>x.id!==id); save(); document.body.removeChild(ov); unlockBody(); renderMatches(); } });
}

// --- Config page ---
function renderConfig(){ q("#currentRole").value=S.currentRole; q("#teamName").value=S.team; q("#accessCode").value=S.accessCode; }
q("#currentRole").onchange=()=>{ S.currentRole=q("#currentRole").value; save(); };
q("#teamName").onchange=()=>{ S.team=q("#teamName").value; save(); };
q("#accessCode").onchange=()=>{ S.accessCode=q("#accessCode").value.trim()||S.accessCode; save(); };

// --- Login gate ---
function checkAuth(){ if(S.auth && S.auth.ok) return true; q("#loginOv").style.display="flex"; q("#lgHint").textContent = "Pide a la capitana el código de acceso."; return false; }
q("#lgEnter").onclick=()=>{
  const code=q("#lgCode").value.trim(); const role=q("#lgRole").value; const name=q("#lgName").value.trim();
  if(code!==S.accessCode){ q("#lgHint").textContent="Código incorrecto"; return; }
  S.auth={ok:true,name,role}; S.currentRole=role; save(); q("#loginOv").style.display="none"; renderCal(); renderEventList(); renderRoster(); renderMatches(); renderConfig();
};

// RSVP inline (demo sin servidor)
function checkHash(){ const h=location.hash; if(h.startsWith("#rsvp=")){ try{ const p=JSON.parse(decodeURIComponent(h.slice(6))); showRSVP(p.id,p.t);}catch{} } }
function showRSVP(id,t){ const E=S.events.find(x=>x.id==id); if(!E){ alert("Evento no existe en este navegador (Pages sin servidor)."); return; }
  alert("Convocatoria: "+t+" — "+E.title+" ("+new Date(E.datetime).toLocaleString('es-CL')+")");
}

// Init
if(!checkAuth()){ /* login visible */ } else { renderCal(); renderEventList(); renderRoster(); renderMatches(); renderConfig(); }
q("#prev").onclick=()=>{view.setMonth(view.getMonth()-1);renderCal();}
q("#next").onclick=()=>{view.setMonth(view.getMonth()+1);renderCal();}
</script>
</body>
</html>
