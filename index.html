<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Golden Moms ‚Äî Panel</title>
<link rel="icon" href="Logo.webp">
<style>
:root{
  --blue:#0f3a78;--lime:#9BE22D;--ink:#0f172a;--mut:#64748b;--bg:#f6f8fb;--b:#e5e7eb;
  --ok:#16a34a;--mid:#d97706;--no:#ef4444;
}
*{box-sizing:border-box} html,body{margin:0;height:100%;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}
a{color:inherit;text-decoration:none}
button{cursor:pointer}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--b);border-radius:10px;background:#fff}
.container{max-width:1100px;margin:0 auto;padding:10px 12px}
.top{position:sticky;top:0;z-index:3;background:#fff;border-bottom:1px solid var(--b)}
.nav{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 12px}
.brand{display:flex;align-items:center;gap:10px}
.brand img{width:34px;height:34px;border-radius:50%;border:2px solid var(--blue)}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{border:1px solid var(--b);background:#fff;border-radius:999px;padding:8px 12px}
.tab.active{background:var(--blue);color:#fff}
.right{display:flex;gap:8px;align-items:center}
.badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--b);background:#fff}
.btn{border:1px solid var(--b);background:#fff;border-radius:10px;padding:8px 12px}
.btn.p{background:var(--lime);border-color:#a3e635;font-weight:800;color:#08244a}
.btn.d{background:#fee2e2;border-color:#fecaca}
.btn.s{background:#f8fafc}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 20px #00000010;padding:12px;margin:10px 0}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.kpi{padding:14px}
.kpi h4{margin:0 0 8px 0;color:#475569;font-size:14px}
.kpi .n{font-weight:800;font-size:24px}
.grid7{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cell{background:#fff;border:1px solid var(--b);min-height:110px;border-radius:12px;padding:6px;position:relative}
.day{position:absolute;right:8px;top:6px;font-size:11px;color:#94a3b8}
.event{margin:4px 0;padding:6px;border:1px solid #cbd5e1;border-radius:10px;background:#f8fafc;font-size:13px}
.event .t{font-weight:800;color:var(--blue)}
.pill{display:inline-block;padding:2px 8px;border:1px solid #cbd5e1;border-radius:999px;font-size:11px;background:#fff}
.pill.match{background:#e0edff;border-color:#b7d1ff}
.pill.train{background:#e9fbd0;border-color:#c6f28a}
.pill.team{background:#eaf7d7;border-color:#c6f28a}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.split{display:flex;gap:12px;flex-wrap:wrap}
.split>*{flex:1 1 260px}
.attRow{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--b);border-radius:10px;padding:8px;margin:6px 0;background:#fff}
.attRow .who{display:flex;gap:8px;align-items:center}
.chip{padding:6px 10px;border-radius:999px;border:1px solid var(--b);background:#f8fafc;font-weight:700;font-size:12px}
.chip.ok{background:#dcfce7;border-color:#bbf7d0}
.chip.mid{background:#fef9c3;border-color:#fde68a}
.chip.no{background:#fee2e2;border-color:#fecaca}
.modalWrap{position:fixed;inset:0;display:none;place-items:center;background:#0008;z-index:50;padding:10px}
.modal{width:min(900px,96vw);max-height:92vh;overflow:auto;background:#fff;border-radius:14px;border:1px solid var(--b);padding:12px}
.hint{font-size:12px;color:#64748b}
table.simple{width:100%;border-collapse:collapse}
table.simple td,table.simple th{border-bottom:1px solid var(--b);padding:6px;text-align:left}
.tag{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;font-size:11px}
.tag.bday{background:#ffeccc;border-color:#ffddb0}
.selectTags label{display:inline-flex;align-items:center;gap:6px;margin-right:10px}
footer{padding:30px 0 60px;color:#94a3b8;text-align:center}
@media (max-width: 860px){
  .grid{grid-template-columns:repeat(6,1fr)}
  .grid7{grid-template-columns:repeat(7,1fr)}
}
@media (max-width: 640px){
  .grid{grid-template-columns:repeat(2,1fr)}
  .grid7{grid-template-columns:repeat(7,1fr)}
  .cell{min-height:90px}
  .tabs{overflow:auto;white-space:nowrap}
}
</style>
</head>
<body>
<header class="top">
  <div class="nav container">
    <div class="brand">
      <img src="Logo.webp" alt="logo">
      <strong>Golden <span style="color:var(--lime)">Moms</span></strong>
    </div>
    <div class="tabs">
      <button class="tab active" data-view="dash">Dashboard</button>
      <button class="tab" data-view="events">Eventos</button>
      <button class="tab" data-view="roster">Plantel</button>
      <button class="tab" data-view="track">Seguimiento</button>
      <button class="tab" data-view="admin">Configuraci√≥n</button>
    </div>
    <div class="right">
      <span id="who" class="badge">Invitada</span>
      <button id="btnLogin" class="btn s">Entrar</button>
      <button id="btnLogout" class="btn s" style="display:none">Salir</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- DASHBOARD -->
  <section id="view-dash">
    <div class="grid">
      <div class="card kpi" style="grid-column:span 3"><h4>Pr√≥ximos eventos</h4><div class="n" id="kUpcoming">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h4>Plantel</h4><div class="n" id="kRoster">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h4>Convocadas (pr√≥x.)</h4><div class="n" id="kOk">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h4>Partidos jugados</h4><div class="n" id="kPlayed">0</div></div>
    </div>

    <div class="split">
      <div class="card" style="flex:2">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button class="btn s" id="mPrevCal">‚Üê</button>
            <div id="mLabel" style="min-width:180px;text-align:center;font-weight:800;color:var(--blue)"></div>
            <button class="btn s" id="mNextCal">‚Üí</button>
          </div>
          <div class="row">
            <select id="fEventType"><option value="Todos">Tipo: Todos</option><option>Entrenamiento</option><option>Partido</option></select>
            <select id="fTeam"><option value="Todos">Equipo: Todos</option><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select>
            <button id="btnCopyWeek" class="btn s">Copiar Semana</button>
            <button id="btnNewEvent" class="btn p">Nuevo Evento</button>
          </div>
        </div>
        <div class="grid7" style="margin-top:6px"><div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div></div>
        <div id="grid" class="grid7"></div>
      </div>

      <div class="card" style="flex:1">
        <div class="row" style="justify-content:space-between"><strong>Pr√≥ximos cumplea√±os</strong><span class="hint">üéÇ se muestran con etiqueta</span></div>
        <div id="bdayList"></div>
        <hr>
        <div class="row" style="justify-content:space-between"><strong>Goleadoras</strong><span class="hint">Top 5</span></div>
        <table class="simple" id="scorerTable"><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- ROSTER -->
  <section id="view-roster" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h3>Plantel</h3>
      <div class="row">
        <button id="btnAddPlayer" class="btn p" style="display:none">Agregar jugadora</button>
      </div>
    </div>
    <div id="rosterList" class="card"></div>
  </section>

  <!-- EVENTS (same calendar as dashboard, kept for consistency) -->
  <section id="view-events" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button class="btn s" id="ePrevCal">‚Üê</button>
          <div id="eLabel" style="min-width:180px;text-align:center;font-weight:800;color:var(--blue)"></div>
          <button class="btn s" id="eNextCal">‚Üí</button>
        </div>
        <div class="row">
          <select id="efEventType"><option value="Todos">Tipo de evento: Todos</option><option>Entrenamiento</option><option>Partido</option></select>
          <select id="efTeam"><option value="Todos">Equipo: Todos</option><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select>
          <button id="btnCopyWeek2" class="btn s">Copiar Semana</button>
          <button id="btnNewEvent2" class="btn p">Nuevo Evento</button>
        </div>
      </div>
      <div class="grid7" style="margin-top:6px"><div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div></div>
      <div id="grid2" class="grid7"></div>
    </div>
  </section>

  <!-- TRACK -->
  <section id="view-track" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h3>Seguimiento de Partidos</h3>
      <button id="btnAddResult" class="btn p" style="display:none">Registrar resultado</button>
    </div>
    <div id="trackList" class="card"></div>
  </section>

  <!-- ADMIN -->
  <section id="view-admin" style="display:none">
    <div class="card">
      <h3>Configuraci√≥n</h3>
      <p class="hint">Visible s√≥lo para <strong>admin</strong>. Aqu√≠ puedes exportar/respaldar o limpiar datos locales.</p>
      <div class="row">
        <button id="btnExport" class="btn s">Exportar JSON</button>
        <button id="btnImport" class="btn s">Importar JSON</button>
        <button id="btnReset" class="btn d">Borrar todo (local)</button>
      </div>
      <input type="file" id="fileImport" accept="application/json" style="display:none">
    </div>
  </section>
</main>

<footer>Golden Moms ¬∑ hecho con üíö lima & azul</footer>

<!-- MODALS -->
<div id="loginWrap" class="modalWrap"><div class="modal">
  <div class="row" style="justify-content:space-between"><h3>Entrar</h3><button class="btn s" data-close="loginWrap">Cerrar</button></div>
  <div class="row"><select id="loginName"></select></div>
  <div class="row"><input id="loginCode" placeholder="C√≥digo de acceso"></div>
  <div class="hint">S√≥lo se ve el nombre. El rol se toma del plantel. (Admin puede cambiar roles y etiquetas en Plantel.)</div>
  <div class="row" style="justify-content:flex-end"><button class="btn p" id="doLogin">Entrar</button></div>
</div></div>

<div id="playerWrap" class="modalWrap"><div class="modal" style="max-width:720px">
  <div class="row" style="justify-content:space-between"><h3 id="playerTitle">Editar jugadora</h3><button class="btn s" data-close="playerWrap">Cerrar</button></div>
  <div class="split">
    <div><label>Nombre</label><input id="pName"></div>
    <div><label>N√∫mero</label><input id="pNumber" type="number" min="0"></div>
  </div>
  <div class="split">
    <div><label>Apodo</label><input id="pNick"></div>
    <div><label>Cumplea√±os</label><input id="pBday" type="date"></div>
  </div>
  <div class="card selectTags">
    <label><input type="checkbox" class="pTeam" value="Golden Moms"> Golden Moms</label>
    <label><input type="checkbox" class="pTeam" value="Golden Dreams"> Golden Dreams</label>
    <label><input type="checkbox" class="pTeam" value="Golden Power"> Golden Power</label>
    <div class="row"><label>Rol</label>
      <select id="pRole">
        <option value="jugadora">Jugadora</option>
        <option value="capitana">Capitana</option>
        <option value="admin">Admin</option>
      </select>
    </div>
    <div class="hint">Puedes marcar m√°s de un equipo.</div>
  </div>
  <div class="row" style="justify-content:flex-end"><button class="btn p" id="pSave">Guardar</button></div>
</div></div>

<div id="eventWrap" class="modalWrap"><div class="modal">
  <div class="row" style="justify-content:space-between"><h3 id="evTitle">Evento</h3><button class="btn s" data-close="eventWrap">Cerrar</button></div>

  <div id="evTabs" class="tabs" style="margin-bottom:10px">
    <button class="tab active" data-evtab="att">Asistencia</button>
    <button class="tab" data-evtab="det">Detalles</button>
    <button class="tab" data-evtab="conv">Convocatoria</button>
  </div>

  <!-- Asistencia -->
  <div id="evTab-att">
    <div class="row" id="attHeader" style="justify-content:space-between"></div>
    <div id="attCounts" class="row" style="margin:8px 0"></div>
    <div id="attList"></div>
    <div id="attOnlyMine" class="hint" style="display:none">Ves s√≥lo tu confirmaci√≥n. Las listas completas est√°n disponibles para capitanas y admin.</div>
  </div>

  <!-- Detalles -->
  <div id="evTab-det" style="display:none">
    <div class="split">
      <div><label>Tipo</label><select id="eType"><option>Entrenamiento</option><option>Partido</option></select></div>
      <div><label>T√≠tulo</label><input id="eTitle"></div>
    </div>
    <div class="split">
      <div><label>Fecha y hora</label><input id="eDT" type="datetime-local"></div>
      <div><label>Lugar</label><input id="eLoc"></div>
    </div>
    <div class="split">
      <div><label>Rival</label><input id="eOpp"></div>
      <div><label>Uniforme</label><select id="eUni"><option value="">‚Äî</option><option>Polera azul</option><option>Polera verde lima</option></select></div>
    </div>
    <div class="split">
      <div><label>Equipo</label><select id="eTeam"><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select></div>
      <div class="row" style="align-items:flex-end;justify-content:flex-end;gap:6px">
        <button id="btnICS" class="btn s">.ics</button>
        <button id="btnDelEvent" class="btn d">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- Convocatoria -->
  <div id="evTab-conv" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="row"><label>Filtrar por etiquetas: </label>
        <label class="tag"><input type="checkbox" class="cTeam" value="Golden Moms" checked> Moms</label>
        <label class="tag"><input type="checkbox" class="cTeam" value="Golden Dreams" checked> Dreams</label>
        <label class="tag"><input type="checkbox" class="cTeam" value="Golden Power" checked> Power</label>
      </div>
      <div class="row">
        <button id="btnCopyWA" class="btn s">Copiar WhatsApp</button>
        <button id="btnRSVP" class="btn s">Link convocatoria</button>
      </div>
    </div>
    <div class="hint" id="convHint"></div>
  </div>

</div></div>

<div id="resultWrap" class="modalWrap"><div class="modal">
  <div class="row" style="justify-content:space-between"><h3 id="resTitle">Resultado</h3><button class="btn s" data-close="resultWrap">Cerrar</button></div>
  <div class="split">
    <div><label>Fecha</label><input id="rDate" type="date"></div>
    <div><label>Competencia</label><input id="rComp" placeholder="Liga LIFA / Amistoso / ..."></div>
  </div>
  <div class="split">
    <div><label>Rival</label><input id="rOpp"></div>
    <div class="row">
      <div style="flex:1"><label>GM</label><input id="rUs" type="number" min="0"></div>
      <div style="flex:1"><label>Rival</label><input id="rThem" type="number" min="0"></div>
    </div>
  </div>
  <div class="card">
    <strong>Goleadoras</strong>
    <div class="hint">Clic para sumar/restar goles por jugadora</div>
    <div id="rScorers" class="row"></div>
  </div>
  <div class="row" style="justify-content:flex-end"><button id="rSave" class="btn p">Guardar</button></div>
</div></div>

<script>
/* ===================== STATE & SEED ===================== */
const KEY="gm-app-v3";
let S={
  team:"Golden Moms",
  usersCode:"moms2025",
  me:null, // {name, role}
  roster:[], // [{name,nick,number,bday,teams:[...],role}]
  events:[], // [{id,type,title,team,datetime,location,opponent,uniform}]
  att:{},   // id -> { player -> 'Asiste'|'Duda'|'No asiste' }
  results:[], // [{date,comp,opp,us,them,scorers:{name:count}}]
};
const save=()=>localStorage.setItem(KEY,JSON.stringify(S));
try{const x=JSON.parse(localStorage.getItem(KEY)||"{}"); if(x && typeof x==="object") S={...S,...x};}catch{}

/* Seed roster once */
if(!S.roster.length){
  const names=["Ale V","Andre","Antonella","Aurora","Carla","Caro G","Caro N","Cata","Celsa","Chica","Consu","Consu S","Cote","Dani C","Dani J","Fabi","Fran","Gaby","Isa","Jandi","Janga","Javiera A","Javi C","Jean","Maca","Male","Marce","Myle","Paz","Pia","Pili","Vale","Vero"];
  const bdays={
    "Javiera A":"2000-01-02","Dani J":"2000-01-11","Vero":"2000-01-29","Antonella":"2000-02-06",
    "Marce":"2000-03-14","Caro N":"2000-04-07","Chica":"2000-04-20","Jean":"2000-05-05",
    "Myle":"2000-06-03","Fran":"2000-06-21","Jandi":"2000-07-14","Caro G":"2000-07-24",
    "Janga":"2000-08-20","Fabi":"2000-08-28","Dani C":"2000-10-10","Vale":"2000-10-11",
    "Pia":"2000-10-21","Maca":"2000-10-25","Isa":"2000-10-26","Aurora":"2000-11-12","Ale V":"2000-11-12",
    "Cata":"2000-12-08","Male":"2000-12-10","Carla":"2000-12-13","Consu":"2000-12-23"
  };
  S.roster = names.map((n,i)=>({name:n,nick:n,number:i+11,bday:bdays[n]||"",teams:["Golden Moms"],role:"jugadora"}));
  // Por defecto: dos capitanas y un admin
  const tag=(nm,prop,val)=>{const p=S.roster.find(x=>x.name===nm); if(p) p[prop]=val};
  tag("Caro G","role","capitana"); tag("Chica","role","capitana");
  tag("Natalia","role","admin"); // si agregas a Natalia luego, podr√°s ponerla admin.
}
/* Seed events (12 semanas) si vac√≠o */
if(!S.events.length){
  function mk(y,m,d,h,mi){const t=new Date(y,m-1,d,h,mi);return new Date(t.getTime()-t.getTimezoneOffset()*60000).toISOString();}
  function nextDow(dow){const n=new Date(), g=(dow-n.getDay()+7)%7||7;const d=new Date(n);d.setDate(n.getDate()+g);return d;}
  const tue=nextDow(2), wed=nextDow(3), thu=nextDow(4), fri=nextDow(5);
  for(let i=0;i<12;i++){
    const T=new Date(tue);T.setDate(tue.getDate()+7*i);
    const Th=new Date(thu);Th.setDate(thu.getDate()+7*i);
    const W=new Date(wed);W.setDate(wed.getDate()+7*i);
    const F=new Date(fri);F.setDate(fri.getDate()+7*i);
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:mk(T.getFullYear(),T.getMonth()+1,T.getDate(),19,30),location:"Colegio",opponent:"",uniform:""});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:mk(Th.getFullYear(),Th.getMonth()+1,Th.getDate(),19,30),location:"Colegio",opponent:"",uniform:""});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Partido",title:"Wonder Mom‚Äôs Cup",team:"Golden Moms",datetime:mk(W.getFullYear(),W.getMonth()+1,W.getDate(),20,0),location:"Universidad de los Andes",opponent:"‚Äî",uniform:""});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Partido",title:"Liga LIFA",team:"Golden Moms",datetime:mk(F.getFullYear(),F.getMonth()+1,F.getDate(),20,0),location:"Cancha Oriente, Las Condes",opponent:"‚Äî",uniform:""});
  }
}
save();

/* ===================== UTIL ===================== */
const $=sel=>document.querySelector(sel);
const $$=sel=>document.querySelectorAll(sel);
const fmtMonth=d=>d.toLocaleDateString("es-CL",{month:"long",year:"numeric"});
const pad=n=>String(n).padStart(2,"0");
const toInput=iso=>{const d=new Date(iso);return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;}
const toHM=d=>`${pad(d.getHours())}:${pad(d.getMinutes())}`;
const role=()=>S.me?.role||null;
const canEdit=()=>role()==="admin"||role()==="capitana";
const isAdmin=()=>role()==="admin";

/* ===================== NAV ===================== */
$$('.tab').forEach(b=>b.onclick=()=>switchView(b.dataset.view));
function switchView(v){
  $$('.tab').forEach(b=>b.classList.toggle('active',b.dataset.view===v));
  ['dash','events','roster','track','admin'].forEach(id=>$("#view-"+id).style.display = (id===v?'block':'none'));
  renderAll();
}

/* ===================== LOGIN ===================== */
const loginWrap=$("#loginWrap");
$("#btnLogin").onclick=()=>{ fillLogin(); openModal('loginWrap'); };
$("#btnLogout").onclick=()=>{ S.me=null; save(); $("#btnLogout").style.display="none"; $("#btnLogin").style.display=""; $("#who").textContent="Invitada"; renderAll(); };
$("[data-close='loginWrap']").onclick=()=>closeModal('loginWrap');
function fillLogin(){
  const sel=$("#loginName"); sel.innerHTML=S.roster.sort((a,b)=>a.name.localeCompare(b.name)).map(p=>`<option>${p.name}</option>`).join('');
  $("#loginCode").value="";
}
$("#doLogin").onclick=()=>{
  const name=$("#loginName").value.trim();
  const code=$("#loginCode").value.trim();
  if(!name || code!==S.usersCode){ alert("C√≥digo incorrecto."); return; }
  const p=S.roster.find(x=>x.name===name); if(!p){ alert("Nombre no existe."); return; }
  S.me={name:p.name, role:p.role}; save(); $("#who").textContent=`${S.me.name} ‚Äî ${S.me.role}`; $("#btnLogin").style.display="none"; $("#btnLogout").style.display=""; closeModal('loginWrap'); renderAll();
};

/* ===================== RENDER DASH & CAL ===================== */
let cal1=new Date(); cal1.setDate(1);
let cal2=new Date(); cal2.setDate(1);
function buildCells(y,m){const first=new Date(y,m,1),start=(first.getDay()+6)%7,days=new Date(y,m+1,0).getDate();const cells=[];for(let i=0;i<start;i++)cells.push(null);for(let d=1;d<=days;d++)cells.push(new Date(y,m,d));while(cells.length%7)cells.push(null);return cells;}
function renderCalendar(target,label,view,ftype,fteam){
  label.textContent=fmtMonth(view);
  target.innerHTML="";
  const cells=buildCells(view.getFullYear(),view.getMonth());
  const E=[...S.events].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
  cells.forEach(dd=>{
    const c=document.createElement("div"); c.className="cell";
    if(dd){
      const n=document.createElement("div"); n.className="day"; n.textContent=dd.getDate(); c.appendChild(n);
      E.filter(e=>{const d=new Date(e.datetime);return d.getFullYear()==dd.getFullYear()&&d.getMonth()==dd.getMonth()&&d.getDate()==dd.getDate();})
       .filter(e=>(ftype.value==="Todos"||e.type===ftype.value)&&(fteam.value==="Todos"||e.team===fteam.value))
       .forEach(e=>{
         const d=new Date(e.datetime);
         const el=document.createElement("div"); el.className="event";
         el.innerHTML=`<div class="row"><span class="pill ${e.type==='Partido'?'match':'train'}">${e.type}</span><span class="pill team">${e.team}</span></div>
         <div class="t">${toHM(d)} ${e.title}</div>`;
         el.onclick=()=>openEvent(e.id);
         c.appendChild(el);
       });
    }
    target.appendChild(c);
  });
}
function nextMon(d){const day=(d.getDay()+6)%7; const diff=(7-day)%7; const nd=new Date(d); nd.setDate(d.getDate()+diff); nd.setHours(0,0,0,0); return nd;}
function copyWeek(){
  const st=nextMon(new Date()), en=new Date(st); en.setDate(st.getDate()+7);
  const L=[`*Semana* ${st.toLocaleDateString('es-CL')} - ${new Date(en.getTime()-86400000).toLocaleDateString('es-CL')}`,`Equipo: ${S.team}`,''];
  S.events.filter(e=>new Date(e.datetime)>=st && new Date(e.datetime)<en).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime))
   .forEach(E=>{
     const w=new Date(E.datetime).toLocaleString('es-CL',{weekday:'short',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
     L.push(`‚Ä¢ ${w} ‚Äî ${E.type}: ${E.title}${E.location?' ‚Äî '+E.location:''} (${E.team}) ${E.opponent?' ‚Äî Rival: '+E.opponent:''}${E.uniform?' ‚Äî Uniforme: '+E.uniform:''}`);
   });
  navigator.clipboard.writeText(L.join('\n')); alert("Semana copiada. Pega en WhatsApp.");
}

/* Dashboard KPIs & bdays & scorers */
function renderKPIs(){
  const up=[...S.events].filter(e=>new Date(e.datetime)>=new Date()).length;
  $("#kUpcoming").textContent=up;
  $("#kRoster").textContent=S.roster.length;
  // pr√≥ximas confirmadas del pr√≥ximo evento
  const next=[...S.events].filter(e=>new Date(e.datetime)>=new Date()).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime))[0];
  if(next){ const A=S.att[next.id]||{}; $("#kOk").textContent=Object.values(A).filter(v=>v==="Asiste").length; } else $("#kOk").textContent=0;
  $("#kPlayed").textContent=S.results.length;
}
function renderBdays(){
  const box=$("#bdayList"); box.innerHTML="";
  const now=new Date();
  const list=[...S.roster].map(p=>{
    if(!p.bday) return null;
    const d=new Date(p.bday); d.setFullYear(now.getFullYear());
    if(d<now){ d.setFullYear(now.getFullYear()+1); }
    return {p, when:d};
  }).filter(Boolean).sort((a,b)=>a.when-b.when).slice(0,10);
  list.forEach(({p,when})=>{
    const row=document.createElement("div"); row.className="row"; row.style.margin="6px 0";
    row.innerHTML=`<span class="tag bday">üéÇ ${p.name}</span><span class="hint">${when.toLocaleDateString('es-CL',{weekday:'short',day:'2-digit',month:'short'})}</span>`;
    box.appendChild(row);
  });
}
function renderScorers(){
  const T={}; S.results.forEach(r=>{ Object.entries(r.scorers||{}).forEach(([n,c])=>{ T[n]=(T[n]||0)+Number(c||0); }); });
  const top=Object.entries(T).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const tb=$("#scorerTable").querySelector("tbody"); tb.innerHTML=top.map(([n,c])=>`<tr><td>${n}</td><td><strong>${c}</strong></td></tr>`).join('') || `<tr><td colspan="2" class="hint">Sin goles a√∫n</td></tr>`;
}

/* ===================== ROSTER ===================== */
function renderRoster(){
  const me=S.me?.name;
  const box=$("#rosterList"); box.innerHTML="";
  const canAdd=isAdmin()||role()==="capitana"; $("#btnAddPlayer").style.display=canAdd?"":"none";
  const frag=document.createDocumentFragment();
  S.roster.sort((a,b)=>a.name.localeCompare(b.name)).forEach(p=>{
    const card=document.createElement("div"); card.className="attRow";
    const tags=(p.teams||[]).map(t=>`<span class="pill">${t}</span>`).join(' ');
    const bday=p.bday?`<span class="tag bday">üéÇ ${new Date(p.bday).toLocaleDateString('es-CL',{day:'2-digit',month:'short'})}</span>`:"";
    card.innerHTML=`<div class="who"><strong>${p.name}</strong> <span class="hint">#${p.number||''} ${p.nick? '¬∑ '+p.nick:''}</span> ${bday} ${tags}</div>
    <div class="row">
      ${(isAdmin()||role()==="capitana"||p.name===me)?'<button class="btn s">Editar</button>':''}
    </div>`;
    const btn=card.querySelector('button');
    if(btn) btn.onclick=()=>openPlayer(p.name);
    frag.appendChild(card);
  });
  box.appendChild(frag);
}
$("#btnAddPlayer").onclick=()=>{ openPlayer(null); };
function openPlayer(name){
  const meName=S.me?.name;
  const canAll=isAdmin()||role()==="capitana";
  const p=name? S.roster.find(x=>x.name===name) : {name:"",nick:"",number:"",bday:"",teams:["Golden Moms"],role:"jugadora"};
  // Jugadora s√≥lo puede editar su propio perfil y s√≥lo 3 campos
  const onlyMine = role()==="jugadora" && name && name!==meName;
  if(onlyMine){ alert("S√≥lo puedes editar tu propio perfil."); return; }
  $("#playerTitle").textContent = name?`Editar ${p.name}`: "Nueva jugadora";
  $("#pName").value=p.name||"";
  $("#pNumber").value=p.number||"";
  $("#pNick").value=p.nick||"";
  $("#pBday").value=p.bday||"";
  $$('.pTeam').forEach(c=>c.checked=(p.teams||[]).includes(c.value));
  $("#pRole").value=p.role||"jugadora";
  // Si rol jugadora y est√° editando su perfil: bloquear Rol y Teams (puede editar equipos? pediste que NO; s√≥lo apodo, cumple, n√∫mero)
  const lockSelf = role()==="jugadora";
  $("#pName").disabled=lockSelf && !!name; // no cambia nombre
  $("#pRole").disabled=lockSelf;
  $$('.pTeam').forEach(c=>c.disabled=lockSelf);
  openModal('playerWrap');
  $("#pSave").onclick=()=>{
    const nm=$("#pName").value.trim(); if(!nm){alert("Nombre requerido"); return;}
    const data={
      name:nm,
      number:$("#pNumber").value?Number($("#pNumber").value):"",
      nick:$("#pNick").value.trim(),
      bday:$("#pBday").value||"",
      teams:[...$$('.pTeam')].filter(c=>c.checked).map(c=>c.value),
      role:$("#pRole").value
    };
    if(lockSelf){ // restringir a 3 campos
      data.teams=p.teams; data.role=p.role; data.name=p.name;
    }
    if(name){ Object.assign(p,data); }
    else{ S.roster.push(data); }
    save(); closeModal('playerWrap'); renderRoster(); renderAll();
  };
}

/* ===================== EVENT EDITOR ===================== */
let curEv=null;
function openEvent(id){
  const E=S.events.find(x=>x.id===id);
  if(!E) return;
  curEv=E.id;
  $("#evTitle").textContent=`${E.type} ‚Äî ${E.title}`;
  // tabs
  $$('#evTabs .tab').forEach(b=>b.classList.remove('active'));
  $$('#evTabs .tab')[0].classList.add('active');
  $("#evTab-att").style.display="block"; $("#evTab-det").style.display="none"; $("#evTab-conv").style.display="none";
  // asistencia header & counts
  renderAtt();
  // detalles (s√≥lo cap/admin)
  $("#eType").value=E.type; $("#eTitle").value=E.title||""; $("#eDT").value=toInput(E.datetime);
  $("#eLoc").value=E.location||""; $("#eOpp").value=E.opponent||""; $("#eUni").value=E.uniform||""; $("#eTeam").value=E.team||"Golden Moms";
  const editable=canEdit();
  $$("#evTab-det input, #evTab-det select, #btnDelEvent, #btnICS").forEach(el=>el.disabled=!editable);
  // convocatoria
  $("#convHint").textContent=`Convocatoria a ${E.team}. Usa los filtros de etiquetas para acotar.`;
  openModal('eventWrap');
}
$$("#evTabs .tab").forEach(b=>b.onclick=()=>{
  $$("#evTabs .tab").forEach(x=>x.classList.remove('active')); b.classList.add('active');
  $("#evTab-att").style.display = (b.dataset.evtab==='att')?'block':'none';
  $("#evTab-det").style.display = (b.dataset.evtab==='det')?'block':'none';
  $("#evTab-conv").style.display = (b.dataset.evtab==='conv')?'block':'none';
});

function renderAtt(){
  const E=S.events.find(x=>x.id===curEv); if(!E) return;
  const A=S.att[E.id]||{};
  const header=$("#attHeader");
  header.innerHTML=`<div class="row"><span class="pill ${E.type==='Partido'?'match':'train'}">${E.type}</span><span class="pill team">${E.team}</span></div>
  <div class="row"><strong>${new Date(E.datetime).toLocaleString('es-CL',{weekday:'long',day:'2-digit',month:'long',hour:'2-digit',minute:'2-digit'})}</strong> ${E.location? '¬∑ '+E.location:''}</div>`;
  const counts={ok:0,mid:0,no:0};
  Object.values(A).forEach(v=>{ if(v==='Asiste') counts.ok++; else if(v==='Duda') counts.mid++; else if(v==='No asiste') counts.no++; });
  $("#attCounts").innerHTML=`<span class="chip ok">‚úÖ ${counts.ok}</span><span class="chip mid">‚ùî ${counts.mid}</span><span class="chip no">‚ùå ${counts.no}</span> <span class="chip">‚ñ´Ô∏è ${S.roster.length - Object.keys(A).length}</span>`;
  const list=$("#attList"); list.innerHTML="";
  const myName=S.me?.name;
  // Filtra por etiquetas del evento
  const eligible=S.roster.filter(p=>!E.team || (p.teams||[]).includes(E.team));
  const renderRow=(p)=>{
    const row=document.createElement("div"); row.className="attRow";
    const bday=p.bday?`<span class="tag bday">üéÇ ${new Date(p.bday).toLocaleDateString('es-CL',{day:'2-digit',month:'short'})}</span>`:"";
    row.innerHTML=`<div class="who"><strong>${p.name}</strong> ${bday} <span class="hint">${(p.teams||[]).join(', ')}</span></div>
      <div class="row">
        <button class="btn s" data-v="Asiste">‚úÖ</button>
        <button class="btn s" data-v="Duda">‚ùî</button>
        <button class="btn s" data-v="No asiste">‚ùå</button>
      </div>`;
    const set=(val)=>{ const AA=S.att[E.id]||{}; AA[p.name]=val; S.att[E.id]=AA; save(); renderAtt(); };
    row.querySelectorAll('button').forEach(b=>b.onclick=()=>set(b.dataset.v));
    // pintar selecci√≥n
    const v=A[p.name]; if(v){ const map={'Asiste':0,'Duda':1,'No asiste':2}; row.querySelectorAll('button')[map[v]].style.background = v==='Asiste'?'#dcfce7':v==='Duda'?'#fef9c3':'#fee2e2'; }
    list.appendChild(row);
  };
  if(role()==="jugadora"){ // s√≥lo yo
    $("#attOnlyMine").style.display="block";
    const me=eligible.find(x=>x.name===myName)||S.roster.find(x=>x.name===myName);
    if(me) renderRow(me);
    else list.innerHTML=`<div class="hint">No est√°s en el equipo ${E.team} para este evento.</div>`;
  }else{
    $("#attOnlyMine").style.display="none";
    eligible.forEach(renderRow);
  }
}

/* Detalles handlers */
$("#eType").onchange=$("#eTitle").oninput=$("#eLoc").oninput=$("#eOpp").oninput=$("#eUni").onchange=$("#eTeam").onchange=()=>{
  if(!canEdit()) return;
  const E=S.events.find(x=>x.id===curEv); if(!E) return;
  E.type=$("#eType").value; E.title=$("#eTitle").value; E.location=$("#eLoc").value; E.opponent=$("#eOpp").value; E.uniform=$("#eUni").value; E.team=$("#eTeam").value;
  save(); renderAll(); renderAtt();
};
$("#eDT").onchange=()=>{ if(!canEdit()) return; const E=S.events.find(x=>x.id===curEv); if(!E) return; const d=new Date($("#eDT").value); E.datetime=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString(); save(); renderAll(); renderAtt(); };
$("#btnDelEvent").onclick=()=>{ if(!canEdit()) return; if(!confirm("Eliminar evento?")) return; const i=S.events.findIndex(x=>x.id===curEv); if(i>=0){ S.events.splice(i,1); delete S.att[curEv]; save(); closeModal('eventWrap'); renderAll(); } };
$("#btnICS").onclick=()=>{ const E=S.events.find(x=>x.id===curEv); if(!E) return;
  const st=new Date(E.datetime), mins=(E.type==="Partido"?120:90), en=new Date(st.getTime()+mins*60000);
  const alarm=(offsetM)=>['BEGIN:VALARM',`TRIGGER:-PT${offsetM}M`,'ACTION:DISPLAY','DESCRIPTION:Recordatorio del evento','END:VALARM'].join('\r\n');
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','CALSCALE:GREGORIAN','BEGIN:VEVENT',`UID:${E.id}@gm`,`DTSTAMP:${st.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z")}`,`DTSTART:${st.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z")}`,`DTEND:${en.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z")}`,`SUMMARY:${E.title} (${E.team})`,`LOCATION:${(E.location||'').replace(/,/g,'\\,')}`,`DESCRIPTION:Uniforme ${E.uniform||'‚Äî'} ¬∑ Calcetines: verde lima`,alarm(60*24),alarm(60),'END:VEVENT','END:VCALENDAR'].join('\r\n');
  const u=URL.createObjectURL(new Blob([lines],{type:"text/calendar"})); const a=document.createElement("a"); a.href=u; a.download=(E.title||"evento")+".ics"; a.click(); URL.revokeObjectURL(u);
};

/* Convocatoria */
$("#btnCopyWA").onclick=()=>{ const E=S.events.find(x=>x.id===curEv); if(!E) return;
  const A=S.att[E.id]||{}; const when=new Date(E.datetime).toLocaleString('es-CL',{weekday:'long',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
  const url=buildRSVPURL(E);
  const text = `*${E.type}: ${E.title}* (${E.team})%0A${when} ‚Äî ${E.location||''}%0AUniforme: ${E.uniform||'‚Äî'} ¬∑ Calcetines: verde lima%0A%0AConfirma aqu√≠: ${url}%0A‚úÖ Asiste  ‚ùî Duda  ‚ùå No asiste`;
  navigator.clipboard.writeText(decodeURIComponent(text)); alert("Mensaje de WhatsApp copiado.");
};
function buildRSVPURL(E){ const payload=encodeURIComponent(JSON.stringify({id:E.id,t:S.team})); return location.origin+location.pathname+'#rsvp='+payload; }
$("#btnRSVP").onclick=()=>{ const E=S.events.find(x=>x.id===curEv); if(!E) return; const url=buildRSVPURL(E); navigator.clipboard.writeText(url); alert("Link copiado (estado es local por navegador)."); };
$$('.cTeam').forEach(c=>c.onchange=()=>{ /* UI only */ });

/* ===================== NEW EVENT ===================== */
function newEvent(){
  const now=new Date(); now.setMinutes(0,0,0);
  const e={id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString(),location:"",opponent:"",uniform:""};
  S.events.push(e); save(); openEvent(e.id); renderAll();
}
$("#btnNewEvent").onclick=$("#btnNewEvent2").onclick=newEvent;

/* ===================== TRACKING ===================== */
function renderTrack(){
  const box=$("#trackList"); box.innerHTML="";
  if(!S.results.length){ box.innerHTML='<div class="hint">A√∫n no hay resultados registrados.</div>'; return; }
  S.results.slice().reverse().forEach(r=>{
    const row=document.createElement("div"); row.className="attRow";
    const tag = r.us>r.them?'‚úÖ Victoria': (r.us===r.them?'üü° Empate':'‚ùå Derrota');
    row.innerHTML=`<div class="who"><strong>${r.comp||'Partido'}</strong> ‚Äî ${new Date(r.date).toLocaleDateString('es-CL')} ‚Äî vs ${r.opp} <span class="pill">${r.us}-${r.them}</span> <span class="tag">${tag}</span></div>
    <div class="row">${canEdit()?'<button class="btn s">Editar</button>':''}</div>`;
    const btn=row.querySelector('button'); if(btn) btn.onclick=()=>openResult(r);
    box.appendChild(row);
  });
}
$("#btnAddResult").onclick=()=>{ openResult(null); };
function openResult(r){
  if(!canEdit()){ alert("S√≥lo capitanas o admin."); return; }
  const data=r||{date:new Date().toISOString().slice(0,10),comp:"Amistoso",opp:"",us:0,them:0,scorers:{}};
  $("#resTitle").textContent = r? "Editar resultado":"Nuevo resultado";
  $("#rDate").value=data.date.slice(0,10); $("#rComp").value=data.comp; $("#rOpp").value=data.opp; $("#rUs").value=data.us; $("#rThem").value=data.them;
  const box=$("#rScorers"); box.innerHTML="";
  S.roster.forEach(p=>{
    const b=document.createElement("button"); b.className="btn s"; b.textContent=`${p.name} (${data.scorers[p.name]||0})`;
    b.onclick=()=>{ data.scorers[p.name]=(data.scorers[p.name]||0)+1; b.textContent=`${p.name} (${data.scorers[p.name]})`; };
    b.oncontextmenu=(e)=>{ e.preventDefault(); data.scorers[p.name]=Math.max(0,(data.scorers[p.name]||0)-1); b.textContent=`${p.name} (${data.scorers[p.name]})`; };
    box.appendChild(b);
  });
  openModal('resultWrap');
  $("#rSave").onclick=()=>{
    data.date=$("#rDate").value; data.comp=$("#rComp").value; data.opp=$("#rOpp").value; data.us=Number($("#rUs").value||0); data.them=Number($("#rThem").value||0);
    if(r){ Object.assign(r,data); } else S.results.push(data);
    save(); closeModal('resultWrap'); renderTrack(); renderScorers();
  };
}

/* ===================== ADMIN (export/import) ===================== */
$("#btnExport").onclick=()=>{ if(!isAdmin()) return alert("S√≥lo admin"); const blob=new Blob([JSON.stringify(S,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="golden-moms-backup.json"; a.click(); };
$("#btnImport").onclick=()=>{ if(!isAdmin()) return alert("S√≥lo admin"); $("#fileImport").click(); };
$("#fileImport").onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const j=JSON.parse(r.result); S=j; save(); alert("Importado."); renderAll(); }catch{ alert("Archivo inv√°lido."); } }; r.readAsText(f); };
$("#btnReset").onclick=()=>{ if(!isAdmin()) return alert("S√≥lo admin"); if(confirm("Borrar todo el estado local?")){ localStorage.removeItem(KEY); location.reload(); } };

/* ===================== MODALS ===================== */
function openModal(id){ $("#"+id).style.display="grid"; }
function closeModal(id){ $("#"+id).style.display="none"; }
$$('[data-close="playerWrap"]').forEach(b=>b.onclick=()=>closeModal('playerWrap'));
$$('[data-close="eventWrap"]').forEach(b=>b.onclick=()=>closeModal('eventWrap'));
$$('[data-close="resultWrap"]').forEach(b=>b.onclick=()=>closeModal('resultWrap'));

/* ===================== CAL NAV & COPY WEEK ===================== */
$("#mPrevCal").onclick=()=>{ cal1.setMonth(cal1.getMonth()-1); renderAll(); };
$("#mNextCal").onclick=()=>{ cal1.setMonth(cal1.getMonth()+1); renderAll(); };
$("#ePrevCal").onclick=()=>{ cal2.setMonth(cal2.getMonth()-1); renderAll(); };
$("#eNextCal").onclick=()=>{ cal2.setMonth(cal2.getMonth()+1); renderAll(); };
$("#btnCopyWeek").onclick=$("#btnCopyWeek2").onclick=copyWeek;

/* ===================== RSVP HASH (jugadora confirma desde link) ===================== */
(function checkHash(){
  const h=location.hash; if(!h.startsWith("#rsvp=")) return;
  try{ const p=JSON.parse(decodeURIComponent(h.slice(6))); const E=S.events.find(x=>x.id===p.id); if(E){ openEvent(E.id); } }catch{}
})();

/* ===================== VIEW GUARDS & RENDER ALL ===================== */
function guardViews(){
  // Configuraci√≥n s√≥lo admin
  document.querySelector('[data-view="admin"]').style.display = isAdmin()? "inline-flex":"none";
  // Seguimiento: bot√≥n registrar s√≥lo cap/admin
  $("#btnAddResult").style.display = canEdit()? "":"none";
  // Plantel: agregar s√≥lo cap/admin
  $("#btnAddPlayer").style.display = (canEdit()? "":"none");
}
function renderAll(){
  guardViews();
  // top who
  $("#who").textContent = S.me? `${S.me.name} ‚Äî ${S.me.role}` : "Invitada";
  // calendars
  renderCalendar($("#grid"), $("#mLabel"), cal1, $("#fEventType"), $("#fTeam"));
  renderCalendar($("#grid2"), $("#eLabel"), cal2, $("#efEventType"), $("#efTeam"));
