<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms â€” Panel (evento + en tarjeta)</title>
<link rel="icon" href="Logo.webp"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{
  --blue:#0f3a78; --lime:#9be22d; --ink:#0f172a; --mut:#64748b;
  --b:#e2e8f0; --bg:#f7f8fa;
  --lime-strong:#7fd410; --blue-strong:#0a2a58;
  --title-size:12px; --content-size:10px; --sub-size:8px; --kpi-number-size:22px;
  --card-radius:12px;
}

/* base */
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:inherit;text-decoration:none}

/* Top bar / buttons (kept from original) */
.btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer;font-size:var(--content-size)}
.btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
.btn.s{background:#f8fafc}

/* Layout */
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:#fff;border:1px solid var(--b);border-radius:var(--card-radius);box-shadow:0 8px 20px #0000000a;padding:12px; overflow:visible}
.section-note{font-size:var(--sub-size);color:var(--mut);margin-top:8px;border-left:3px solid #e6edf7;padding-left:8px}

/* Roster tiles (compact) */
#rosterGrid { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; align-items:start; }
.player-tile {
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:12px;
  text-align:center;
  cursor:pointer;
  transition:transform .12s ease, box-shadow .12s ease;
  border-radius:10px;
  min-height:110px;
  background:#fff;
  border:1px solid var(--b);
}
.player-tile:hover{ transform: translateY(-4px); box-shadow: 0 12px 30px #00000011; }
.player-photo { width:84px; height:84px; border-radius:999px; object-fit:cover; border:2px solid #fff; box-shadow:0 6px 18px #00000010; background:#f1f5f9; }
.player-apodo { font-weight:800; font-size:14px; color:var(--ink); }

/* Modal for player details */
.player-modal-bg{ position:fixed; inset:0; background:#0006; display:none; z-index:1200; justify-content:center; align-items:flex-start; padding-top:6vh; overflow:auto; -webkit-overflow-scrolling:touch }
.player-modal{ width:min(920px, calc(100% - 24px)); margin:0 auto; background:#fff; border-radius:12px; padding:16px; box-shadow:0 30px 60px #00000033; border:1px solid var(--b); }
.player-modal h3{ margin:0 0 10px; font-size:16px; }
.form-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
@media(max-width:800px){ .form-grid{ grid-template-columns:1fr; } }

/* Input styling */
.input, select, textarea{ width:100%; padding:10px; border:1px solid var(--b); border-radius:10px; background:#fff; font-size:var(--content-size) }
.modal-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px }

/* Responsive: single column on small screens */
@media(max-width:900px){
  #rosterGrid { grid-template-columns: repeat(2, 1fr); }
}
@media(max-width:540px){
  #rosterGrid { grid-template-columns: 1fr; }
  .player-photo{ width:72px; height:72px; }
  .player-tile{ min-height:86px; padding:10px; }
}

/* Small helper text */
.meta-small{ font-size:12px; color:var(--mut); margin-top:6px; text-align:center; }

/* keep previous calendar styles minimal (not changed here) */
</style>
</head>
<body>

<!-- Top -->
<div class="top" style="position:sticky;top:0;background:#fff;padding:10px 14px;border-bottom:1px solid var(--b);z-index:50;">
  <div style="display:flex;gap:10px;align-items:center">
    <img src="Logo.webp" alt="GM" style="width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)"/>
    <div style="font-size:14px"><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <div class="nav" role="tablist" aria-label="NavegaciÃ³n">
      <button class="tab active" data-view="dash" onclick="showView('dash')">Dashboard</button>
      <button class="tab" data-view="events" onclick="showView('events')">Eventos</button>
      <button class="tab" data-view="roster" onclick="showView('roster')">Plantel</button>
      <button class="tab" data-view="matches" onclick="showView('matches')">Partidos</button>
    </div>
  </div>
</div>

<div class="container">
  <!-- Dashboard (kept) -->
  <section id="v-dash">
    <div class="grid" style="align-items:stretch">
      <div class="card kpi" style="grid-column:span 6;display:flex;flex-direction:column;justify-content:space-between">
        <div>
          <h4>Plantel</h4>
          <div class="n" id="kRoster">0</div>
          <div style="font-size:var(--sub-size);color:var(--mut)">Integrantes registrados</div>
        </div>
      </div>
      <div class="card kpi" style="grid-column:span 6;display:flex;flex-direction:column;justify-content:space-between">
        <div>
          <h4>Partidos jugados</h4>
          <div class="n" id="kGames">0</div>
          <div id="lastMatchSummary" style="font-size:var(--content-size);color:var(--mut)"></div>
        </div>
        <div style="margin-top:8px;display:flex;justify-content:flex-end">
          <button class="btn s" onclick="showView('matches')">Ir a partidos</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Events (kept minimal) -->
  <section id="v-events" style="display:none">
    <div class="card">
      <h4>Eventos</h4>
      <div class="section-note">Calendario y eventos</div>
      <div id="monthGrid" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- ROSTER -->
  <section id="v-roster" style="display:none">
    <div class="card">
      <h4>Plantel</h4>
      <div class="section-note">Listado del plantel (tabla <code>players</code>) â€” toca una tarjeta para ver/editar.</div>
      <div id="rosterGrid" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- Matches (kept) -->
  <section id="v-matches" style="display:none">
    <div class="card">
      <h4>Partidos jugados</h4>
      <div class="section-note">Registro de partidos.</div>
      <div id="matchesList" style="margin-top:12px"></div>
    </div>
  </section>
</div>

<footer style="text-align:center;padding:16px;color:var(--mut);font-size:var(--content-size)">Golden Moms Â· hecho con ðŸ’š lima & azul</footer>

<!-- Player Modal (view + edit) -->
<div class="player-modal-bg" id="playerModalBg" aria-hidden="true">
  <div class="player-modal" role="dialog" aria-modal="true" aria-labelledby="playerModalTitle">
    <h3 id="playerModalTitle">Jugadora</h3>
    <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
      <div style="min-width:120px">
        <img id="p_img_preview" src="https://via.placeholder.com/160x160.png?text=Sin+foto" alt="foto" style="width:120px;height:120px;border-radius:8px;object-fit:cover;border:1px solid var(--b)" />
      </div>
      <div style="flex:1">
        <div class="form-grid" style="margin-bottom:8px">
          <div>
            <label>Apodo</label>
            <input id="p_apodo" class="input" placeholder="Apodo (ej: Ale)"/>
          </div>
          <div>
            <label>Nombre completo</label>
            <input id="p_nombre" class="input" placeholder="Nombre (ej: Alejandra PÃ©rez)"/>
          </div>

          <div>
            <label>NÃºmero de camiseta</label>
            <input id="p_numero" class="input" placeholder="14" type="number" min="0"/>
          </div>
          <div>
            <label>Rol / PosiciÃ³n</label>
            <input id="p_rol" class="input" placeholder="jugadora / arquera / lateral"/>
          </div>

          <div>
            <label>Equipos</label>
            <input id="p_equipos" class="input" placeholder="Golden Moms, Dream"/>
          </div>
          <div>
            <label>Fecha de nacimiento</label>
            <input id="p_fecha_nac" class="input" type="date"/>
          </div>

          <div>
            <label>Celular</label>
            <input id="p_celular" class="input" placeholder="+56 9 ..."/>
          </div>
          <div>
            <label>Tel. emergencia</label>
            <input id="p_telemer" class="input" placeholder="TelÃ©fono de emergencia"/>
          </div>

          <div>
            <label>Mail</label>
            <input id="p_email" class="input" placeholder="email@ejemplo.com"/>
          </div>
          <div>
            <label>RUT</label>
            <input id="p_rut" class="input" placeholder="RUT"/>
          </div>

          <div>
            <label>Seguro mÃ©dico</label>
            <input id="p_seguro" class="input" placeholder="Nombre seguro"/>
          </div>
          <div>
            <label>Curso hijos / nota</label>
            <input id="p_curso_hijos" class="input" placeholder="Curso hijos (si aplica)"/>
          </div>

          <div style="grid-column:1 / -1">
            <label>URL de la foto</label>
            <input id="p_foto" class="input" placeholder="https://... (mejor usar URL de la foto)" />
            <div class="meta-small">Por ahora la subida de archivos no estÃ¡ incluida: pega la URL de la imagen en este campo.</div>
          </div>
        </div>

        <div class="modal-actions" style="padding-top:6px">
          <button id="btnDeletePlayer" class="btn s" style="margin-right:auto">Eliminar</button>
          <button id="btnCancelPlayer" class="btn s">Cancelar</button>
          <button id="btnSavePlayer" class="btn p">Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Supabase config: deja tus credenciales ---------- */
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};
const supa = (typeof supabase !== 'undefined') ? supabase.createClient(SUPA.url, SUPA.key) : null;

/* ---------- Helpers ---------- */
function pad(n){ return n.toString().padStart(2,'0'); }
function isoToLocalInput(iso){
  if(!iso) return '';
  const d = new Date(iso);
  const mm = pad(d.getMonth()+1), dd = pad(d.getDate());
  return `${d.getFullYear()}-${mm}-${dd}`;
}
function localDateYMD(d){ const D=new Date(d); return `${D.getFullYear()}-${pad(D.getMonth()+1)}-${pad(D.getDate())}`; }

/* ---------- Simple nav + view handling ---------- */
function showView(v){
  ['dash','events','roster','matches'].forEach(id=>{
    const el = document.getElementById('v-'+id);
    if(el) el.style.display = (id===v) ? 'block' : 'none';
  });
  if(v==='dash') renderDash();
  if(v==='events') renderMonth(); // placeholder: the calendar functions may be present from original
  if(v==='roster') renderRoster();
  if(v==='matches') renderMatches();
}

/* ---------- Player Modal logic ---------- */
const playerModalBg = document.getElementById('playerModalBg');
const p_img_preview = document.getElementById('p_img_preview');
const p_apodo = document.getElementById('p_apodo');
const p_nombre = document.getElementById('p_nombre');
const p_numero = document.getElementById('p_numero');
const p_rol = document.getElementById('p_rol');
const p_equipos = document.getElementById('p_equipos');
const p_fecha_nac = document.getElementById('p_fecha_nac');
const p_celular = document.getElementById('p_celular');
const p_telemer = document.getElementById('p_telemer');
const p_email = document.getElementById('p_email');
const p_rut = document.getElementById('p_rut');
const p_seguro = document.getElementById('p_seguro');
const p_curso_hijos = document.getElementById('p_curso_hijos');
const p_foto = document.getElementById('p_foto');

let currentPlayerId = null;

function openPlayerModal(player){
  currentPlayerId = player.id;
  document.getElementById('playerModalTitle').textContent = player.apodo ? `${player.apodo} (${player.nombre || ''})` : (player.nombre || 'Jugadora');
  p_img_preview.src = player.foto || 'https://via.placeholder.com/160x160.png?text=Sin+foto';
  p_apodo.value = player.apodo || '';
  p_nombre.value = player.nombre || '';
  p_numero.value = player.numero_camiseta != null ? player.numero_camiseta : '';
  p_rol.value = player.rol || '';
  p_equipos.value = player.equipos || '';
  p_fecha_nac.value = player.fecha_nacimiento ? isoToLocalInput(player.fecha_nacimiento) : '';
  p_celular.value = player.celular || '';
  p_telemer.value = player.Telefono_emergencia || '';
  p_email.value = player.email || '';
  p_rut.value = player.Rut || '';
  p_seguro.value = player.Seguro_Medico || '';
  p_curso_hijos.value = player.Curso_hijos || '';
  p_foto.value = player.foto || '';
  playerModalBg.style.display = 'flex';
  playerModalBg.setAttribute('aria-hidden','false');
}

function closePlayerModal(){ 
  playerModalBg.style.display = 'none';
  playerModalBg.setAttribute('aria-hidden','true');
  currentPlayerId = null;
}

/* Cancel / close handlers */
document.getElementById('btnCancelPlayer').addEventListener('click', ()=> closePlayerModal());
playerModalBg.addEventListener('click', (e)=> { if(e.target === playerModalBg) closePlayerModal(); });

/* Save player changes */
document.getElementById('btnSavePlayer').addEventListener('click', async ()=>{
  if(!supa){ alert('No conectado a Supabase.'); return; }
  if(!currentPlayerId){ alert('No hay jugadora seleccionada'); return; }

  const payload = {
    apodo: p_apodo.value.trim() || null,
    nombre: p_nombre.value.trim() || null,
    numero_camiseta: p_numero.value !== '' ? (isNaN(Number(p_numero.value)) ? null : Number(p_numero.value)) : null,
    rol: p_rol.value.trim() || null,
    equipos: p_equipos.value.trim() || null,
    fecha_nacimiento: p_fecha_nac.value ? new Date(p_fecha_nac.value).toISOString() : null,
    celular: p_celular.value.trim() || null,
    Telefono_emergencia: p_telemer.value.trim() || null,
    email: p_email.value.trim() || null,
    Rut: p_rut.value.trim() || null,
    Seguro_Medico: p_seguro.value.trim() || null,
    Curso_hijos: p_curso_hijos.value.trim() || null,
    foto: p_foto.value.trim() || null
  };

  try{
    const { error } = await supa.from('players').update(payload).eq('id', currentPlayerId);
    if(error) throw error;
    closePlayerModal();
    await renderRoster();
    await renderDash();
  }catch(err){
    console.error('Error actualizando player:', err);
    alert('Error guardando cambios. Revisa consola.');
  }
});

/* Delete player */
document.getElementById('btnDeletePlayer').addEventListener('click', async ()=>{
  if(!currentPlayerId) return;
  if(!confirm('Â¿Eliminar a esta jugadora? Esta acciÃ³n no se puede deshacer.')) return;
  try{
    const { error } = await supa.from('players').delete().eq('id', currentPlayerId);
    if(error) throw error;
    closePlayerModal();
    await renderRoster();
    await renderDash();
  }catch(err){
    console.error('Error eliminando player:', err);
    alert('Error eliminando. Revisa consola.');
  }
});

/* Keep preview image in sync with URL field */
p_foto.addEventListener('input', ()=> {
  p_img_preview.src = p_foto.value && p_foto.value.trim() ? p_foto.value.trim() : 'https://via.placeholder.com/160x160.png?text=Sin+foto';
});

/* ---------- roster renderer (compact clickable tiles) ---------- */
async function renderRoster(){
  const rosterGrid = document.getElementById('rosterGrid');
  rosterGrid.innerHTML = '<div style="color:var(--mut)">Cargando plantelâ€¦</div>';
  try{
    if(!supa){ rosterGrid.innerHTML = '<div style="color:var(--mut)">Sin conexiÃ³n â€” no se pudo cargar plantel</div>'; return; }
    const { data:playersList, error } = await supa.from('players').select('*').order('apodo',{ascending:true});
    if(error){ console.error('Error cargando players', error); rosterGrid.innerHTML = '<div style="color:var(--mut)">Error cargando plantel</div>'; return; }
    if(!playersList || playersList.length===0){ rosterGrid.innerHTML = '<div style="color:var(--mut)">No hay jugadores registrados</div>'; return; }

    rosterGrid.innerHTML = '';
    playersList.forEach(p=>{
      const tile = document.createElement('div');
      tile.className = 'player-tile card';
      tile.title = (p.apodo || p.nombre) ? `${p.apodo || p.nombre}` : 'Ver jugadora';
      tile.onclick = ()=> openPlayerModal(p);

      const img = document.createElement('img');
      img.className = 'player-photo';
      img.alt = p.apodo || p.nombre || 'Jugador';
      img.src = p.foto || 'https://via.placeholder.com/160x160.png?text=Sin+foto';

      const name = document.createElement('div');
      name.className = 'player-apodo';
      name.textContent = p.apodo || p.nombre || 'Sin nombre';

      tile.appendChild(img);
      tile.appendChild(name);

      rosterGrid.appendChild(tile);
    });
  }catch(err){
    console.error('renderRoster error', err);
    rosterGrid.innerHTML = '<div style="color:var(--mut)">Error cargando plantel</div>';
  }
}

/* ---------- minimal: renderDash & renderMatches placeholders (kept from previous code) ---------- */
async function renderDash(){
  try{
    // players count
    let players = [];
    if(supa){
      try{ const resPlayers = await supa.from("players").select("id"); if(resPlayers && resPlayers.data) players = resPlayers.data; }catch(e){ players = []; }
    }
    document.getElementById('kRoster').textContent = (players||[]).length || 0;
  }catch(err){
    console.error(err);
  }
}
async function renderMatches(){
  const container = document.getElementById('matchesList');
  container.innerHTML = 'Cargandoâ€¦';
  try{
    if(!supa){ container.innerHTML = '<div style="color:var(--mut)">Sin conexiÃ³n â€” no se pueden cargar partidos</div>'; return; }
    const { data, error } = await supa.from('matches').select(`*, events:event_id ( id, title, datetime, team, opponent )`).order('created_at', {ascending:false});
    if(error || !data || data.length===0){ container.innerHTML = '<div style="color:var(--mut)">No hay registros de partidos.</div>'; return; }
    container.innerHTML = data.map(m=>{
      const ev = m.events || {};
      const d = ev.datetime ? new Date(ev.datetime) : null;
      const dateTxt = d ? `${d.toLocaleDateString('es-CL',{day:'2-digit',month:'short'})} ${d.toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'})}` : '';
      const scorers = (m.scorers || []).join(', ') || 'â€”';
      const assists = (m.assists || []).join(', ') || 'â€”';
      return `<div style="border:1px solid var(--b);padding:10px;border-radius:8px;margin-bottom:8px">
        <div style="font-weight:700">${ev.title || 'Partido'}</div>
        <div style="font-size:13px;color:var(--mut)">${dateTxt}</div>
        <div style="margin-top:6px">Resultado: <strong>${m.goals_for ?? 'â€”'}</strong> â€” <strong>${m.goals_against ?? 'â€”'}</strong> (Dif: ${m.goal_difference ?? 'â€”'})</div>
        <div style="margin-top:6px"><strong>Goleadoras:</strong> ${scorers}</div>
        <div style="margin-top:4px"><strong>Asistencias:</strong> ${assists}</div>
      </div>`;
    }).join('');
  }catch(err){
    console.error('renderMatches error', err);
    container.innerHTML = '<div style="color:var(--mut)">Error cargando partidos</div>';
  }
}

/* ---------- init ---------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  // Start on saved view 'roster' if user was there, else dash
  const persisted = localStorage.getItem('gm_view');
  const initial = persisted || 'dash';
  document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
  const btn = document.querySelector(`.nav .tab[data-view="${initial}"]`);
  if(btn) btn.classList.add('active');
  showView(initial);
});
</script>
</body>
</html>
