<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Golden Moms ‚Äî Panel</title>
<link rel="icon" href="Logo.webp"/>
<style>
:root{
  --blue:#0f3a78;--lime:#9BE22D;--ink:#0f172a;--mut:#64748b;--b:#e2e8f0;--bg:#f7f8fa;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:inherit}
.container{max-width:1160px;margin:0 auto;padding:12px}
.top{position:sticky;top:0;z-index:8;background:#fff;border-bottom:1px solid var(--b)}
.top .in{display:flex;align-items:center;gap:10px;padding:10px 12px}
.brand{display:flex;align-items:center;gap:10px;margin-right:auto}
.logo{width:34px;height:34px;border-radius:50%;border:2px solid var(--blue);background:
  url('Logo.webp') center/cover no-repeat, radial-gradient(circle at 35% 35%,var(--lime) 0 45%,var(--blue) 46% 100%)}
h1{font-size:18px;margin:0;font-weight:900}
.badge{font-size:11px;border:1px solid #cbd5e1;border-radius:999px;padding:2px 6px;background:#f8fafc}
.nav{display:flex;gap:6px;flex-wrap:wrap}
.nav .tab{border:1px solid var(--b);border-radius:999px;background:#fff;padding:8px 12px;cursor:pointer}
.nav .tab.act{background:var(--blue);color:#fff}
.btn{border:1px solid var(--b);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.p{background:var(--lime);color:#052c52;border-color:#a3e635;font-weight:800}
.grid{display:grid;gap:12px}
.kpi{background:#fff;border:1px solid var(--b);border-radius:12px;padding:12px}
.kpi h3{margin:0 0 6px 0;color:var(--mut);font-size:14px}
.kpi .n{font-size:26px;font-weight:900}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;padding:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select,input,textarea{width:100%;padding:10px;border:1px solid var(--b);border-radius:10px;background:#fff}
label{font-size:12px;color:#334155;font-weight:600}
.grid7{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cell{background:#fff;border:1px solid var(--b);min-height:120px;border-radius:12px;padding:8px;position:relative}
.day{position:absolute;right:8px;top:6px;font-size:11px;color:#94a3b8}
.tag{font-size:10px;border:1px solid #0001;border-radius:999px;padding:2px 6px;display:inline-block;margin-bottom:4px}
.match{background:#e0edff;border-color:#b7d1ff;color:#0f3a78}
.train{background:#e9fbd0;border-color:#c6f28a;color:#2d5a00}
.event{font-size:13px;margin-bottom:6px;cursor:pointer}
.team{font-size:10px;background:#eaf7d7;border:1px solid #c8ef7a;border-radius:999px;padding:1px 6px;margin-left:6px;font-weight:700}
.overlay{position:fixed;inset:0;background:#0006;display:none;align-items:center;justify-content:center;padding:14px;z-index:10}
.modal{max-width:840px;width:100%;background:#fff;border-radius:14px;border:1px solid var(--b);padding:12px}
.attrow{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--b);border-radius:12px;padding:8px;margin:6px 0;background:#fff}
.bsm{padding:6px 10px;border:1px solid var(--b);border-radius:10px;background:#f8fafc;cursor:pointer}
.counts{display:flex;gap:6px;flex-wrap:wrap}
.chip{padding:6px 10px;border-radius:999px;border:1px solid var(--b);background:#f8fafc;font-weight:700;font-size:12px}
.chip.ok{background:#d9f99d;border-color:#bef264} .chip.mid{background:#fef9c3;border-color:#fde68a} .chip.no{background:#fee2e2;border-color:#fecaca}
.list .item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--b);border-radius:12px;padding:10px;margin:6px 0;background:#fff}
.time{font-weight:800;color:var(--blue)}
.pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--b);border-radius:999px;padding:2px 8px;background:#fff}
.pill .cake{font-size:12px}
hr.sep{border:0;border-top:1px dashed #cbd5e1;margin:8px 0}
.footer{padding:16px 12px;color:#334155;text-align:center}
@media(min-width:900px){
  .grid.kpis{grid-template-columns:repeat(4,1fr)}
}
@media(max-width:899px){
  .grid7{grid-template-columns:repeat(7, minmax(36px,1fr))}
  .cell{min-height:90px}
}
.hidden{display:none !important}
.right{margin-left:auto}
</style>
</head>
<body>
<header class="top">
  <div class="in">
    <div class="brand"><div class="logo"></div><h1>Golden <span style="color:var(--lime)">Moms</span></h1></div>
    <nav class="nav">
      <button class="tab act" data-view="dash">Dashboard</button>
      <button class="tab" data-view="events">Eventos</button>
      <button class="tab" data-view="roster">Plantel</button>
      <button class="tab" data-view="track">Seguimiento</button>
      <button class="tab" data-view="config">Configuraci√≥n</button>
    </nav>
    <span id="roleBadge" class="badge hidden"></span>
    <button id="btnInvite" class="btn">Invitada</button>
    <button id="btnLogin" class="btn">Entrar</button>
  </div>
</header>

<main class="container">

  <!-- DASHBOARD -->
  <section id="view-dash">
    <div class="grid kpis">
      <div class="kpi"><h3>Pr√≥ximos eventos</h3><div class="n" id="kNext">0</div></div>
      <div class="kpi"><h3>Plantel</h3><div class="n" id="kRoster">0</div></div>
      <div class="kpi"><h3>Convocadas (pr√≥x.)</h3><div class="n" id="kOk">0</div></div>
      <div class="kpi"><h3>Partidos jugados</h3><div class="n" id="kPlayed">0</div></div>
    </div>

    <div class="grid" style="grid-template-columns: 1.2fr .8fr; margin-top:12px">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button id="prev" class="btn">&larr;</button>
            <div id="mlabel" style="min-width:200px;text-align:center;font-weight:900;color:var(--blue)"></div>
            <button id="next" class="btn">&rarr;</button>
          </div>
          <div class="row">
            <select id="fltType">
              <option value="Todos">Tipo: Todos</option>
              <option>Entrenamiento</option>
              <option>Partido</option>
              <option>Copa</option>
            </select>
            <select id="fltTeam">
              <option value="Todos">Equipo: Todos</option>
              <option>Golden Moms</option>
              <option>Golden Dreams</option>
              <option>Golden Power</option>
            </select>
            <button id="copyWeek" class="btn">Copiar Semana</button>
            <button id="newEvent" class="btn p">Nuevo Evento</button>
          </div>
        </div>
        <div class="grid7" style="margin-top:8px"><div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div></div>
        <div id="grid" class="grid7"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <strong>Pr√≥ximos cumplea√±os</strong>
          <span class="badge">üéÇ se muestran con etiqueta</span>
        </div>
        <div id="bdayBox" style="margin-top:8px"></div>
        <hr class="sep">
        <div class="row" style="justify-content:space-between">
          <strong>Goleadoras</strong><span class="badge">Top 5</span>
        </div>
        <div id="scorerBox" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="footer">Golden Moms ¬∑ hecho con üíö lima & azul</div>
  </section>

  <!-- EVENTOS SOLO LISTA (para navegaci√≥n) -->
  <section id="view-events" class="hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button id="ePrev" class="btn">&larr;</button>
          <div id="eMonth" style="min-width:180px;text-align:center;font-weight:900;color:var(--blue)"></div>
          <button id="eNext" class="btn">&rarr;</button>
        </div>
        <div class="row">
          <select id="eFType">
            <option value="Todos">Tipo: Todos</option>
            <option>Entrenamiento</option><option>Partido</option><option>Copa</option>
          </select>
          <select id="eFTeam">
            <option value="Todos">Equipo: Todos</option>
            <option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option>
          </select>
        </div>
      </div>
      <div id="eventList" class="list" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- PLANTEL -->
  <section id="view-roster" class="hidden">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:6px 0">Plantel Golden Moms</h3>
      <button id="addPlayer" class="btn p hidden">Agregar jugadora</button>
    </div>
    <div id="rosterList"></div>
  </section>

  <!-- SEGUIMIENTO -->
  <section id="view-track" class="hidden">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:6px 0">Seguimiento de Partidos</h3>
      <button id="btnAddMatch" class="btn p hidden">Registrar resultado</button>
    </div>
    <div id="trackList" class="list" style="margin-top:8px"></div>
  </section>

  <!-- CONFIG (solo admin) -->
  <section id="view-config" class="hidden">
    <div class="card">
      <h3>Configuraci√≥n</h3>
      <p class="badge">Solo administraci√≥n</p>
      <div class="row">
        <button id="btnExport" class="btn">Exportar backup</button>
        <button id="btnImport" class="btn">Importar backup</button>
        <input id="fileImport" type="file" accept="application/json" class="hidden"/>
        <button id="btnReset" class="btn" style="background:#fee2e2;border-color:#fecaca">Restablecer datos demo</button>
      </div>
    </div>
  </section>

</main>

<!-- EDITOR DE EVENTO -->
<div id="ovEvent" class="overlay">
  <div class="modal">
    <div class="row" style="justify-content:space-between">
      <div class="row"><strong id="evtTitleHead">Editar evento</strong><span id="evtTeamBadge" class="team">Golden Moms</span></div>
      <div class="row">
        <button id="btnICS" class="btn">.ics</button>
        <button id="btnCopyWA" class="btn">Copiar WhatsApp</button>
        <button id="btnLink" class="btn">Link convocatoria</button>
        <button id="btnDel" class="btn" style="background:#ef4444;border-color:#ef4444;color:#fff">Eliminar</button>
        <button id="btnCloseEvt" class="btn">Cerrar</button>
      </div>
    </div>
    <div class="row">
      <div style="flex:1;min-width:160px"><label>Tipo</label><select id="eType"><option>Entrenamiento</option><option>Partido</option><option>Copa</option></select></div>
      <div style="flex:2;min-width:220px"><label>T√≠tulo</label><input id="eTitle" /></div>
      <div style="flex:1;min-width:160px"><label>Equipo</label>
        <select id="eTeam"><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select>
      </div>
    </div>
    <div class="row">
      <div style="flex:1;min-width:180px"><label>Fecha y hora</label><input id="eDT" type="datetime-local"></div>
      <div style="flex:1;min-width:180px"><label>Lugar</label><input id="eLoc"></div>
      <div style="flex:1;min-width:180px"><label>Rival</label><input id="eOpp"></div>
      <div style="flex:1;min-width:180px"><label>Uniforme</label><select id="eUni"><option value="">‚Äî</option><option>Polera azul</option><option>Polera verde lima</option></select></div>
    </div>

    <hr class="sep">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>Asistencia</strong>
      <div id="eCounts" class="counts"></div>
    </div>
    <div id="eAtt"></div>
  </div>
</div>

<!-- EDITAR JUGADORA -->
<div id="ovPlayer" class="overlay">
  <div class="modal">
    <div class="row" style="justify-content:space-between">
      <strong>Editar jugadora</strong>
      <button id="plClose" class="btn">Cerrar</button>
    </div>
    <div class="row">
      <div style="flex:2;min-width:240px"><label>Nombre</label><input id="plName"/></div>
      <div style="flex:1;min-width:140px"><label>N√∫mero</label><input id="plNum" type="number"/></div>
    </div>
    <div class="row">
      <div style="flex:1;min-width:180px"><label>Apodo</label><input id="plNick"/></div>
      <div style="flex:1;min-width:180px"><label>Nacimiento</label><input id="plBirth" type="date"/></div>
      <div style="flex:1;min-width:200px">
        <label>Equipos (Ctrl/Cmd para multi)</label>
        <select id="plTeams" multiple>
          <option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option>
        </select>
      </div>
      <div style="flex:1;min-width:180px" id="roleWrap">
        <label>Rol</label>
        <select id="plRole"><option>Jugadora</option><option>Capitana</option><option>Admin</option></select>
      </div>
    </div>
    <div class="row"><button id="plSave" class="btn p">Guardar</button></div>
  </div>
</div>

<!-- LOGIN -->
<div id="ovLogin" class="overlay">
  <div class="modal" style="max-width:460px">
    <strong>Ingresar</strong>
    <div class="row" style="margin-top:8px">
      <select id="lgName"></select>
      <input id="lgCode" placeholder="C√≥digo de acceso"/>
      <button id="lgGo" class="btn p">Entrar</button>
    </div>
    <small class="badge">Usa tu nombre + c√≥digo: <b>golden2025</b></small>
  </div>
</div>

<script>
/* =============== Estado & Utilidades =============== */
const KEY='gm-v4';
const SESSION_KEY='gm-sess';
const CODE='golden2025';
let S = {
  roster: [],
  events: [],
  results: [], // {id, dateISO, title, team, opponent, scoreA, scoreB, goals:[{name, n}]}
};
let SESSION = { name:'Invitada', role:'Invitada' };

function save(){ localStorage.setItem(KEY, JSON.stringify(S)); }
function load(){
  try{ const x=JSON.parse(localStorage.getItem(KEY)||'{}'); if(x && typeof x==='object'){ S={...S,...x}; } }catch{}
  const sess = JSON.parse(localStorage.getItem(SESSION_KEY)||'{}');
  if(sess && sess.name) SESSION=sess;
}
function persistSession(){ localStorage.setItem(SESSION_KEY, JSON.stringify(SESSION)); }

function isoLocal(d){ // Date -> local ISO without TZ skew
  const t=new Date(d); return new Date(t.getTime()-t.getTimezoneOffset()*60000).toISOString();
}
function fmtMonth(d){ return d.toLocaleDateString('es-CL',{month:'long',year:'numeric'}); }
function toInput(iso){ const d=new Date(iso); const p=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
}
function shortWhen(iso){ const d=new Date(iso);
  return d.toLocaleString('es-CL',{weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
}
function nextMon(d){const day=(d.getDay()+6)%7;const diff=(7-day)%7;const nd=new Date(d);nd.setDate(d.getDate()+diff);nd.setHours(0,0,0,0);return nd;}

function ensureSeed(){
  if(S.roster.length) return;
  const names = [
    "Ale V","Andre","Antonella","Aurora","Carla","Caro G","Caro N","Cata","Celsa","Chica","Consu","Consu S","Cote","Dani C","Dani J","Fabi","Fran","Gaby","Isa","Jandi","Janga","Javiera A","Javi C","Jean","Maca","Male","Marce","Myle","Paz","Pia","Pili","Vale","Vero"
  ];
  const bdays = {
    "Javiera A":"01-02","Dani J":"01-11","Vero":"01-29","Antonella":"02-06","Marce":"03-14","Caro N":"04-07",
    "Trini":"04-10","Chica":"04-20","Jean":"05-05","Myle":"06-03","Fran":"06-21","Jandi":"07-14","Caro G":"07-24",
    "Janga":"08-20","Fabi":"08-28","Dani C":"10-10","Vale":"10-11","Pia":"10-21","Maca":"10-25","Isa":"10-26",
    "Aurora":"11-12","Ale V":"11-12","Cata":"12-08","Male":"12-10","Carla":"12-13","Consu":"12-23"
  };
  S.roster = names.map((n,i)=>({
    id: crypto.randomUUID?.()||(""+Math.random()).slice(2),
    name:n, nick:"", number:i+11, birth: bdays[n] ? (new Date().getFullYear()+"-"+bdays[n].replace('-','-')) : "",
    teams:["Golden Moms"], role: (n==="Fabi"||n==="Chica")?"Capitana":"Jugadora", goals:0
  }));
  // 12 semanas de seed: entrenos mar/jue 19:30, Copa mi√© 20:00, LIFA vie 20:00
  function mk(y,m,d,h,mi){ return isoLocal(new Date(y,m-1,d,h,mi)); }
  function startOfNext(dow){ const n=new Date(), g=(dow-n.getDay()+7)%7||7; const d=new Date(n); d.setDate(n.getDate()+g); return d; }
  const tue=startOfNext(2), wed=startOfNext(3), thu=startOfNext(4), fri=startOfNext(5);
  for(let i=0;i<12;i++){
    const T=new Date(tue);T.setDate(tue.getDate()+7*i);
    const Th=new Date(thu);Th.setDate(thu.getDate()+7*i);
    const W=new Date(wed);W.setDate(wed.getDate()+7*i);
    const F=new Date(fri);F.setDate(fri.getDate()+7*i);
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:mk(T.getFullYear(),T.getMonth()+1,T.getDate(),19,30),location:"Colegio",opponent:"",uniform:"", att:{}});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:mk(Th.getFullYear(),Th.getMonth()+1,Th.getDate(),19,30),location:"Colegio",opponent:"",uniform:"", att:{}});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Partido",title:"Wonder Mom‚Äôs Cup",team:"Golden Moms",datetime:mk(W.getFullYear(),W.getMonth()+1,W.getDate(),20,0),location:"Universidad de los Andes",opponent:"‚Äî",uniform:"", att:{}});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Partido",title:"Liga LIFA",team:"Golden Moms",datetime:mk(F.getFullYear(),F.getMonth()+1,F.getDate(),20,0),location:"Cancha Oriente, Las Condes",opponent:"‚Äî",uniform:"", att:{}});
  }
  save();
}

/* =============== Login & Roles =============== */
const roleBadge=document.getElementById('roleBadge');
const btnLogin=document.getElementById('btnLogin');
const btnInvite=document.getElementById('btnInvite');
const ovLogin=document.getElementById('ovLogin');
const lgName=document.getElementById('lgName');
const lgCode=document.getElementById('lgCode');

function refreshRoleUI(){
  roleBadge.classList.remove('hidden');
  roleBadge.textContent = `${SESSION.name} ‚Äî ${SESSION.role}`;
  document.getElementById('addPlayer').classList.toggle('hidden', !(SESSION.role==='Admin'||SESSION.role==='Capitana'));
  document.getElementById('btnAddMatch').classList.toggle('hidden', !(SESSION.role==='Admin'||SESSION.role==='Capitana'));
  // Config solo admin
  document.getElementById('view-config').querySelectorAll('button').forEach(b=>b.disabled = !(SESSION.role==='Admin'));
}

btnInvite.onclick=()=>{ SESSION={name:'Invitada',role:'Invitada'}; persistSession(); refreshRoleUI(); };
btnLogin.onclick=()=>{
  lgName.innerHTML = S.roster.map(p=>`<option>${p.name}</option>`).join('');
  lgCode.value='';
  ovLogin.style.display='flex';
};
document.getElementById('lgGo').onclick=()=>{
  const n=lgName.value.trim();
  if(!n) return;
  if(lgCode.value.trim().toLowerCase()!==CODE){ alert('C√≥digo incorrecto'); return; }
  const p=S.roster.find(x=>x.name===n);
  SESSION={ name:n, role: p?.role||'Jugadora' };
  persistSession();
  ovLogin.style.display='none';
  refreshRoleUI();
};

/* =============== Navegaci√≥n =============== */
const tabs=[...document.querySelectorAll('.nav .tab')];
const views={
  dash: document.getElementById('view-dash'),
  events: document.getElementById('view-events'),
  roster: document.getElementById('view-roster'),
  track: document.getElementById('view-track'),
  config: document.getElementById('view-config'),
};
tabs.forEach(t=>{
  t.onclick=()=>{
    tabs.forEach(x=>x.classList.remove('act')); t.classList.add('act');
    Object.values(views).forEach(v=>v.classList.add('hidden'));
    const id=t.dataset.view;
    views[id].classList.remove('hidden');
    if(id==='dash'){ renderKPIs(); renderCal(); renderBirthdays(); renderScorers(); }
    if(id==='events'){ renderEventsList(); }
    if(id==='roster'){ renderRoster(); }
    if(id==='track'){ renderTrack(); }
  };
});

/* =============== Calendario (Dashboard) =============== */
let mView=new Date(); mView.setDate(1);
const grid=document.getElementById('grid');
const mlabel=document.getElementById('mlabel');
function buildCells(y,m){ const first=new Date(y,m,1), start=(first.getDay()+6)%7, days=new Date(y,m+1,0).getDate();
  const cells=[]; for(let i=0;i<start;i++) cells.push(null); for(let d=1;d<=days;d++) cells.push(new Date(y,m,d));
  while(cells.length%7) cells.push(null); return cells;
}
function renderCal(){
  mlabel.textContent=fmtMonth(mView);
  const y=mView.getFullYear(), m=mView.getMonth(); grid.innerHTML="";
  const cells=buildCells(y,m);
  const FT=document.getElementById('fltType').value||'Todos';
  const TM=document.getElementById('fltTeam').value||'Todos';
  const ev=[...S.events].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
  cells.forEach(d=>{
    const c=document.createElement('div'); c.className='cell';
    if(d){ const day=document.createElement('div'); day.className='day'; day.textContent=d.getDate(); c.appendChild(day);
      ev.filter(e=>{
        const dd=new Date(e.datetime);
        return dd.getFullYear()==d.getFullYear()&&dd.getMonth()==d.getMonth()&&dd.getDate()==d.getDate();
      }).filter(e=> (FT==='Todos'||e.type===FT) && (TM==='Todos'||(e.team||'Golden Moms')===TM) )
      .forEach(E=>{
        const tag=document.createElement('div'); tag.className='tag '+(E.type==='Partido'?'match':'train'); tag.textContent=E.type; c.appendChild(tag);
        const r=document.createElement('div'); r.className='event';
        const dd=new Date(E.datetime); const hh=String(dd.getHours()).padStart(2,'0')+':'+String(dd.getMinutes()).padStart(2,'0');
        r.innerHTML=`<strong>${hh}</strong> ${E.title} <span class="team">${E.team}</span>`;
        r.onclick=()=>openEvent(E.id);
        c.appendChild(r);
      });
    }
    grid.appendChild(c);
  });
}
document.getElementById('prev').onclick=()=>{ mView.setMonth(mView.getMonth()-1); renderCal(); }
document.getElementById('next').onclick=()=>{ mView.setMonth(mView.getMonth()+1); renderCal(); }
document.getElementById('fltType').onchange=renderCal;
document.getElementById('fltTeam').onchange=renderCal;

/* KPIs / Cumplea√±os / Goleadoras */
function renderKPIs(){
  document.getElementById('kRoster').textContent=S.roster.length;
  const upcoming=[...S.events].filter(e=>new Date(e.datetime)>=new Date()).length;
  document.getElementById('kNext').textContent=upcoming;
  // Convocadas del pr√≥ximo
  const next=[...S.events].filter(e=>new Date(e.datetime)>=new Date()).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime))[0];
  if(next){ const A=next.att||{}; const ok=S.roster.filter(p=>A[p.name]==='Asiste').length; document.getElementById('kOk').textContent=ok; }
  document.getElementById('kPlayed').textContent = S.results.length;
}
function renderBirthdays(){
  const box=document.getElementById('bdayBox'); box.innerHTML="";
  const today=new Date();
  const upcoming=S.roster.map(p=>{
    if(!p.birth) return null;
    const [y,m,d]=p.birth.split('-').map(n=>parseInt(n,10));
    const year=today.getFullYear(); const dt=new Date(year, m-1, d);
    if(dt < today){ dt.setFullYear(year+1); }
    return {name:p.name, date:dt};
  }).filter(Boolean).sort((a,b)=>a.date-b.date).slice(0,8);
  upcoming.forEach(u=>{
    const it=document.createElement('div'); it.className='row';
    it.innerHTML=`<span class="pill"><span class="cake">üéÇ</span> ${u.name}</span><span class="right">${u.date.toLocaleDateString('es-CL',{weekday:'short',day:'2-digit',month:'short'})}</span>`;
    box.appendChild(it);
  });
}
function renderScorers(){
  const box=document.getElementById('scorerBox'); box.innerHTML="";
  const rank=[...S.roster].sort((a,b)=>(b.goals||0)-(a.goals||0)).slice(0,5);
  rank.forEach((p,i)=>{
    const it=document.createElement('div'); it.className='row';
    it.innerHTML=`<span class="pill">#${i+1} ${p.name}</span><span class="right"><strong>${p.goals||0}</strong> gol(es)</span>`;
    box.appendChild(it);
  });
}

/* =============== Lista de eventos (vista Eventos) =============== */
let eView=new Date(); eView.setDate(1);
function renderEventsList(){
  document.getElementById('eMonth').textContent=fmtMonth(eView);
  const FT=document.getElementById('eFType').value||'Todos';
  const TM=document.getElementById('eFTeam').value||'Todos';
  const L=document.getElementById('eventList'); L.innerHTML="";
  const ev=[...S.events].filter(e=>{ const d=new Date(e.datetime); return d.getFullYear()==eView.getFullYear() && d.getMonth()==eView.getMonth(); })
    .filter(e=> (FT==='Todos'||e.type===FT) && (TM==='Todos'||(e.team||'Golden Moms')===TM))
    .sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
  ev.forEach(E=>{
    const when=shortWhen(E.datetime);
    const item=document.createElement('div'); item.className='item';
    item.innerHTML=`<div class="row"><span class="badge">${E.type}</span><div><div class="time">${when}</div><div>${E.title} <span class="badge">${E.team}</span></div></div></div><div><button class="btn">Editar</button></div>`;
    item.querySelector('button').onclick=()=>openEvent(E.id);
    L.appendChild(item);
  });
}
document.getElementById('ePrev').onclick=()=>{ eView.setMonth(eView.getMonth()-1); renderEventsList(); };
document.getElementById('eNext').onclick=()=>{ eView.setMonth(eView.getMonth()+1); renderEventsList(); };
document.getElementById('eFType').onchange=renderEventsList;
document.getElementById('eFTeam').onchange=renderEventsList;

/* Copiar semana */
document.getElementById('copyWeek').onclick=()=>{
  const st=nextMon(new Date()), en=new Date(st); en.setDate(st.getDate()+7);
  const L=['*Semana* '+st.toLocaleDateString('es-CL')+' - '+new Date(en.getTime()-86400000).toLocaleDateString('es-CL'),'Equipo GM',''];
  S.events.filter(e=>new Date(e.datetime)>=st && new Date(e.datetime)<en).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)).forEach(E=>{
    const w=shortWhen(E.datetime);
    L.push(`‚Ä¢ ${w} ‚Äî ${E.type}: ${E.title}${E.location?' ‚Äî '+E.location:''} (${E.team}) ${E.opponent?' ‚Äî Rival: '+E.opponent:''}${E.uniform?' ‚Äî Uniforme: '+E.uniform:''}`);
  });
  navigator.clipboard.writeText(L.join('\n'));
  alert('Semana copiada. Pega en WhatsApp.');
};

/* Nuevo evento */
document.getElementById('newEvent').onclick=()=>{
  if(!(SESSION.role==='Admin'||SESSION.role==='Capitana')){ alert('Solo Capitana/Admin'); return; }
  const now=new Date(); now.setMinutes(0,0,0);
  const E={id:crypto.randomUUID?.()||(""+Math.random()).slice(2), type:"Entrenamiento", title:"Entrenamiento",
    team:"Golden Moms", datetime:isoLocal(now), location:"", opponent:"", uniform:"", att:{}};
  S.events.push(E); save(); openEvent(E.id);
  renderCal(); renderEventsList();
};

/* =============== Editor de evento / Asistencia =============== */
const ovEvent=document.getElementById('ovEvent');
const eType=document.getElementById('eType'), eTitle=document.getElementById('eTitle'), eTeam=document.getElementById('eTeam');
const eDT=document.getElementById('eDT'), eLoc=document.getElementById('eLoc'), eOpp=document.getElementById('eOpp'), eUni=document.getElementById('eUni');
const eAtt=document.getElementById('eAtt'), eCounts=document.getElementById('eCounts');
let curEvt=null;

function openEvent(id){
  const E=S.events.find(x=>x.id===id); if(!E) return;
  curEvt=id; ovEvent.style.display='flex';
  document.getElementById('evtTeamBadge').textContent=E.team;
  document.getElementById('evtTitleHead').textContent=(E.type||'Evento')+' ‚Äî '+(E.title||'');
  eType.value=E.type||'Entrenamiento'; eTitle.value=E.title||''; eTeam.value=E.team||'Golden Moms';
  eDT.value=toInput(E.datetime); eLoc.value=E.location||''; eOpp.value=E.opponent||''; eUni.value=E.uniform||'';
  renderAttendance();
}
document.getElementById('btnCloseEvt').onclick=()=>{ ovEvent.style.display='none'; };

function renderAttendance(){
  const E=S.events.find(x=>x.id===curEvt); const team=E.team||'Golden Moms';
  const list = S.roster.filter(p=> (p.teams||['Golden Moms']).includes(team) );
  const A=E.att||{};
  // Contadores
  const counts={ok:0,mid:0,no:0,blank:0};
  list.forEach(p=>{ const v=A[p.name]; if(v==='Asiste') counts.ok++; else if(v==='Duda') counts.mid++; else if(v==='No asiste') counts.no++; else counts.blank++; });
  eCounts.innerHTML=`<span class="chip ok">‚úÖ ${counts.ok}</span><span class="chip mid">‚ùî ${counts.mid}</span><span class="chip no">‚ùå ${counts.no}</span><span class="chip">‚ñ´Ô∏è ${counts.blank}</span>`;
  // Fila por persona (rol)
  eAtt.innerHTML="";
  const isCaptain = (SESSION.role==='Admin'||SESSION.role==='Capitana');
  const me=SESSION.name;
  list.forEach(p=>{
    if(!isCaptain && p.name!==me) return; // jugadores solo su propia fila
    const v=A[p.name]||"";
    const row=document.createElement('div'); row.className='attrow';
    const bday = p.birth ? ` <span class="badge">üéÇ ${new Date(p.birth).toLocaleDateString('es-CL',{day:'2-digit',month:'short'})}</span>` : '';
    row.innerHTML=`<div><strong>${p.name}</strong> <span class="badge">${(p.teams||[]).join(', ')}</span>${bday}</div><div class="row"></div>`;
    function mk(lbl,val){ const b=document.createElement('button'); b.className='bsm'; b.textContent=lbl; b.onclick=()=>{
      E.att=E.att||{}; E.att[p.name]=val; save(); renderAttendance(); }; return b; }
    const r=row.lastChild;
    const b1=mk("‚úÖ","Asiste"), b2=mk("‚ùî","Duda"), b3=mk("‚ùå","No asiste");
    if(v==="Asiste") b1.style.background="#d9f99d"; if(v==="Duda") b2.style.background="#fef9c3"; if(v==="No asiste") b3.style.background="#fee2e2";
    r.appendChild(b1); r.appendChild(b2); r.appendChild(b3);
    eAtt.appendChild(row);
  });
}
[eType,eTitle,eTeam,eDT,eLoc,eOpp,eUni].forEach(el=>el.addEventListener('change',()=>{
  const E=S.events.find(x=>x.id===curEvt); if(!E) return;
  if(el===eDT){ E.datetime=isoLocal(new Date(el.value)); } else { E[el.id.slice(1).toLowerCase()]=el.value; }
  if(el===eTeam){ document.getElementById('evtTeamBadge').textContent=E.team; }
  save(); renderCal(); renderEventsList(); renderAttendance();
}));
document.getElementById('btnDel').onclick=()=>{
  if(!(SESSION.role==='Admin'||SESSION.role==='Capitana')){ alert('Solo Capitana/Admin'); return; }
  const i=S.events.findIndex(x=>x.id===curEvt); if(i>=0){ S.events.splice(i,1); save(); }
  ovEvent.style.display='none'; renderCal(); renderEventsList();
};

/* ICS con dos alarmas (d√≠a anterior + misma ma√±ana) */
function icsDate(d){return new Date(d).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z")}
document.getElementById('btnICS').onclick=()=>{
  const E=S.events.find(x=>x.id===curEvt); if(!E) return;
  const st=new Date(E.datetime), mins=(E.type==="Partido"?120:90), en=new Date(st.getTime()+mins*60000);
  const dayBefore=new Date(st.getTime()-24*3600*1000), sameDay=new Date(st.getFullYear(),st.getMonth(),st.getDate(),9,0,0);
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//GM//Org//ES','CALSCALE:GREGORIAN',
  'BEGIN:VEVENT','UID:'+E.id+'@gm','DTSTAMP:'+icsDate(new Date()),'DTSTART:'+icsDate(st),'DTEND:'+icsDate(en),
  'SUMMARY:'+E.title+' ('+(E.team||'GM')+')','LOCATION:'+ (E.location||'').replace(/,/g,'\\,'),
  'DESCRIPTION:Uniforme '+(E.uniform||'‚Äî')+' | Calcetines: verde lima',
  'BEGIN:VALARM','TRIGGER:-P1D','ACTION:DISPLAY','DESCRIPTION:Recordatorio d√≠a anterior','END:VALARM',
  'BEGIN:VALARM','TRIGGER:'+icsDate(sameDay),'ACTION:DISPLAY','DESCRIPTION:Recordatorio d√≠a del evento','END:VALARM',
  'END:VEVENT','END:VCALENDAR'].join('\r\n');
  const u=URL.createObjectURL(new Blob([lines],{type:"text/calendar"})); const a=document.createElement("a"); a.href=u; a.download=(E.title||"evento")+".ics"; a.click(); URL.revokeObjectURL(u);
};
/* WhatsApp */
document.getElementById('btnCopyWA').onclick=()=>{
  const E=S.events.find(x=>x.id===curEvt); if(!E) return;
  const when=shortWhen(E.datetime); const A=E.att||{};
  // Jugadora solo su estado; Capitana/Admin ve todo
  let L=[];
  L.push(`*${E.type}: ${E.title}* (${E.team})`);
  L.push(`${when}${E.location?' ‚Äî '+E.location:''}`);
  if(E.opponent) L.push('Rival: '+E.opponent);
  if(E.uniform) L.push('Uniforme: '+E.uniform);
  L.push('Calcetines: verde lima'); L.push('');
  if(SESSION.role==='Admin'||SESSION.role==='Capitana'){
    S.roster.forEach(p=>{
      if(!(p.teams||['Golden Moms']).includes(E.team)) return;
      const st=A[p.name]||''; const em=st=='Asiste'?'‚úÖ':st=='Duda'?'‚ùî':st=='No asiste'?'‚ùå':'‚ñ´Ô∏è';
      L.push(`${em} ${p.name} ${st? '('+st+')':''}`);
    });
  }else{
    const st=A[SESSION.name]||''; const em=st=='Asiste'?'‚úÖ':st=='Duda'?'‚ùî':st=='No asiste'?'‚ùå':'‚ñ´Ô∏è';
    L.push(`${em} ${SESSION.name} ${st? '('+st+')':''}`);
  }
  navigator.clipboard.writeText(L.join('\n'));
  alert("Resumen copiado. Pega en WhatsApp.");
};
/* Link convocatoria */
document.getElementById('btnLink').onclick=()=>{
  const E=S.events.find(x=>x.id===curEvt); if(!E) return;
  const payload=btoa(JSON.stringify({id:E.id, team:E.team}));
  const url=location.origin+location.pathname+'#rsvp='+payload;
  navigator.clipboard.writeText(url);
  alert('Link copiado (nota: en Pages el estado es local por navegador)');
};

/* =============== Plantel =============== */
let editPlayerId=null;
const rosterList=document.getElementById('rosterList');
function renderRoster(){
  rosterList.innerHTML="";
  S.roster.sort((a,b)=>a.name.localeCompare(b.name)).forEach(p=>{
    const canEdit = (SESSION.role==='Admin'||SESSION.role==='Capitana' || SESSION.name===p.name);
    const card=document.createElement('div'); card.className='card';
    const teams=(p.teams||['Golden Moms']).map(t=>`<span class="badge">${t}</span>`).join(' ');
    const bday=p.birth?` <span class="badge">üéÇ ${new Date(p.birth).toLocaleDateString('es-CL',{day:'2-digit',month:'short'})}</span>`:'';
    card.innerHTML=`<div class="row" style="justify-content:space-between">
      <div><strong>${p.name}</strong> <span class="badge">${p.role||'Jugadora'}</span> ${teams} ${bday}</div>
      ${canEdit?'<button class="btn">Editar</button>':''}
    </div>`;
    if(canEdit) card.querySelector('button').onclick=()=>openPlayer(p.id
