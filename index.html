<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Golden Moms â€” Panel</title>
<link rel="icon" href="Logo.webp" />
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  :root{
    --blue:#0f3a78; --lime:#9be22d; --lime-strong:#7dd61d; --ink:#0f172a; --mut:#64748b;
    --b:#e2e8f0; --bg:#f7f8fa; --ok:#d9f99d; --mid:#fef9c3; --no:#fee2e2; --card:#ffffff;
    --badge:#f1f5f9;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  a{color:inherit}
  .btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer}
  .btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
  .btn.s{background:#f8fafc}
  .badge{font-size:11px;border:1px solid var(--b);border-radius:999px;padding:2px 8px;background:#f8fafc}
  .top{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  .brand{display:flex;gap:10px;align-items:center}
  .brand img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)}
  .nav{display:flex;gap:8px;flex-wrap:wrap}
  .nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
  .nav .tab.active{background:var(--blue);color:#fff}
  .container{max-width:1200px;margin:14px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 20px #0000000a;padding:12px}
  .kpi h3{margin:0;color:var(--mut);font-size:14px}.kpi .n{font-size:22px;font-weight:800}

  /* ======== Eventos (vista mensual) ======== */
  .month-head{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px}
  .month-head .title{font-weight:800}
  .month-toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
  .day-col{background:#fff;border:1px solid var(--b);border-radius:12px;min-height:140px;display:flex;flex-direction:column}
  .day-head{display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px dashed var(--b)}
  .dow{font-size:12px;color:var(--mut)}
  .dnum{font-weight:700}
  .day-body{padding:8px;display:flex;flex-direction:column;gap:8px}
  .ev{border-radius:10px;border:1px solid var(--b);padding:8px;line-height:1.2;cursor:pointer}
  .ev.train{background:#d9fac2;border-color:#b5ee86}     /* verde lima mÃ¡s fuerte */
  .ev.match{background:#e0edff;border-color:#b7d1ff}     /* azul predominante */
  .ev .title{font-weight:500} /* sin negrita gruesa */
  .day-actions{display:flex;gap:6px;align-items:center}
  .day-plus{border:1px dashed var(--b);border-radius:8px;padding:2px 6px;font-size:12px;background:#f8fafc;cursor:pointer}

  /* ======== Modal ======== */
  .modal{position:fixed;inset:0;background:#0005;display:none;align-items:center;justify-content:center;padding:16px}
  .modal.show{display:flex}
  .dialog{background:#fff;border-radius:14px;border:1px solid var(--b);max-width:760px;width:100%;padding:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field input,.field select,.field textarea{border:1px solid var(--b);border-radius:10px;padding:10px;background:#fff}
  .dialog-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

  /* Footer */
  footer{margin-top:40px;text-align:center;padding:16px;color:var(--mut);font-size:14px}

  /* Responsive */
  @media (max-width: 900px){
    .grid{grid-template-columns:1fr}
    .month-grid{grid-template-columns:repeat(2,1fr)}
    .row,.row3{grid-template-columns:1fr}
  }
  @media (min-width: 901px) and (max-width: 1200px){
    .month-grid{grid-template-columns:repeat(4,1fr)}
  }
</style>
</head>
<body>

<!-- Top -->
<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM"/>
    <div><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div class="nav">
    <button class="tab active" data-view="dash">Dashboard</button>
    <button class="tab" data-view="events">Eventos</button>
    <button class="tab" data-view="roster">Plantel</button>
    <button class="tab" data-view="track">Seguimiento</button>
  </div>
</div>

<div class="container">
  <!-- DASHBOARD -->
  <section id="v-dash">
    <div class="grid">
      <div class="card kpi" style="grid-column:span 4"><h3>PrÃ³ximos eventos</h3><div class="n" id="kEvents">0</div></div>
      <div class="card kpi" style="grid-column:span 4"><h3>Plantel</h3><div class="n" id="kRoster">0</div></div>
      <div class="card kpi" style="grid-column:span 4"><h3>Partidos jugados</h3><div class="n" id="kGames">0</div></div>
      <div class="card kpi" style="grid-column:span 4"><h3>CumpleaÃ±os (hoy)</h3><div class="n" id="kBdayToday">â€”</div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <strong>ðŸŽ‚ PrÃ³ximos cumpleaÃ±os</strong>
      <ul id="upBirth" style="margin:8px 0 0 16px"></ul>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="font-weight:700;margin-bottom:6px">ðŸ“† Hoy</div>
      <ul id="todayEvents" style="margin:8px 0 12px 16px"></ul>
      <div style="font-weight:700;margin:12px 0 6px">ðŸ“… Eventos de la semana</div>
      <ul id="weekEvents" style="margin:8px 0 0 16px"></ul>
    </div>
  </section>

  <!-- EVENTOS -->
  <section id="v-events" style="display:none">
    <div class="card">
      <div class="month-head">
        <div class="title" id="monthTitle">Mes</div>
        <div class="month-toolbar">
          <button class="btn s" id="btnToday">Hoy</button>
          <button class="btn s" id="btnPrev">â—€</button>
          <button class="btn s" id="btnNext">â–¶</button>
          <button class="btn p" id="btnNewEvent">Nuevo Evento</button>
        </div>
      </div>
      <div class="month-grid" id="monthGrid"></div>
    </div>
  </section>

  <!-- PLANTEL -->
  <section id="v-roster" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Plantel</strong>
      </div>
      <div id="rosterGrid" class="grid"></div>
    </div>
  </section>

  <!-- SEGUIMIENTO -->
  <section id="v-track" style="display:none">
    <div class="card">
      <strong>Seguimiento de partidos</strong>
      <div id="trackList"></div>
    </div>
  </section>
</div>

<footer>Golden Moms Â· hecho con ðŸ’š lima & azul</footer>

<!-- ========= Modal Evento ========= -->
<div class="modal" id="mdl">
  <div class="dialog">
    <h3 id="dlgTitle">Nuevo evento</h3>
    <div class="field">
      <label>TÃ­tulo</label>
      <input id="fTitle" placeholder="Ej: Entrenamiento Colegio"/>
    </div>
    <div class="row">
      <div class="field">
        <label>Fecha y hora</label>
        <input id="fDatetime" type="datetime-local"/>
      </div>
      <div class="field">
        <label>Tipo</label>
        <select id="fType">
          <option>Entrenamiento</option>
          <option>Partido</option>
        </select>
      </div>
    </div>
    <div class="row3">
      <div class="field">
        <label>Equipo</label>
        <input id="fTeam" value="Golden Moms" />
      </div>
      <div class="field">
        <label>Rival (si aplica)</label>
        <input id="fOpponent" placeholder="Rivales / Liga" />
      </div>
      <div class="field">
        <label>Uniforme</label>
        <select id="fUniform">
          <option value="">(definir)</option>
          <option>Polera azul â€” * medias verde lima</option>
          <option>Polera verde lima â€” * medias verde lima</option>
        </select>
      </div>
    </div>
    <div class="field">
      <label>UbicaciÃ³n</label>
      <input id="fLocation" placeholder="Colegio / Cancha / DirecciÃ³n" />
    </div>
    <div class="dialog-actions">
      <button class="btn s" id="btnDelete" style="display:none">Eliminar</button>
      <button class="btn s" id="btnCancel">Cancelar</button>
      <button class="btn p" id="btnSave">Guardar</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  (async function start() {
    try {
      /* ========= SUPABASE ========= */
      const SUPA = {
        url: "https://xglojvvbgaivwbpdxvne.supabase.co",
        key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
      };
      const supa = supabase.createClient(SUPA.url, SUPA.key);

      /* ========= NavegaciÃ³n ========= */
      document.querySelectorAll('.nav .tab').forEach(btn=>{
        btn.onclick=()=>{
          document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          showView(btn.dataset.view);
        };
      });
      function showView(v){
        ['dash','events','roster','track'].forEach(id=>document.getElementById('v-'+id).style.display='none');
        document.getElementById('v-'+v).style.display='block';
        if(v==='dash') renderDash();
        if(v==='events') renderMonth();
        if(v==='roster') renderRoster();
        if(v==='track') renderTrack();
      }

      /* ========= Utiles ========= */
      const fmtDay = (d)=>d.toLocaleDateString('es-CL',{weekday:'short'});
      const fmtDnum= (d)=>d.getDate();
      const fmtMonthTitle=(d)=>d.toLocaleDateString('es-CL',{month:'long', year:'numeric'});

      const isSameDay=(a,b)=>a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();

      /* ========= Dashboard ========= */
      async function renderDash(){
        try{
          const now = new Date();
          const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate()-((now.getDay()+6)%7)); // lunes
          const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate()+7);

          const {data:events}=await supa.from("events").select("*").gte("datetime", new Date(now.getFullYear(), now.getMonth(), 1).toISOString());
          const {data:players}=await supa.from("players").select("*");

          // KPIs
          document.getElementById('kEvents').textContent=events?.length||0;
          document.getElementById('kRoster').textContent=players?.length||0;
          document.getElementById('kGames').textContent=0;

          // CumpleaÃ±os hoy & prÃ³ximos
          const { data: allPlayers } = await supa.from('players').select('nombre, apodo, fecha_nacimiento');
          const list = document.getElementById("upBirth"); list.innerHTML="";
          const todayList = [];
          (allPlayers||[]).forEach(p=>{
            if(!p.fecha_nacimiento) return;
            const bd = new Date(p.fecha_nacimiento);
            const next = new Date(new Date().getFullYear(), bd.getMonth(), bd.getDate());
            if(next.getMonth() === now.getMonth() && next.getDate() >= now.getDate()){
              list.innerHTML += `<li>${p.apodo || p.nombre} â€” ${next.toLocaleDateString("es-CL",{day:"2-digit",month:"short"})}</li>`;
            }
            if(isSameDay(next, now)){ todayList.push(p.apodo || p.nombre); }
          });
          document.getElementById('kBdayToday').textContent = (todayList.length? todayList.join(", "): 'â€”');

          // Hoy
          const todayUl = document.getElementById('todayEvents'); todayUl.innerHTML="";
          (events||[]).forEach(e=>{
            const d = new Date(e.datetime);
            if(isSameDay(d, now)){
              todayUl.innerHTML += `<li><strong>${e.title}</strong> â€” ${d.toLocaleString("es-CL",{weekday:"short",hour:"2-digit",minute:"2-digit"})}</li>`;
            }
          });

          // Semana actual
          const weekUl=document.getElementById('weekEvents'); weekUl.innerHTML="";
          (events||[]).forEach(e=>{
            const d = new Date(e.datetime);
            if(d>=startOfWeek && d<endOfWeek){
              weekUl.innerHTML += `<li><strong>${e.title}</strong> â€” ${d.toLocaleString("es-CL",{weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"})}</li>`;
            }
          });
        }catch(err){ console.error('Dash error', err); }
      }

      /* ========= Plantel ========= */
      async function renderRoster(){
        try{
          const {data}=await supa.from("players").select("*");
          const grid=document.getElementById('rosterGrid'); grid.innerHTML="";
          (data||[]).forEach(p=>{
            const c=document.createElement("div"); c.className="card";
            c.innerHTML=`<strong>${p.nombre}</strong><br/>${p.apodo||""}<br/><span>${p.posicion||""}</span>`;
            grid.appendChild(c);
          });
        }catch(err){ console.error('Roster error', err); }
      }

      /* ========= Seguimiento ========= */
      async function renderTrack(){
        try{
          const {data}=await supa.from("matches").select("*").order("datetime",{ascending:false});
          const wrap=document.getElementById("trackList"); wrap.innerHTML="";
          (data||[]).forEach(m=>{
            const d=new Date(m.datetime);
            const div=document.createElement("div"); div.className="card";
            div.innerHTML=`<strong>${m.title||'Partido'}</strong><br/>
              ${d.toLocaleDateString("es-CL",{weekday:'short',day:'2-digit',month:'short'})}<br/>
              Goleadora: ${m.Goleadora||"-"}`;
            wrap.appendChild(div);
          });
        }catch(err){ console.error('Track error', err); }
      }

      /* ========= Eventos (mensual) ========= */
      let monthCursor = new Date(); // mes que se muestra
      const monthTitle = document.getElementById('monthTitle');
      const monthGrid  = document.getElementById('monthGrid');
      const btnPrev = document.getElementById('btnPrev');
      const btnNext = document.getElementById('btnNext');
      const btnToday= document.getElementById('btnToday');

      btnPrev.onclick=()=>{ monthCursor.setMonth(monthCursor.getMonth()-1); renderMonth(); };
      btnNext.onclick=()=>{ monthCursor.setMonth(monthCursor.getMonth()+1); renderMonth(); };
      btnToday.onclick=()=>{ monthCursor = new Date(); renderMonth(); };

      let editId = null; // para modal
      const mdl = document.getElementById('mdl');
      const openModal=()=>mdl.classList.add('show');
      const closeModal=()=>{ mdl.classList.remove('show'); editId=null; };
      document.getElementById('btnCancel').onclick=closeModal;

      async function renderMonth(){
        try{
          monthTitle.textContent = fmtMonthTitle(monthCursor);
          monthGrid.innerHTML = "";

          // rango del mes visible
          const y=monthCursor.getFullYear(), m=monthCursor.getMonth();
          const monthStart = new Date(y,m,1);
          const monthEnd   = new Date(y,m+1,1);

          // Traemos todo del mes (con un pequeÃ±o margen por seguridad)
          const { data: events } = await supa
            .from("events")
            .select("*")
            .gte("datetime", new Date(y,m,1).toISOString())
            .lt("datetime", new Date(y,m+1,1).toISOString())
            .order("datetime",{ascending:true});

          // Construye grilla 7x(sem)
          // Encontrar lunes anterior al 1 del mes
          const first = new Date(y,m,1);
          const offset = ( (first.getDay()+6) % 7 ); // 0= lunes
          const gridStart = new Date(y,m,1 - offset);
          // 6 filas * 7 = 42 casillas da holgura
          for(let i=0;i<42;i++){
            const d = new Date(gridStart); d.setDate(gridStart.getDate()+i);
            const col = document.createElement('div'); col.className='day-col';
            const head = document.createElement('div'); head.className='day-head';
            head.innerHTML = `<div><div class="dow">${fmtDay(d)}</div><div class="dnum">${fmtDnum(d)}</div></div>`;
            const actions = document.createElement('div'); actions.className='day-actions';
            const plus = document.createElement('button'); plus.className='day-plus'; plus.textContent='+';
            plus.onclick = ()=> openNewAt(d);
            actions.appendChild(plus);
            head.appendChild(actions);
            col.appendChild(head);

            const body = document.createElement('div'); body.className='day-body';

            (events||[]).forEach(e=>{
              const ed = new Date(e.datetime);
              if(isSameDay(ed, d)){
                const tag = document.createElement('div');
                tag.className = 'ev ' + (e.type==='Partido'?'match':'train');
                tag.innerHTML = `<div class="title">${e.title}</div>`;
                tag.onclick = ()=> openEdit(e);
                body.appendChild(tag);
              }
            });

            col.appendChild(body);
            // Atenuar dÃ­as que no son del mes visible
            if(d.getMonth()!==m){ col.style.opacity='0.45'; }
            monthGrid.appendChild(col);
          }
        }catch(err){ console.error('Month error', err); }
      }

      // BotÃ³n global
      document.getElementById('btnNewEvent').onclick = ()=> openNewAt(new Date());

      // Modal helpers
      const f = {
        title: document.getElementById('fTitle'),
        dt:    document.getElementById('fDatetime'),
        type:  document.getElementById('fType'),
        team:  document.getElementById('fTeam'),
        opp:   document.getElementById('fOpponent'),
        uni:   document.getElementById('fUniform'),
        loc:   document.getElementById('fLocation'),
        del:   document.getElementById('btnDelete'),
        save:  document.getElementById('btnSave'),
        ttl:   document.getElementById('dlgTitle'),
      };

      function seedForm(e){
        f.title.value = e?.title || '';
        f.dt.value = e?.datetime ? new Date(e.datetime).toISOString().slice(0,16) : '';
        f.type.value = e?.type || 'Entrenamiento';
        f.team.value = e?.team || 'Golden Moms';
        f.opp.value  = e?.opponent || '';
        f.uni.value  = e?.uniform || '';
        f.loc.value  = e?.location || '';
      }

      function openNewAt(date){
        editId = null;
        f.ttl.textContent='Nuevo evento';
        seedForm({ type:'Entrenamiento', team:'Golden Moms', datetime: date.toISOString() });
        f.dt.value = new Date(date).toISOString().slice(0,16);
        f.del.style.display='none';
        openModal();
      }
      function openEdit(e){
        editId = e.id;
        f.ttl.textContent='Editar evento';
        seedForm(e);
        f.del.style.display='';
        openModal();
      }

      f.del.onclick = async ()=>{
        if(!editId) return;
        if(!confirm('Â¿Eliminar evento?')) return;
        await supa.from('events').delete().eq('id', editId);
        closeModal(); renderMonth(); renderDash();
      };

      f.save.onclick = async ()=>{
        const payload = {
          title: f.title.value.trim(),
          datetime: new Date(f.dt.value).toISOString(),
          type: f.type.value,
          team: f.team.value.trim(),
          opponent: f.opp.value.trim() || null,
          uniform: f.uni.value || null,
          location: f.loc.value.trim() || null,
        };
        if(!payload.title || !payload.datetime){ alert('Falta tÃ­tulo o fecha/hora'); return; }
        if(editId){
          await supa.from('events').update(payload).eq('id', editId);
        }else{
          await supa.from('events').insert([payload]);
        }
        closeModal(); renderMonth(); renderDash();
      };

      // Inicial
      showView('dash');
    } catch (err) {
      console.error('Fatal init error', err);
      alert('OcurriÃ³ un error inicializando la app. Revisa la consola del navegador.');
    }
  })();
});
</script>
</body>
</html>
