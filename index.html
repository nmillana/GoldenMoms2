<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Golden Moms ‚Äî Panel</title>
<link rel="icon" type="image/webp" href="Logo.webp"/>
<style>
:root{--blue:#0f3a78;--lime:#9BE22D;--ink:#0f172a;--b:#e2e8f0;--bg:#f7f8fa;--mut:#64748b;--red:#ef4444}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
a{color:inherit}
.top{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--b);z-index:10}
.topin{display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
.brand{display:flex;gap:10px;align-items:center}
.logo-img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue);object-fit:cover;object-position:center;background:#fff}
nav{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border:1px solid var(--b);border-radius:999px;background:#f8fafc;cursor:pointer}
.tab.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.container{max-width:1200px;margin:12px auto;padding:0 12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 20px #0000000a;padding:12px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{border:1px solid var(--b);background:#0f3a78;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.s{background:#f8fafc;color:var(--ink)}
.btn.d{background:var(--red);border-color:var(--red)}
.badge{font-size:11px;border:1px solid #cbd5e1;border-radius:999px;padding:2px 6px;background:#f8fafc;margin-right:4px}
.badge.bday{background:#fff0f5;border-color:#f472b6;color:#9d174d;font-weight:700}
input,select,textarea{padding:10px;border:1px solid var(--b);border-radius:10px;width:100%}
label{font-size:12px;color:#334155;font-weight:600}
hr{border:none;border-top:1px solid var(--b);margin:10px 0}
.chip{padding:6px 10px;border-radius:999px;border:1px solid var(--b);background:#f8fafc;font-weight:700;font-size:12px;margin:3px 4px;display:inline-flex;align-items:center;gap:6px}
.small{font-size:12px;color:#64748b}
.page{display:none}.page.active{display:block}
.grid7{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cell{background:#fff;border:1px solid var(--b);min-height:110px;border-radius:12px;padding:8px;position:relative}
.day{position:absolute;right:8px;top:6px;font-size:11px;color:#94a3b8}
.tag{font-size:10px;border:1px solid #0001;border-radius:999px;padding:2px 6px;display:inline-block;margin-bottom:4px}
.match{background:#e0edff;border-color:#b7d1ff;color:#0f3a78}
.train{background:#e9fbd0;border-color:#c6f28a;color:#2d5a00}
.event{font-size:13px;margin-bottom:6px;cursor:pointer}
.team{font-size:10px;background:#eaf7d7;border:1px solid #c8ef7a;border-radius:999px;padding:1px 6px;margin-left:6px;font-weight:700}
/* Modal */
.overlay{display:none;position:fixed;inset:0;background:#0006;align-items:center;justify-content:center;padding:12px;z-index:9999;overflow:auto}
.modal{max-width:900px;width:100%;background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 10px 30px #0003;padding:10px;max-height:92vh;overflow:auto}
.tabs{display:flex;gap:6px;margin-bottom:8px;position:sticky;top:0;background:#fff;padding-top:4px}
.tab2{padding:8px 12px;border:1px solid var(--b);border-radius:10px;background:#f8fafc;cursor:pointer}
.tab2.active{background:var(--blue);color:#fff;border-color:var(--blue)}
/* Roster */
.roster-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.player{border:1px solid var(--b);border-radius:12px;padding:10px}
.player h4{margin:4px 0}
/* Login */
.login-ov{display:flex;position:fixed;inset:0;background:#0b1220e6;align-items:center;justify-content:center;z-index:10000}
.login{max-width:420px;width:100%;background:#fff;border-radius:12px;border:1px solid var(--b);padding:16px;box-shadow:0 20px 60px #0006;text-align:center}
.login img{width:72px;height:72px;border-radius:12px;border:2px solid var(--blue);background:#fff;margin-bottom:8px}
</style>
</head>
<body>
<header class="top">
  <div class="topin">
    <div class="brand"><img class="logo-img" src="Logo.webp" alt="Golden Moms"/><strong>Golden <span style="color:var(--lime)">Moms</span></strong></div>
    <nav>
      <button class="tab active" data-page="dash">Dashboard</button>
      <button class="tab" data-page="events">Eventos</button>
      <button class="tab" data-page="roster">Plantel</button>
      <button class="tab" data-page="tracker">Seguimiento</button>
      <button class="tab" data-page="config">Configuraci√≥n</button>
    </nav>
  </div>
</header>

<main class="container">

  <section id="page-dash" class="page active">
    <div class="grid">
      <div class="card" style="grid-column:span 3"><h3>Pr√≥ximos</h3><div id="kUp">0</div></div>
      <div class="card" style="grid-column:span 3"><h3>Plantel</h3><div id="kPlayers">0</div></div>
      <div class="card" style="grid-column:span 3"><h3>Capitanas</h3><div id="kCap">0</div></div>
      <div class="card" style="grid-column:span 3"><h3>Partidos jugados</h3><div id="kMatches">0</div></div>
<div class="card" style="grid-column:span 6"><h3>Pr√≥ximos cumplea√±os</h3><div id="kBirths"></div></div>
    </div>
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button class="btn s" id="prev">&larr;</button>
          <div id="mlabel" style="min-width:200px;text-align:center;font-weight:800;color:#0f3a78"></div>
          <button class="btn s" id="next">&rarr;</button>
          <select id="fType"><option value="Todos">Todos</option><option value="Partido">Partidos</option><option value="Entrenamiento">Entrenamientos</option></select>
          <select id="fTeam"><option value="Todos">Todos</option><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select>
        </div>
        <div class="row">
          <button class="btn s" id="btnNew">Nuevo Evento</button>
        </div>
      </div>
      <div class="grid7"><div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div></div>
      <div id="grid" class="grid7"></div>
    </div>
  </section>

  <section id="page-events" class="page">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Eventos</strong>
        <button class="btn" id="btnNew2">Nuevo Evento</button>
      </div>
      <div id="elist"></div>
    </div>
  </section>

  <section id="page-roster" class="page">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Plantel ‚Äî Administraci√≥n</strong>
        <div class="row">
          <select id="fltTeam"><option value="Todos">Todos</option><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select>
          <select id="fltRole"><option value="Todos">Rol: Todos</option><option>Jugadora</option><option>Capitana</option><option>Admin</option></select>
          <button class="btn" id="btnAddPlayer">Agregar Jugadora</button>
        </div>
      </div>
      <div id="players" class="roster-grid"></div>
    </div>
  </section>

  <section id="page-tracker" class="page">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Seguimiento de Partidos</strong>
        <button class="btn s" id="btnAddMatch">Registrar resultado</button>
      </div>
      <div id="matches"></div>
    </div>
  </section>

  <section id="page-config" class="page">
    <div class="card">
      <strong>Configuraci√≥n</strong>
      <div id="accessMgr" class="card" style="margin-top:10px">
        <div class="row" style="justify-content:space-between"><strong>Accesos (Admin)</strong><span class="small">Define c√≥digo por jugadora para el login</span></div>
        <div id="accTable" class="small"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div style="min-width:220px">
          <label>Rol actual</label>
          <input id="currentRole" disabled/>
          <span class="small">Tu rol viene del plantel.</span>
        </div>
        <div style="min-width:220px">
          <label>Nombre de equipo</label>
          <input id="teamName"/>
        </div>
        <div style="min-width:220px">
          <label>C√≥digo de acceso (solo equipo)</label>
          <input id="accessCode"/>
          <span class="small">Solo *Admin* puede cambiarlo.</span>
        </div>
        <div class="row"><button class="btn s" id="btnReset">Reiniciar todo (local)</button></div>
      </div>
    </div>
  </section>

</main>

<!-- Modal Evento -->
<div id="ov" class="overlay">
  <div class="modal">
    <div class="row" style="justify-content:space-between"><strong id="evTitle">Evento</strong><button class="btn s" id="closeEv">Cerrar</button></div>
    <div class="tabs">
      <button class="tab2 active" data-pane="att">Asistencia</button>
      <button class="tab2" data-pane="det">Detalles</button>
      <button class="tab2" data-pane="conv">Convocatoria</button>
    </div>
    <div id="pane-att">
      <div class="row" style="justify-content:space-between">
        <div id="attCounts" class="row"></div>
        <label class="chip"><input type="checkbox" id="hideNo" checked> Ocultar ‚ùå</label>
      </div>
      <div id="attGrid"></div>
    </div>
    <div id="pane-det" style="display:none">
      <div class="row">
        <div style="flex:1;min-width:180px"><label>Tipo</label><select id="eType"><option>Partido</option><option>Entrenamiento</option></select></div>
        <div style="flex:2;min-width:220px"><label>T√≠tulo</label><input id="eTitle"/></div>
        <div style="flex:1;min-width:180px"><label>Equipo</label><select id="eTeam"><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select></div>
      </div>
      <div class="row">
        <div style="flex:1;min-width:180px"><label>Fecha y hora</label><input id="eDT" type="datetime-local"/></div>
        <div style="flex:1;min-width:180px"><label>Lugar</label><input id="eLoc"/></div>
        <div style="flex:1;min-width:180px"><label>Rival</label><input id="eOpp"/></div>
        <div style="flex:1;min-width:180px"><label>Uniforme</label><select id="eUni"><option value="">‚Äî</option><option>Polera azul</option><option>Polera verde lima</option></select></div>
      </div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <button class="btn d" id="btnDel">Eliminar</button>
        <span class="small">Capitana/Admin pueden editar detalles</span>
      </div>
    </div>
    <div id="pane-conv" style="display:none">
      <div class="row">
        <label>Filtrar por etiquetas de equipo:</label>
        <label class="chip"><input type="checkbox" id="cvMoms" checked> Moms</label>
        <label class="chip"><input type="checkbox" id="cvDreams" checked> Dreams</label>
        <label class="chip"><input type="checkbox" id="cvPower" checked> Power</label>
      </div>
      <div class="row">
        <button class="btn s" id="btnCopyWA">Copiar WhatsApp</button>
        <button class="btn s" id="btnRSVP">Link convocatoria</button>
        <button class="btn s" id="btnQuickWA">Recordatorio (1 clic)</button>
        <button class="btn s" id="btnICS">.ics</button>
      </div>
      <div class="small" id="convInfo"></div>
    </div>
  </div>
</div>

<!-- Modal Jugadora -->
<div id="ovP" class="overlay">
  <div class="modal">
    <div class="row" style="justify-content:space-between"><strong id="pTitle">Nueva jugadora</strong><button class="btn s" id="closeP">Cerrar</button></div>
    <div class="row">
      <div style="flex:2;min-width:240px"><label>Nombre</label><input id="pName"/></div>
      <div style="flex:1;min-width:160px"><label>Apodo</label><input id="pNick"/></div>
      <div style="flex:1;min-width:120px"><label>N√∫mero</label><input id="pNum" type="number"/></div>
    </div>
    <div class="row">
      <div style="flex:1;min-width:160px"><label>Fecha Nacimiento</label><input id="pBirth" type="date"/></div>
      <div style="flex:1;min-width:220px"><label>Rol</label><select id="pRole"><option>Jugadora</option><option>Capitana</option><option>Admin</option></select></div>
    </div>
    <div class="row">
      <label>Equipos:</label>
      <label class="chip">Moms <input type="checkbox" id="tMoms" checked></label>
      <label class="chip">Dreams <input type="checkbox" id="tDreams"></label>
      <label class="chip">Power <input type="checkbox" id="tPower"></label>
    </div>
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <button class="btn d" id="pDelete" style="display:none">Eliminar</button>
      <button class="btn" id="pSave">Guardar</button>
    </div>
  </div>
</div>

<!-- Login -->
<div id="loginOv" class="login-ov" style="display:none">
  <div class="login">
    <img src="Logo.webp" alt="Logo"/>
    <h3>Golden Moms ‚Äî Acceso</h3>
    <div class="row"><select id="lgPlayer"></select></div>
    <div class="row"><input id="lgCode" placeholder="C√≥digo de acceso"/></div>
    <div class="row" style="justify-content:center"><button class="btn" id="lgEnter">Entrar</button></div>
    <div class="small" id="lgHint"></div>
  </div>
</div>

<script>
// --- State ---
const KEY="gm-roster-v4";
let S={
  team:"Golden Moms",
  accessCode:"GOLDEN2025",
  players:[],
  events:[],
  att:{},
  matches:[],
  passes:{},
  auth:{ok:false,playerId:null,role:"Jugadora"}
};
try{const t=JSON.parse(localStorage.getItem(KEY)||"{}"); S={...S,...t};}catch{}
function save(){localStorage.setItem(KEY,JSON.stringify(S));}
function refreshLoginList(){ const sel=document.getElementById("lgPlayer"); if(!sel) return; sel.innerHTML=S.players.sort((a,b)=>a.name.localeCompare(b.name)).map(p=>`<option value="${p.id}">${p.name}</option>`).join(""); }

// Seed players if empty, include one Admin by default (Natalia como Admin)

// Cumplea√±os (ISO yyyy-mm-dd, a√±o referencial 2000)
const BIRTH = {
  "Javiera A":"2000-01-02",
  "Dani J":"2000-01-11",
  "Vero":"2000-01-29",
  "Antonella":"2000-02-06",
  "Marce":"2000-03-14",
  "Caro N":"2000-04-07",
  "Trini":"2000-04-10",
  "Chica":"2000-04-20",
  "Jean":"2000-05-05",
  "Myle":"2000-06-03",
  "Fran":"2000-06-21",
  "Jandi":"2000-07-14",
  "Caro G":"2000-07-24",
  "Janga":"2000-08-20",
  "Fabi":"2000-08-28",
  "Dani C":"2000-10-10",
  "Vale":"2000-10-11",
  "Pia":"2000-10-21",
  "Maca":"2000-10-25",
  "Isa":"2000-10-26",
  "Aurora":"2000-11-12",
  "Ale V":"2000-11-12",
  "Cata":"2000-12-08",
  "Male":"2000-12-10",
  "Carla":"2000-12-13",
  "Consu":"2000-12-23"
};
// Seed players if empty, include one Admin by default (Natalia como Admin)
if(!S.players.length){
  const base=["Ale V","Andre","Antonella","Aurora","Carla","Caro G","Caro N","Cata","Celsa","Chica","Consu","Consu S","Cote","Dani C","Dani J","Fabi","Fran","Gaby","Isa","Jandi","Janga","Javiera A","Javi C","Jean","Maca","Male","Marce","Myle","Paz","Pia","Pili","Vale","Vero","Natalia"];
  S.players = base.map((n,i)=>({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),name:n,nick:"",number:(i%30)+1,birth:(BIRTH[n]||""),teams:["Moms"],role:"Jugadora"}));
// A√±ade Trini si no existe pero viene con cumplea√±os
if(!S.players.find(p=>p.name==="Trini") && BIRTH["Trini"]){ S.players.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),name:"Trini",nick:"",number:99,birth:BIRTH["Trini"],teams:["Moms"],role:"Jugadora"}); }
  ["Dani J","Chica","Caro G"].forEach(n=>{const p=S.players.find(x=>x.name===n); if(p) p.role="Capitana";});
  const adm=S.players.find(p=>p.name==="Chica"); if(adm) adm.role="Admin";
  save();
}

// Seed schedule from fixture (LIFA 20:00, Wonder 20:00/21:00 como indica)
if(!S.events.length){
  function mk(y,m,d,h,mi){const t=new Date(y,m-1,d,h,mi);return new Date(t.getTime()-t.getTimezoneOffset()*60000).toISOString();}
  // Agosto 2025
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Sirio (Plan B)",team:"Golden Moms",datetime:mk(2025,8,7,20,0),location:"Sirio, Cancha 2",opponent:"Plan B",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Liga Amistoso (La Maisonnette vs Andree)",team:"Golden Moms",datetime:mk(2025,8,19,20,0),location:"La Maisonnette",opponent:"Andree",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Wonder Mom‚Äôs Cup (Queenelastair vs GM)",team:"Golden Moms",datetime:mk(2025,8,20,20,0),location:"Universidad de los Andes",opponent:"Queenelastair",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"LIFA",team:"Golden Moms",datetime:mk(2025,8,22,20,0),location:"Cancha USS",opponent:"‚Äî",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Liga Amistoso (Andree vs Trewela's)",team:"Golden Moms",datetime:mk(2025,8,28,21,0),location:"San Jorge",opponent:"Trewela's",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"LIFA",team:"Golden Moms",datetime:mk(2025,8,29,20,0),location:"Cancha USS",opponent:"‚Äî",uniform:""});
  // Septiembre 2025
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Wonder Mom‚Äôs Cup (British vs GM)",team:"Golden Moms",datetime:mk(2025,9,3,21,0),location:"Universidad de los Andes",opponent:"British",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Liga Amistoso (Everest vs Andree)",team:"Golden Moms",datetime:mk(2025,9,4,20,15),location:"Everest",opponent:"Andree",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Wonder Mom‚Äôs Cup (GM vs Osas de Osso)",team:"Golden Moms",datetime:mk(2025,9,24,21,0),location:"Universidad de los Andes",opponent:"Osas de Osso",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Liga Amistoso (Andree vs C√≠a de Mar√≠a Apoquindo)",team:"Golden Moms",datetime:mk(2025,9,25,20,0),location:"Andree",opponent:"C√≠a de Mar√≠a Apoquindo",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"LIFA",team:"Golden Moms",datetime:mk(2025,9,26,20,0),location:"Cancha USS",opponent:"‚Äî",uniform:""});
  // Octubre 2025
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Wonder Mom‚Äôs Cup (GM vs Mamajuana)",team:"Golden Moms",datetime:mk(2025,10,1,20,0),location:"Universidad de los Andes",opponent:"Mamajuana",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"LIFA",team:"Golden Moms",datetime:mk(2025,10,3,20,0),location:"Cancha USS",opponent:"‚Äî",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"LIFA",team:"Golden Moms",datetime:mk(2025,10,10,20,0),location:"Cancha USS",opponent:"‚Äî",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Wonder Mom‚Äôs Cup (GM vs Olguitas FC)",team:"Golden Moms",datetime:mk(2025,10,22,20,0),location:"Universidad de los Andes",opponent:"Olguitas FC",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"LIFA",team:"Golden Moms",datetime:mk(2025,10,24,20,0),location:"Cancha USS",opponent:"‚Äî",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Wonder Mom‚Äôs Cup (SNM Queens vs GM)",team:"Golden Moms",datetime:mk(2025,10,29,20,0),location:"Universidad de los Andes",opponent:"SNM Queens",uniform:""});
  // Noviembre 2025
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"LIFA",team:"Golden Moms",datetime:mk(2025,11,7,20,0),location:"Cancha USS",opponent:"‚Äî",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Wonder Mom‚Äôs Cup (Juanas vs GM)",team:"Golden Moms",datetime:mk(2025,11,12,20,0),location:"Universidad de los Andes",opponent:"Juanas",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"LIFA",team:"Golden Moms",datetime:mk(2025,11,14,20,0),location:"Cancha USS",opponent:"‚Äî",uniform:""});
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Wonder Mom‚Äôs Cup ‚Äî Semifinal",team:"Golden Moms",datetime:mk(2025,11,26,20,0),location:"Universidad de los Andes",opponent:"Semifinal",uniform:""});
  // Diciembre 2025
  S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Wonder Mom‚Äôs Cup ‚Äî Final",team:"Golden Moms",datetime:mk(2025,12,3,20,0),location:"Universidad de los Andes",opponent:"Final",uniform:""});
  save();
}

// Helpers
const q=(s)=>document.querySelector(s);
const qa=(s)=>Array.from(document.querySelectorAll(s));
function fmtMonth(d){return d.toLocaleDateString("es-CL",{month:"long",year:"numeric"})}
function toInput(iso){const d=new Date(iso);const p=n=>String(n).padStart(2,"0");return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`}
function fromInput(val){const d=new Date(val);return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString()}
function chipsTeams(arr){return arr.map(t=>`<span class="badge">${t}</span>`).join("")}


function playersBirthdayOn(dateObj){
  const m = dateObj.getMonth()+1, d = dateObj.getDate();
  return S.players.filter(p=>p.birth && (new Date(p.birth).getMonth()+1)==m && (new Date(p.birth).getDate())==d);
}

// Navigation
qa(".tab").forEach(b=>b.onclick=()=>{qa(".tab").forEach(x=>x.classList.remove("active")); b.classList.add("active"); qa(".page").forEach(p=>p.classList.remove("active")); q("#page-"+b.dataset.page).classList.add("active"); if(b.dataset.page==='dash') renderCal(); if(b.dataset.page==='events') renderEventList(); if(b.dataset.page==='roster') renderRoster(); if(b.dataset.page==='tracker') renderMatches(); if(b.dataset.page==='config') renderConfig();});

// Calendar
let view=new Date(); view.setDate(1);
function buildCells(y,m){const first=new Date(y,m,1),start=(first.getDay()+6)%7,days=new Date(y,m+1,0).getDate();const cells=[];for(let i=0;i<start;i++)cells.push(null);for(let d=1;d<=days;d++)cells.push(new Date(y,m,d));while(cells.length%7)cells.push(null);return cells;}
function renderCal(){
  q("#mlabel").textContent=fmtMonth(view);
  const FT=q("#fType").value, TM=q("#fTeam").value;
  const grid=q("#grid"); grid.innerHTML="";
  buildCells(view.getFullYear(),view.getMonth()).forEach(dd=>{
    const c=document.createElement("div"); c.className="cell";
    if(dd){
      c.innerHTML=`<div class="day">${dd.getDate()}</div>`;
      S.events.filter(e=>{const d=new Date(e.datetime);return d.getFullYear()==dd.getFullYear()&&d.getMonth()==dd.getMonth()&&d.getDate()==dd.getDate();})
        .filter(e=>(FT=="Todos"||e.type==FT)&&(TM=="Todos"||(e.team||"Golden Moms")==TM))
        .forEach(e=>{
          const t=document.createElement("div"); t.className="tag "+(e.type=="Partido"?"match":"train"); t.textContent=e.type; c.appendChild(t);
          const r=document.createElement("div"); r.className="event"; const d=new Date(e.datetime);
          r.innerHTML=`<strong>${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}</strong> ${e.title} <span class="team">${e.team||"Golden Moms"}</span>`;
          r.onclick=()=>openEvent(e.id); c.appendChild(r);
        });
      const bday=playersBirthdayOn(dd); if(bday.length){ const wrap=document.createElement("div"); wrap.className="small"; wrap.style.marginTop="4px"; wrap.innerHTML=bday.map(p=>`<span class=\"badge bday\">üéÇ ${p.name}</span>`).join(" "); c.appendChild(wrap);}
    }
    grid.appendChild(c);
  });
  q("#kUp").textContent=S.events.filter(e=>new Date(e.datetime)>=new Date()).length;
  q("#kPlayers").textContent=S.players.length;
  q("#kCap").textContent=S.players.filter(p=>p.role=="Capitana").length;
  q("#kMatches").textContent=S.matches.length;
  renderBirthdays();
}
q("#prev").onclick=()=>{view.setMonth(view.getMonth()-1);renderCal();}
q("#next").onclick=()=>{view.setMonth(view.getMonth()+1);renderCal();}
q("#fType").onchange=renderCal; q("#fTeam").onchange=renderCal;
q("#btnNew").onclick=()=>newEvent(); q("#btnNew2").onclick=()=>newEvent();

// Event modal
let cur=null;
function lockBody(){document.body.style.overflow='hidden';}
function unlockBody(){document.body.style.overflow='';}
function openEvent(id){cur=id; renderEventModal(); q("#ov").style.display="flex"; lockBody();}
q("#closeEv").onclick=()=>{q("#ov").style.display="none"; unlockBody();}
q("#ov").addEventListener("click",(e)=>{ if(e.target.id==="ov"){ q("#ov").style.display="none"; unlockBody(); } });
qa(".tab2").forEach(b=>b.onclick=()=>{qa(".tab2").forEach(x=>x.classList.remove("active")); qa("#pane-att,#pane-det,#pane-conv").forEach(p=>p.style.display="none"); b.classList.add("active"); q("#pane-"+b.dataset.pane).style.display="block";});

function canEdit(){ return S.auth?.role==="Capitana" || S.auth?.role==="Admin"; }

function renderEventModal(){
  const E=S.events.find(e=>e.id==cur); if(!E) return;
  q("#evTitle").textContent=`${E.type} ‚Äî ${E.title}`;
  const hideNo=q("#hideNo").checked;
  const A=S.att[E.id]||{};
  const counts={ok:0,mid:0,no:0,blank:0};
  const list=document.createElement("div"); list.style.display="grid"; list.style.gridTemplateColumns="repeat(auto-fill,minmax(260px,1fr))"; list.style.gap="8px";
  // FILTRO por etiqueta seg√∫n E.team (Moms/Dreams/Power)
  const tag=(E.team||"Golden Moms").replace("Golden ",""); // "Moms"/"Dreams"/"Power"
  const eligible=S.players.filter(p=>p.teams.includes(tag));
  eligible.forEach(p=>{
    const v=A[p.name]||"";
    if(v=="Asiste") counts.ok++; else if(v=="Duda") counts.mid++; else if(v=="No asiste") counts.no++; else counts.blank++;
    if(hideNo && v=="No asiste") return;
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<div class="row" style="justify-content:space-between"><div><strong>${p.name}</strong> <span class="small">(${p.nick||'‚Äî'})</span><br><span class="small">#${p.number} ${chipsTeams(p.teams)}</span></div><div class="small">${p.role}</div></div>
    <div class="row"><button class="btn s">‚úÖ</button><button class="btn s">‚ùî</button><button class="btn s">‚ùå</button></div>`;
    const [b1,b2,b3]=card.querySelectorAll("button");
    function set(val){const AA=S.att[E.id]||{}; AA[p.name]=val; S.att[E.id]=AA; save(); renderEventModal();}
    b1.onclick=()=>set("Asiste"); b2.onclick=()=>set("Duda"); b3.onclick=()=>set("No asiste");
    if(v=="Asiste") b1.style.background="#d9f99d"; if(v=="Duda") b2.style.background="#fef9c3"; if(v=="No asiste") b3.style.background="#fee2e2";
    list.appendChild(card);
  });
  q("#attGrid").innerHTML=""; q("#attGrid").appendChild(list);
  q("#attCounts").innerHTML=`<span class="chip">‚úÖ ${counts.ok}</span><span class="chip">‚ùî ${counts.mid}</span><span class="chip">‚ùå ${counts.no}</span><span class="chip">‚ñ´Ô∏è ${counts.blank}</span>`;
  q("#hideNo").onchange=()=>renderEventModal();

  // Detalles (solo cap/admin pueden editar)
  const editable = canEdit();
  ["eType","eTitle","eDT","eLoc","eOpp","eUni","eTeam"].forEach(id=>q("#"+id).disabled=!editable);
  q("#eType").value=E.type; q("#eTitle").value=E.title; q("#eDT").value=toInput(E.datetime); q("#eLoc").value=E.location||""; q("#eOpp").value=E.opponent||""; q("#eUni").value=E.uniform||""; q("#eTeam").value=E.team||"Golden Moms";
  q("#btnDel").style.display=editable?"inline-block":"none";
  const apply=()=>{ if(!editable) return; E.type=q("#eType").value; E.title=q("#eTitle").value; E.location=q("#eLoc").value; E.opponent=q("#eOpp").value; E.uniform=q("#eUni").value; E.team=q("#eTeam").value; save(); renderCal(); renderEventList(); renderEventModal(); };
  ["eType","eTitle","eLoc","eOpp","eUni","eTeam"].forEach(id=>q("#"+id).onchange=apply);
  q("#eDT").onchange=()=>{ if(!editable) return; E.datetime=fromInput(q("#eDT").value); save(); renderCal(); renderEventList();};
  q("#btnDel").onclick=()=>{ if(!editable || !confirm("Eliminar evento?")) return; S.events=S.events.filter(x=>x.id!==E.id); delete S.att[E.id]; save(); q("#ov").style.display="none"; unlockBody(); renderCal(); renderEventList();};

  // Convocatoria
  const selTeams = [];
  if(q("#cvMoms").checked) selTeams.push("Moms");
  if(q("#cvDreams").checked) selTeams.push("Dreams");
  if(q("#cvPower").checked) selTeams.push("Power");
  const convocadas=S.players.filter(p=>p.teams.some(t=>selTeams.includes(t)));
  const when=new Date(E.datetime).toLocaleString('es-CL',{weekday:'long',day:'2-digit',month:'long',hour:'2-digit',minute:'2-digit'});
  q("#convInfo").textContent = `Convocatoria a ${convocadas.length} jugadoras (${selTeams.join(", ")}) ‚Äî ${when} ${E.location? " ¬∑ "+E.location:""}`;
  q("#btnCopyWA").onclick=()=>{
    const L=[`*${E.type}: ${E.title}* (${E.team||'Golden Moms'})`,`${when} ‚Äî ${E.location||''}`,`Uniforme: ${E.uniform||'‚Äî'} ¬∑ Calcetines: verde lima`,"","*Convocadas*"];
    convocadas.forEach(p=>L.push("‚ñ´Ô∏è "+p.name+(p.nick? " (‚Äú"+p.nick+"‚Äù)": "")));
    navigator.clipboard.writeText(L.join("\n")); alert("Resumen copiado");
  };
  q("#btnQuickWA").onclick=()=>{
    const url=location.origin+location.pathname+'#rsvp='+encodeURIComponent(JSON.stringify({id:E.id,t:S.team}));
    const text = `*${E.type}: ${E.title}* (${E.team||'Golden Moms'})%0A${when} ‚Äî ${E.location||''}%0AUniforme: ${E.uniform||'‚Äî'} ¬∑ Calcetines: verde lima%0AConfirma aqu√≠: ${encodeURI(url)}`;
    window.open('https://wa.me/?text='+text, '_blank');
  };
  q("#btnRSVP").onclick=()=>{
    const url=location.origin+location.pathname+'#rsvp='+encodeURIComponent(JSON.stringify({id:E.id,t:S.team}));
    const when=new Date(E.datetime).toLocaleString('es-CL',{weekday:'long',day:'2-digit',month:'long',hour:'2-digit',minute:'2-digit'});
    const msg = `*${E.type}: ${E.title}* (${E.team||'Golden Moms'})%0A${when} ‚Äî ${E.location||''}%0AUniforme: ${E.uniform||'‚Äî'} ¬∑ Calcetines: verde lima%0AConfirma aqu√≠: ${encodeURI(url)}`;
    // abrir wa.me y adem√°s dejarlo en el portapapeles
    navigator.clipboard.writeText(decodeURIComponent(msg));
    window.open('https://wa.me/?text='+msg, '_blank');
  };
  q("#btnICS").onclick=()=>{
    const st=new Date(E.datetime), mins=(E.type=="Partido"?120:90), en=new Date(st.getTime()+mins*60000);
    const icsDate=(d)=>new Date(d).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z");
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//GM//Org//ES','CALSCALE:GREGORIAN','BEGIN:VEVENT',
      'UID:'+E.id+'@gm','DTSTAMP:'+icsDate(new Date()),'DTSTART:'+icsDate(st),'DTEND:'+icsDate(en),
      'SUMMARY:'+E.title+' ('+(E.team||'Golden Moms')+')','LOCATION:'+(E.location||'').replace(/,/g,'\\,'),
      'DESCRIPTION:Uniforme '+(E.uniform||'‚Äî')+' | Calcetines: verde lima','END:VEVENT','END:VCALENDAR'].join('\r\n');
    const u=URL.createObjectURL(new Blob([lines],{type:"text/calendar"})); const a=document.createElement("a"); a.href=u; a.download=(E.title||"evento")+".ics"; a.click(); URL.revokeObjectURL(u);
  };
}

// Event list
function renderEventList(){
  const box=q("#elist"); box.innerHTML="";
  [...S.events].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)).forEach(E=>{
    const when=new Date(E.datetime).toLocaleString('es-CL',{weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
    const div=document.createElement("div"); div.className="card";
    div.innerHTML=`<div class="row" style="justify-content:space-between"><div><span class="badge">${E.type}</span> <strong>${E.title}</strong> <span class="badge">${E.team}</span><br><span class="small">${when} ¬∑ ${E.location||''}</span></div><div class="row"><button class="btn s">Abrir</button></div></div>`;
    div.querySelector("button").onclick=()=>openEvent(E.id);
    box.appendChild(div);
  });
}

// New event
function newEvent(){
  const id=crypto.randomUUID?.()||(""+Math.random()).slice(2);
  const now=new Date(); now.setMinutes(0,0,0);
  const E={id,type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString(),location:"",opponent:"",uniform:""};
  S.events.push(E); save(); renderCal(); renderEventList(); openEvent(id);
}

// Roster
function renderRoster(){
  const box=q("#players"); box.innerHTML="";
  const tf=q("#fltTeam").value, rf=q("#fltRole").value;
  S.players.filter(p=>(tf=="Todos"||p.teams.includes(tf.replace("Golden ","")))&&(rf=="Todos"||p.role==rf))
    .sort((a,b)=>a.name.localeCompare(b.name))
    .forEach(p=>{
      const d=document.createElement("div"); d.className="player";
      d.innerHTML=`<h4>${p.name} <span class="small">(${p.nick||"‚Äî"})</span></h4>
      <div class="small">#${p.number} ¬∑ ${p.birth? new Date(p.birth).toLocaleDateString("es-CL",{day:"2-digit",month:"short"}):"‚Äî"} ¬∑ Rol: ${p.role} ${p.birth? `<span class="badge bday">üéÇ ${new Date(p.birth).toLocaleDateString("es-CL",{day:"2-digit",month:"short"})}</span>`:""}</div>
      <div>${chipsTeams(p.teams)}</div>
      <div class="row" style="margin-top:6px"><button class="btn s">Editar</button></div>`;
      d.querySelector("button").onclick=()=>openPlayer(p.id);
      box.appendChild(d);
    });
}
q("#fltTeam").onchange=renderRoster; q("#fltRole").onchange=renderRoster;
q("#btnAddPlayer").onclick=()=>openPlayer(null);

let curP=null;
function openPlayer(id){
  if(!(S.auth?.role==="Admin"||S.auth?.role==="Capitana")){ alert("Solo Capitana/Admin pueden editar el plantel."); return; }
  curP=id;
  const p=id? S.players.find(x=>x.id==id) : {id:null,name:"",nick:"",number:"",birth:"",teams:["Moms"],role:"Jugadora"};
  q("#pTitle").textContent=id? "Editar jugadora":"Nueva jugadora";
  q("#pName").value=p.name||""; q("#pNick").value=p.nick||""; q("#pNum").value=p.number||""; q("#pBirth").value=p.birth||""; q("#pRole").value=p.role||"Jugadora"; q("#pRole").disabled = !(S.auth&&S.auth.role==="Admin");
  q("#tMoms").checked=p.teams.includes("Moms"); q("#tDreams").checked=p.teams.includes("Dreams"); q("#tPower").checked=p.teams.includes("Power");
  q("#pDelete").style.display=id? "inline-block":"none";
  q("#ovP").style.display="flex"; lockBody();
}
q("#closeP").onclick=()=>{q("#ovP").style.display="none"; unlockBody();}
q("#pDelete").onclick=()=>{ if(!confirm("¬øEliminar jugadora?")) return; S.players=S.players.filter(x=>x.id!==curP); save(); q("#ovP").style.display="none"; unlockBody(); renderRoster();};
q("#pSave").onclick=()=>{
  const getTeams=()=>{const arr=[]; if(q("#tMoms").checked)arr.push("Moms"); if(q("#tDreams").checked)arr.push("Dreams"); if(q("#tPower").checked)arr.push("Power"); return arr;}
  if(curP){ const p=S.players.find(x=>x.id==curP); p.name=q("#pName").value.trim(); p.nick=q("#pNick").value.trim(); p.number=q("#pNum").value; p.birth=q("#pBirth").value; p.role=q("#pRole").value; p.teams=getTeams(); }
  else{ const p={id:crypto.randomUUID?.()||(""+Math.random()).slice(2),name:q("#pName").value.trim(),nick:q("#pNick").value.trim(),number:q("#pNum").value,birth:q("#pBirth").value,role:q("#pRole").value,teams:getTeams()}; S.players.push(p); }
  save(); q("#ovP").style.display="none"; unlockBody(); renderRoster();
}

// Matches
function renderMatches(){
  const box=q("#matches"); box.innerHTML="";
  if(!S.matches.length){ box.innerHTML='<div class="small">A√∫n sin resultados cargados.</div>'; }
  [...S.matches].sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(M=>{
    const res = M.our>M.their? "Victoria" : M.our<M.their? "Derrota" : "Empate";
    const d=document.createElement("div"); d.className="card";
    d.innerHTML=`<div class="row" style="justify-content:space-between">
      <div><strong>${new Date(M.date).toLocaleDateString('es-CL')} ¬∑ ${M.opponent}</strong> <span class="badge">${res}</span><br><span class="small">${M.our} - ${M.their}</span><br><span class="small">${M.notes||''}</span></div>
      <div class="row"><button class="btn s">Editar</button><button class="btn d">Borrar</button></div>
    </div>`;
    const [eDel,eBor]=d.querySelectorAll("button"); eDel.onclick=()=>editMatch(M.id); eBor.onclick=()=>{if(confirm('¬øEliminar?')){S.matches=S.matches.filter(x=>x.id!==M.id); save(); renderMatches();}};
    box.appendChild(d);
  });
}
q("#btnAddMatch").onclick=()=>editMatch(null);
function editMatch(id){
  if(!(S.auth?.role==="Admin"||S.auth?.role==="Capitana")) { alert("Solo Capitana/Admin pueden registrar resultados."); return; }
  const M=id? S.matches.find(x=>x.id==id) : {id:null,date:new Date().toISOString().slice(0,10),opponent:"",our:0,their:0,notes:""};
  const html=`<div class="modal"><div class="row" style="justify-content:space-between"><strong>${id?'Editar':'Registrar'} partido</strong><button class="btn s" id="x">Cerrar</button></div>
    <div class="row"><div style="flex:1"><label>Fecha</label><input id="mDate" type="date" value="${M.date.slice(0,10)}"/></div>
    <div style="flex:1"><label>Rival</label><input id="mOpp" value="${M.opponent}"/></div>
    <div style="flex:1"><label>Nosotras</label><input id="mOur" type="number" value="${M.our}"/></div>
    <div style="flex:1"><label>Ellas</label><input id="mTheir" type="number" value="${M.their}"/></div></div>
    <div><label>Notas</label><textarea id="mNotes">${M.notes||''}</textarea></div>
    <div class="row" style="justify-content:space-between;margin-top:8px"><button class="btn s" id="mSave">Guardar</button><button class="btn d" id="mDel" ${id?'':'style="display:none"'}>Eliminar</button></div></div>`;
  const ov=document.createElement("div"); ov.className="overlay"; ov.style.display="flex"; ov.innerHTML=html; document.body.appendChild(ov); lockBody();
  ov.querySelector("#x").onclick=()=>{document.body.removeChild(ov); unlockBody();};
  ov.querySelector("#mSave").onclick=()=>{ if(id){ M.date=ov.querySelector('#mDate').value; M.opponent=ov.querySelector('#mOpp').value; M.our=+ov.querySelector('#mOur').value; M.their=+ov.querySelector('#mTheir').value; M.notes=ov.querySelector('#mNotes').value; } else { const N={id:crypto.randomUUID?.()||(""+Math.random()).slice(2),date:ov.querySelector('#mDate').value,opponent:ov.querySelector('#mOpp').value,our:+ov.querySelector('#mOur').value,their:+ov.querySelector('#mTheir').value,notes:ov.querySelector('#mNotes').value}; S.matches.push(N);} save(); document.body.removeChild(ov); unlockBody(); renderMatches(); };
  ov.querySelector("#mDel")?.addEventListener('click',()=>{ if(confirm('¬øEliminar?')){ S.matches=S.matches.filter(x=>x.id!==id); save(); document.body.removeChild(ov); unlockBody(); renderMatches(); } });
}

// Config

function renderConfig(){
  q("#teamName").value=S.team;
  q("#currentRole").value=S.auth?.role||"‚Äî";
  q("#accessCode").value=S.accessCode;
  // Access manager
  const box=q("#accTable");
  if(!(S.auth&&S.auth.role==="Admin")){ q("#accessMgr").style.display="none"; }
  else{
    q("#accessMgr").style.display="block";
    const rows=S.players.sort((a,b)=>a.name.localeCompare(b.name)).map(p=>{
      const pass=(S.passes&&S.passes[p.id])||"";
      return `<div class="row" style="margin:4px 0;align-items:center"><div style="min-width:220px"><strong>${p.name}</strong> <span class="small">(${p.role})</span></div><input data-p="${p.id}" class="acc-input" placeholder="c√≥digo de acceso" value="${pass}"/></div>`;
    }).join("");
    box.innerHTML=rows;
    qa(".acc-input").forEach(inp=>inp.onchange=()=>{ const pid=inp.getAttribute("data-p"); S.passes=S.passes||{}; S.passes[pid]=inp.value.trim(); save(); });
  }
  // Impersonar (solo Admin) ‚Äî selector de rol temporal
  if(S.auth&&S.auth.role==="Admin"){
    if(!q("#impWrap")){
      const wrap=document.createElement("div"); wrap.id="impWrap"; wrap.className="row"; wrap.innerHTML=`<label>Ver como:</label>
        <select id="impSel"><option>Admin</option><option>Capitana</option><option>Jugadora</option></select>
        <button class="btn s" id="impBtn">Aplicar</button>`;
      q("#page-config").querySelector(".card").appendChild(wrap);
      q("#impBtn").onclick=()=>{ const v=q("#impSel").value; S.auth.role=v; save(); renderConfig(); alert("Modo **"+v+"** activo (temporal)"); };
    }
  }else{ const w=q("#impWrap"); if(w) w.remove(); }
  // Guardado de team & access code (solo Admin)
  const canEdit=S.auth&&S.auth.role==="Admin";
  ["teamName","accessCode"].forEach(id=>q("#"+id).disabled=!canEdit);
}
q("#teamName").onchange=()=>{ S.team=q("#teamName").value; save(); };
q("#accessCode").onchange=()=>{ if(S.auth.role!=="Admin") return; S.accessCode=q("#accessCode").value.trim()||S.accessCode; save(); };
q("#btnReset").onclick=()=>{ if(!confirm("Esto borra todos los datos locales. ¬øContinuar?")) return; localStorage.removeItem(KEY); location.reload(); };

// Login
function showLogin(){
  const sel=q("#lgPlayer"); sel.innerHTML=S.players.map(p=>`<option value="${p.id}">${p.name} ‚Äî ${p.role}</option>`).join("");
  q("#loginOv").style.display="flex";
  q("#lgHint").textContent="El rol se asigna seg√∫n el plantel. Ingresa el c√≥digo del equipo.";
}
function checkAuth(){ if(S.auth && S.auth.ok) return true; showLogin(); return false; }

q("#lgEnter").onclick=()=>{
  const code=(q("#lgCode").value||"").trim();
  const pid=q("#lgPlayer").value;
  const pl=S.players.find(p=>p.id===pid);
  if(!pl){ q("#lgHint").textContent="Selecciona tu nombre del plantel"; return; }
  const pass=(S.passes&&S.passes[pid])||S.accessCode||"";
  if(code!==pass){ q("#lgHint").textContent="C√≥digo incorrecto"; return; }
  S.auth={ok:true,playerId:pl.id,role:pl.role};
  save();
  q("#loginOv").style.display="none";
  renderCal(); renderEventList(); renderRoster(); renderMatches(); renderConfig();
};


function nextOccur(iso){
  if(!iso) return null;
  const [y,m,d]=iso.split('-').map(Number);
  const now=new Date();
  const year=now.getMonth()+1 > m || (now.getMonth()+1==m && now.getDate()>d) ? now.getFullYear()+1 : now.getFullYear();
  return new Date(year, m-1, d);
}
function renderBirthdays(){
  const arr = S.players.filter(p=>p.birth).map(p=>({p, when: nextOccur(p.birth)})).sort((a,b)=>a.when-b.when).slice(0,5);
  const box=document.getElementById("kBirths");
  if(!arr.length){ box.textContent="‚Äî"; return; }
  box.innerHTML = arr.map(x=>`<div class="row"><span class="badge bday">üéÇ</span> <strong>${x.p.name}</strong> <span class="small">${x.when.toLocaleDateString('es-CL',{weekday:'short',day:'2-digit',month:'short'})}</span></div>`).join("");
}

// Init
if(!checkAuth()){ } else { renderCal(); renderEventList(); renderRoster(); renderMatches(); renderConfig(); }
</script>
</body>
</html>
