<!-- ========== EVENTOS (reemplazar tu sección v-events completa por esta) ========== -->
<section id="v-events" style="display:none">
  <style>
    /* ====== Eventos: estilos locales ====== */
    #eventsWrap{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    #monthLbl{font-weight:800;font-size:18px}
    .ev-btn{border:1px solid var(--b);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .ev-btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
    .ev-cal{
      display:grid;gap:10px;
      grid-template-columns:repeat(7,1fr)
    }
    .ev-day{
      background:#fff;border:1px solid var(--b);border-radius:12px;
      min-height:140px;padding:8px;position:relative;overflow:hidden
    }
    .ev-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .ev-dow{color:var(--mut);font-size:12px}
    .ev-num{font-weight:800}
    .ev-add{border:1px dashed var(--b);border-radius:10px;width:26px;height:26px;line-height:24px;text-align:center;font-weight:700;color:var(--mut);cursor:pointer;background:#fff}
    .ev-card{
      margin:6px 0 0 0;padding:8px;border-radius:10px;border:1px solid #0001;
      font-size:13px;font-weight:400;cursor:pointer
    }
    /* Colores por tipo */
    .is-train{background:#ccfb90;border-color:#a3e635}     /* verde lima más fuerte */
    .is-match{background:#ddebff;border-color:#b7d1ff}     /* azul predominante */
    /* Evitar negrita del título */
    .ev-title{font-weight:400}

    /* ====== Responsive ====== */
    @media (max-width:1100px){ .ev-cal{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:720px){  .ev-cal{grid-template-columns:1fr} }
  </style>

  <!-- Barra superior de navegación de mes -->
  <div id="eventsWrap">
    <button id="btnPrevMonth" class="ev-btn">◀</button>
    <div id="monthLbl">—</div>
    <button id="btnNextMonth" class="ev-btn">▶</button>
    <div style="flex:1"></div>
    <button id="btnToday" class="ev-btn">Hoy</button>
    <button id="btnNewEvent" class="ev-btn p">Nuevo Evento</button>
  </div>

  <!-- Calendario -->
  <div id="calMonth" class="ev-cal"></div>

  <!-- Modal Crear/Editar -->
  <dialog id="evModal" style="border:none;border-radius:12px;padding:0;max-width:520px;width:calc(100% - 24px)">
    <form method="dialog" id="evForm" style="padding:14px">
      <h3 id="evModalTitle" style="margin:0 0 10px 0">Nuevo evento</h3>
      <input type="hidden" id="f_id"/>
      <div style="display:grid;gap:10px">
        <label>Título
          <input id="f_title" class="ev-in" placeholder="Ej: Entrenamiento Colegio" style="width:100%;padding:8px;border:1px solid var(--b);border-radius:8px"/>
        </label>

        <label>Tipo
          <select id="f_type" style="width:100%;padding:8px;border:1px solid var(--b);border-radius:8px">
            <option>Entrenamiento</option>
            <option>Partido</option>
          </select>
        </label>

        <div style="display:grid;gap:10px;grid-template-columns:1fr 1fr">
          <label>Fecha y hora
            <input id="f_datetime" type="datetime-local" style="width:100%;padding:8px;border:1px solid var(--b);border-radius:8px"/>
          </label>
          <label>Equipo
            <input id="f_team" value="Golden Moms" style="width:100%;padding:8px;border:1px solid var(--b);border-radius:8px"/>
          </label>
        </div>

        <label>Rival (si aplica)
          <input id="f_opponent" placeholder="Rivales / Liga" style="width:100%;padding:8px;border:1px solid var(--b);border-radius:8px"/>
        </label>

        <label>Uniforme
          <select id="f_uniform" style="width:100%;padding:8px;border:1px solid var(--b);border-radius:8px">
            <option value="">(definir)</option>
            <option>Polera azul</option>
            <option>Polera verde lima</option>
          </select>
          <div style="color:var(--mut);font-size:12px;margin-top:4px">* Siempre medias verde lima</div>
        </label>

        <label>Ubicación
          <input id="f_location" placeholder="Colegio / Cancha / Dirección" style="width:100%;padding:8px;border:1px solid var(--b);border-radius:8px"/>
        </label>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
        <button class="ev-btn" id="btnDelete" type="button" style="display:none;border-color:#fecaca;background:#fee2e2">Eliminar</button>
        <button class="ev-btn" id="btnCancel" type="button">Cancelar</button>
        <button class="ev-btn p" id="btnSave" type="submit">Guardar</button>
      </div>
    </form>
  </dialog>

  <script>
    /* ================== Eventos: lógica ================== */
    // Re-usa tu cliente supa ya creado arriba:
    // const supa = supabase.createClient(SUPA.url, SUPA.key);

    const tz = "America/Santiago"; // evitar corrimientos
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

    const calEl  = $("#calMonth");
    const monthLbl = $("#monthLbl");
    let cursor = new Date();   // mes mostrado
    cursor.setDate(1);

    // Helpers
    const fmtMonth = (d)=>
      d.toLocaleDateString("es-CL",{month:"long",year:"numeric", timeZone: tz});
    const startOfWeekIndex = 1; // lunes

    function firstDayGrid(d){
      const x = new Date(d);
      const dow = (x.getDay()+6)%7; // L=0..D=6
      x.setDate(x.getDate() - ((dow - startOfWeekIndex + 7)%7));
      return x;
    }
    const toLocalDayKey = (iso)=>{
      // clave YYYY-MM-DD en zona CL
      const dt = new Date(iso);
      const y = dt.toLocaleString("en-CA",{year:"numeric", timeZone: tz});
      const m = dt.toLocaleString("en-CA",{month:"2-digit", timeZone: tz});
      const d = dt.toLocaleString("en-CA",{day:"2-digit", timeZone: tz});
      return `${y}-${m}-${d}`;
    }
    const dayKeyFromDate = (d)=>{
      const y = d.toLocaleString("en-CA",{year:"numeric", timeZone: tz});
      const m = d.toLocaleString("en-CA",{month:"2-digit", timeZone: tz});
      const dd= d.toLocaleString("en-CA",{day:"2-digit", timeZone: tz});
      return `${y}-${m}-${dd}`;
    }

    // Render
    async function renderMonth(){
      monthLbl.textContent = capitalize(fmtMonth(cursor));
      calEl.innerHTML = "";

      const monthStart = new Date(cursor);
      const monthEnd   = new Date(cursor.getFullYear(), cursor.getMonth()+1, 0);

      // rango extendido para cubrir grilla (6 semanas máx)
      const gridStart = firstDayGrid(monthStart);
      const gridDays = 42; // 6 filas

      // Cargar eventos del rango (en UTC pero convertimos al agrupar)
      const fromISO = new Date(gridStart);
      const toISO = new Date(gridStart); toISO.setDate(toISO.getDate()+gridDays);

      const { data: events, error } = await supa
        .from("events")
        .select("*")
        .gte("datetime", fromISO.toISOString())
        .lt("datetime", toISO.toISOString())
        .order("datetime", { ascending: true });

      if(error){ console.error(error); }

      // Agrupar por día (en TZ CL)
      const byDay = {};
      (events||[]).forEach(e=>{
        const k = toLocalDayKey(e.datetime);
        (byDay[k] ??= []).push(e);
      });

      // Construir celdas
      const DOW = ["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"];
      for(let i=0;i<gridDays;i++){
        const d = new Date(gridStart); d.setDate(d.getDate()+i);
        const key = dayKeyFromDate(d);

        const cell = document.createElement("div");
        cell.className = "ev-day";

        // header día
        const hdr = document.createElement("div");
        hdr.className = "ev-hdr";
        hdr.innerHTML = `
          <div>
            <div class="ev-dow">${DOW[(d.getDay()+6)%7]}</div>
            <div class="ev-num">${d.getDate()}</div>
          </div>
          <button class="ev-add" title="Nuevo">+</button>
        `;
        hdr.querySelector(".ev-add").onclick = ()=> openModalForNew(d);
        cell.appendChild(hdr);

        // tarjetas
        (byDay[key]||[]).forEach(e=>{
          const tag = document.createElement("div");
          tag.className = "ev-card "+ (e.type==="Entrenamiento" ? "is-train":"is-match");
          tag.innerHTML = `<div class="ev-title">${escapeHTML(e.title||"(sin título)")}</div>`;
          tag.onclick = ()=> openModalForEdit(e);
          cell.appendChild(tag);
        });

        calEl.appendChild(cell);
      }
    }

    // Modal
    const dlg = $("#evModal");
    const f_id = $("#f_id"), f_title = $("#f_title"), f_type = $("#f_type"),
          f_datetime = $("#f_datetime"), f_team = $("#f_team"),
          f_opponent=$("#f_opponent"), f_uniform=$("#f_uniform"),
          f_location=$("#f_location");
    const btnDel = $("#btnDelete"), btnCancel=$("#btnCancel"), btnSave=$("#btnSave");

    function setModalData(e){
      $("#evModalTitle").textContent = e?.id ? "Editar evento" : "Nuevo evento";
      f_id.value = e?.id || "";
      f_title.value = e?.title || "";
      f_type.value  = e?.type || "Entrenamiento";
      // datetime-local en TZ local CL
      f_datetime.value = e?.datetime ? toLocalDatetimeLocal(e.datetime) : "";
      f_team.value = e?.team || "Golden Moms";
      f_opponent.value = e?.opponent || "";
      f_uniform.value = e?.uniform || "";
      f_location.value = e?.location || "";
      btnDel.style.display = e?.id ? "inline-flex":"none";
    }
    function openModalForNew(dayDate){
      const d = new Date(dayDate);
      // por defecto 19:30
      d.setHours(19,30,0,0);
      setModalData({ datetime: d.toISOString() });
      dlg.showModal();
    }
    function openModalForEdit(e){
      setModalData(e);
      dlg.showModal();
    }
    btnCancel.onclick = ()=> dlg.close();

    btnDel.onclick = async ()=>{
      if(!f_id.value) return;
      const { error } = await supa.from("events").delete().eq("id", f_id.value);
      if(error) alert("❌ No se pudo eliminar: "+error.message);
      dlg.close(); renderMonth();
    };

    $("#evForm").onsubmit = async (ev)=>{
      ev.preventDefault();
      const payload = {
        title: f_title.value?.trim(),
        type:  f_type.value,
        team:  f_team.value?.trim() || "Golden Moms",
        opponent: f_opponent.value?.trim() || null,
        uniform:  f_uniform.value || null,
        location: f_location.value?.trim() || null,
        datetime: fromLocalDatetimeLocal(f_datetime.value)  // a ISO
      };
      if(!payload.title || !payload.datetime){ alert("Falta título y/o fecha"); return; }

      let error;
      if(f_id.value){
        ({error} = await supa.from("events").update(payload).eq("id", f_id.value));
      }else{
        ({error} = await supa.from("events").insert([payload]));
      }
      if(error) alert("❌ Error al guardar: "+error.message);
      dlg.close(); renderMonth();
    };

    // Controles superiores
    $("#btnPrevMonth").onclick = ()=>{ cursor.setMonth(cursor.getMonth()-1); renderMonth(); };
    $("#btnNextMonth").onclick = ()=>{ cursor.setMonth(cursor.getMonth()+1); renderMonth(); };
    $("#btnToday").onclick     = ()=>{ const t=new Date(); cursor=new Date(t.getFullYear(),t.getMonth(),1); renderMonth(); };
    $("#btnNewEvent").onclick  = ()=> openModalForNew(new Date());

    // utilidades
    function escapeHTML(s){ return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
    function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

    function toLocalDatetimeLocal(iso){
      if(!iso) return "";
      const d = new Date(iso);
      // a texto local (TZ CL) para input datetime-local
      const y = d.toLocaleString("en-CA",{year:"numeric", timeZone: tz});
      const m = d.toLocaleString("en-CA",{month:"2-digit", timeZone: tz});
      const da= d.toLocaleString("en-CA",{day:"2-digit", timeZone: tz});
      const hh= d.toLocaleString("en-CA",{hour:"2-digit", hour12:false, timeZone: tz});
      const mi= d.toLocaleString("en-CA",{minute:"2-digit", timeZone: tz});
      return `${y}-${m}-${da}T${hh}:${mi}`;
    }
    function fromLocalDatetimeLocal(v){
      // interpreta valor local y lo convierte a ISO (manteniendo la hora local CL)
      if(!v) return null;
      // El input está en zona local del dispositivo; asumimos misma hora local => creamos Date local
      const d = new Date(v);
      return d.toISOString();
    }

    // Inicial
    renderMonth();
  </script>
</section>
