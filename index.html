<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms — Panel</title>
<link rel="icon" href="Logo.webp"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{
  --blue:#0f3a78;--lime:#9be22d;--ink:#0f172a;--mut:#64748b;
  --b:#e2e8f0;--bg:#f7f8fa;--ok:#d9f99d;--mid:#fef9c3;--no:#fee2e2;
  --chip:#eef2ff;--chip2:#ecfccb;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:inherit}
.btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer}
.btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
.btn.s{background:#f8fafc}
.badge{font-size:11px;border:1px solid var(--b);border-radius:999px;padding:2px 8px;background:#f8fafc}
.top{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.brand{display:flex;gap:10px;align-items:center}
.brand img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
.nav .tab.active{background:var(--blue);color:#fff}
.container{max-width:1200px;margin:14px auto;padding:0 12px}
/* ---------- Calendario mensual ---------- */
.head-row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.cal-month{font-size:24px;font-weight:800;margin-right:auto}
.month-nav{display:flex;gap:8px}
.month-nav button{border-radius:10px;border:1px solid var(--b);background:#fff;padding:6px 10px;cursor:pointer}
.week-head{display:grid;grid-template-columns:repeat(7,1fr);gap:12px;margin:8px 0 6px}
.week-head>div{text-align:center;font-weight:700;color:#0f3a78}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:12px}
.day{min-height:220px;background:#fff;border:1px solid var(--b);border-radius:14px;padding:8px;display:flex;flex-direction:column}
.day-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.day-num{font-weight:800}
.add-btn{width:28px;height:28px;border:1px solid var(--b);border-radius:50%;display:flex;align-items:center;justify-content:center;background:#fff;cursor:pointer;line-height:0}
.add-btn:hover{background:#f3f4f6}
.card{border:1px solid var(--b);border-radius:12px;padding:8px;background:var(--chip);box-shadow:0 8px 14px #0000000a;margin-bottom:8px;cursor:pointer}
.card.train{background:var(--chip2)}
.card .time{font-size:12px;color:#334155;margin-bottom:2px}
.card .title{font-weight:800}
.card .meta{font-size:12px;color:#475569}
.card .pin{font-size:12px}
.sticky-week{position:sticky;top:74px;z-index:15;background:var(--bg);padding-top:4px}
/* ---------- Modal ---------- */
.modal{position:fixed;inset:0;background:#0006;display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal.show{display:flex}
.sheet{width:100%;max-width:680px;background:#fff;border:1px solid var(--b);border-radius:16px;padding:16px}
.sheet h3{margin:0 0 10px 0}
.form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form .row{display:flex;flex-direction:column;gap:6px}
.form input,.form select,.form textarea{border:1px solid var(--b);border-radius:10px;padding:10px 12px;font:inherit}
.form textarea{min-height:80px;resize:vertical}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.actions .danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
@media (max-width: 900px){
  .cal-grid{grid-template-columns:1fr}
  .week-head{display:none}
  .sticky-week{top:58px}
  .day{min-height:120px}
  .form{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- Top -->
<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM"/>
    <div><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div class="nav">
    <button class="tab" data-view="dash" onclick="showView('dash')">Dashboard</button>
    <button class="tab active" data-view="events" onclick="showView('events')">Eventos</button>
    <button class="tab" data-view="roster" onclick="showView('roster')">Plantel</button>
    <button class="tab" data-view="track" onclick="showView('track')">Seguimiento</button>
  </div>
</div>

<div class="container">

  <!-- EVENTOS (mensual) -->
  <section id="v-events">
    <div class="head-row">
      <div class="cal-month" id="calMonth">Mes</div>
      <button class="btn s" id="btnToday">Hoy</button>
      <div class="month-nav">
        <button id="btnPrev">◀</button>
        <button id="btnNext">▶</button>
      </div>
      <button class="btn p" id="btnNew">Nuevo Evento</button>
    </div>

    <div class="sticky-week">
      <div class="week-head">
        <div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div>
      </div>
    </div>

    <div id="calGrid" class="cal-grid"></div>
  </section>
</div>

<!-- MODAL -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true">
    <h3 id="mTitle">Nuevo evento</h3>
    <div class="form">
      <div class="row">
        <label>Título</label>
        <input id="fTitle" placeholder="Ej: Entrenamiento Colegio"/>
      </div>
      <div class="row">
        <label>Tipo</label>
        <select id="fType">
          <option>Entrenamiento</option>
          <option>Partido</option>
        </select>
      </div>

      <div class="row">
        <label>Fecha y hora</label>
        <input id="fDateTime" type="datetime-local"/>
      </div>
      <div class="row">
        <label>Equipo</label>
        <input id="fTeam" value="Golden Moms"/>
      </div>

      <div class="row">
        <label>Rival (si aplica)</label>
        <input id="fOpponent" placeholder="Rivales / Liga"/>
      </div>
      <div class="row">
        <label>Uniforme</label>
        <select id="fUniform">
          <option value="">(definir)</option>
          <option>Polera azul</option>
          <option>Polera verde lima</option>
        </select>
      </div>

      <div class="row" style="grid-column:1/-1">
        <label>Ubicación</label>
        <input id="fLocation" placeholder="Colegio / Cancha / Dirección"/>
        <small style="color:#475569">* Siempre medias verde lima</small>
      </div>
    </div>

    <div class="actions">
      <button class="btn danger" id="btnDelete" style="display:none">Eliminar</button>
      <button class="btn s" id="btnCancel">Cancelar</button>
      <button class="btn p" id="btnSave">Guardar</button>
    </div>
  </div>
</div>

<script>
/* ========= SUPABASE ========= */
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};
const supa = supabase.createClient(SUPA.url, SUPA.key);

/* ========= Constantes ========= */
const TIMEZONE = 'America/Santiago';   // muestra SIEMPRE con la hora local de Santiago
let currentMonth = new Date();          // fecha “puntero” del calendario
let eventsCache = [];                   // para no re-consultar en cada click
let editingId = null;                   // id evento que se está editando

/* ========= Utilidades de fecha ========= */
// Convierte "YYYY-MM-DDTHH:mm" (local) a ISO (UTC) conservando la hora local elegida
function localInputToISO(dtLocal){
  const [d,t] = dtLocal.split('T');
  const [Y, M, D] = d.split('-').map(Number);
  const [h, m] = t.split(':').map(Number);
  const local = new Date(Y, M-1, D, h, m, 0);    // crea en zona local
  return local.toISOString();                    // a UTC para guardar en timestamptz
}
// Formatea un ISO/timestamptz a string con TZ CL
function fmtDateTime(iso) {
  const d = new Date(iso);
  return d.toLocaleString('es-CL', { timeZone: TIMEZONE, hour:'2-digit', minute:'2-digit' });
}
function fmtDate(iso) {
  const d = new Date(iso);
  return d.toLocaleDateString('es-CL', { timeZone: TIMEZONE, weekday:'short', day:'2-digit', month:'short' });
}
function dateToInputLocal(iso){
  const d = new Date(iso);
  // “normaliza” a la zona local
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${y}-${m}-${da}T${hh}:${mm}`;
}
/* rango del mes (lunes a domingo) */
function monthGridRange(anyDate){
  const d = new Date(anyDate.getFullYear(), anyDate.getMonth(), 1);
  const start = new Date(d);
  const day = (start.getDay()+6)%7; // 0=lun ... 6=dom
  start.setDate(start.getDate() - day);
  const end = new Date(start);
  end.setDate(end.getDate()+41); // 6 x 7 - 1
  return {start, end};
}

/* ========= Render ========= */
async function loadEventsForMonth(){
  const {start,end} = monthGridRange(currentMonth);
  // Pedimos por rango; nota: usamos toISOString para cubrir TZ correctamente
  const { data, error } = await supa
    .from('events')
    .select('*')
    .gte('datetime', start.toISOString())
    .lte('datetime', new Date(end.getFullYear(), end.getMonth(), end.getDate(), 23,59,59).toISOString());

  eventsCache = data || [];
  if(error) console.error(error);
}
function groupByDay(){
  const map = {};
  for(const e of eventsCache){
    const d = new Date(e.datetime);
    // normalizamos a CL antes de cortar la fecha
    const y = d.toLocaleString('en-CA',{ timeZone: TIMEZONE, year:'numeric' });
    const m = d.toLocaleString('en-CA',{ timeZone: TIMEZONE, month:'2-digit' });
    const da = d.toLocaleString('en-CA',{ timeZone: TIMEZONE, day:'2-digit' });
    const key = `${y}-${m}-${da}`;
    (map[key] ||= []).push(e);
  }
  // ordenar por hora local
  Object.values(map).forEach(arr => arr.sort((a,b)=> new Date(a.datetime)-new Date(b.datetime)));
  return map;
}
async function renderMonth(){
  document.getElementById('calMonth').textContent = currentMonth.toLocaleDateString('es-CL',{ timeZone: TIMEZONE, month:'long', year:'numeric' });

  await loadEventsForMonth();
  const byDay = groupByDay();

  const grid = document.getElementById('calGrid');
  grid.innerHTML = '';

  const {start} = monthGridRange(currentMonth);
  for(let i=0;i<42;i++){
    const day = new Date(start);
    day.setDate(start.getDate()+i);

    const y = day.getFullYear(), m = String(day.getMonth()+1).padStart(2,'0'), da = String(day.getDate()).padStart(2,'0');
    const key = `${y}-${m}-${da}`;

    const cell = document.createElement('div'); cell.className='day';
    // top
    const top = document.createElement('div'); top.className='day-top';
    const num = document.createElement('div'); num.className='day-num'; num.textContent = day.getDate();
    const add = document.createElement('button'); add.className='add-btn'; add.innerHTML = '+';
    add.title = 'Agregar evento';
    add.onclick = ()=> openModalCreate(key);
    top.append(num, add);
    cell.appendChild(top);

    // eventos
    (byDay[key]||[]).forEach(ev=>{
      const card = document.createElement('div'); card.className='card ' + (ev.type==='Entrenamiento'?'train':'');
      card.innerHTML = `
        <div class="time">${fmtDateTime(ev.datetime)} — <span style="font-size:12px">${ev.type||''}</span></div>
        <div class="title">${ev.title||''}</div>
        <div class="meta">${ev.team||''}${ev.opponent?` · vs ${ev.opponent}`:''}</div>
        <div class="pin">📍 ${ev.location||''}</div>
      `;
      card.onclick = ()=> openModalEdit(ev);
      cell.appendChild(card);
    });

    grid.appendChild(cell);
  }
}

/* ========= Modal: Crear / Editar ========= */
const modal = document.getElementById('modal');
const fTitle = document.getElementById('fTitle');
const fType = document.getElementById('fType');
const fDateTime = document.getElementById('fDateTime');
const fTeam = document.getElementById('fTeam');
const fOpponent = document.getElementById('fOpponent');
const fUniform = document.getElementById('fUniform');
const fLocation = document.getElementById('fLocation');
const btnDelete = document.getElementById('btnDelete');
const mTitle = document.getElementById('mTitle');

function openModalCreate(yyyy_mm_dd){
  editingId = null;
  mTitle.textContent = 'Nuevo evento';
  btnDelete.style.display = 'none';
  fTitle.value=''; fType.value='Entrenamiento'; fTeam.value='Golden Moms';
  fOpponent.value=''; fUniform.value=''; fLocation.value='';
  // pre-carga hora 19:30 para entrenamientos por defecto
  fDateTime.value = `${yyyy_mm_dd}T19:30`;
  modal.classList.add('show');
}
function openModalEdit(ev){
  editingId = ev.id;
  mTitle.textContent = 'Editar evento';
  btnDelete.style.display = 'inline-block';
  fTitle.value = ev.title||'';
  fType.value = ev.type||'Entrenamiento';
  fTeam.value = ev.team||'Golden Moms';
  fOpponent.value = ev.opponent||'';
  fUniform.value = ev.uniform||'';
  fLocation.value = ev.location||'';
  fDateTime.value = dateToInputLocal(ev.datetime);
  modal.classList.add('show');
}
function closeModal(){ modal.classList.remove('show'); }

/* ========= Acciones ========= */
document.getElementById('btnCancel').onclick = closeModal;
document.getElementById('btnNew').onclick = ()=>{
  const today = new Date();
  const y = today.getFullYear(), m = String(today.getMonth()+1).padStart(2,'0'), d = String(today.getDate()).padStart(2,'0');
  openModalCreate(`${y}-${m}-${d}`);
};
document.getElementById('btnSave').onclick = async ()=>{
  const payload = {
    title: fTitle.value?.trim()||'(Sin título)',
    type: fType.value,
    team: fTeam.value?.trim()||'Golden Moms',
    datetime: localInputToISO(fDateTime.value),
    location: fLocation.value?.trim()||null,
    opponent: fOpponent.value?.trim()||null,
    uniform: fUniform.value||null
  };
  let error;
  if(editingId){
    ({ error } = await supa.from('events').update(payload).eq('id', editingId));
  }else{
    ({ error } = await supa.from('events').insert([payload]));
  }
  if(error){ alert('❌ Error: '+error.message); return; }
  closeModal(); await renderMonth();
};
btnDelete.onclick = async ()=>{
  if(!editingId) return;
  if(!confirm('¿Eliminar este evento?')) return;
  const { error } = await supa.from('events').delete().eq('id', editingId);
  if(error){ alert('❌ Error: '+error.message); return; }
  closeModal(); await renderMonth();
};

/* ========= Navegación mensual ========= */
document.getElementById('btnPrev').onclick = ()=>{ currentMonth.setMonth(currentMonth.getMonth()-1); renderMonth(); };
document.getElementById('btnNext').onclick = ()=>{ currentMonth.setMonth(currentMonth.getMonth()+1); renderMonth(); };
document.getElementById('btnToday').onclick = ()=>{ currentMonth = new Date(); renderMonth(); };

/* ========= Vistas (si luego quieres alternar) ========= */
function showView(v){
  // En este HTML solo mostramos “Eventos”; mantenemos la API por compatibilidad
  document.querySelectorAll('.nav .tab').forEach(b=>b.classList.toggle('active', b.dataset.view===v));
  // podrías ocultar/mostrar secciones si agregas más
}

/* ========= Inicial ========= */
renderMonth();
</script>

</body>
</html>
