<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms ğŸ’š</title>
<link rel="icon" href="Logo.webp"/>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Golden Moms">
<link rel="apple-touch-icon" href="Logo.webp">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GOLDEN MOMS â€” Paleta liviana, aireada
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&family=Nunito+Sans:wght@300;400;500;600&display=swap');

:root {
  /* Fondo y superficies â€” todo muy claro */
  --bg:        #f6f8fb;
  --surface:   #ffffff;
  --surface-2: #f9fafb;
  --surface-3: #f0f4f8;

  /* Texto */
  --ink:       #1a2332;
  --ink-2:     #2d3e52;
  --muted:     #718096;
  --muted-2:   #a0aec0;

  /* Bordes muy suaves */
  --line:      #e8edf4;
  --line-2:    #d8e0ea;

  /* Lima â€” el alma del equipo, usado con mucha contenciÃ³n */
  --lime:      #6db33f;
  --lime-pale: #f0f9e8;
  --lime-soft: #d4edba;
  --lime-mid:  #8dc963;

  /* Azul â€” solo para detalles y foco */
  --blue:      #3b6fd4;
  --blue-pale: #eef3fd;
  --blue-soft: #c3d5f5;

  /* Equipos â€” versiones desaturadas y suaves */
  --gm-c: #3b6fd4; --gm-bg: #eef3fd; --gm-b: #c3d5f5;
  --dr-c: #7c55c9; --dr-bg: #f3f0fc; --dr-b: #d5c9f5;
  --pw-c: #c47a1e; --pw-bg: #fdf5e8; --pw-b: #f5dcaa;

  /* SemÃ¡foro */
  --win:  #3a9e5f; --win-bg:  #edfaf3;
  --loss: #d95555; --loss-bg: #fdf0f0;

  --danger: #d95555; --danger-bg: #fdf0f0; --danger-b: #f5c0c0;

  /* Fuentes */
  --font-head: 'Nunito', sans-serif;
  --font-body: 'Nunito Sans', sans-serif;

  /* Radios generosos */
  --r-xs: 6px;
  --r-sm: 10px;
  --r-md: 14px;
  --r-lg: 18px;
  --r-xl: 22px;

  /* Sombras casi invisibles */
  --sh-1: 0 1px 3px rgba(26,35,50,0.06);
  --sh-2: 0 2px 10px rgba(26,35,50,0.07);
  --sh-3: 0 4px 20px rgba(26,35,50,0.08);
}

/* â”€â”€ Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html   { scroll-behavior: smooth; }
body   {
  font-family: var(--font-body);
  background:  var(--bg);
  color:       var(--ink);
  min-height:  100vh;
  font-size:   14px;
  line-height: 1.55;
  -webkit-font-smoothing: antialiased;
}
a      { color: inherit; text-decoration: none; }
button { font-family: var(--font-body); cursor: pointer; }

/* â”€â”€ Top bar â€” blanco, muy limpio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.top {
  position: sticky; top: 0; z-index: 100;
  background: var(--surface);
  border-bottom: 1px solid var(--line);
  display: flex; align-items: center;
  justify-content: space-between;
  padding: 0 24px; height: 58px;
  box-shadow: var(--sh-1);
}
.brand { display: flex; align-items: center; gap: 10px; }
.brand-logo {
  width: 32px; height: 32px; border-radius: 50%;
  border: 1.5px solid var(--lime-soft); object-fit: cover;
}
.brand-name {
  font-family: var(--font-head); font-size: 17px; font-weight: 800;
  color: var(--ink); letter-spacing: -0.2px;
}
.brand-name span { color: var(--lime); }
.top-right { display: flex; align-items: center; gap: 14px; }

#connStatus { font-size: 11px; font-weight: 600; color: var(--muted-2); }
#connStatus.online  { color: var(--win); }
#connStatus.offline { color: var(--danger); }

/* â”€â”€ Nav â€” pastillas sutiles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.nav {
  display: flex; gap: 2px;
  background: var(--surface-2);
  border: 1px solid var(--line);
  padding: 3px; border-radius: 12px;
}
.nav .tab {
  border: none; background: transparent;
  color: var(--muted); font-family: var(--font-head);
  font-size: 13px; font-weight: 600;
  padding: 6px 14px; border-radius: 9px;
  white-space: nowrap; transition: all 0.15s;
}
.nav .tab:hover  { color: var(--ink-2); background: var(--surface); }
.nav .tab.active {
  background: var(--surface); color: var(--lime);
  font-weight: 700; box-shadow: var(--sh-1);
}
@media (max-width: 640px) {
  .top { padding: 0 14px; }
  .nav .tab { font-size: 12px; padding: 5px 10px; }
}
@media (max-width: 420px) {
  .nav .tab { font-size: 11px; padding: 5px 7px; }
  #connStatus { display: none; }
}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.container { max-width: 1100px; margin: 0 auto; padding: 22px 16px 48px; }
.section-header {
  display: flex; align-items: flex-end;
  justify-content: space-between; margin-bottom: 18px; gap: 12px;
}
.section-title { font-family: var(--font-head); font-size: 22px; font-weight: 800; color: var(--ink); }
.section-sub   { font-size: 13px; color: var(--muted); margin-top: 2px; }

/* â”€â”€ Card base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--surface);
  border: 1px solid var(--line);
  border-radius: var(--r-lg);
  box-shadow: var(--sh-1);
  padding: 18px;
}

/* â”€â”€ KPI cards â€” fondos pÃ¡lidos, nÃºmeros grandes â”€â”€â”€â”€â”€â”€â”€ */
.kpi-grid {
  display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 14px;
}
@media (max-width: 680px) { .kpi-grid { grid-template-columns: 1fr 1fr; } }
@media (max-width: 380px) { .kpi-grid { grid-template-columns: 1fr; } }

.kpi-card {
  background: var(--surface); border: 1px solid var(--line);
  border-radius: var(--r-lg); padding: 20px;
  box-shadow: var(--sh-1); position: relative; overflow: hidden;
}
/* Acento lima muy suave en borde izquierdo */
.kpi-card::before {
  content: ''; position: absolute;
  left: 0; top: 16px; bottom: 16px;
  width: 3px; border-radius: 99px;
  background: var(--lime-soft);
}
.kpi-label {
  font-size: 11px; font-weight: 600; letter-spacing: 0.5px;
  text-transform: uppercase; color: var(--muted-2); margin-bottom: 8px;
}
.kpi-value {
  font-family: var(--font-head); font-size: 42px; font-weight: 800;
  color: var(--ink); line-height: 1; letter-spacing: -1.5px;
}
.kpi-sub { font-size: 12px; color: var(--muted); margin-top: 5px; }
.kpi-accent {
  position: absolute; bottom: 12px; right: 16px;
  font-size: 24px; opacity: 0.08;
}

/* â”€â”€ Dashboard grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dash-grid {
  display: grid; grid-template-columns: repeat(3,1fr); gap: 10px;
}
.dash-grid .span3 { grid-column: span 3; }
@media (max-width: 840px) {
  .dash-grid { grid-template-columns: 1fr 1fr; }
  .dash-grid .span3 { grid-column: span 2; }
}
@media (max-width: 540px) {
  .dash-grid { grid-template-columns: 1fr; }
  .dash-grid .span3 { grid-column: span 1; }
}

.dash-card-title {
  font-family: var(--font-head); font-size: 14px; font-weight: 700;
  color: var(--ink); display: flex; align-items: center; gap: 7px; margin-bottom: 12px;
}
.dash-card-icon {
  width: 26px; height: 26px; border-radius: 8px;
  background: var(--lime-pale); border: 1px solid var(--lime-soft);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; flex-shrink: 0;
}

/* â”€â”€ Event items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.event-item {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 9px 0; border-bottom: 1px solid var(--line);
}
.event-item:last-child { border-bottom: none; }
.event-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--lime-mid); margin-top: 6px; flex-shrink: 0;
}
.event-dot.match { background: var(--blue); }
.event-name { font-weight: 600; font-size: 13px; color: var(--ink); }
.event-meta { font-size: 12px; color: var(--muted); margin-top: 1px; }

/* â”€â”€ Birthday items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.birth-item {
  display: flex; align-items: center; gap: 9px;
  padding: 8px 10px; border-radius: var(--r-sm);
  border: 1px solid var(--line); margin-bottom: 5px;
  background: var(--surface); transition: border-color 0.15s;
}
.birth-item:hover { border-color: var(--line-2); }
.birth-avatar {
  width: 30px; height: 30px; border-radius: 50%;
  background: var(--lime-pale); border: 1.5px solid var(--lime-soft);
  color: var(--lime); font-family: var(--font-head); font-weight: 700; font-size: 13px;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.birth-name { font-weight: 600; font-size: 13px; color: var(--ink); }
.birth-date { font-size: 11px; color: var(--muted); }
.birth-today-badge {
  margin-left: auto; background: var(--lime-pale);
  color: var(--lime); border: 1px solid var(--lime-soft);
  font-size: 10px; font-weight: 700; padding: 2px 8px;
  border-radius: 99px; white-space: nowrap;
}

/* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state {
  text-align: center; padding: 24px 12px;
  color: var(--muted-2); font-size: 13px;
}
.empty-state-icon { font-size: 22px; display: block; margin-bottom: 6px; opacity: 0.6; }

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  border: 1px solid var(--line-2);
  border-radius: var(--r-sm); padding: 8px 16px;
  background: var(--surface); cursor: pointer;
  font-family: var(--font-body); font-size: 13px; font-weight: 600;
  color: var(--ink-2); transition: all 0.14s;
  display: inline-flex; align-items: center; gap: 5px;
}
.btn:hover { border-color: var(--lime-soft); background: var(--lime-pale); color: var(--lime); }
.btn.p {
  background: var(--lime-pale); border-color: var(--lime-soft);
  color: var(--lime); font-weight: 700;
}
.btn.p:hover { background: var(--lime-soft); border-color: var(--lime-mid); }
.btn.danger  { color: var(--danger); border-color: var(--danger-b); background: var(--danger-bg); }
.btn.danger:hover { background: #fde0e0; }
.btn-icon {
  width: 32px; height: 32px; padding: 0;
  display: inline-flex; align-items: center; justify-content: center;
  border-radius: var(--r-sm); font-size: 14px;
}

/* â”€â”€ Calendar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.calendar-card { padding: 16px; }
.month-bar {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px; gap: 10px; flex-wrap: wrap;
}
.month-nav  { display: flex; gap: 5px; align-items: center; }
.month-title {
  font-family: var(--font-head); font-size: 20px; font-weight: 800;
  color: var(--ink); letter-spacing: -0.3px; text-transform: capitalize;
}

.team-filters { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
.team-chip {
  border-radius: 99px; padding: 4px 13px;
  font-family: var(--font-body); font-size: 12px; font-weight: 600;
  cursor: pointer; border: 1px solid transparent; transition: all 0.13s;
}
.team-chip.inactive { opacity: 0.3; }
.chip-gm  { background: var(--gm-bg); color: var(--gm-c); border-color: var(--gm-b); }
.chip-dr  { background: var(--dr-bg); color: var(--dr-c); border-color: var(--dr-b); }
.chip-pw  { background: var(--pw-bg); color: var(--pw-c); border-color: var(--pw-b); }
.chip-all { background: var(--surface-2); color: var(--ink-2); border-color: var(--line-2); }

.cal-note { font-size: 11px; color: var(--muted); margin-bottom: 12px; }

/* Month grid */
.month-grid {
  display: grid; grid-template-columns: repeat(7,1fr);
  gap: 5px; grid-auto-rows: minmax(86px, auto);
}
.week-sep {
  grid-column: 1 / -1; height: 1px;
  background: var(--line); margin: 2px 0;
}
.day {
  min-height: 86px; background: var(--surface);
  border: 1px solid var(--line); border-radius: var(--r-md);
  padding: 8px; position: relative;
  display: flex; flex-direction: column; gap: 4px;
  transition: border-color 0.14s;
}
.day:hover { border-color: var(--lime-soft); }
.day.today {
  border-color: var(--lime-soft); background: var(--lime-pale);
}
.day-head  { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1px; }
.day-num-box { display: flex; flex-direction: column; align-items: center; line-height: 1; }
.day-wk-grid {
  font-size: 9px; font-weight: 600; letter-spacing: 0.4px;
  text-transform: uppercase; color: var(--muted-2);
}
.day-n {
  font-family: var(--font-head); font-size: 16px; font-weight: 700;
  color: var(--muted); line-height: 1.1;
}
.day.today .day-n {
  color: var(--lime); font-weight: 800;
}
.day-add {
  position: absolute; top: 7px; right: 7px;
  width: 20px; height: 20px; border-radius: 6px;
  border: 1px solid var(--line); background: var(--surface);
  color: var(--muted-2); display: inline-flex;
  align-items: center; justify-content: center;
  cursor: pointer; font-size: 13px; line-height: 1;
  opacity: 0; transition: opacity 0.13s; z-index: 3;
}
.day:hover .day-add { opacity: 1; }
.day-add:hover { background: var(--lime-pale); color: var(--lime); border-color: var(--lime-soft); }

/* Event chips â€” muy suaves */
.ev {
  border-radius: var(--r-xs); padding: 4px 7px;
  cursor: pointer; line-height: 1.25; word-break: break-word;
  font-size: 10px; font-weight: 600; transition: opacity 0.12s;
}
.ev:hover    { opacity: 0.8; }
.ev.ev-train { background: var(--lime-pale); color: var(--lime); border: 1px solid var(--lime-soft); }
.ev.ev-match { background: var(--blue-pale); color: var(--blue); border: 1px solid var(--blue-soft); }
.ev-time     { font-size: 9px; opacity: 0.65; margin-top: 1px; }

.ev-team-badge {
  display: inline-block; font-size: 8px; font-weight: 700;
  padding: 1px 5px; border-radius: 99px;
  text-transform: uppercase; letter-spacing: 0.2px; margin-bottom: 2px;
}
.ev-team-gm { background: var(--gm-bg); color: var(--gm-c); border: 1px solid var(--gm-b); }
.ev-team-dr { background: var(--dr-bg); color: var(--dr-c); border: 1px solid var(--dr-b); }
.ev-team-pw { background: var(--pw-bg); color: var(--pw-c); border: 1px solid var(--pw-b); }

/* Month list (mobile) */
.month-list { display: none; flex-direction: column; gap: 5px; }
.month-list .day {
  flex-direction: row; align-items: flex-start;
  min-height: auto; padding: 10px; gap: 10px;
}
.day-date {
  min-width: 42px; border-radius: var(--r-sm);
  background: var(--surface-2); border: 1px solid var(--line);
  padding: 5px; text-align: center;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 1px; line-height: 1; flex-shrink: 0;
}
.day-date .day-wk  { font-size: 9px; font-weight: 600; text-transform: uppercase; color: var(--muted-2); }
.day-date .day-num { font-family: var(--font-head); font-size: 18px; font-weight: 800; color: var(--ink); }
.month-list .day.today .day-date { background: var(--lime-pale); border-color: var(--lime-soft); }
.month-list .day.today .day-date .day-num { color: var(--lime); }
.month-list .week-sep { display: block; }

@media (max-width: 480px) {
  .month-grid { gap: 4px; }
  .day { padding: 6px; min-height: 72px; }
  .day-n { font-size: 14px; }
}

/* â”€â”€ Roster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.roster-grid {
  display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; margin-top: 14px;
}
@media (max-width: 1000px) { .roster-grid { grid-template-columns: repeat(3,1fr); } }
@media (max-width: 680px)  { .roster-grid { grid-template-columns: repeat(2,1fr); } }
@media (max-width: 360px)  { .roster-grid { grid-template-columns: 1fr; } }

.player-card {
  background: var(--surface); border: 1px solid var(--line);
  border-radius: var(--r-lg); padding: 16px 12px;
  display: flex; flex-direction: column; align-items: center;
  text-align: center; gap: 7px; cursor: pointer;
  transition: border-color 0.15s, box-shadow 0.15s, transform 0.15s;
  box-shadow: var(--sh-1);
}
.player-card:hover {
  border-color: var(--lime-soft); box-shadow: var(--sh-2); transform: translateY(-2px);
}
.player-photo {
  width: 64px; height: 64px; border-radius: 50%;
  object-fit: cover; border: 2px solid var(--line); background: var(--surface-2);
}
.jersey-placeholder {
  width: 64px; height: 64px; border-radius: 50%;
  background: var(--lime-pale); border: 2px solid var(--lime-soft);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-head); font-weight: 800; color: var(--lime); font-size: 20px;
}
.player-apodo  { font-family: var(--font-head); font-weight: 700; font-size: 15px; color: var(--ink); }
.player-nombre { font-size: 12px; color: var(--muted); }
.equipo-badges { display: flex; gap: 3px; flex-wrap: wrap; justify-content: center; }
.equipo-badge  { font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 99px; }

/* â”€â”€ Matches â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.match-card {
  background: var(--surface); border: 1px solid var(--line);
  border-left: 3px solid var(--line-2);
  border-radius: var(--r-lg); padding: 14px 18px; margin-bottom: 8px;
  display: grid; grid-template-columns: 1fr auto; gap: 14px; align-items: center;
  box-shadow: var(--sh-1); transition: border-color 0.13s;
}
.match-card:hover { border-color: var(--line-2); }
.match-card.win  { border-left-color: var(--win); }
.match-card.loss { border-left-color: var(--loss); }
.match-card.draw { border-left-color: var(--muted-2); }
.match-title  { font-family: var(--font-head); font-size: 15px; font-weight: 700; color: var(--ink); display: flex; align-items: center; gap: 7px; flex-wrap: wrap; }
.match-meta   { font-size: 12px; color: var(--muted); margin-top: 3px; }
.match-scorers{ font-size: 11px; color: var(--muted); margin-top: 5px; }
.match-obs    { font-size: 11px; color: var(--muted); margin-top: 5px; padding: 5px 8px; background: var(--surface-2); border-radius: var(--r-xs); border: 1px solid var(--line); }
.score-badge  { font-family: var(--font-head); font-size: 28px; font-weight: 800; white-space: nowrap; letter-spacing: -1px; }
.score-badge.win  { color: var(--win); }
.score-badge.loss { color: var(--loss); }
.score-badge.draw { color: var(--muted-2); }
.score-sep    { font-size: 18px; color: var(--muted-2); font-weight: 300; margin: 0 2px; }
.score-no     { font-size: 12px; color: var(--muted-2); }
@media (max-width: 560px) { .match-card { grid-template-columns: 1fr; } }

/* â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-bg {
  position: fixed; inset: 0;
  background: rgba(20, 30, 48, 0.35);
  backdrop-filter: blur(4px);
  display: none; z-index: 1000;
  justify-content: center; align-items: flex-start;
  padding: 24px 12px; overflow-y: auto;
}
.modal {
  width: min(560px, calc(100% - 24px)); margin: 16px auto;
  background: var(--surface); border: 1px solid var(--line);
  border-radius: var(--r-xl); padding: 24px;
  box-shadow: var(--sh-3);
  max-height: calc(100vh - 80px); overflow-y: auto;
  animation: modalIn 0.2s ease both;
}
.modal-wide { width: min(660px, calc(100% - 24px)); }
@keyframes modalIn {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}
@media (max-width: 480px) { .modal { padding: 16px; border-radius: var(--r-lg); } }

.modal-title {
  font-family: var(--font-head); font-size: 19px; font-weight: 800;
  color: var(--ink); margin-bottom: 18px;
  display: flex; align-items: center; gap: 9px;
}
.modal-title-icon {
  width: 30px; height: 30px; border-radius: 8px;
  background: var(--lime-pale); border: 1px solid var(--lime-soft);
  display: flex; align-items: center; justify-content: center; font-size: 14px;
}

/* â”€â”€ Forms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
@media (max-width: 520px) { .form-row { grid-template-columns: 1fr; } }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-label {
  font-size: 11px; font-weight: 700; letter-spacing: 0.4px;
  text-transform: uppercase; color: var(--muted-2);
}
.input, select, textarea {
  width: 100%; padding: 9px 12px;
  border: 1px solid var(--line-2); border-radius: var(--r-sm);
  background: var(--surface); font-family: var(--font-body);
  font-size: 13px; color: var(--ink);
  transition: border-color 0.13s, box-shadow 0.13s;
}
.input:focus, select:focus, textarea:focus {
  outline: none; border-color: var(--lime-mid);
  box-shadow: 0 0 0 3px var(--lime-pale);
}
select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23a0aec0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center;
  padding-right: 28px; cursor: pointer; appearance: none;
}
.form-divider { height: 1px; background: var(--line); margin: 14px 0; }
.form-section-title {
  font-size: 10px; font-weight: 700; letter-spacing: 0.6px;
  text-transform: uppercase; color: var(--muted-2);
  margin-bottom: 9px; display: flex; align-items: center; gap: 7px;
}
.form-section-title::after { content: ''; flex: 1; height: 1px; background: var(--line); }

.equipo-checks { display: flex; gap: 7px; flex-wrap: wrap; }
.equipo-check-label {
  display: flex; align-items: center; gap: 5px;
  padding: 6px 12px; border: 1px solid var(--line-2);
  border-radius: 99px; cursor: pointer; font-size: 12px; font-weight: 600;
  transition: all 0.13s; user-select: none;
}
.equipo-check-label:has(input:checked) {
  background: var(--lime-pale); border-color: var(--lime-soft); color: var(--lime);
}
.equipo-check-label input { display: none; }

.modal-actions {
  display: flex; gap: 8px; justify-content: flex-end;
  margin-top: 18px; padding-top: 14px; border-top: 1px solid var(--line);
}

/* â”€â”€ Convocatoria â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.convocatoria-section {
  margin-top: 14px; padding: 12px;
  background: var(--surface-2); border-radius: var(--r-md);
  border: 1px solid var(--line);
}
.conv-title { font-size: 12px; font-weight: 700; color: var(--ink); margin-bottom: 8px; }
.conv-grid  { display: flex; flex-wrap: wrap; gap: 5px; }
.conv-player {
  display: flex; align-items: center; gap: 4px;
  padding: 5px 11px; border: 1px solid var(--line-2);
  border-radius: 99px; cursor: pointer; font-size: 12px; font-weight: 600;
  background: var(--surface); transition: all 0.13s; user-select: none;
}
.conv-player:hover { border-color: var(--lime-soft); }
.conv-player.selected {
  background: var(--lime-pale); border-color: var(--lime-soft); color: var(--lime); font-weight: 700;
}
.conv-num { font-size: 10px; font-weight: 700; opacity: 0.5; }
.conv-player.selected .conv-num { opacity: 0.65; }

/* â”€â”€ Player modal header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.player-modal-header {
  display: flex; align-items: center; gap: 14px;
  padding: 14px; background: var(--lime-pale);
  border: 1px solid var(--lime-soft);
  border-radius: var(--r-md); margin-bottom: 18px;
}
.player-modal-photo {
  width: 52px; height: 52px; border-radius: 50%;
  object-fit: cover; border: 2px solid var(--lime-soft);
  background: var(--surface); flex-shrink: 0;
}
.player-modal-name { font-family: var(--font-head); font-size: 17px; font-weight: 800; color: var(--ink); }
.player-modal-meta { font-size: 11px; color: var(--muted); margin-top: 2px; }

/* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
footer { text-align: center; padding: 20px; font-size: 12px; color: var(--muted-2); }

/* â”€â”€ Animaciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}
.view-enter { animation: fadeUp 0.18s ease both; }

/* â”€â”€ Asistencia rÃ¡pida â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.att-section-label {
  font-size: 10px; font-weight: 800; letter-spacing: 0.8px;
  text-transform: uppercase; color: var(--muted-2);
  padding: 8px 0 4px; display: flex; align-items: center; gap: 6px;
}
.att-section-label::after { content:''; flex:1; height:1px; background:var(--line); }
.att-row {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 12px; border-radius: var(--r-sm);
  border: 1px solid var(--line); background: var(--surface);
  transition: all 0.13s; user-select: none;
}
.att-row.att-yes   { background: var(--win-bg);  border-color: #86efac; }
.att-row.att-no    { background: var(--loss-bg); border-color: #fca5a5; }
.att-row.att-maybe { background: #fffbeb;         border-color: #fde68a; }
.att-row.att-pending { background: var(--surface); border-color: var(--line); opacity: 0.7; }
.att-avatar {
  width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;
  background: var(--lime-pale); border: 1.5px solid var(--lime-soft);
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 12px; color: var(--lime);
  font-family: var(--font-head);
}
.att-name { font-weight: 600; font-size: 14px; flex: 1; min-width: 0; }
.att-num  { font-size: 11px; color: var(--muted-2); font-weight: 600; }
/* Big tap buttons â€” easy on mobile */
.att-tap-group { display: flex; gap: 3px; }
.att-tap {
  min-width: 38px; height: 34px; border-radius: var(--r-sm);
  border: 1px solid var(--line); background: var(--surface-2);
  font-size: 17px; display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all 0.13s; padding: 0 6px;
}
.att-tap:hover    { transform: scale(1.08); box-shadow: var(--sh-1); }
.att-tap.act-yes  { background: var(--win-bg);  border-color: #4ade80; box-shadow: 0 0 0 2px #bbf7d0; }
.att-tap.act-no   { background: var(--loss-bg); border-color: #f87171; box-shadow: 0 0 0 2px #fecaca; }
.att-tap.act-duda { background: #fffbeb;         border-color: #fcd34d; box-shadow: 0 0 0 2px #fef3c7; }

/* â”€â”€ Resultado partido desde calendario â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ev-result-btn {
  display: inline-flex; align-items: center; gap: 3px;
  margin-top: 3px; font-size: 9px; font-weight: 700;
  background: var(--blue-pale); color: var(--blue);
  border: 1px solid var(--blue-soft); border-radius: 5px;
  padding: 2px 6px; cursor: pointer; transition: background 0.12s;
}
.ev-result-btn:hover { background: var(--blue-soft); }

/* â”€â”€ EstadÃ­sticas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-row {
  display: grid;
  grid-template-columns: 44px 1fr 60px 60px 80px;
  align-items: center; gap: 12px;
  padding: 12px 16px; background: var(--surface);
  border: 1px solid var(--line); border-radius: var(--r-md);
  box-shadow: var(--sh-1); transition: border-color 0.13s;
}
.stats-row:hover { border-color: var(--line-2); }
.stats-avatar {
  width: 40px; height: 40px; border-radius: 50%;
  object-fit: cover; background: var(--lime-pale);
  border: 2px solid var(--lime-soft);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-head); font-weight: 800; color: var(--lime); font-size: 15px;
  flex-shrink: 0;
}
.stats-name  { font-weight: 700; font-size: 14px; }
.stats-sub   { font-size: 11px; color: var(--muted); margin-top: 1px; }
.stats-kpi   { text-align: center; }
.stats-kpi-n { font-family: var(--font-head); font-size: 20px; font-weight: 800; color: var(--ink); line-height: 1; }
.stats-kpi-l { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.4px; margin-top: 2px; }
.stats-bar-wrap { display: flex; align-items: center; gap: 6px; }
.stats-bar-bg {
  flex: 1; height: 6px; background: var(--surface-3);
  border-radius: 99px; overflow: hidden;
}
.stats-bar-fill { height: 100%; background: var(--lime-mid); border-radius: 99px; transition: width 0.4s ease; }
.stats-pct { font-size: 11px; font-weight: 700; color: var(--muted); min-width: 30px; text-align: right; }
@media (max-width: 600px) {
  .stats-row { grid-template-columns: 36px 1fr 50px 50px; }
  .stats-bar-wrap { display: none; }
}

/* â”€â”€ TablÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ann-card {
  background: var(--surface); border: 1px solid var(--line);
  border-radius: var(--r-lg); padding: 16px; box-shadow: var(--sh-1);
  position: relative; transition: border-color 0.13s;
}
.ann-card.pinned { border-color: var(--lime-soft); background: var(--lime-pale); }
.ann-card:hover  { border-color: var(--line-2); }
.ann-pin-badge {
  display: inline-flex; align-items: center; gap: 3px;
  font-size: 10px; font-weight: 700; color: var(--lime);
  background: var(--surface); border: 1px solid var(--lime-soft);
  border-radius: 99px; padding: 1px 7px; margin-bottom: 6px;
}
.ann-title { font-family: var(--font-head); font-size: 17px; font-weight: 800; color: var(--ink); }
.ann-body  { font-size: 13px; color: var(--ink-2); margin-top: 5px; line-height: 1.5; white-space: pre-line; }
.ann-meta  { font-size: 11px; color: var(--muted); margin-top: 8px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
.ann-edit-btn {
  margin-left: auto; font-size: 11px; font-weight: 600;
  background: none; border: 1px solid var(--line-2); border-radius: var(--r-xs);
  padding: 2px 8px; color: var(--muted); cursor: pointer; transition: all 0.12s;
}
.ann-edit-btn:hover { border-color: var(--lime-soft); color: var(--lime); }

/* â”€â”€ Cuotas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fee-card {
  background: var(--surface); border: 1px solid var(--line);
  border-radius: var(--r-lg); box-shadow: var(--sh-1); overflow: hidden;
}
.fee-header {
  display: grid; grid-template-columns: 1fr auto;
  align-items: center; gap: 12px;
  padding: 14px 18px; border-bottom: 1px solid var(--line);
  cursor: pointer; transition: background 0.13s;
}
.fee-header:hover { background: var(--surface-2); }
.fee-title { font-family: var(--font-head); font-size: 16px; font-weight: 800; color: var(--ink); }
.fee-meta  { font-size: 12px; color: var(--muted); margin-top: 2px; }
.fee-progress-wrap { display: flex; align-items: center; gap: 8px; min-width: 120px; }
.fee-progress-bg   { flex: 1; height: 8px; background: var(--surface-3); border-radius: 99px; overflow: hidden; }
.fee-progress-fill { height: 100%; background: var(--lime-mid); border-radius: 99px; transition: width 0.4s ease; }
.fee-pct { font-size: 12px; font-weight: 700; color: var(--lime); min-width: 36px; text-align: right; }
.fee-body { padding: 10px 18px 14px; }
.fee-player-row {
  display: flex; align-items: center; gap: 10px;
  padding: 7px 0; border-bottom: 1px solid var(--line);
  font-size: 13px;
}
.fee-player-row:last-child { border-bottom: none; }
.fee-player-name { flex: 1; font-weight: 600; }
.fee-toggle {
  display: flex; align-items: center; gap: 6px;
  font-size: 12px; font-weight: 700; cursor: pointer;
  padding: 4px 10px; border-radius: 99px; border: 1px solid var(--line-2);
  background: var(--surface); transition: all 0.13s; user-select: none;
}
.fee-toggle.paid   { background: var(--win-bg); border-color: #86efac; color: var(--win); }
.fee-toggle.unpaid { background: var(--loss-bg); border-color: #fca5a5; color: var(--loss); }
.fee-collapsed { display: none; }
.fee-edit-btn {
  font-size: 11px; font-weight: 600; background: none;
  border: 1px solid var(--line-2); border-radius: var(--r-xs);
  padding: 3px 9px; color: var(--muted); cursor: pointer; transition: all 0.12s;
}
.fee-edit-btn:hover { border-color: var(--lime-soft); color: var(--lime); }


/* â”€â”€ WhatsApp â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-wa {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 6px 13px; border-radius: 99px;
  background: #dcfce7; border: 1px solid #86efac;
  color: #16a34a; font-size: 12px; font-weight: 700;
  cursor: pointer; transition: all 0.13s; text-decoration: none;
  font-family: var(--font-body);
}
.btn-wa:hover { background: #bbf7d0; border-color: #4ade80; }
.btn-wa svg  { width: 14px; height: 14px; flex-shrink: 0; }

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
  background: var(--ink); color: #fff;
  padding: 10px 20px; border-radius: 99px;
  font-size: 13px; font-weight: 600;
  box-shadow: var(--sh-3); z-index: 9999;
  transition: transform 0.25s cubic-bezier(0.34,1.56,0.64,1), opacity 0.25s;
  opacity: 0; pointer-events: none; white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
</style>
</head>
<body>

<!-- â”€â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM" class="brand-logo"/>
    <div class="brand-name">Golden <span>Moms</span></div>
  </div>
  <div class="top-right">
    <div id="connStatus">Conectandoâ€¦</div>
    <nav class="nav" role="tablist" aria-label="NavegaciÃ³n">
      <button class="tab active" data-view="dash">Dashboard</button>
      <button class="tab" data-view="events">Eventos</button>
      <button class="tab" data-view="roster">Plantel</button>
      <button class="tab" data-view="matches">Partidos</button>
      <button class="tab" data-view="stats">EstadÃ­sticas</button>
      <button class="tab" data-view="board">TablÃ³n</button>
      <button class="tab" data-view="fees">Cuotas</button>
    </nav>
  </div>
</header>

<div class="container">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DASHBOARD
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="v-dash" class="view-enter">

    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Plantel</div>
        <div class="kpi-value" id="kRoster">â€”</div>
        <div class="kpi-sub">Jugadoras</div>
        <span class="kpi-accent">ğŸ‘¥</span>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Partidos</div>
        <div class="kpi-value" id="kGames">â€”</div>
        <div class="kpi-sub" id="kRecord"></div>
        <span class="kpi-accent">âš½</span>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Ãšltimo resultado</div>
        <div class="kpi-value" id="kLastMatch" style="font-size:38px">â€”</div>
        <div class="kpi-sub" id="kLastMatchMeta"></div>
        <span class="kpi-accent">ğŸ†</span>
      </div>
    </div>

    <!-- Cards secundarias -->
    <div class="dash-grid">
      <div class="card">
        <div class="dash-card-title">
          <span class="dash-card-icon">ğŸ“…</span> Hoy
        </div>
        <div id="todayEvents"></div>
      </div>
      <div class="card">
        <div class="dash-card-title">
          <span class="dash-card-icon">ğŸ‚</span> CumpleaÃ±os Hoy
        </div>
        <div id="birthToday"><div class="empty-state"><span class="empty-state-icon">ğŸ‚</span>Sin cumpleaÃ±os hoy</div></div>
      </div>
      <div class="card">
        <div class="dash-card-title">
          <span class="dash-card-icon">ğŸ‰</span> PrÃ³ximos
        </div>
        <div id="upBirth"></div>
      </div>
      <div class="card span3">
        <div class="dash-card-title">
          <span class="dash-card-icon">ğŸ“†</span> Esta Semana
        </div>
        <div id="weekEvents"></div>
      </div>
    </div>

  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EVENTOS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="v-events" style="display:none">
    <div class="card calendar-card">
      <div class="month-bar">
        <div class="month-nav">
          <button class="btn btn-icon" id="btnPrevMonth" title="Mes anterior">â—€</button>
          <button class="btn" id="btnToday">Hoy</button>
          <button class="btn btn-icon" id="btnNextMonth" title="Mes siguiente">â–¶</button>
        </div>
        <div class="month-title" id="monthTitle">Mes</div>
        <button class="btn p" id="btnNewEventTop">ï¼‹ Nuevo Evento</button>
      </div>

      <div class="team-filters" id="teamFilters">
        <button class="team-chip chip-gm" data-team="Golden Moms">ğŸ’š Golden Moms</button>
        <button class="team-chip chip-dr" data-team="Dreams">ğŸ’œ Dreams</button>
        <button class="team-chip chip-pw" data-team="Power">ğŸ§¡ Power</button>
      </div>

      <div class="cal-note" id="calNote">Mostrando todos los equipos Â· fecha local</div>
      <div id="monthGrid" class="month-grid"></div>
      <div id="monthList" class="month-list"></div>
    </div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PLANTEL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="v-roster" style="display:none">
    <div class="section-header">
      <div>
        <div class="section-title">Plantel</div>
        <div class="section-sub">Toca una jugadora para ver o editar su ficha</div>
      </div>
      <button class="btn p" id="btnNewPlayer">ï¼‹ Nueva jugadora</button>
    </div>

    <div class="team-filters" id="rosterTeamFilters">
      <button class="team-chip chip-all" data-team="all">Todas</button>
      <button class="team-chip chip-gm" data-team="Golden Moms">ğŸ’š Golden Moms</button>
      <button class="team-chip chip-dr" data-team="Dreams">ğŸ’œ Dreams</button>
      <button class="team-chip chip-pw" data-team="Power">ğŸ§¡ Power</button>
    </div>

    <div id="rosterGrid" class="roster-grid"></div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PARTIDOS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="v-matches" style="display:none">
    <div class="section-header">
      <div>
        <div class="section-title">Partidos</div>
        <div class="section-sub">Historial con marcador, goleadoras y observaciones</div>
      </div>
    </div>
    <div id="matchesList"></div>
  </section>

</div>


  <!-- â•â•â•â•â•â•â•â•â•â•â• ASISTENCIA RÃPIDA MODAL â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="modal-bg" id="attModalBg" style="display:none" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-title"><div class="modal-title-icon">âœ…</div><span id="attModalTitle">Pase de lista</span></div>
      <div id="attEventMeta" style="font-size:12px;color:var(--muted);margin-bottom:12px"></div>
      <div id="attList" style="display:flex;flex-direction:column;gap:6px;max-height:55vh;overflow-y:auto"></div>
      <div class="modal-actions" style="margin-top:14px">
        <span id="attCounter" style="margin-right:auto;font-size:13px;color:var(--muted);font-weight:600"></span>
        <button class="btn" id="btnCloseAtt">Cerrar</button>
        <button class="btn p" id="btnSaveAtt">ğŸ’¾ Guardar y avisar</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• RESULTADO PARTIDO MODAL â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="modal-bg" id="resultModalBg" style="display:none" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-title"><div class="modal-title-icon">âš½</div><span id="resultModalTitle">Cargar resultado</span></div>
      <input type="hidden" id="res_event_id">
      <div class="form-row" style="margin-bottom:14px">
        <div class="form-group" style="align-items:center">
          <label class="form-label">Golden Moms</label>
          <input id="res_gf" type="number" min="0" max="99" class="input" placeholder="0"
            style="font-size:40px;font-weight:800;text-align:center;padding:8px">
        </div>
        <div class="form-group" style="align-items:center">
          <label class="form-label" id="res_opp_label">Rival</label>
          <input id="res_ga" type="number" min="0" max="99" class="input" placeholder="0"
            style="font-size:40px;font-weight:800;text-align:center;padding:8px">
        </div>
      </div>
      <div class="form-group" style="margin-bottom:10px">
        <label class="form-label">Goleadoras (seleccionÃ¡)</label>
        <div id="res_scorers_grid" class="conv-grid" style="margin-top:6px"></div>
      </div>
      <div class="form-group">
        <label class="form-label">ObservaciÃ³n</label>
        <textarea id="res_obs" class="input" rows="2" placeholder="Notas del partidoâ€¦" style="resize:vertical"></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn" id="btnCloseResult">Cancelar</button>
        <button class="btn p" id="btnSaveResult">ğŸ’¾ Guardar resultado</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• ANUNCIO MODAL â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="modal-bg" id="annModalBg" style="display:none" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-title"><div class="modal-title-icon">ğŸ“¢</div><span id="annModalTitle">Nuevo anuncio</span></div>
      <input type="hidden" id="ann_id">
      <div class="form-group" style="margin-bottom:10px">
        <label class="form-label">TÃ­tulo *</label>
        <input id="ann_title" class="input" placeholder="Ej: Cancha suspendida por lluvia">
      </div>
      <div class="form-group" style="margin-bottom:10px">
        <label class="form-label">Mensaje</label>
        <textarea id="ann_body" class="input" rows="3" placeholder="Detalle del anuncioâ€¦" style="resize:vertical"></textarea>
      </div>
      <div class="form-row" style="margin-bottom:10px">
        <div class="form-group">
          <label class="form-label">Equipo</label>
          <select id="ann_team" class="input">
            <option value="Golden Moms">ğŸ’š Golden Moms</option>
            <option value="Dreams">ğŸ’œ Dreams</option>
            <option value="Power">ğŸ§¡ Power</option>
            <option value="Todos">ğŸ“£ Todos</option>
          </select>
        </div>
        <div class="form-group" style="justify-content:flex-end">
          <label class="form-label">Fijar arriba</label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;margin-top:4px">
            <input type="checkbox" id="ann_pinned"> Destacado ğŸ“Œ
          </label>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn danger" id="btnDeleteAnn" style="margin-right:auto;display:none">ğŸ—‘ Eliminar</button>
        <button class="btn" id="btnCloseAnn">Cancelar</button>
        <button class="btn p" id="btnSaveAnn">ğŸ’¾ Publicar</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• CUOTA MODAL â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="modal-bg" id="feeModalBg" style="display:none" aria-hidden="true">
    <div class="modal modal-wide" role="dialog" aria-modal="true">
      <div class="modal-title"><div class="modal-title-icon">ğŸ’°</div><span id="feeModalTitle">Nueva cuota</span></div>
      <input type="hidden" id="fee_id">
      <div class="form-row" style="margin-bottom:10px">
        <div class="form-group">
          <label class="form-label">TÃ­tulo *</label>
          <input id="fee_title" class="input" placeholder="Ej: Cuota Marzo 2025">
        </div>
        <div class="form-group">
          <label class="form-label">Monto ($)</label>
          <input id="fee_amount" class="input" type="number" min="0" placeholder="10000">
        </div>
      </div>
      <div class="form-row" style="margin-bottom:14px">
        <div class="form-group">
          <label class="form-label">Vencimiento</label>
          <input id="fee_due" class="input" type="date">
        </div>
        <div class="form-group">
          <label class="form-label">Equipo</label>
          <select id="fee_team" class="input">
            <option value="Golden Moms">ğŸ’š Golden Moms</option>
            <option value="Dreams">ğŸ’œ Dreams</option>
            <option value="Power">ğŸ§¡ Power</option>
            <option value="Todos">Todos</option>
          </select>
        </div>
      </div>
      <div class="form-section-title">Pagos por jugadora</div>
      <div id="fee_payments_grid" style="display:flex;flex-direction:column;gap:5px;max-height:45vh;overflow-y:auto"></div>
      <div class="modal-actions">
        <button class="btn danger" id="btnDeleteFee" style="margin-right:auto;display:none">ğŸ—‘ Eliminar</button>
        <button class="btn" id="btnCloseFee">Cancelar</button>
        <button class="btn p" id="btnSaveFee">ğŸ’¾ Guardar</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• ESTADÃSTICAS â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="v-stats" style="display:none">
    <div class="section-header">
      <div><div class="section-title">EstadÃ­sticas</div><div class="section-sub">Rendimiento individual de la temporada</div></div>
      <select id="stats_team_filter" class="input" style="width:auto;min-width:160px">
        <option value="all">Todos los equipos</option>
        <option value="Golden Moms">ğŸ’š Golden Moms</option>
        <option value="Dreams">ğŸ’œ Dreams</option>
        <option value="Power">ğŸ§¡ Power</option>
      </select>
    </div>
    <div id="statsGrid" style="display:flex;flex-direction:column;gap:8px"></div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â• TABLÃ“N â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="v-board" style="display:none">
    <div class="section-header">
      <div><div class="section-title">TablÃ³n</div><div class="section-sub">Anuncios y avisos del equipo</div></div>
      <button class="btn p" id="btnNewAnn">ï¼‹ Anuncio</button>
    </div>
    <div id="boardList" style="display:flex;flex-direction:column;gap:10px"></div>
  </section>

  <!-- â•â•â•â•â•â•â•â•â•â•â• CUOTAS â•â•â•â•â•â•â•â•â•â•â• -->
  <section id="v-fees" style="display:none">
    <div class="section-header">
      <div><div class="section-title">Cuotas</div><div class="section-sub">Control de pagos del equipo</div></div>
      <button class="btn p" id="btnNewFee">ï¼‹ Nueva cuota</button>
    </div>
    <div id="feesList" style="display:flex;flex-direction:column;gap:10px"></div>
  </section>

<footer>Golden Moms Â· hecho con ğŸ’š lima &amp; azul</footer>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL EVENTOS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="modalBg" style="display:none" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-title">
      <div class="modal-title-icon">ğŸ“…</div>
      <span id="modalTitle">Nuevo evento</span>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label" for="f_title">TÃ­tulo *</label>
        <input id="f_title" class="input" placeholder="Ej: Entrenamiento Colegio">
      </div>
      <div class="form-group">
        <label class="form-label" for="f_type">Tipo *</label>
        <select id="f_type" class="input">
          <option value="Entrenamiento">Entrenamiento</option>
          <option value="Partido">Partido</option>
        </select>
      </div>
    </div>
    <div class="form-row" style="margin-top:12px">
      <div class="form-group">
        <label class="form-label" for="f_dt">Fecha y hora *</label>
        <input id="f_dt" type="datetime-local" class="input">
      </div>
      <div class="form-group">
        <label class="form-label" for="f_team">Equipo *</label>
        <select id="f_team" class="input">
          <option value="Golden Moms">ğŸ’š Golden Moms</option>
          <option value="Dreams">ğŸ’œ Dreams</option>
          <option value="Power">ğŸ§¡ Power</option>
        </select>
      </div>
    </div>
    <div class="form-row" style="margin-top:12px">
      <div class="form-group">
        <label class="form-label" for="f_opponent">Rival</label>
        <input id="f_opponent" class="input" placeholder="Nombre del rival">
      </div>
      <div class="form-group">
        <label class="form-label" for="f_uniform">Uniforme</label>
        <select id="f_uniform" class="input">
          <option value="">(por definir)</option>
          <option>Polera azul â€” medias verde lima</option>
          <option>Polera verde lima â€” medias verde lima</option>
        </select>
      </div>
    </div>
    <div class="form-row" style="margin-top:12px">
      <div class="form-group">
        <label class="form-label" for="f_location">UbicaciÃ³n</label>
        <input id="f_location" class="input" placeholder="Cancha / DirecciÃ³n">
      </div>
      <div></div>
    </div>

    <div class="convocatoria-section" id="convocatoriaSection">
      <div class="conv-title" id="convTitle">ğŸ‘¥ Convocatoria</div>
      <div id="convGrid" class="conv-grid">
        <span style="color:var(--muted);font-size:12px">SeleccionÃ¡ el equipo para ver las jugadorasâ€¦</span>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn danger" id="btnDelete" style="margin-right:auto;display:none">ğŸ—‘ Eliminar</button>
      <button class="btn" id="btnCancel">Cancelar</button>
      <button class="btn p" id="btnSave">ğŸ’¾ Guardar</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL JUGADORA
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="playerModalBg" style="display:none" aria-hidden="true">
  <div class="modal modal-wide" role="dialog" aria-modal="true" aria-labelledby="playerModalTitle">

    <!-- Header con foto -->
    <div class="player-modal-header">
      <img id="p_img_preview"
        src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='72' height='72'><rect fill='%231a3a5c' width='72' height='72' rx='36'/><text x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='26' fill='%23a8e63d'>ğŸ‘¤</text></svg>"
        alt="Foto jugadora"
        class="player-modal-photo"/>
      <div class="player-modal-info">
        <div class="player-modal-name" id="playerModalTitle">Jugadora</div>
        <div class="player-modal-meta">URL de foto editable en el campo <code style="background:rgba(255,255,255,0.15);padding:1px 5px;border-radius:4px">foto</code></div>
      </div>
    </div>

    <!-- Datos bÃ¡sicos -->
    <div class="form-section-title">Datos bÃ¡sicos</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label" for="p_apodo">Apodo</label>
        <input id="p_apodo" class="input" placeholder="Ej: Ale"/>
      </div>
      <div class="form-group">
        <label class="form-label" for="p_nombre">Nombre completo *</label>
        <input id="p_nombre" class="input" placeholder="Ej: Alejandra PÃ©rez"/>
      </div>
    </div>
    <div class="form-row" style="margin-top:12px">
      <div class="form-group">
        <label class="form-label" for="p_numero">NÂ° camiseta</label>
        <input id="p_numero" class="input" type="number" min="1" max="99" placeholder="10"/>
      </div>
      <div class="form-group">
        <label class="form-label" for="p_fecha_nac">Fecha de nacimiento</label>
        <input id="p_fecha_nac" class="input" type="date"/>
      </div>
    </div>
    <div class="form-row" style="margin-top:12px">
      <div class="form-group">
        <label class="form-label" for="p_rol">Rol</label>
        <select id="p_rol" class="input">
          <option value="jugadora">Jugadora</option>
          <option value="capitana">Capitana Â©</option>
          <option value="dt">DT</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="p_estado">Estado</label>
        <select id="p_estado" class="input">
          <option value="">â€”</option>
          <option value="activo">Activa âœ“</option>
          <option value="reposo">En reposo ğŸ©¹</option>
        </select>
      </div>
    </div>

    <div class="form-divider"></div>
    <div class="form-section-title">Equipos</div>
    <div class="equipo-checks">
      <label class="equipo-check-label chip-gm">
        <input type="checkbox" id="p_eq_gm" value="Golden Moms"> ğŸ’š Golden Moms
      </label>
      <label class="equipo-check-label chip-dr">
        <input type="checkbox" id="p_eq_dr" value="Dreams"> ğŸ’œ Dreams
      </label>
      <label class="equipo-check-label chip-pw">
        <input type="checkbox" id="p_eq_pw" value="Power"> ğŸ§¡ Power
      </label>
    </div>

    <div class="form-divider"></div>
    <div class="form-section-title">Contacto</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label" for="p_celular">Celular</label>
        <input id="p_celular" class="input" type="text" placeholder="+56 9 1234 5678"/>
      </div>
      <div class="form-group">
        <label class="form-label" for="p_email">Email</label>
        <input id="p_email" class="input" type="text" placeholder="correo@ejemplo.com"/>
      </div>
    </div>
    <div class="form-row" style="margin-top:12px">
      <div class="form-group">
        <label class="form-label" for="p_tel_emerg">TelÃ©fono emergencia</label>
        <input id="p_tel_emerg" class="input" type="text" placeholder="+56 9 0000 0000"/>
      </div>
      <div class="form-group">
        <label class="form-label" for="p_rut">RUT</label>
        <input id="p_rut" class="input" placeholder="12.345.678-9"/>
      </div>
    </div>

    <div class="form-divider"></div>
    <div class="form-section-title">Colegio / Seguro</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label" for="p_curso">Curso hijo/a</label>
        <input id="p_curso" class="input" placeholder="Ej: 3Â° BÃ¡sico B"/>
      </div>
      <div class="form-group">
        <label class="form-label" for="p_seguro">Seguro mÃ©dico</label>
        <input id="p_seguro" class="input" placeholder="Ej: Fonasa / Isapre"/>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn danger" id="btnDeletePlayer" style="margin-right:auto">ğŸ—‘ Eliminar</button>
      <button class="btn" id="btnCancelPlayer">Cancelar</button>
      <button class="btn p" id="btnSavePlayer">ğŸ’¾ Guardar</button>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const EVENT_TYPES = { TRAIN: 'Entrenamiento', MATCH: 'Partido' };
const TEAMS = { GM: 'Golden Moms', DR: 'Dreams', PW: 'Power' };
const ALL_TEAMS = [TEAMS.GM, TEAMS.DR, TEAMS.PW];

function teamBadgeClass(team){
  if(team === TEAMS.DR) return 'ev-team-dr';
  if(team === TEAMS.PW) return 'ev-team-pw';
  return 'ev-team-gm';
}

/* Cache de jugadoras para convocatoria */
let allPlayers = [];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUPABASE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SUPA_CONFIG = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};
let supa = null;
let IS_CONNECTED = false;

async function initSupabase(timeoutMs = 8000){
  try{
    if(typeof createClient === 'function'){
      supa = createClient(SUPA_CONFIG.url, SUPA_CONFIG.key);
    } else if(window.supabase?.createClient){
      supa = window.supabase.createClient(SUPA_CONFIG.url, SUPA_CONFIG.key);
    } else {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js';
        s.async = true;
        let done = false;
        const to = setTimeout(() => { if(!done){ done=true; reject(new Error('timeout')); }}, timeoutMs);
        s.onload  = () => { if(done) return; done=true; clearTimeout(to); resolve(); };
        s.onerror = () => { if(done) return; done=true; clearTimeout(to); reject(new Error('load error')); };
        document.head.appendChild(s);
      });
      if(typeof createClient === 'function') supa = createClient(SUPA_CONFIG.url, SUPA_CONFIG.key);
      else if(window.supabase?.createClient) supa = window.supabase.createClient(SUPA_CONFIG.url, SUPA_CONFIG.key);
    }
    const test = await supa.from('events').select('id').limit(1);
    IS_CONNECTED = !test?.error;
    if(test?.error) console.warn('Supabase test error:', test.error);
  } catch(err){
    console.error('initSupabase:', err);
    supa = null; IS_CONNECTED = false;
  }
  updateConnStatus();
}

function updateConnStatus(){
  const el = document.getElementById('connStatus');
  if(!el) return;
  if(IS_CONNECTED){
    el.textContent = 'â— Conectado';
    el.className = 'online';
  } else {
    el.textContent = 'â— Sin conexiÃ³n';
    el.className = 'offline';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEGURIDAD & HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function escapeHTML(str){
  if(str == null) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function pad(n){ return n.toString().padStart(2,'0'); }

// Para fechas CON hora (events.datetime â†’ timestamp with time zone)
// new Date(iso) es correcto porque viene con offset explÃ­cito.
function safeDate(iso){
  if(!iso) return null;
  const d = new Date(iso);
  return isNaN(d.getTime()) ? null : d;
}

// Para fechas SIN hora (fecha_nacimiento, proximo_cumple â†’ tipo `date` en PG).
// "2025-03-14" â†’ new Date("2025-03-14") = UTC midnight â†’ en Chile aparece como 13 mar.
// Parseamos manualmente para quedarnos en hora local.
function safeDateOnly(str){
  if(!str) return null;
  // Si tiene hora (timestamp), usar safeDate normal
  if(str.includes('T') || str.includes(' ')) return safeDate(str);
  const [y, m, d] = str.split('-').map(Number);
  if(!y || !m || !d) return null;
  return new Date(y, m - 1, d); // constructor local, sin UTC
}

function localInputToISOWithOffset(inp){
  if(!inp) return null;
  const [d, t] = inp.split('T');
  const offMin = -new Date().getTimezoneOffset();
  const sign = offMin >= 0 ? '+' : '-';
  const abs = Math.abs(offMin);
  return `${d}T${t}:00${sign}${pad(Math.floor(abs/60))}:${pad(abs%60)}`;
}
function isoToLocalInput(iso){
  if(!iso) return '';
  const d = safeDate(iso);
  if(!d) return '';
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function localDateYMD(d){
  const D = new Date(d);
  return `${D.getFullYear()}-${pad(D.getMonth()+1)}-${pad(D.getDate())}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL EVENTOS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const modalBg    = document.getElementById('modalBg');
const f_title    = document.getElementById('f_title');
const f_type     = document.getElementById('f_type');
const f_dt       = document.getElementById('f_dt');
const f_team     = document.getElementById('f_team');
const f_opponent = document.getElementById('f_opponent');
const f_uniform  = document.getElementById('f_uniform');
const f_location = document.getElementById('f_location');
const btnDelete  = document.getElementById('btnDelete');
const btnCancel  = document.getElementById('btnCancel');
const btnSave    = document.getElementById('btnSave');

let editingEventId = null;
let selectedPlayerIds = new Set();

async function loadConvocatoria(team){
  const grid  = document.getElementById('convGrid');
  const title = document.getElementById('convTitle');
  grid.innerHTML = '';
  const loading = document.createElement('span');
  loading.style.cssText = 'color:var(--muted);font-size:12px';
  loading.textContent = 'Cargandoâ€¦';
  grid.appendChild(loading);
  if(!supa || !IS_CONNECTED){ loading.textContent = 'Sin conexiÃ³n'; return; }
  try{
    if(!allPlayers.length){
      const { data, error } = await supa.from('players').select('id, apodo, nombre, numero_camiseta, equipos').order('apodo', { ascending: true });
      if(error) throw error;
      allPlayers = data || [];
    }
    const filtered = team === TEAMS.GM ? allPlayers : allPlayers.filter(p => Array.isArray(p.equipos) && p.equipos.includes(team));
    title.textContent = `ğŸ‘¥ Convocatoria â€” ${team} (${filtered.length})`;
    grid.innerHTML = '';
    if(!filtered.length){
      const msg = document.createElement('span'); msg.style.cssText='color:var(--muted);font-size:12px';
      msg.textContent = `No hay jugadoras en ${team}`; grid.appendChild(msg); return;
    }
    for(const p of filtered){
      const btn = document.createElement('button'); btn.type='button';
      btn.className = 'conv-player' + (selectedPlayerIds.has(p.id) ? ' selected' : '');
      btn.dataset.id = p.id;
      if(p.numero_camiseta != null){
        const num = document.createElement('span'); num.className='conv-num'; num.textContent='#'+p.numero_camiseta; btn.appendChild(num);
      }
      const name = document.createElement('span'); name.textContent = p.apodo || p.nombre || 'â€”'; btn.appendChild(name);
      btn.addEventListener('click', () => {
        if(selectedPlayerIds.has(p.id)){ selectedPlayerIds.delete(p.id); btn.classList.remove('selected'); }
        else { selectedPlayerIds.add(p.id); btn.classList.add('selected'); }
      });
      grid.appendChild(btn);
    }
  } catch(err){ console.error('loadConvocatoria', err); grid.innerHTML='<span style="color:var(--danger);font-size:12px">Error cargando jugadoras</span>'; }
}

async function loadAttendanceForEvent(eventId){
  selectedPlayerIds = new Set();
  if(!supa || !IS_CONNECTED || !eventId) return;
  try{
    const { data } = await supa.from('attendance').select('player_id, status').eq('event_id', eventId);
    for(const row of (data||[])){ if(row.status === 'Asiste') selectedPlayerIds.add(row.player_id); }
  } catch(err){ console.warn('loadAttendanceForEvent', err); }
}

async function saveAttendance(eventId){
  if(!supa || !IS_CONNECTED || !eventId) return;
  try{
    const upserts = [];
    for(const p of allPlayers){
      upserts.push({ event_id: eventId, player_id: p.id, status: selectedPlayerIds.has(p.id) ? 'Asiste' : 'No asiste', updated_at: new Date().toISOString() });
    }
    if(upserts.length) await supa.from('attendance').upsert(upserts, { onConflict: 'event_id,player_id' });
  } catch(err){ console.warn('saveAttendance', err); }
}

function openModal(opts = {}){
  document.getElementById('modalTitle').textContent = opts.existing ? 'Editar evento' : 'Nuevo evento';
  editingEventId = null; selectedPlayerIds = new Set();
  if(opts.existing){
    const e = opts.existing;
    editingEventId   = e.id;
    f_title.value    = e.title    || '';
    f_type.value     = e.type     || EVENT_TYPES.TRAIN;
    f_dt.value       = isoToLocalInput(e.datetime);
    f_team.value     = e.team     || TEAMS.GM;
    f_opponent.value = e.opponent || '';
    f_uniform.value  = e.uniform  || '';
    f_location.value = e.location || '';
    btnDelete.style.display = '';
    loadAttendanceForEvent(e.id).then(() => loadConvocatoria(f_team.value));
  } else {
    f_title.value=''; f_type.value=EVENT_TYPES.TRAIN;
    const base = opts.date ? new Date(opts.date) : new Date();
    base.setHours(19,30,0,0);
    f_dt.value       = isoToLocalInput(base.toISOString());
    f_team.value     = opts.team || TEAMS.GM;
    f_opponent.value=''; f_uniform.value=''; f_location.value='';
    btnDelete.style.display = 'none';
    loadConvocatoria(f_team.value);
  }
  modalBg.style.display='flex'; modalBg.setAttribute('aria-hidden','false'); f_title.focus();
}
function closeModal(){ modalBg.style.display='none'; modalBg.setAttribute('aria-hidden','true'); editingEventId=null; }

f_team.addEventListener('change', () => { selectedPlayerIds=new Set(); loadConvocatoria(f_team.value); });
modalBg.addEventListener('click', e => { if(e.target===modalBg) closeModal(); });
document.addEventListener('keydown', e => { if(e.key==='Escape'){ closeModal(); closePlayerModal(); } });
btnCancel.addEventListener('click', closeModal);

btnDelete.addEventListener('click', async () => {
  if(!editingEventId) return;
  if(!confirm('Â¿Eliminar este evento? TambiÃ©n se eliminarÃ¡ su asistencia.')) return;
  if(!supa||!IS_CONNECTED){ alert('Sin conexiÃ³n.'); return; }
  try{
    await supa.from('attendance').delete().eq('event_id', editingEventId);
    const { error, count } = await supa.from('events').delete({ count:'exact' }).eq('id', editingEventId);
    if(error) throw error;
    if(count===0) console.warn('delete: ninguna fila eliminada');
  } catch(err){ alert('Error: '+(err.message||err)); return; }
  closeModal(); renderMonth(); renderDash();
});

btnSave.addEventListener('click', async () => {
  const title=f_title.value.trim(), type=f_type.value, team=f_team.value;
  const opponent=f_opponent.value.trim(), uniform=f_uniform.value, location=f_location.value.trim();
  if(!title||!f_dt.value){ alert('Completa tÃ­tulo y fecha/hora'); return; }
  if(!supa||!IS_CONNECTED){ alert('Sin conexiÃ³n.'); return; }
  const datetime=localInputToISOWithOffset(f_dt.value);
  const payload={ title, type, team, opponent, uniform, location, datetime };
  try{
    let savedId=editingEventId;
    if(editingEventId){
      const { error, count } = await supa.from('events').update(payload,{count:'exact'}).eq('id',editingEventId);
      if(error) throw error;
      if(count===0) console.warn('update: ninguna fila actualizada');
    } else {
      const { data, error } = await supa.from('events').insert([payload]).select('id');
      if(error) throw error;
      savedId = data?.[0]?.id;
    }
    if(savedId && allPlayers.length) await saveAttendance(savedId);
  } catch(err){ alert('Error: '+(err.message||err)); console.error(err); return; }
  closeModal(); renderMonth(); renderDash();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL JUGADORA
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const playerModalBg  = document.getElementById('playerModalBg');
const p_apodo        = document.getElementById('p_apodo');
const p_nombre       = document.getElementById('p_nombre');
const p_numero       = document.getElementById('p_numero');
const p_fecha_nac    = document.getElementById('p_fecha_nac');
const p_rol          = document.getElementById('p_rol');
const p_estado       = document.getElementById('p_estado');
const p_celular      = document.getElementById('p_celular');
const p_email        = document.getElementById('p_email');
const p_tel_emerg    = document.getElementById('p_tel_emerg');
const p_rut          = document.getElementById('p_rut');
const p_curso        = document.getElementById('p_curso');
const p_seguro       = document.getElementById('p_seguro');
const p_img_preview  = document.getElementById('p_img_preview');
const p_eq_gm        = document.getElementById('p_eq_gm');
const p_eq_dr        = document.getElementById('p_eq_dr');
const p_eq_pw        = document.getElementById('p_eq_pw');

let editingPlayerId = null;
const PHOTO_PLACEHOLDER = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='72' height='72'><rect fill='%231a3a5c' width='72' height='72' rx='36'/><text x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' font-size='26' fill='%23a8e63d'>ğŸ‘¤</text></svg>";

function openPlayerModal(player){
  editingPlayerId = player?.id ?? null;
  const isNew = !editingPlayerId;
  document.getElementById('playerModalTitle').textContent = isNew ? 'Nueva jugadora' : (player.apodo||player.nombre||'Jugadora');
  document.getElementById('btnDeletePlayer').style.display = isNew ? 'none' : '';
  p_apodo.value     = player?.apodo     || '';
  p_nombre.value    = player?.nombre    || '';
  p_numero.value    = player?.numero_camiseta != null ? player.numero_camiseta : '';
  p_fecha_nac.value = player?.fecha_nacimiento ? player.fecha_nacimiento.slice(0,10) : '';
  p_rol.value       = player?.rol       || 'jugadora';
  p_estado.value    = player?.Estado    || '';
  p_celular.value   = player?.celular   || '';
  p_email.value     = player?.email     || '';
  p_tel_emerg.value = player?.Telefono_emergencia || '';
  p_rut.value       = player?.Rut       || '';
  p_curso.value     = player?.Curso_hijos || '';
  p_seguro.value    = player?.Seguro_Medico || '';
  const equipos = Array.isArray(player?.equipos) ? player.equipos : [];
  p_eq_gm.checked = equipos.includes(TEAMS.GM);
  p_eq_dr.checked = equipos.includes(TEAMS.DR);
  p_eq_pw.checked = equipos.includes(TEAMS.PW);
  p_img_preview.src = player?.foto || PHOTO_PLACEHOLDER;
  p_img_preview.alt = escapeHTML(player?.apodo||player?.nombre||'Jugadora');
  playerModalBg.style.display='flex'; playerModalBg.setAttribute('aria-hidden','false'); p_nombre.focus();
}
function closePlayerModal(){ playerModalBg.style.display='none'; playerModalBg.setAttribute('aria-hidden','true'); editingPlayerId=null; }

playerModalBg.addEventListener('click', e => { if(e.target===playerModalBg) closePlayerModal(); });
document.getElementById('btnCancelPlayer').addEventListener('click', closePlayerModal);

document.getElementById('btnDeletePlayer').addEventListener('click', async () => {
  if(!editingPlayerId) return;
  const name = p_apodo.value||p_nombre.value||'esta jugadora';
  if(!confirm(`Â¿Eliminar a ${name}? No se puede deshacer.`)) return;
  if(!supa||!IS_CONNECTED){ alert('Sin conexiÃ³n.'); return; }
  try{
    const { error, count } = await supa.from('players').delete({count:'exact'}).eq('id',editingPlayerId);
    if(error) throw error;
    if(count===0) console.warn('delete player: ninguna fila');
  } catch(err){ alert('Error: '+(err.message||err)); return; }
  allPlayers=[];
  closePlayerModal(); renderRoster(); renderKPIs();
});

document.getElementById('btnSavePlayer').addEventListener('click', async () => {
  const nombre = p_nombre.value.trim();
  if(!nombre){ alert('El nombre es obligatorio.'); return; }
  if(!supa||!IS_CONNECTED){ alert('Sin conexiÃ³n.'); return; }
  const numero = p_numero.value !== '' ? parseInt(p_numero.value) : null;
  const equipos = [];
  if(p_eq_gm.checked) equipos.push(TEAMS.GM);
  if(p_eq_dr.checked) equipos.push(TEAMS.DR);
  if(p_eq_pw.checked) equipos.push(TEAMS.PW);
  if(!equipos.length) equipos.push(TEAMS.GM);
  const payload = {
    nombre, apodo: p_apodo.value.trim()||null,
    numero_camiseta: isNaN(numero)?null:numero,
    fecha_nacimiento: p_fecha_nac.value||null,
    rol: p_rol.value||'jugadora',
    Estado: p_estado.value||null,
    equipos,
    celular: p_celular.value.trim()||null,
    email: p_email.value.trim()||null,
    Telefono_emergencia: p_tel_emerg.value.trim()||null,
    Rut: p_rut.value.trim()||null,
    Curso_hijos: p_curso.value.trim()||null,
    Seguro_Medico: p_seguro.value.trim()||null,
  };
  try{
    if(editingPlayerId){
      const { error, count } = await supa.from('players').update(payload,{count:'exact'}).eq('id',editingPlayerId);
      if(error) throw error;
      if(count===0) console.warn('update player: ninguna fila');
    } else {
      const { error } = await supa.from('players').insert([payload]);
      if(error) throw error;
    }
  } catch(err){ alert('Error: '+(err.message||err)); console.error(err); return; }
  allPlayers=[];
  closePlayerModal(); renderRoster(); renderKPIs();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALENDARIO
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let monthCursor  = new Date();
let cachedEvents = [];
let activeTeams  = new Set(ALL_TEAMS);

const monthTitleEl = document.getElementById('monthTitle');
const monthGrid    = document.getElementById('monthGrid');
const monthList    = document.getElementById('monthList');

function getMonthRange(d){
  const first = new Date(d.getFullYear(), d.getMonth(), 1);
  const last  = new Date(d.getFullYear(), d.getMonth()+1, 0);
  let start = new Date(first); start.setDate(start.getDate()-((start.getDay()+6)%7));
  let end   = new Date(last);  end.setDate(end.getDate()+(6-(end.getDay()+6)%7));
  return { start, end };
}
function getDaysInRange(start, end){
  const days=[]; let d=new Date(start);
  while(d<=end){ days.push(new Date(d)); d.setDate(d.getDate()+1); }
  return days;
}
function makeWeekSep(){ const s=document.createElement('div'); s.className='week-sep'; return s; }

async function fetchEventsRange(start, end){
  if(!supa||!IS_CONNECTED) return [];
  try{
    const { data, error } = await supa.from('events').select('*')
      .gte('datetime',start.toISOString()).lte('datetime',end.toISOString())
      .order('datetime',{ascending:true});
    if(error){ console.error(error); return []; }
    return data||[];
  } catch(err){ console.error(err); return []; }
}

function renderMonthTitle(){
  const m = monthCursor.toLocaleString('es-CL',{month:'long',year:'numeric'});
  monthTitleEl.textContent = m.charAt(0).toUpperCase()+m.slice(1);
}

async function renderMonth(){
  renderMonthTitle();
  const { start, end } = getMonthRange(monthCursor);
  cachedEvents = await fetchEventsRange(start, end);
  const visible = cachedEvents.filter(e => activeTeams.has(e.team||TEAMS.GM));
  const isMobile = window.matchMedia('(max-width:500px)').matches;
  monthGrid.style.display = isMobile ? 'none' : '';
  monthList.style.display = isMobile ? 'flex' : 'none';
  if(isMobile) drawMonthList(start, end, visible);
  else         drawMonthGrid(start, end, visible);
}

function makeEventChip(e){
  const ev = document.createElement('div');
  ev.className = 'ev '+(e.type===EVENT_TYPES.TRAIN?'ev-train':'ev-match');
  const badge = document.createElement('div');
  badge.className = 'ev-team-badge '+teamBadgeClass(e.team||TEAMS.GM);
  badge.textContent = e.team||TEAMS.GM; ev.appendChild(badge);
  const tDiv = document.createElement('div'); tDiv.style.fontWeight='700'; tDiv.textContent = e.title||'â€”'; ev.appendChild(tDiv);
  const d = safeDate(e.datetime);
  if(d){
    const time = document.createElement('div'); time.className='ev-time';
    time.textContent = d.toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'}); ev.appendChild(time);
  }
  // Attendance button for training events
  if(e.type === EVENT_TYPES.TRAIN){
    const attBtn = document.createElement('div');
    attBtn.className='ev-result-btn'; attBtn.textContent='âœ… Lista';
    attBtn.addEventListener('click', ev2=>{ ev2.stopPropagation(); openAttModal(e); });
    ev.appendChild(attBtn);
  }
  // Result button for match events
  if(e.type === EVENT_TYPES.MATCH){
    const resBtn = document.createElement('div');
    resBtn.className='ev-result-btn'; resBtn.textContent='âš½ Resultado';
    resBtn.addEventListener('click', ev2=>{ ev2.stopPropagation(); openResultModal(e); });
    ev.appendChild(resBtn);
  }
  ev.addEventListener('click', () => openModal({ existing: e }));
  return ev;
}

function drawMonthGrid(start, end, visible){
  monthGrid.innerHTML='';
  const todayYMD = localDateYMD(new Date());
  for(const day of getDaysInRange(start, end)){
    const ymd = localDateYMD(day);
    const cell = document.createElement('div'); cell.className='day';
    if(ymd===todayYMD){ cell.classList.add('today'); cell.setAttribute('aria-current','date'); }
    const head = document.createElement('div'); head.className='day-head';
    const numBox = document.createElement('div'); numBox.className='day-num-box';
    const wkEl = document.createElement('div'); wkEl.className='day-wk-grid';
    wkEl.textContent = day.toLocaleDateString('es-CL',{weekday:'short'}).replace(/\./g,'');
    const nEl = document.createElement('div'); nEl.className='day-n'; nEl.textContent=pad(day.getDate());
    numBox.appendChild(wkEl); numBox.appendChild(nEl); head.appendChild(numBox);
    const plus = document.createElement('button'); plus.className='day-add';
    plus.textContent='+'; plus.title='Nuevo evento';
    plus.addEventListener('click', ()=>openModal({date:day}));
    cell.appendChild(head); cell.appendChild(plus);
    for(const e of visible.filter(e=>localDateYMD(safeDate(e.datetime)||new Date(0))===ymd))
      cell.appendChild(makeEventChip(e));
    monthGrid.appendChild(cell);
    if(day.getDay()===0) monthGrid.appendChild(makeWeekSep());
  }
}

function drawMonthList(start, end, visible){
  monthList.innerHTML='';
  const todayYMD = localDateYMD(new Date());
  for(const day of getDaysInRange(start, end)){
    const ymd = localDateYMD(day);
    const evs = visible.filter(e=>localDateYMD(safeDate(e.datetime)||new Date(0))===ymd);
    const row = document.createElement('div'); row.className='day';
    if(ymd===todayYMD){ row.classList.add('today'); row.setAttribute('aria-current','date'); }
    const dateBox = document.createElement('div'); dateBox.className='day-date';
    const wkEl=document.createElement('div'); wkEl.className='day-wk'; wkEl.textContent=day.toLocaleDateString('es-CL',{weekday:'short'}).replace(/\./g,'');
    const numEl=document.createElement('div'); numEl.className='day-num'; numEl.textContent=pad(day.getDate());
    dateBox.appendChild(wkEl); dateBox.appendChild(numEl);
    const col=document.createElement('div'); col.style.flex='1';
    if(evs.length) for(const e of evs) col.appendChild(makeEventChip(e));
    else { const em=document.createElement('div'); em.style.cssText='color:var(--muted);font-size:12px;padding:8px 0'; em.textContent='Sin eventos'; col.appendChild(em); }
    const plus=document.createElement('button'); plus.className='day-add'; plus.style.opacity='1';
    plus.textContent='+'; plus.title='Nuevo evento';
    plus.addEventListener('click',()=>openModal({date:day}));
    row.appendChild(dateBox); row.appendChild(col); row.appendChild(plus);
    monthList.appendChild(row);
    if(day.getDay()===0) monthList.appendChild(makeWeekSep());
  }
}

document.getElementById('btnPrevMonth').addEventListener('click', ()=>{ monthCursor.setMonth(monthCursor.getMonth()-1); renderMonth(); });
document.getElementById('btnNextMonth').addEventListener('click', ()=>{ monthCursor.setMonth(monthCursor.getMonth()+1); renderMonth(); });
document.getElementById('btnToday').addEventListener('click',    ()=>{ monthCursor=new Date(); renderMonth(); });
document.getElementById('btnNewEventTop').addEventListener('click', ()=>openModal({}));

document.querySelectorAll('#teamFilters .team-chip').forEach(btn => {
  btn.addEventListener('click', () => {
    const team = btn.dataset.team;
    if(activeTeams.has(team)){
      if(activeTeams.size===1) return;
      activeTeams.delete(team); btn.classList.add('inactive');
    } else { activeTeams.add(team); btn.classList.remove('inactive'); }
    const note = document.getElementById('calNote');
    if(note) note.innerHTML='Mostrando: <strong>'+[...activeTeams].join(', ')+'</strong>';
    const visible = cachedEvents.filter(e=>activeTeams.has(e.team||TEAMS.GM));
    const { start, end } = getMonthRange(monthCursor);
    const isMobile = window.matchMedia('(max-width:500px)').matches;
    if(isMobile) drawMonthList(start, end, visible);
    else         drawMonthGrid(start, end, visible);
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderKPIs(){
  try{
    if(supa&&IS_CONNECTED){
      const { count } = await supa.from('players').select('*',{count:'exact',head:true});
      animateNumber('kRoster', count??0);
    }
  } catch(err){ console.warn('kRoster', err); }

  try{
    if(supa&&IS_CONNECTED){
      const { data: ms } = await supa.from('matches').select('id,goals_for,goals_against,team,opponent,date').order('date',{ascending:false});
      const matches = ms||[];
      animateNumber('kGames', matches.length);
      let w=0,d=0,l=0;
      for(const m of matches){
        const gf=m.goals_for??0, ga=m.goals_against??0;
        if(gf>ga)w++; else if(gf===ga)d++; else l++;
      }
      document.getElementById('kRecord').textContent = matches.length ? `${w}G Â· ${d}E Â· ${l}P` : '';
      if(matches.length){
        const last=matches[0];
        const gf=last.goals_for??'?', ga=last.goals_against??'?';
        const kl=document.getElementById('kLastMatch');
        kl.textContent=`${gf} â€“ ${ga}`;
        kl.style.color = gf>ga?'#a8e63d':gf<ga?'#f87171':'rgba(255,255,255,0.7)';
        document.getElementById('kLastMatchMeta').textContent = last.opponent?`vs ${last.opponent}`:'';
      }
    }
  } catch(err){ console.warn('kGames', err); }
}

function animateNumber(id, target){
  const el = document.getElementById(id);
  if(!el) return;
  let start=0; const dur=600; const t0=performance.now();
  const step = now => {
    const p = Math.min((now-t0)/dur, 1);
    el.textContent = Math.round(start + (target-start)*p);
    if(p<1) requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
}

async function renderWeekEvents(){
  const now=new Date();
  const ws=new Date(now); ws.setDate(ws.getDate()-((ws.getDay()+6)%7)); ws.setHours(0,0,0,0);
  const we=new Date(ws); we.setDate(we.getDate()+6); we.setHours(23,59,59,999);
  const todayYMD=localDateYMD(now);
  let evs=[];
  if(supa&&IS_CONNECTED){
    const { data } = await supa.from('events').select('*')
      .gte('datetime',ws.toISOString()).lte('datetime',we.toISOString())
      .order('datetime',{ascending:true});
    evs=data||[];
  }
  // Hoy
  const todayEl=document.getElementById('todayEvents'); todayEl.innerHTML='';
  const todayEvs=evs.filter(e=>localDateYMD(safeDate(e.datetime)||new Date(0))===todayYMD);
  if(todayEvs.length){
    for(const e of todayEvs){
      const item=document.createElement('div'); item.className='event-item';
      const dot=document.createElement('div'); dot.className='event-dot'+(e.type===EVENT_TYPES.MATCH?' match':''); item.appendChild(dot);
      const info=document.createElement('div');
      const nm=document.createElement('div'); nm.className='event-name'; nm.textContent=e.title||'â€”'; info.appendChild(nm);
      const d=safeDate(e.datetime);
      const meta=document.createElement('div'); meta.className='event-meta';
      meta.textContent=(d?d.toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'}):'â€”')+' Â· '+(e.team||'');
      info.appendChild(meta); item.appendChild(info); todayEl.appendChild(item);
    }
  } else {
    todayEl.innerHTML='<div class="empty-state"><span class="empty-state-icon">ğŸ“…</span>Sin eventos hoy</div>';
  }
  // Semana
  const wEl=document.getElementById('weekEvents'); wEl.innerHTML='';
  if(evs.length){
    for(const e of evs){
      const item=document.createElement('div'); item.className='event-item';
      const dot=document.createElement('div'); dot.className='event-dot'+(e.type===EVENT_TYPES.MATCH?' match':''); item.appendChild(dot);
      const info=document.createElement('div');
      const nm=document.createElement('div'); nm.className='event-name'; nm.textContent=e.title||'â€”'; info.appendChild(nm);
      const d=safeDate(e.datetime);
      const meta=document.createElement('div'); meta.className='event-meta';
      meta.textContent=(d?d.toLocaleString('es-CL',{weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}):'â€”')+' Â· '+(e.team||'');
      info.appendChild(meta); item.appendChild(info); wEl.appendChild(item);
    }
  } else {
    wEl.innerHTML='<div class="empty-state"><span class="empty-state-icon">ğŸ“†</span>Sin eventos esta semana</div>';
  }
}

async function renderBirthdays(){
  const upB=document.getElementById('upBirth');
  const birthTodayEl=document.getElementById('birthToday');
  const todayYMD=localDateYMD(new Date());
  upB.innerHTML=''; birthTodayEl.innerHTML='';
  if(!supa||!IS_CONNECTED){ upB.innerHTML='<div class="empty-state">Sin conexiÃ³n</div>'; return; }
  try{
    const { data:vw, error } = await supa.from('vw_upcoming_birthdays').select('*').order('proximo_cumple',{ascending:true}).limit(10);
    if(error) throw error;
    const seen=new Set(); const uniq=[];
    for(const p of (vw||[])){ if(!seen.has(p.id)&&uniq.length<5){ seen.add(p.id); uniq.push(p); } }
    if(uniq.length){
      for(const p of uniq){
        const bd=safeDateOnly(p.proximo_cumple); if(!bd) continue;
        const item=document.createElement('div'); item.className='birth-item';
        const av=document.createElement('div'); av.className='birth-avatar';
        av.textContent=(p.apodo||p.nombre||'?')[0].toUpperCase(); item.appendChild(av);
        const info=document.createElement('div');
        const nm=document.createElement('div'); nm.className='birth-name'; nm.textContent=p.apodo||p.nombre||'â€”'; info.appendChild(nm);
        const dt=document.createElement('div'); dt.className='birth-date';
        dt.textContent=bd.toLocaleDateString('es-CL',{day:'2-digit',month:'short'}); info.appendChild(dt);
        item.appendChild(info);
        const isToday=localDateYMD(bd)===todayYMD;
        if(isToday){ const b=document.createElement('div'); b.className='birth-today-badge'; b.textContent='Â¡Hoy! ğŸ‚'; item.appendChild(b); }
        upB.appendChild(item);
      }
      const todayList=uniq.filter(p=>p.proximo_cumple&&localDateYMD(safeDateOnly(p.proximo_cumple)||new Date(0))===todayYMD);
      if(todayList.length){
        birthTodayEl.innerHTML='';
        for(const p of todayList){
          const item=document.createElement('div'); item.className='birth-item';
          const av=document.createElement('div'); av.className='birth-avatar'; av.style.background='var(--lime)'; av.style.color='var(--navy)';
          av.textContent=(p.apodo||p.nombre||'?')[0].toUpperCase(); item.appendChild(av);
          const info=document.createElement('div');
          const nm=document.createElement('div'); nm.className='birth-name'; nm.textContent=p.apodo||p.nombre||'â€”'; info.appendChild(nm);
          if(p.edad){ const ag=document.createElement('div'); ag.className='birth-date'; ag.textContent=`${p.edad} aÃ±os ğŸ‰`; info.appendChild(ag); }
          item.appendChild(info); birthTodayEl.appendChild(item);
        }
      } else { birthTodayEl.innerHTML='<div class="empty-state"><span class="empty-state-icon">ğŸ‚</span>Hoy no hay cumpleaÃ±os</div>'; }
    } else {
      upB.innerHTML='<div class="empty-state"><span class="empty-state-icon">ğŸ‰</span>Sin datos</div>';
      birthTodayEl.innerHTML='<div class="empty-state"><span class="empty-state-icon">ğŸ‚</span>Sin cumpleaÃ±os hoy</div>';
    }
  } catch(err){ console.warn('renderBirthdays', err); upB.innerHTML='<div class="empty-state">Error</div>'; }
}

async function renderRoster(filterTeam='all'){
  const rosterGrid=document.getElementById('rosterGrid');
  rosterGrid.innerHTML='';
  if(!supa||!IS_CONNECTED){ rosterGrid.innerHTML='<div style="color:var(--muted);padding:20px">Sin conexiÃ³n</div>'; return; }
  try{
    const { data:players, error } = await supa.from('players').select('*').order('apodo',{ascending:true});
    if(error) throw error;
    let filtered=players||[];
    if(filterTeam!=='all') filtered=filtered.filter(p=>Array.isArray(p.equipos)&&p.equipos.includes(filterTeam));
    if(!filtered.length){ rosterGrid.innerHTML='<div class="empty-state" style="grid-column:1/-1"><span class="empty-state-icon">ğŸ‘¥</span>No hay jugadoras</div>'; return; }
    for(const p of filtered){
      const c=document.createElement('div'); c.className='player-card';
      c.addEventListener('click',()=>openPlayerModal(p));
      if(p.foto){
        const img=document.createElement('img'); img.className='player-photo';
        img.src=p.foto; img.alt=escapeHTML(p.apodo||p.nombre||''); c.appendChild(img);
      } else {
        const ph=document.createElement('div'); ph.className='jersey-placeholder';
        ph.textContent=p.numero_camiseta!=null?String(p.numero_camiseta):'âš½'; c.appendChild(ph);
      }
      const ap=document.createElement('div'); ap.className='player-apodo'; ap.textContent=p.apodo||'Sin apodo'; c.appendChild(ap);
      if(p.nombre){ const nm=document.createElement('div'); nm.className='player-nombre'; nm.textContent=p.nombre; c.appendChild(nm); }
      const equipos=Array.isArray(p.equipos)?p.equipos:[];
      if(equipos.length){
        const badges=document.createElement('div'); badges.className='equipo-badges';
        for(const eq of equipos){
          const b=document.createElement('span'); b.className='equipo-badge '+teamBadgeClass(eq);
          b.textContent=eq===TEAMS.GM?'ğŸ’š GM':eq===TEAMS.DR?'ğŸ’œ DR':'ğŸ§¡ PW'; badges.appendChild(b);
        }
        c.appendChild(badges);
      }
      rosterGrid.appendChild(c);
    }
  } catch(err){ console.warn('renderRoster', err); rosterGrid.innerHTML='<div style="color:var(--muted)">Error</div>'; }
}

async function renderDash(){
  await Promise.all([renderKPIs(), renderWeekEvents(), renderBirthdays()]);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PARTIDOS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderMatches(){
  const container=document.getElementById('matchesList');
  container.innerHTML='';
  if(!supa||!IS_CONNECTED){ container.innerHTML='<div class="empty-state"><span class="empty-state-icon">âš½</span>Sin conexiÃ³n</div>'; return; }
  try{
    const { data:matches, error } = await supa
      .from('matches').select('*, events(title, datetime, location, team, opponent)').order('date',{ascending:false});
    if(error) throw error;
    if(!matches?.length){ container.innerHTML='<div class="empty-state"><span class="empty-state-icon">âš½</span>No hay partidos registrados</div>'; return; }
    for(const m of matches){
      const ev=m.events;
      const gf=m.goals_for??null, ga=m.goals_against??null;
      const hasScore=gf!==null&&ga!==null;
      const resultKey=!hasScore?'':'draw'+(gf>ga?'win':gf<ga?'loss':'draw').replace('drawwin','win').replace('drawloss','loss');
      const rc=hasScore?(gf>ga?'win':gf<ga?'loss':'draw'):'';
      const date=safeDate(ev?.datetime) || safeDateOnly(m.date);
      const title=ev?.title||m.opponent||'Partido';
      const team=ev?.team||m.team||TEAMS.GM;
      const opp=ev?.opponent||m.opponent||'';
      const loc=ev?.location||'';
      const card=document.createElement('div'); card.className='match-card'+(rc?' '+rc:'');
      // Left
      const left=document.createElement('div');
      const titleEl=document.createElement('div'); titleEl.className='match-title';
      const badge=document.createElement('span'); badge.className='ev-team-badge '+teamBadgeClass(team); badge.textContent=team; titleEl.appendChild(badge);
      const tname=document.createElement('span'); tname.textContent=title; titleEl.appendChild(tname);
      const meta=document.createElement('div'); meta.className='match-meta';
      const parts=[];
      if(date) parts.push(date.toLocaleDateString('es-CL',{weekday:'short',day:'2-digit',month:'short',year:'numeric'}));
      if(opp&&!title.includes(opp)) parts.push('vs '+opp);
      if(loc) parts.push(loc);
      meta.textContent=parts.join(' Â· ');
      left.appendChild(titleEl); left.appendChild(meta);
      if(Array.isArray(m.scorers)&&m.scorers.length){
        const sc=document.createElement('div'); sc.className='match-scorers';
        sc.textContent='âš½ '+m.scorers.join(', '); left.appendChild(sc);
      }
      if(m.observation||m.notes){
        const obs=document.createElement('div'); obs.className='match-obs';
        obs.textContent=m.observation||m.notes; left.appendChild(obs);
      }
      // Right
      const right=document.createElement('div');
      if(hasScore){
        const score=document.createElement('div'); score.className='score-badge'+(rc?' '+rc:'');
        const gfEl=document.createElement('span'); gfEl.textContent=String(gf);
        const sep=document.createElement('span'); sep.className='score-sep'; sep.textContent=' â€“ ';
        const gaEl=document.createElement('span'); gaEl.textContent=String(ga);
        score.appendChild(gfEl); score.appendChild(sep); score.appendChild(gaEl); right.appendChild(score);
      } else {
        const p=document.createElement('div'); p.className='score-no'; p.textContent='Sin resultado'; right.appendChild(p);
      }
      card.appendChild(left); card.appendChild(right);
      container.appendChild(card);
    }
  } catch(err){ console.error('renderMatches', err); container.innerHTML='<div class="empty-state">Error cargando partidos</div>'; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILTRO PLANTEL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentRosterFilter='all';
document.querySelectorAll('#rosterTeamFilters .team-chip').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#rosterTeamFilters .team-chip').forEach(b=>{ b.style.opacity=''; b.style.fontWeight=''; });
    btn.style.fontWeight='900';
    currentRosterFilter=btn.dataset.team;
    renderRoster(currentRosterFilter);
  });
});
document.getElementById('btnNewPlayer').addEventListener('click', ()=>openPlayerModal({}));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROUTING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showView(v){
  for(const id of ['dash','events','roster','matches','stats','board','fees']){
    const el=document.getElementById('v-'+id);
    if(el){ el.style.display='none'; el.classList.remove('view-enter'); }
  }
  const target=document.getElementById('v-'+v);
  if(target){ target.style.display='block'; requestAnimationFrame(()=>target.classList.add('view-enter')); }
  if(v==='dash')    renderDash();
  if(v==='events')  renderMonth();
  if(v==='matches') renderMatches();
  if(v==='roster')  renderRoster(currentRosterFilter);
  if(v==='stats')   renderStats();
  if(v==='board')   renderBoard();
  if(v==='fees')    renderFees();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', async () => {
  await initSupabase();
  document.querySelectorAll('.nav .tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const view=btn.dataset.view;
      try{ localStorage.setItem('gm_view',view); } catch(e){}
      showView(view);
    });
  });
  const persisted=(()=>{ try{ return localStorage.getItem('gm_view'); } catch(e){ return null; } })();
  const initialView=persisted||'dash';
  document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
  const toActivate=document.querySelector(`.nav .tab[data-view="${initialView}"]`);
  if(toActivate) toActivate.classList.add('active');
  showView(initialView);
  closeModal();
  closePlayerModal();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ASISTENCIA RÃPIDA
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let attEventId = null;
let attStatuses = {}; // player_id â†’ 'Asiste'|'No asiste'|'Duda'

function openAttModal(event) {
  attEventId = event.id;
  attStatuses = {};
  selectedPlayerIds = new Set();

  document.getElementById('attModalTitle').textContent = event.title || 'Pase de lista';
  const d = safeDate(event.datetime);
  document.getElementById('attEventMeta').textContent =
    (d ? d.toLocaleString('es-CL',{weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '') +
    (event.team ? ' Â· ' + event.team : '');

  attModalBg.style.display = 'flex';
  loadAttendanceForEvent(event.id).then(() => {
    // Pre-populate attStatuses from selectedPlayerIds
    for(const pid of selectedPlayerIds) attStatuses[pid] = 'Asiste';
    renderAttList(event.team || TEAMS.GM);
  });
}

async function renderAttList(team) {
  const list = document.getElementById('attList');
  list.innerHTML = '';
  if(!allPlayers.length) {
    const { data } = await supa.from('players')
      .select('id,apodo,nombre,numero_camiseta,equipos').order('apodo',{ascending:true});
    allPlayers = data || [];
  }
  const filtered = team === TEAMS.GM ? allPlayers
    : allPlayers.filter(p => Array.isArray(p.equipos) && p.equipos.includes(team));

  // Split into groups: confirmed, absent, pending (no answer)
  const yes    = filtered.filter(p => attStatuses[p.id] === 'Asiste');
  const no     = filtered.filter(p => attStatuses[p.id] === 'No asiste');
  const duda   = filtered.filter(p => attStatuses[p.id] === 'Duda');
  const pending= filtered.filter(p => !attStatuses[p.id]);

  function makePlayerRow(p) {
    const status = attStatuses[p.id] || null;
    const row = document.createElement('div');
    row.className = 'att-row' +
      (status==='Asiste'?' att-yes' : status==='No asiste'?' att-no' :
       status==='Duda'?' att-maybe' : ' att-pending');
    row.dataset.pid = p.id;

    const av = document.createElement('div'); av.className='att-avatar';
    av.textContent = (p.apodo||p.nombre||'?')[0].toUpperCase();
    const nm = document.createElement('div'); nm.className='att-name';
    nm.textContent = p.apodo || p.nombre || 'â€”';
    const num = document.createElement('div'); num.className='att-num';
    if(p.numero_camiseta) num.textContent = '#'+p.numero_camiseta;

    const taps = document.createElement('div'); taps.className='att-tap-group';
    [['âœ…','Asiste','act-yes'],['âŒ','No asiste','act-no'],['ğŸ¤”','Duda','act-duda']].forEach(([emoji,val,cls])=>{
      const b = document.createElement('button');
      b.className = 'att-tap' + (status===val?' '+cls:'');
      b.textContent = emoji; b.title = val;
      b.addEventListener('click', e=>{
        e.stopPropagation();
        attStatuses[p.id] = attStatuses[p.id]===val ? null : val;
        renderAttList(team); updateAttCounter();
      });
      taps.appendChild(b);
    });

    row.appendChild(av); row.appendChild(nm); row.appendChild(num); row.appendChild(taps);
    return row;
  }

  function addSection(label, players) {
    if(!players.length) return;
    const sep = document.createElement('div');
    sep.className = 'att-section-label';
    sep.textContent = label + ' (' + players.length + ')';
    list.appendChild(sep);
    players.forEach(p => list.appendChild(makePlayerRow(p)));
  }

  addSection('âœ… Asisten', yes);
  addSection('ğŸ¤” Duda', duda);
  addSection('âŒ No asisten', no);
  addSection('â³ Sin respuesta', pending);

  updateAttCounter();
}

function updateAttCounter(){
  const vals = Object.values(attStatuses);
  const yes  = vals.filter(v=>v==='Asiste').length;
  const no   = vals.filter(v=>v==='No asiste').length;
  const duda = vals.filter(v=>v==='Duda').length;
  const total= allPlayers.length;
  const pend = total - yes - no - duda;
  let txt = `âœ… ${yes}  âŒ ${no}`;
  if(duda) txt += `  ğŸ¤” ${duda}`;
  if(pend > 0) txt += `  â³ ${pend}`;
  document.getElementById('attCounter').textContent = txt;
}

const attModalBg = document.getElementById('attModalBg');
document.getElementById('btnCloseAtt').addEventListener('click', ()=>{ attModalBg.style.display='none'; });
attModalBg.addEventListener('click', e=>{ if(e.target===attModalBg) attModalBg.style.display='none'; });

document.getElementById('btnSaveAtt').addEventListener('click', async ()=>{
  if(!supa||!IS_CONNECTED||!attEventId){ alert('Sin conexiÃ³n.'); return; }
  if(!allPlayers.length){ alert('No hay jugadoras cargadas.'); return; }
  try{
    const upserts = allPlayers.map(p=>({
      event_id: attEventId,
      player_id: p.id,
      status: attStatuses[p.id] || 'No asiste',
      updated_at: new Date().toISOString()
    }));
    const {error} = await supa.from('attendance').upsert(upserts, {onConflict:'event_id,player_id'});
    if(error) throw error;

    // Build WA message with attendance summary
    const eventTitle = document.getElementById('attModalTitle').textContent;
    const attTeam = attEventId ? (cachedEvents.find(e=>e.id===attEventId)?.team||TEAMS.GM) : TEAMS.GM;
    const teamPlayers = attTeam === TEAMS.GM ? allPlayers
      : allPlayers.filter(p=>Array.isArray(p.equipos)&&p.equipos.includes(attTeam));
    const yes    = teamPlayers.filter(p=>attStatuses[p.id]==='Asiste').map(p=>p.apodo||p.nombre);
    const no     = teamPlayers.filter(p=>attStatuses[p.id]==='No asiste').map(p=>p.apodo||p.nombre);
    const duda   = teamPlayers.filter(p=>attStatuses[p.id]==='Duda').map(p=>p.apodo||p.nombre);
    const pending= teamPlayers.filter(p=>!attStatuses[p.id]).map(p=>p.apodo||p.nombre);
    const appUrl = window.location.href.split('?')[0];
    let msg = `ğŸ“‹ *Asistencia â€” ${eventTitle}*\n`;
    if(yes.length)     msg += `\nâœ… Asisten (${yes.length}): ${yes.join(', ')}`;
    if(duda.length)    msg += `\nğŸ¤” Duda (${duda.length}): ${duda.join(', ')}`;
    if(no.length)      msg += `\nâŒ No asisten (${no.length}): ${no.join(', ')}`;
    if(pending.length) msg += `\nâ³ Sin responder (${pending.length}): ${pending.join(', ')}`;
    msg += `\n\nğŸ‘‰ Confirma tu asistencia en la app: ${appUrl}`;

    // Share on WA group: copy + open (do before closing modal so toast is visible)
    if(yes.length+no.length+duda.length > 0){
      await waGroupSend(msg);
    }
    attModalBg.style.display='none';
  } catch(err){ alert('Error guardando asistencia: '+(err.message||err)); }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESULTADO PARTIDO
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let resSelectedScorers = new Set();

function openResultModal(event) {
  resSelectedScorers = new Set();
  document.getElementById('resultModalTitle').textContent = 'Resultado â€” ' + (event.title||'Partido');
  document.getElementById('res_event_id').value = event.id;
  document.getElementById('res_opp_label').textContent = event.opponent || 'Rival';
  document.getElementById('res_gf').value = '';
  document.getElementById('res_ga').value = '';
  document.getElementById('res_obs').value = '';

  // Load existing match if any
  if(supa&&IS_CONNECTED){
    supa.from('matches').select('*').eq('event_id', event.id).maybeSingle().then(({data:m})=>{
      if(m){
        document.getElementById('res_gf').value = m.goals_for ?? '';
        document.getElementById('res_ga').value = m.goals_against ?? '';
        document.getElementById('res_obs').value = m.observation || m.notes || '';
        resSelectedScorers = new Set(m.scorer_ids||[]);
      }
      renderScorerGrid(event.team || TEAMS.GM);
    });
  } else { renderScorerGrid(event.team || TEAMS.GM); }

  resultModalBg.style.display='flex';
}

async function renderScorerGrid(team) {
  const grid = document.getElementById('res_scorers_grid');
  grid.innerHTML='';
  if(!allPlayers.length && supa && IS_CONNECTED){
    const {data} = await supa.from('players').select('id,apodo,nombre,numero_camiseta,equipos').order('apodo',{ascending:true});
    allPlayers = data||[];
  }
  const filtered = team===TEAMS.GM ? allPlayers
    : allPlayers.filter(p=>Array.isArray(p.equipos)&&p.equipos.includes(team));
  for(const p of filtered){
    const btn = document.createElement('button'); btn.type='button';
    btn.className = 'conv-player'+(resSelectedScorers.has(p.id)?' selected':'');
    btn.dataset.id=p.id;
    if(p.numero_camiseta){ const s=document.createElement('span');s.className='conv-num';s.textContent='#'+p.numero_camiseta;btn.appendChild(s); }
    const nm=document.createElement('span');nm.textContent=p.apodo||p.nombre||'â€”';btn.appendChild(nm);
    btn.addEventListener('click',()=>{
      resSelectedScorers.has(p.id)?resSelectedScorers.delete(p.id):resSelectedScorers.add(p.id);
      btn.classList.toggle('selected');
    });
    grid.appendChild(btn);
  }
}

const resultModalBg = document.getElementById('resultModalBg');
document.getElementById('btnCloseResult').addEventListener('click',()=>{ resultModalBg.style.display='none'; });
resultModalBg.addEventListener('click', e=>{ if(e.target===resultModalBg) resultModalBg.style.display='none'; });

document.getElementById('btnSaveResult').addEventListener('click', async ()=>{
  if(!supa||!IS_CONNECTED){ alert('Sin conexiÃ³n.'); return; }
  const event_id = document.getElementById('res_event_id').value;
  const gf = parseInt(document.getElementById('res_gf').value);
  const ga = parseInt(document.getElementById('res_ga').value);
  if(isNaN(gf)||isNaN(ga)){ alert('IngresÃ¡ el marcador.'); return; }

  const scorerIds = [...resSelectedScorers];
  // Get scorer names for the scorers array
  const scorerNames = allPlayers.filter(p=>scorerIds.includes(p.id)).map(p=>p.apodo||p.nombre);

  const observation = document.getElementById('res_obs').value.trim()||null;
  const payload = {
    event_id, goals_for:gf, goals_against:ga,
    goal_difference: gf-ga,
    scorer_ids: scorerIds,
    scorers: scorerNames,
    observation
  };
  try{
    // Check if match exists for this event
    const {data:existing} = await supa.from('matches').select('id').eq('event_id',event_id).maybeSingle();
    if(existing){
      const {error} = await supa.from('matches').update(payload).eq('id',existing.id);
      if(error) throw error;
    } else {
      // Also grab event data for the match record
      const {data:ev} = await supa.from('events').select('team,opponent,datetime').eq('id',event_id).maybeSingle();
      const {error} = await supa.from('matches').insert([{
        ...payload,
        team: ev?.team||TEAMS.GM,
        opponent: ev?.opponent||null,
        date: ev?.datetime ? ev.datetime.slice(0,10) : null
      }]);
      if(error) throw error;
    }
    resultModalBg.style.display='none';
    if(document.querySelector('.nav .tab.active')?.dataset.view==='matches') renderMatches();
    renderKPIs();
  } catch(err){ alert('Error: '+(err.message||err)); console.error(err); }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ESTADÃSTICAS INDIVIDUALES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderStats() {
  const grid = document.getElementById('statsGrid');
  const filterTeam = document.getElementById('stats_team_filter').value;
  grid.innerHTML = '<div class="empty-state"><span class="empty-state-icon">â³</span>Calculandoâ€¦</div>';
  if(!supa||!IS_CONNECTED){ grid.innerHTML='<div class="empty-state">Sin conexiÃ³n</div>'; return; }
  try{
    // Load players
    const {data:players} = await supa.from('players').select('id,apodo,nombre,numero_camiseta,foto,equipos').order('apodo',{ascending:true});
    // Load attendance with event info (only entrenos for attendance %)
    const {data:att} = await supa.from('attendance').select('player_id,status,events(type)');
    // Load goals
    const {data:goals} = await supa.from('goals').select('player_id');
    // Load scorer_ids from matches
    const {data:matches} = await supa.from('matches').select('scorer_ids');

    grid.innerHTML='';

    // Build stats per player
    const attByPlayer = {};
    const trainTotal = (att||[]).filter(a=>a.events?.type==='Entrenamiento').length;
    for(const a of (att||[])){
      if(!attByPlayer[a.player_id]) attByPlayer[a.player_id]={total:0,asiste:0};
      if(a.events?.type==='Entrenamiento'){
        attByPlayer[a.player_id].total++;
        if(a.status==='Asiste') attByPlayer[a.player_id].asiste++;
      }
    }
    const goalsByPlayer = {};
    for(const g of (goals||[])){ if(g.player_id) goalsByPlayer[g.player_id]=(goalsByPlayer[g.player_id]||0)+1; }
    // Also count from matches.scorer_ids
    for(const m of (matches||[])){ for(const id of (m.scorer_ids||[])){ goalsByPlayer[id]=(goalsByPlayer[id]||0)+1; } }

    let filtered = (players||[]);
    if(filterTeam!=='all') filtered=filtered.filter(p=>Array.isArray(p.equipos)&&p.equipos.includes(filterTeam));

    // Sort by goals desc, then attendance desc
    filtered.sort((a,b)=>{
      const gd=(goalsByPlayer[b.id]||0)-(goalsByPlayer[a.id]||0);
      if(gd!==0) return gd;
      const ad=(attByPlayer[b.id]?.asiste||0)-(attByPlayer[a.id]?.asiste||0);
      return ad;
    });

    if(!filtered.length){ grid.innerHTML='<div class="empty-state"><span class="empty-state-icon">ğŸ‘¥</span>Sin jugadoras</div>'; return; }

    // Header
    const header = document.createElement('div');
    header.className='stats-row'; header.style.background='var(--surface-2)'; header.style.fontWeight='700'; header.style.fontSize='10px'; header.style.color='var(--muted)'; header.style.textTransform='uppercase'; header.style.letterSpacing='0.5px';
    header.innerHTML='<div></div><div>Jugadora</div><div style="text-align:center">Goles</div><div style="text-align:center">Asistencia</div><div>% entrenamientos</div>';
    grid.appendChild(header);

    for(const p of filtered){
      const goles = goalsByPlayer[p.id]||0;
      const att_data = attByPlayer[p.id]||{total:0,asiste:0};
      const pct = att_data.total>0 ? Math.round(att_data.asiste/att_data.total*100) : null;

      const row = document.createElement('div'); row.className='stats-row';

      // Avatar
      const avWrap = document.createElement('div');
      if(p.foto){
        const img=document.createElement('img');img.className='stats-avatar';img.style.width='40px';img.style.height='40px';img.style.borderRadius='50%';img.style.objectFit='cover';img.src=p.foto;img.alt='';avWrap.appendChild(img);
      } else {
        const av=document.createElement('div');av.className='stats-avatar';av.textContent=(p.apodo||p.nombre||'?')[0].toUpperCase();avWrap.appendChild(av);
      }

      const info=document.createElement('div');
      const nm=document.createElement('div');nm.className='stats-name';nm.textContent=p.apodo||p.nombre||'â€”';
      const sub=document.createElement('div');sub.className='stats-sub';sub.textContent=p.nombre&&p.apodo?p.nombre:(p.numero_camiseta?'#'+p.numero_camiseta:'');
      info.appendChild(nm);info.appendChild(sub);

      const golesKpi=document.createElement('div');golesKpi.className='stats-kpi';
      golesKpi.innerHTML=`<div class="stats-kpi-n">${goles}</div><div class="stats-kpi-l">Goles</div>`;

      const attKpi=document.createElement('div');attKpi.className='stats-kpi';
      attKpi.innerHTML=`<div class="stats-kpi-n">${att_data.asiste}</div><div class="stats-kpi-l">Presencias</div>`;

      const barWrap=document.createElement('div');barWrap.className='stats-bar-wrap';
      if(pct!==null){
        barWrap.innerHTML=`<div class="stats-bar-bg"><div class="stats-bar-fill" style="width:${pct}%"></div></div><div class="stats-pct">${pct}%</div>`;
      } else { barWrap.innerHTML='<div class="stats-pct" style="color:var(--muted-2)">â€”</div>'; }

      row.appendChild(avWrap);row.appendChild(info);row.appendChild(golesKpi);row.appendChild(attKpi);row.appendChild(barWrap);
      grid.appendChild(row);
    }
  } catch(err){ console.error('renderStats',err); grid.innerHTML='<div class="empty-state">Error cargando estadÃ­sticas</div>'; }
}
document.getElementById('stats_team_filter').addEventListener('change', renderStats);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLÃ“N DE ANUNCIOS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const annModalBg = document.getElementById('annModalBg');
let editingAnnId = null;

function openAnnModal(ann=null){
  editingAnnId = ann?.id||null;
  document.getElementById('annModalTitle').textContent = ann ? 'Editar anuncio' : 'Nuevo anuncio';
  document.getElementById('ann_id').value = ann?.id||'';
  document.getElementById('ann_title').value = ann?.title||'';
  document.getElementById('ann_body').value = ann?.body||'';
  document.getElementById('ann_team').value = ann?.team||'Golden Moms';
  document.getElementById('ann_pinned').checked = ann?.pinned||false;
  document.getElementById('btnDeleteAnn').style.display = ann ? '' : 'none';
  annModalBg.style.display='flex';
  document.getElementById('ann_title').focus();
}
function closeAnnModal(){ annModalBg.style.display='none'; editingAnnId=null; }

document.getElementById('btnNewAnn').addEventListener('click',()=>openAnnModal());
document.getElementById('btnCloseAnn').addEventListener('click',closeAnnModal);
annModalBg.addEventListener('click',e=>{if(e.target===annModalBg)closeAnnModal();});

document.getElementById('btnDeleteAnn').addEventListener('click', async ()=>{
  if(!editingAnnId||!supa||!IS_CONNECTED) return;
  if(!confirm('Â¿Eliminar este anuncio?')) return;
  try{
    const {error}=await supa.from('announcements').delete().eq('id',editingAnnId);
    if(error) throw error;
  } catch(err){ alert('Error: '+(err.message||err)); return; }
  closeAnnModal(); renderBoard();
});

document.getElementById('btnSaveAnn').addEventListener('click', async ()=>{
  const title=document.getElementById('ann_title').value.trim();
  if(!title){ alert('El tÃ­tulo es obligatorio.'); return; }
  if(!supa||!IS_CONNECTED){ alert('Sin conexiÃ³n.'); return; }
  const payload={
    title,
    body: document.getElementById('ann_body').value.trim()||null,
    team: document.getElementById('ann_team').value,
    pinned: document.getElementById('ann_pinned').checked,
  };
  try{
    if(editingAnnId){
      const {error}=await supa.from('announcements').update(payload).eq('id',editingAnnId);
      if(error) throw error;
    } else {
      const {error}=await supa.from('announcements').insert([payload]);
      if(error) throw error;
    }
  } catch(err){ alert('Error: '+(err.message||err)); return; }
  closeAnnModal(); renderBoard();
});

async function renderBoard(){
  const list=document.getElementById('boardList');
  list.innerHTML='';
  if(!supa||!IS_CONNECTED){ list.innerHTML='<div class="empty-state">Sin conexiÃ³n</div>'; return; }
  try{
    const {data,error}=await supa.from('announcements').select('*').order('pinned',{ascending:false}).order('created_at',{ascending:false});
    if(error) throw error;
    if(!data?.length){ list.innerHTML='<div class="empty-state"><span class="empty-state-icon">ğŸ“¢</span>Sin anuncios. Â¡Publica el primero!</div>'; return; }
    for(const ann of data){
      const card=document.createElement('div');card.className='ann-card'+(ann.pinned?' pinned':'');
      if(ann.pinned){
        const pin=document.createElement('div');pin.className='ann-pin-badge';pin.textContent='ğŸ“Œ Destacado';card.appendChild(pin);
      }
      const title=document.createElement('div');title.className='ann-title';title.textContent=ann.title;card.appendChild(title);
      if(ann.body){const body=document.createElement('div');body.className='ann-body';body.textContent=ann.body;card.appendChild(body);}
      const meta=document.createElement('div');meta.className='ann-meta';
      const d=safeDate(ann.created_at);
      const teamBadge=document.createElement('span');
      teamBadge.className='ev-team-badge '+teamBadgeClass(ann.team==='Todos'?TEAMS.GM:ann.team);
      teamBadge.textContent=ann.team;
      meta.appendChild(teamBadge);
      if(d){ const dt=document.createElement('span');dt.textContent=d.toLocaleDateString('es-CL',{day:'2-digit',month:'short',year:'numeric'});meta.appendChild(dt); }
      const editBtn=document.createElement('button');editBtn.className='ann-edit-btn';editBtn.textContent='âœï¸ Editar';
      editBtn.addEventListener('click',()=>openAnnModal(ann));meta.appendChild(editBtn);
      // WhatsApp share
      const waText = `ğŸ“¢ *${ann.title}*${ann.body?'\n\n'+ann.body:''}\n\n_Golden Moms_`;
      const waBtn = document.createElement('button');
      waBtn.className='btn-wa';
      waBtn.innerHTML = WA_ICON + ' Compartir al grupo';
      waBtn.addEventListener('click', () => waGroupSend(waText));
      meta.appendChild(waBtn);
      card.appendChild(meta);
      list.appendChild(card);
    }
  } catch(err){ console.error('renderBoard',err); list.innerHTML='<div class="empty-state">Error cargando anuncios</div>'; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CUOTAS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const feeModalBg=document.getElementById('feeModalBg');
let editingFeeId=null;
let feePaymentsState={}; // player_id â†’ boolean

async function openFeeModal(fee=null){
  editingFeeId=fee?.id||null;
  feePaymentsState={};
  document.getElementById('feeModalTitle').textContent=fee?'Editar cuota':'Nueva cuota';
  document.getElementById('fee_id').value=fee?.id||'';
  document.getElementById('fee_title').value=fee?.title||'';
  document.getElementById('fee_amount').value=fee?.amount||'';
  document.getElementById('fee_due').value=fee?.due_date||'';
  document.getElementById('fee_team').value=fee?.team||'Golden Moms';
  document.getElementById('btnDeleteFee').style.display=fee?'':'none';

  // Load payment statuses
  const pgrid=document.getElementById('fee_payments_grid');
  pgrid.innerHTML='<div style="color:var(--muted);font-size:12px;padding:8px">Cargando jugadorasâ€¦</div>';
  feeModalBg.style.display='flex';

  if(!supa||!IS_CONNECTED){ pgrid.innerHTML='<div style="color:var(--muted)">Sin conexiÃ³n</div>'; return; }
  try{
    // Load players
    if(!allPlayers.length){
      const {data}=await supa.from('players').select('id,apodo,nombre,numero_camiseta,equipos').order('apodo',{ascending:true});
      allPlayers=data||[];
    }
    const teamFilter=document.getElementById('fee_team').value;
    let filtered=allPlayers;
    if(teamFilter!=='Todos') filtered=filtered.filter(p=>Array.isArray(p.equipos)&&p.equipos.includes(teamFilter));

    // Load existing payments if editing
    if(fee?.id){
      const {data:payments}=await supa.from('fee_payments').select('player_id,paid').eq('fee_id',fee.id);
      for(const pay of (payments||[])){ feePaymentsState[pay.player_id]=pay.paid; }
    }

    renderFeePaymentsGrid(filtered);
  } catch(err){ pgrid.innerHTML='<div style="color:var(--danger)">Error cargando jugadoras</div>'; }
}

function renderFeePaymentsGrid(players){
  const pgrid=document.getElementById('fee_payments_grid');
  pgrid.innerHTML='';
  for(const p of players){
    const paid=feePaymentsState[p.id]||false;
    const row=document.createElement('div');row.className='fee-player-row';
    const av=document.createElement('div');av.className='att-avatar';av.style.width='28px';av.style.height='28px';av.style.fontSize='11px';
    av.textContent=(p.apodo||p.nombre||'?')[0].toUpperCase();
    const nm=document.createElement('div');nm.className='fee-player-name';nm.textContent=p.apodo||p.nombre||'â€”';
    const toggle=document.createElement('button');toggle.type='button';
    toggle.className='fee-toggle '+(paid?'paid':'unpaid');
    toggle.textContent=paid?'âœ… PagÃ³':'âŒ Debe';
    toggle.dataset.pid=p.id;
    toggle.addEventListener('click',()=>{
      feePaymentsState[p.id]=!feePaymentsState[p.id];
      toggle.className='fee-toggle '+(feePaymentsState[p.id]?'paid':'unpaid');
      toggle.textContent=feePaymentsState[p.id]?'âœ… PagÃ³':'âŒ Debe';
    });
    row.appendChild(av);row.appendChild(nm);row.appendChild(toggle);
    pgrid.appendChild(row);
  }
}

document.getElementById('fee_team').addEventListener('change', ()=>{
  if(!allPlayers.length) return;
  const t=document.getElementById('fee_team').value;
  const filtered=t==='Todos'?allPlayers:allPlayers.filter(p=>Array.isArray(p.equipos)&&p.equipos.includes(t));
  renderFeePaymentsGrid(filtered);
});

function closeFeeModal(){ feeModalBg.style.display='none'; editingFeeId=null; feePaymentsState={}; }
document.getElementById('btnNewFee').addEventListener('click',()=>openFeeModal());
document.getElementById('btnCloseFee').addEventListener('click',closeFeeModal);
feeModalBg.addEventListener('click',e=>{ if(e.target===feeModalBg) closeFeeModal(); });

document.getElementById('btnDeleteFee').addEventListener('click', async ()=>{
  if(!editingFeeId||!supa||!IS_CONNECTED) return;
  if(!confirm('Â¿Eliminar esta cuota y todos sus pagos?')) return;
  try{
    await supa.from('fee_payments').delete().eq('fee_id',editingFeeId);
    const {error}=await supa.from('fees').delete().eq('id',editingFeeId);
    if(error) throw error;
  } catch(err){ alert('Error: '+(err.message||err)); return; }
  closeFeeModal(); renderFees();
});

document.getElementById('btnSaveFee').addEventListener('click', async ()=>{
  const title=document.getElementById('fee_title').value.trim();
  if(!title){ alert('El tÃ­tulo es obligatorio.'); return; }
  if(!supa||!IS_CONNECTED){ alert('Sin conexiÃ³n.'); return; }
  const amount=document.getElementById('fee_amount').value;
  const payload={
    title,
    amount: amount?parseFloat(amount):null,
    due_date: document.getElementById('fee_due').value||null,
    team: document.getElementById('fee_team').value,
  };
  try{
    let feeId=editingFeeId;
    if(editingFeeId){
      const {error}=await supa.from('fees').update(payload).eq('id',editingFeeId);
      if(error) throw error;
    } else {
      const {data,error}=await supa.from('fees').insert([payload]).select('id');
      if(error) throw error;
      feeId=data?.[0]?.id;
    }
    // Upsert payments
    if(feeId){
      const upserts=Object.entries(feePaymentsState).map(([player_id,paid])=>({
        fee_id:feeId, player_id, paid,
        paid_at: paid ? new Date().toISOString() : null
      }));
      if(upserts.length){
        const {error}=await supa.from('fee_payments').upsert(upserts,{onConflict:'fee_id,player_id'});
        if(error) console.warn('fee_payments upsert:',error);
      }
    }
  } catch(err){ alert('Error: '+(err.message||err)); return; }
  closeFeeModal(); renderFees();
});

async function renderFees(){
  const list=document.getElementById('feesList');
  list.innerHTML='';
  if(!supa||!IS_CONNECTED){ list.innerHTML='<div class="empty-state">Sin conexiÃ³n</div>'; return; }
  try{
    const {data:fees,error}=await supa.from('fees').select('*').order('created_at',{ascending:false});
    if(error) throw error;
    if(!fees?.length){ list.innerHTML='<div class="empty-state"><span class="empty-state-icon">ğŸ’°</span>No hay cuotas. Â¡Crea la primera!</div>'; return; }

    for(const fee of fees){
      // Load payments for this fee
      const {data:payments}=await supa.from('fee_payments').select('player_id,paid');
      const paidSet=new Set((payments||[]).filter(p=>p.paid).map(p=>p.player_id));
      const totalPayers=(payments||[]).length;
      const paidCount=paidSet.size;
      const pct=totalPayers>0?Math.round(paidCount/totalPayers*100):0;

      const card=document.createElement('div');card.className='fee-card';

      const header=document.createElement('div');header.className='fee-header';
      const left=document.createElement('div');
      const title=document.createElement('div');title.className='fee-title';title.textContent=fee.title;
      const meta=document.createElement('div');meta.className='fee-meta';
      const parts=[];
      if(fee.amount) parts.push('$'+Number(fee.amount).toLocaleString('es-CL'));
      if(fee.due_date) parts.push('Vence: '+safeDateOnly(fee.due_date)?.toLocaleDateString('es-CL',{day:'2-digit',month:'short'})||fee.due_date);
      parts.push(fee.team);
      meta.textContent=parts.join(' Â· ');
      left.appendChild(title);left.appendChild(meta);

      const right=document.createElement('div');right.style.display='flex';right.style.alignItems='center';right.style.gap='10px';
      const progWrap=document.createElement('div');progWrap.className='fee-progress-wrap';
      progWrap.innerHTML=`<div class="fee-progress-bg"><div class="fee-progress-fill" style="width:${pct}%"></div></div><div class="fee-pct">${paidCount}/${totalPayers}</div>`;
      const editBtn=document.createElement('button');editBtn.className='fee-edit-btn';editBtn.textContent='âœï¸ Editar';
      editBtn.addEventListener('click',e=>{e.stopPropagation();openFeeModal(fee);});
      right.appendChild(progWrap);right.appendChild(editBtn);

      header.appendChild(left);header.appendChild(right);

      // Collapsible body with per-player status
      const body=document.createElement('div');body.className='fee-body fee-collapsed';
      if(payments?.length){
        // Load player names (with celular for WA reminders) â€” always reload with celular
        {
          const {data:pl}=await supa.from('players').select('id,apodo,nombre,celular').order('apodo',{ascending:true});
          if(pl?.length) allPlayers=pl;
        }
        const playerMap=Object.fromEntries(allPlayers.map(p=>[p.id,p]));
        for(const pay of (payments||[])){
          const pl=playerMap[pay.player_id];
          if(!pl) continue;
          const row=document.createElement('div');row.className='fee-player-row';
          const nm=document.createElement('span');nm.className='fee-player-name';nm.textContent=pl.apodo||pl.nombre||'â€”';
          const status=document.createElement('span');
          status.className='fee-toggle '+(pay.paid?'paid':'unpaid');
          status.textContent=pay.paid?'âœ… PagÃ³':'âŒ Debe';
          // Toggle payment inline
          status.style.cursor='pointer';
          status.addEventListener('click', async ()=>{
            const newPaid=!pay.paid;
            try{
              await supa.from('fee_payments').upsert([{fee_id:fee.id,player_id:pay.player_id,paid:newPaid,paid_at:newPaid?new Date().toISOString():null}],{onConflict:'fee_id,player_id'});
              pay.paid=newPaid;
              status.className='fee-toggle '+(newPaid?'paid':'unpaid');
              status.textContent=newPaid?'âœ… PagÃ³':'âŒ Debe';
              waReminder.style.display = newPaid ? 'none' : '';
            } catch(e){ console.warn(e); }
          });
          // WA reminder â€” only visible if unpaid
          const waReminder = document.createElement('a');
          waReminder.className='btn-wa'; waReminder.target='_blank'; waReminder.rel='noopener noreferrer';
          const playerName = pl.apodo||pl.nombre||'';
          const playerPhone = pl.celular ? pl.celular.replace(/\D/g,'') : '';
          const feeMsg = `Hola ${playerName} ğŸ‘‹ Te recordamos que tienes pendiente la cuota *${fee.title}*${fee.amount?' por $'+Number(fee.amount).toLocaleString('es-CL'):''} del equipo Golden Moms ğŸ’š`;
          // If we have their number, send direct; otherwise open chat selector
          if(playerPhone){
            // Direct chat with pre-filled message (works for individual wa.me links)
            const cleanPhone = playerPhone.replace(/^\+?56/,'').replace(/\D/g,'');
            waReminder.href = `https://wa.me/56${cleanPhone}?text=${encodeURIComponent(feeMsg)}`;
          } else {
            // No phone: copy message and open group
            waReminder.href = '#';
            waReminder.addEventListener('click', e=>{
              e.preventDefault();
              waGroupSend(feeMsg);
            });
          }
          waReminder.innerHTML = WA_ICON + (playerPhone ? ' Recordar' : ' Recordar (grupo)');
          waReminder.style.display = pay.paid ? 'none' : '';
          row.appendChild(nm);row.appendChild(status);row.appendChild(waReminder);body.appendChild(row);
        }
      }
      // Toggle expand
      header.addEventListener('click',()=>{
        body.classList.toggle('fee-collapsed');
      });
      card.appendChild(header);card.appendChild(body);
      list.appendChild(card);
    }
  } catch(err){ console.error('renderFees',err); list.innerHTML='<div class="empty-state">Error cargando cuotas</div>'; }
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WHATSAPP HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const WA_ICON = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.127.558 4.121 1.532 5.849L.073 23.927l6.244-1.635A11.945 11.945 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 21.818a9.818 9.818 0 01-5.007-1.373l-.36-.214-3.707.972.989-3.614-.234-.373A9.818 9.818 0 1112 21.818z"/></svg>`;

const WA_GROUP = 'https://chat.whatsapp.com/CJlsdVUqSjJAiaXZBaSi41';

function waLink(text) {
  return 'https://wa.me/?text=' + encodeURIComponent(text);
}

function waGroupLink(text) {
  // ?text= no funciona en links de grupo â€” copiamos al portapapeles y abrimos el grupo
  try { navigator.clipboard.writeText(text); } catch(e) {}
  return WA_GROUP;
}

function showToast(msg, duration=2800) {
  const t = document.getElementById('toast');
  if(!t) return;
  t.textContent = msg; t.classList.add('show');
  clearTimeout(t._to);
  t._to = setTimeout(() => t.classList.remove('show'), duration);
}

async function waGroupSend(text) {
  // Copy to clipboard then open group
  try {
    await navigator.clipboard.writeText(text);
    showToast('ğŸ“‹ Mensaje copiado â€” pegalo en el grupo');
  } catch(e) {
    showToast('Abriendo grupo de WhatsAppâ€¦');
  }
  setTimeout(() => window.open(WA_GROUP, '_blank'), 400);
}

function makeWaBtn(text, label='WhatsApp') {
  const a = document.createElement('a');
  a.className = 'btn-wa';
  a.href = waLink(text);
  a.target = '_blank';
  a.rel = 'noopener noreferrer';
  a.innerHTML = WA_ICON + label;
  return a;
}

</script>

<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('/sw.js').catch(console.warn));
}
</script>

<div class="toast" id="toast"></div>
</body>
</html>
