<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms â€” Panel</title>
<link rel="icon" href="Logo.webp"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
/* --- OMITO estilos para acortar aquÃ­ en este bloque (usa los mismos que ya tenÃ­as) --- */
/* Puedes pegar exactamente tus estilos anteriores aquÃ­; los mantengo iguales. */
:root{ --blue:#0f3a78; --lime:#9be22d; --ink:#0f172a; --mut:#64748b; --b:#e2e8f0; --bg:#f7f8fa }
*{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
.btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer;font-size:12px}
.btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
.btn.s{background:#f8fafc}
/* ... (resto de estilos idÃ©nticos a tu versiÃ³n) ... */
.modal-bg{ position:fixed; inset:0; background:#0006; display:none; z-index:1000; justify-content:center; align-items:center; padding:12px; overflow-y:auto; }
.modal{ width: min(920px, calc(100% - 32px)); margin: 0 auto; background:#fff; border:1px solid var(--b); border-radius:14px; padding:16px; box-shadow:0 20px 40px #00000022; max-height:calc(100vh - 48px); overflow:auto; box-sizing:border-box;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.input, select, textarea{width:100%;padding:10px;border:1px solid var(--b);border-radius:10px;background:#fff}
.meta-small{ font-size:12px; color:var(--mut); margin-top:6px; }
</style>
</head>
<body>
<!-- (top / nav / container / vistas: idem a tu versiÃ³n previa) -->
<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM" style="width:32px;height:32px;border-radius:50%;border:2px solid #0f3a78"/>
    <div><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <div id="connStatus" style="font-size:12px;color:var(--mut)">Comprobando conexiÃ³nâ€¦</div>
    <div class="nav" role="tablist" aria-label="NavegaciÃ³n">
      <button class="tab active" data-view="dash">Dashboard</button>
      <button class="tab" data-view="events">Eventos</button>
      <button class="tab" data-view="roster">Plantel</button>
      <button class="tab" data-view="matches">Partidos</button>
    </div>
  </div>
</div>

<div class="container">
  <!-- DASHBOARD / EVENTOS / PLANTEL / PARTIDOS: mantengo tu estructura anterior -->
  <section id="v-dash">
    <!-- ... dashboard content ... -->
    <div style="padding:12px">
      <h4>Plantel</h4>
      <div id="rosterGrid" class="grid" style="margin-top:8px;display:grid;grid-template-columns:repeat(12,1fr);gap:12px"></div>
    </div>
  </section>

  <section id="v-events" style="display:none">
    <!-- ... tu calendario (igual que antes) ... -->
    <div style="padding:12px">
      <div id="monthGrid" class="month-grid"></div>
      <div id="monthList" class="month-list"></div>
    </div>
  </section>

  <section id="v-roster" style="display:none">
    <div class="card">
      <h4>Plantel</h4>
      <div class="section-note">Listado del plantel (tabla <code>players</code>) â€” toca una tarjeta para ver/editar.</div>
      <div id="rosterGrid" class="grid" style="margin-top:8px"></div>
    </div>
  </section>

  <section id="v-matches" style="display:none">
    <div class="card"><h4>Partidos</h4><div id="matchesList"></div></div>
  </section>
</div>

<footer style="text-align:center;padding:16px;color:var(--mut);font-size:12px">Golden Moms Â· hecho con ðŸ’š lima & azul</footer>

<!-- ------------------ PLAYER modal con lÃ³gica segura ------------------ -->
<div class="modal-bg" id="playerModalBg" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="playerModalTitle">
    <h3 id="playerModalTitle">Jugadora</h3>

    <div style="display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:start">
      <div>
        <img id="p_img_preview" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect fill='%23f1f5f9' width='100%25' height='100%25'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='14' fill='%2364748b'>Sin foto</text></svg>" alt="foto" style="width:120px;height:120px;border-radius:8px;object-fit:cover;border:1px solid var(--b)" />
        <div class="meta-small">La foto (si existe) se edita directamente en Supabase</div>
      </div>

      <div>
        <div id="playerSaveNotice" class="meta-small" style="margin-bottom:8px;color:var(--mut)"></div>

        <div class="form-row">
          <div>
            <label>Apodo</label>
            <input id="p_apodo" class="input" placeholder="Apodo (ej: Ale)"/>
          </div>
          <div>
            <label>Nombre completo</label>
            <input id="p_nombre" class="input" placeholder="Nombre (ej: Alejandra PÃ©rez)"/>
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div>
            <label>NÃºmero de camiseta</label>
            <input id="p_numero" class="input" placeholder="14" type="number" min="0"/>
          </div>
          <div>
            <label>Rol / PosiciÃ³n</label>
            <select id="p_rol" class="input"></select>
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div>
            <label>Equipos</label>
            <select id="p_equipos_select" class="input" multiple size="4"></select>
            <div style="font-size:12px;color:var(--mut);margin-top:6px">MantÃ©n Ctrl/Cmd o usa Shift para seleccionar mÃºltiples; o agrega equipos adicionales abajo.</div>
            <input id="p_equipos_extra" class="input" placeholder="Equipos extra, separados por comas" style="margin-top:8px"/>
          </div>
          <div>
            <label>Estado</label>
            <select id="p_estado" class="input"></select>
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div>
            <label>Fecha de nacimiento</label>
            <input id="p_fecha_nac" class="input" type="date"/>
          </div>
          <div>
            <label>Celular</label>
            <input id="p_celular" class="input" placeholder="+56 9 ..."/>
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div>
            <label>Tel. emergencia</label>
            <input id="p_telemer" class="input" placeholder="TelÃ©fono de emergencia"/>
          </div>
          <div>
            <label>Mail</label>
            <input id="p_email" class="input" placeholder="email@ejemplo.com"/>
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div>
            <label>RUT</label>
            <input id="p_rut" class="input" placeholder="RUT"/>
          </div>
          <div>
            <label>Seguro mÃ©dico</label>
            <input id="p_seguro" class="input" placeholder="Nombre seguro"/>
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div>
            <label>Curso hijos / nota</label>
            <input id="p_curso_hijos" class="input" placeholder="Curso hijos (si aplica)"/>
          </div>
          <div></div>
        </div>

        <div class="modal-actions" style="margin-top:12px">
          <button class="btn s" id="btnDeletePlayer" style="margin-right:auto">Eliminar</button>
          <button class="btn s" id="btnCancelPlayer">Cancelar</button>
          <button class="btn p" id="btnSavePlayer">Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Supabase config & init (idÃ©ntico a tu versiÃ³n estable) ---------- */
const SUPA = { url: "https://xglojvvbgaivwbpdxvne.supabase.co", key: "TU_KEY_AQUI_REEMPLAZAR" };
let supa = null;
let IS_CONNECTED = false;
async function initSupabase(timeoutMs = 8000){
  try{
    if(typeof createClient === 'function'){ supa = createClient(SUPA.url, SUPA.key); }
    else if(window.supabase && typeof window.supabase.createClient === 'function'){ supa = window.supabase.createClient(SUPA.url, SUPA.key); }
    else {
      await new Promise((resolve,reject)=>{
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js';
        s.async = true;
        let done=false;
        const to=setTimeout(()=>{ if(!done){ done=true; reject(new Error('timeout cargando supabase')); }}, timeoutMs);
        s.onload=()=>{ if(done) return; done=true; clearTimeout(to); resolve(); };
        s.onerror=()=>{ if(done) return; done=true; clearTimeout(to); reject(new Error('error cargando supabase')); };
        document.head.appendChild(s);
      });
      if(typeof createClient === 'function') supa = createClient(SUPA.url, SUPA.key);
      else if(window.supabase && typeof window.supabase.createClient === 'function') supa = window.supabase.createClient(SUPA.url, SUPA.key);
    }
    // test
    try{
      const test = await supa.from('players').select('id').limit(1);
      IS_CONNECTED = !(test && test.error);
    }catch(e){ IS_CONNECTED = false; }
  }catch(e){ console.error(e); IS_CONNECTED = false; supa = null; }
  document.getElementById('connStatus').textContent = IS_CONNECTED ? 'Conectado a Supabase' : 'Sin conexiÃ³n a Supabase (ver consola)';
}

/* ---------- utilidades ---------- */
function pad(n){return n.toString().padStart(2,'0');}
function isoToLocalDateInput(iso){ if(!iso) return ''; const d=new Date(iso); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

/* ---------- variables y refs del modal ---------- */
const playerModalBg = document.getElementById('playerModalBg');
const p_img_preview = document.getElementById('p_img_preview');
const p_apodo = document.getElementById('p_apodo');
const p_nombre = document.getElementById('p_nombre');
const p_numero = document.getElementById('p_numero');
const p_rol = document.getElementById('p_rol');
const p_equipos_select = document.getElementById('p_equipos_select');
const p_equipos_extra = document.getElementById('p_equipos_extra');
const p_estado = document.getElementById('p_estado');
const p_fecha_nac = document.getElementById('p_fecha_nac');
const p_celular = document.getElementById('p_celular');
const p_telemer = document.getElementById('p_telemer');
const p_email = document.getElementById('p_email');
const p_rut = document.getElementById('p_rut');
const p_seguro = document.getElementById('p_seguro');
const p_curso_hijos = document.getElementById('p_curso_hijos');
const btnSavePlayer = document.getElementById('btnSavePlayer');
const btnDeletePlayer = document.getElementById('btnDeletePlayer');
const btnCancelPlayer = document.getElementById('btnCancelPlayer');
const playerSaveNotice = document.getElementById('playerSaveNotice');

let CURRENT_PLAYER = null;       // objeto completo tal como lo devuelve Supabase
let CURRENT_PLAYER_KEYS = [];    // lista de columnas presentes en la fila (para no inventar columnas)
const DEFAULT_TEAMS = ['Golden Moms','Golden Dream','Golden Power'];
const DEFAULT_ESTADOS = ['activo','reposo'];
const DEFAULT_ROLES = ['jugadora','capitana','dt','admin'];

/* ---------- helpers para cargar selects (tolerantes) ---------- */
async function loadTeamsOptions(selectedCsv){
  p_equipos_select.innerHTML = '';
  try{
    // intentamos recoger equipos de todos los jugadores (si hay conexiÃ³n), pero si no, usamos DEFAULT_TEAMS
    const set = new Set(DEFAULT_TEAMS);
    if(supa && IS_CONNECTED){
      const { data } = await supa.from('players').select('equipos');
      (data||[]).forEach(r=>{
        if(r && r.equipos){
          // r.equipos puede ser array o CSV segÃºn tu esquema; lo normal es array
          if(Array.isArray(r.equipos)) r.equipos.forEach(x=>x && set.add(x));
          else r.equipos.split(',').map(s=>s.trim()).filter(Boolean).forEach(x=>set.add(x));
        }
      });
    }
    const arr = Array.from(set).sort();
    arr.forEach(t=>{
      const o = document.createElement('option'); o.value=t; o.textContent=t; p_equipos_select.appendChild(o);
    });
    // seleccionar los existentes
    const selected = (selectedCsv||'').split?.(',').map(s=>s.trim()).filter(Boolean) || [];
    for(const opt of p_equipos_select.options) if(selected.includes(opt.value)) opt.selected = true;
    // extras:
    const extras = selected.filter(s=> !arr.includes(s) );
    p_equipos_extra.value = extras.join(', ');
  }catch(err){
    console.warn('loadTeamsOptions error', err);
    // fallback simple
    DEFAULT_TEAMS.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; p_equipos_select.appendChild(o); });
  }
}

async function loadEnums(selectedEstado, selectedRol){
  p_estado.innerHTML=''; p_rol.innerHTML='';
  try{
    const estados = new Set(DEFAULT_ESTADOS); const roles = new Set(DEFAULT_ROLES);
    if(supa && IS_CONNECTED){
      const { data } = await supa.from('players').select('Estado, rol');
      (data||[]).forEach(r=>{
        if(r && r.Estado) estados.add(r.Estado);
        if(r && r.rol) roles.add(r.rol);
      });
    }
    const estadosArr = Array.from(estados).filter(Boolean).sort();
    const rolesArr = Array.from(roles).filter(Boolean).sort();
    const empty = document.createElement('option'); empty.value=''; empty.textContent='(definir)';
    p_estado.appendChild(empty.cloneNode(true));
    estadosArr.forEach(e=>{ const o=document.createElement('option'); o.value=e; o.textContent=e; if(e===selectedEstado) o.selected=true; p_estado.appendChild(o); });
    p_rol.appendChild(empty.cloneNode(true));
    rolesArr.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; if(r===selectedRol) o.selected=true; p_rol.appendChild(o); });
    // si selected no estaba en list, lo agregamos
    if(selectedEstado && !estadosArr.includes(selectedEstado)){ const o=document.createElement('option'); o.value=selectedEstado; o.textContent=selectedEstado; o.selected=true; p_estado.appendChild(o); }
    if(selectedRol && !rolesArr.includes(selectedRol)){ const o=document.createElement('option'); o.value=selectedRol; o.textContent=selectedRol; o.selected=true; p_rol.appendChild(o); }
  }catch(err){
    console.warn('loadEnums error', err);
    // fallback
    const empty = document.createElement('option'); empty.value=''; empty.textContent='(definir)';
    p_estado.appendChild(empty.cloneNode(true));
    DEFAULT_ESTADOS.forEach(e=>{ const o=document.createElement('option'); o.value=e; o.textContent=e; if(e===selectedEstado) o.selected=true; p_estado.appendChild(o); });
    p_rol.appendChild(empty.cloneNode(true));
    DEFAULT_ROLES.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; if(r===selectedRol) o.selected=true; p_rol.appendChild(o); });
  }
}

/* ---------- abrir modal jugador (seguro: solo columnas existentes) ---------- */
function openPlayerModal(player){
  // player es el objeto devuelto por Supabase (puede contener solo columnas existentes)
  CURRENT_PLAYER = player || null;
  CURRENT_PLAYER_KEYS = CURRENT_PLAYER ? Object.keys(CURRENT_PLAYER) : [];

  // TÃ­tulo
  const title = (player?.apodo ? player.apodo : (player?.nombre || 'Jugadora'));
  document.getElementById('playerModalTitle').textContent = `${title} ${player?.nombre ? '('+player.nombre+')' : ''}`;

  // Preview foto (solo si existe la columna foto en el objeto)
  if(CURRENT_PLAYER_KEYS.includes('foto') && player.foto){
    p_img_preview.src = player.foto;
  } else {
    p_img_preview.src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect fill='%23f1f5f9' width='100%25' height='100%25'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='14' fill='%2364748b'>Sin foto</text></svg>";
  }

  // Rellenar campos SOLO si la columna existe en la fila
  if(CURRENT_PLAYER_KEYS.includes('apodo')) p_apodo.value = player.apodo || '';
  else p_apodo.value = '';

  if(CURRENT_PLAYER_KEYS.includes('nombre')) p_nombre.value = player.nombre || '';
  else p_nombre.value = '';

  if(CURRENT_PLAYER_KEYS.includes('numero_camiseta')) p_numero.value = player.numero_camiseta != null ? player.numero_camiseta : '';
  else p_numero.value = '';

  // enums y equipos (cargamos las opciones y seleccionamos los existentes)
  awaitLoadEnumsAndTeams(player);

  if(CURRENT_PLAYER_KEYS.includes('fecha_nacimiento')) p_fecha_nac.value = player.fecha_nacimiento ? isoToLocalDateInput(player.fecha_nacimiento) : '';
  else p_fecha_nac.value = '';

  if(CURRENT_PLAYER_KEYS.includes('celular')) p_celular.value = player.celular || ''; else p_celular.value = '';
  if(CURRENT_PLAYER_KEYS.includes('Telefono_emergencia')) p_telemer.value = player.Telefono_emergencia || ''; else p_telemer.value = '';
  if(CURRENT_PLAYER_KEYS.includes('email')) p_email.value = player.email || ''; else p_email.value = '';
  if(CURRENT_PLAYER_KEYS.includes('Rut')) p_rut.value = player.Rut || ''; else p_rut.value = '';
  if(CURRENT_PLAYER_KEYS.includes('Seguro_Medico')) p_seguro.value = player.Seguro_Medico || ''; else p_seguro.value = '';
  if(CURRENT_PLAYER_KEYS.includes('Curso_hijos')) p_curso_hijos.value = player.Curso_hijos || ''; else p_curso_hijos.value = '';

  // Mostrar aviso: cuÃ¡les campos del formulario se guardarÃ¡n (es decir: estÃ¡n presentes en la fila)
  const formFieldsMap = {
    apodo: 'Apodo', nombre: 'Nombre', numero_camiseta: 'NÃºmero', rol: 'Rol', equipos:'Equipos',
    fecha_nacimiento:'Fecha nacimiento', celular:'Celular', Telefono_emergencia:'Tel. emergencia',
    email:'Mail', Rut:'RUT', Seguro_Medico:'Seguro mÃ©dico', Curso_hijos:'Curso hijos'
  };
  const willSave = [];
  const willNotSave = [];
  Object.entries(formFieldsMap).forEach(([col,label])=>{
    if(CURRENT_PLAYER_KEYS.includes(col)) willSave.push(label); else willNotSave.push(label);
  });
  playerSaveNotice.innerHTML = `<strong>Se guardarÃ¡n:</strong> ${willSave.join(', ') || 'â€”'}<br/><small style="color:var(--mut)"><strong>No se guardarÃ¡n (columna ausente):</strong> ${willNotSave.join(', ') || 'â€”'}</small>`;

  // mostrar modal
  playerModalBg.style.display = 'flex';
  playerModalBg.setAttribute('aria-hidden','false');
}

async function awaitLoadEnumsAndTeams(player){
  // espera la carga de enums/teams y selecciona valores existentes si estÃ¡n
  const equiposCsv = (player && (player.equipos && (Array.isArray(player.equipos) ? player.equipos.join(',') : player.equipos))) || '';
  await loadTeamsOptions(equiposCsv);
  const selectedRol = (player && player.rol) || '';
  const selectedEstado = (player && (player.Estado || player.estado)) || '';
  await loadEnums(selectedEstado, selectedRol);
}

/* ---------- cerrar modal ---------- */
function closePlayerModal(){
  playerModalBg.style.display = 'none';
  playerModalBg.setAttribute('aria-hidden','true');
  CURRENT_PLAYER = null; CURRENT_PLAYER_KEYS = [];
}
btnCancelPlayer.addEventListener('click', closePlayerModal);
playerModalBg.addEventListener('click', (e)=>{ if(e.target === playerModalBg) closePlayerModal(); });

/* ---------- guardar Jugadora (solo columnas existentes) ---------- */
btnSavePlayer.addEventListener('click', async ()=>{
  if(!supa || !IS_CONNECTED){ alert('No conectado a Supabase.'); return; }
  if(!CURRENT_PLAYER || !CURRENT_PLAYER.id){ alert('No hay jugadora seleccionada'); return; }

  // Construir payload sÃ³lo con columnas que existÃ­an en la fila (CURRENT_PLAYER_KEYS)
  const payload = {};

  if(CURRENT_PLAYER_KEYS.includes('apodo')) payload.apodo = p_apodo.value.trim() || null;
  if(CURRENT_PLAYER_KEYS.includes('nombre')) payload.nombre = p_nombre.value.trim() || null;
  if(CURRENT_PLAYER_KEYS.includes('numero_camiseta')){
    payload.numero_camiseta = p_numero.value !== '' ? (isNaN(Number(p_numero.value)) ? null : Number(p_numero.value)) : null;
  }
  if(CURRENT_PLAYER_KEYS.includes('rol')) payload.rol = p_rol.value || null;

  // equipos: intentamos guardar como text[] si la columna existe
  if(CURRENT_PLAYER_KEYS.includes('equipos')){
    const selected = Array.from(p_equipos_select.selectedOptions).map(o=>o.value.trim()).filter(Boolean);
    const extra = (p_equipos_extra.value || '').split(',').map(s=>s.trim()).filter(Boolean);
    const all = Array.from(new Set([...(selected||[]), ...extra]));
    payload.equipos = all.length ? all : [];
  }

  if(CURRENT_PLAYER_KEYS.includes('Estado')) payload.Estado = p_estado.value || null;
  if(CURRENT_PLAYER_KEYS.includes('fecha_nacimiento')) payload.fecha_nacimiento = p_fecha_nac.value ? new Date(p_fecha_nac.value).toISOString() : null;
  if(CURRENT_PLAYER_KEYS.includes('celular')) payload.celular = p_celular.value.trim() || null;
  if(CURRENT_PLAYER_KEYS.includes('Telefono_emergencia')) payload.Telefono_emergencia = p_telemer.value.trim() || null;
  if(CURRENT_PLAYER_KEYS.includes('email')) payload.email = p_email.value.trim() || null;
  if(CURRENT_PLAYER_KEYS.includes('Rut')) payload.Rut = p_rut.value.trim() || null;
  if(CURRENT_PLAYER_KEYS.includes('Seguro_Medico')) payload.Seguro_Medico = p_seguro.value.trim() || null;
  if(CURRENT_PLAYER_KEYS.includes('Curso_hijos')) payload.Curso_hijos = p_curso_hijos.value.trim() || null;

  // Si payload estÃ¡ vacÃ­o (no hay columnas coincidentes) avisar y salir
  if(Object.keys(payload).length===0){ alert('No hay columnas en la tabla players que correspondan a los campos de este formulario. Revisa esquema.'); return; }

  try{
    const { error } = await supa.from('players').update(payload).eq('id', CURRENT_PLAYER.id);
    if(error) throw error;
    closePlayerModal();
    // refrescar listados
    renderDash(); // tu funciÃ³n que recarga roster y dashboard
    renderMonth && renderMonth();
  }catch(err){
    console.error('Error actualizando player:', err);
    alert('Error guardando cambios. Revisa consola.');
  }
});

/* ---------- eliminar Jugadora ---------- */
btnDeletePlayer.addEventListener('click', async ()=>{
  if(!CURRENT_PLAYER || !CURRENT_PLAYER.id) return;
  if(!confirm('Â¿Eliminar a esta jugadora? Esta acciÃ³n no se puede deshacer.')) return;
  if(!supa || !IS_CONNECTED){ alert('No conectado a Supabase.'); return; }
  try{
    const { error } = await supa.from('players').delete().eq('id', CURRENT_PLAYER.id);
    if(error) throw error;
    closePlayerModal();
    renderDash();
    renderMonth && renderMonth();
  }catch(err){
    console.error('Error eliminando player:', err);
    alert('Error eliminando. Revisa consola.');
  }
});

/* ---------- renderDash / roster (simplificado, similar a tu versiÃ³n) ---------- */
async function renderDash(){
  const rosterGrid = document.getElementById('rosterGrid'); rosterGrid.innerHTML = 'Cargando...';
  if(!supa || !IS_CONNECTED){ rosterGrid.innerHTML = '<div style="color:var(--mut)">Sin conexiÃ³n â€” no se pudo cargar plantel</div>'; return; }
  try{
    const { data:playersList, error } = await supa.from('players').select('*').order('apodo',{ascending:true});
    if(error){ console.warn(error); rosterGrid.innerHTML = '<div style="color:var(--mut)">Error cargando plantel</div>'; return; }
    rosterGrid.innerHTML = '';
    if(!playersList || !playersList.length) { rosterGrid.innerHTML = '<div style="color:var(--mut)">No hay jugadores registrados</div>'; return; }
    playersList.forEach(p=>{
      const c = document.createElement('div'); c.className='card'; c.style.cursor='pointer'; c.onclick = ()=> openPlayerModal(p);
      // foto or placeholder
      if(p.foto){ const img=document.createElement('img'); img.className='player-photo'; img.src=p.foto; img.alt=p.apodo||p.nombre||'Jugador'; img.style.width='64px'; img.style.height='64px'; img.style.borderRadius='50%'; img.style.objectFit='cover'; c.appendChild(img); }
      else { const ph=document.createElement('div'); ph.className='jersey-placeholder'; ph.textContent = p.numero_camiseta ? String(p.numero_camiseta) : 'ðŸ‘•'; ph.style.width='64px'; ph.style.height='64px'; ph.style.borderRadius='50%'; c.appendChild(ph); }
      const text=document.createElement('div'); text.style.display='flex'; text.style.flexDirection='column'; text.style.marginLeft='12px';
      const ap=document.createElement('div'); ap.style.fontWeight='800'; ap.textContent = p.apodo || 'Sin apodo';
      const nm=document.createElement('div'); nm.style.color='var(--mut)'; nm.textContent = p.nombre ? `(${p.nombre})` : '';
      text.appendChild(ap); text.appendChild(nm); c.appendChild(text);
      rosterGrid.appendChild(c);
    });
  }catch(err){ console.error('renderDash roster error', err); rosterGrid.innerHTML = '<div style="color:var(--mut)">Error cargando plantel</div>'; }
}

/* ---------- init ---------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  await initSupabase();
  // Nav wiring (idÃ©ntico a tu app)
  document.querySelectorAll('.nav .tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const view = btn.dataset.view;
      try{ localStorage.setItem('gm_view', view); }catch(e){}
      showView(view);
    });
  });

  // initial view
  const persisted = (function(){ try{ return localStorage.getItem('gm_view'); }catch(e){return null;} })();
  const activeTab = document.querySelector('.nav .tab.active');
  const initialView = persisted || (activeTab ? activeTab.dataset.view : 'dash');
  document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
  const btnToActivate = document.querySelector(`.nav .tab[data-view="${initialView}"]`);
  if(btnToActivate) btnToActivate.classList.add('active');
  showView(initialView);
  closePlayerModal();
});

/* ---------- showView helper (simplificado) ---------- */
function showView(v){
  ['dash','events','roster','matches'].forEach(id=>{
    const el = document.getElementById('v-'+id);
    if(el) el.style.display='none';
  });
  const target = document.getElementById('v-'+v) || document.getElementById('v-matches');
  if(target) target.style.display='block';
  if(v==='dash' || v==='roster') renderDash();
  if(v==='events') typeof renderMonth === 'function' && renderMonth();
  if(v==='matches') typeof renderMatches === 'function' && renderMatches();
}
</script>
</body>
</html>
