<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms — Panel</title>
<link rel="icon" href="Logo.webp"/>
<style>
:root{
  --blue:#0f3a78; --lime:#9BE22D; --ink:#0f172a; --mut:#64748b;
  --b:#e2e8f0; --bg:#f7f8fa; --ok:#d9f99d; --mid:#fef9c3; --no:#fee2e2;
}
*{box-sizing:border-box}
html,body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
a{color:inherit}
.badge{font-size:11px;border:1px solid #cbd5e1;border-radius:999px;padding:2px 6px;background:#f8fafc}
.badge-bday{font-size:11px;border:1px dashed #f59e0b;border-radius:999px;padding:2px 6px;background:#fff7ed;color:#92400e}
.chip{padding:6px 10px;border-radius:999px;border:1px solid var(--b);background:#f8fafc;font-weight:700;font-size:12px}
.chip.ok{background:var(--ok)} .chip.mid{background:var(--mid)} .chip.no{background:var(--no)}
.btn{border:1px solid var(--b);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.p{background:var(--lime);color:#08244a;border-color:#a3e635;font-weight:800}
.btn.danger{background:#ef4444;color:#fff;border-color:#ef4444}
.btn.primary{background:#0f3a78;color:#fff}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--b);border-radius:10px;background:#fff}
input:disabled,select:disabled{background:#f1f5f9;color:#64748b;cursor:not-allowed}
label{display:block;font-size:12px;color:#334155;margin-bottom:4px;font-weight:600}
.top{position:sticky;top:0;z-index:5;display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 14px;background:#fff;border-bottom:1px solid var(--b)}
.brand{display:flex;align-items:center;gap:10px}
.brand img{width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid var(--blue)}
.title{font-weight:900}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 20px #0000000a;padding:12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.kpi{display:flex;flex-direction:column;gap:6px}
.kpi h3{margin:0;font-size:14px;color:var(--mut)} .kpi .n{font-size:24px;font-weight:900}
.grid7{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cell{background:#fff;border:1px solid var(--b);min-height:120px;border-radius:12px;padding:8px;position:relative}
.day{position:absolute;right:8px;top:6px;font-size:11px;color:#94a3b8}
.tag{font-size:10px;border:1px solid #0001;border-radius:999px;padding:2px 6px;display:inline-block;margin-bottom:4px}
.match{background:#e0edff;border-color:#b7d1ff;color:#0f3a78}
.train{background:#e9fbd0;border-color:#c6f28a;color:#2d5a00}
.event{font-size:13px;margin-bottom:6px;cursor:pointer}
.team{font-size:10px;background:#eaf7d7;border:1px solid #c8ef7a;border-radius:999px;padding:1px 6px;margin-left:6px;font-weight:700}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.right{margin-left:auto}
.att{border:1px solid var(--b);border-radius:12px;padding:8px;display:flex;justify-content:space-between;align-items:center}
.bsm{padding:6px 10px;border:1px solid var(--b);border-radius:10px;background:#f8fafc;cursor:pointer}
.list .item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--b);border-radius:12px;padding:10px;margin:6px 0;background:#fff}
.item .l{display:flex;gap:8px;align-items:center}
.time{font-weight:800;color:#0f3a78}
.hide{display:none}
hr.sep{border:none;border-top:1px solid var(--b);margin:10px 0}

/* Modales */
.overlay{position:fixed;inset:0;background:#0006;display:none;align-items:center;justify-content:center;z-index:10}
.modal{background:#fff;border:1px solid var(--b);border-radius:12px;max-width:880px;width:92vw;padding:14px;max-height:85vh;overflow:auto}

/* Tabs editor evento */
.tabs{display:flex;gap:8px;margin-bottom:8px}
.tab{border:1px solid var(--b);border-radius:999px;padding:6px 10px;background:#f8fafc;cursor:pointer}
.tab.active{background:#0f3a78;color:#fff}

/* Bottom nav móvil */
.mnav{position:sticky;bottom:0;z-index:4;background:#fff;border-top:1px solid var(--b);display:none}
.mnav .in{display:flex;justify-content:space-around;padding:10px 8px}
.mnav button{background:#f8fafc;border:1px solid var(--b);border-radius:999px;padding:8px 12px}

/* Responsive */
.desktop{display:none} .mobile{display:block}
@media (min-width: 980px){
  .desktop{display:block} .mobile{display:none}
}
</style>
</head>
<body>

<!-- TOP -->
<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="logo" onerror="this.style.display='none'"/>
    <div class="title">Golden <span style="color:var(--lime)">Moms</span></div>
  </div>
  <div class="nav">
    <button class="btn" data-nav="dash">Dashboard</button>
    <button class="btn" data-nav="ev">Eventos</button>
    <button class="btn" data-nav="roster">Plantel</button>
    <button class="btn" data-nav="track">Seguimiento</button>
    <button class="btn hide" id="btnAdmin" data-nav="cfg">Configuración</button>
    <button class="btn primary" id="btnLogin">Entrar</button>
    <button class="btn hide" id="btnLogout">Salir</button>
  </div>
</div>

<div class="container">

  <!-- DASHBOARD -->
  <section id="viewDash" class="desktop">
    <div class="grid">
      <div class="card kpi" style="grid-column:span 3"><h3>Próximos eventos</h3><div class="n" id="kEvents">0</div><small id="nextTxt" style="color:var(--mut)"></small></div>
      <div class="card kpi" style="grid-column:span 3"><h3>Plantel</h3><div class="n" id="kRoster">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h3>Convocadas (próx.)</h3><div class="n" id="kOk">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h3>Partidos jugados</h3><div class="n" id="kPlayed">0</div></div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="card" style="grid-column:span 4">
        <div class="row" style="justify-content:space-between"><strong>Próximos cumpleaños</strong></div>
        <div id="bdayList"></div>
      </div>
      <div class="card" style="grid-column:span 8">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button class="btn" id="prev">&larr;</button>
            <div id="mlabel" style="min-width:220px;text-align:center;font-weight:900;color:#0f3a78"></div>
            <button class="btn" id="next">&rarr;</button>
          </div>
          <div class="row">
            <div>
              <label for="fType">Tipo de evento</label>
              <select id="fType"><option>Todos</option><option>Partido</option><option>Entrenamiento</option><option>Cumpleaños</option></select>
            </div>
            <div>
              <label for="fTeam">Equipo</label>
              <select id="fTeam"><option>Todos</option><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select>
            </div>
            <button class="btn" id="btnCopyWeek">Copiar Semana</button>
            <button class="btn p hide" id="btnNew">Nuevo Evento</button>
          </div>
        </div>
        <div class="grid7" style="margin-top:8px"><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div></div>
        <div id="grid" class="grid7"></div>
      </div>
    </div>
  </section>

  <!-- MOBILE DASH -->
  <section id="viewDashM" class="mobile">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Próximos eventos</strong>
        <button class="btn" id="mToggleCal">Ver calendario</button>
      </div>
      <div id="upcoming" class="list"></div>
    </div>
    <div id="mCalWrap" class="card" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <button class="btn" id="mPrev">&larr;</button>
          <div id="mLabel" style="min-width:160px;text-align:center;font-weight:900;color:#0f3a78"></div>
          <button class="btn" id="mNext">&rarr;</button>
        </div>
      </div>
      <div class="grid7" style="margin-top:8px"><div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div></div>
      <div id="mGrid" class="grid7"></div>
    </div>
  </section>

  <!-- EVENTOS (misma vista de arriba; dejamos botón en top) -->
  <section id="viewEvents" class="hide">
    <div class="card">
      <div class="row" style="justify-content:space-between;flex-wrap:wrap">
        <div class="row" style="gap:12px">
          <div>
            <label for="fType2">Tipo de evento</label>
            <select id="fType2"><option>Todos</option><option>Partido</option><option>Entrenamiento</option><option>Cumpleaños</option></select>
          </div>
          <div>
            <label for="fTeam2">Equipo</label>
            <select id="fTeam2"><option>Todos</option><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select>
          </div>
        </div>
        <div class="row">
          <button class="btn" id="btnCopyWeek2">Copiar Semana</button>
          <button class="btn p hide" id="btnNew2">Nuevo Evento</button>
        </div>
      </div>
    </div>
    <div class="card" style="margin-top:10px">
      <div class="grid7"><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div></div>
      <div id="grid2" class="grid7"></div>
    </div>
  </section>

  <!-- PLANTEL -->
  <section id="viewRoster" class="hide">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Plantel Golden Moms</strong>
        <button class="btn p hide" id="btnAddPlayer">Agregar Jugadora</button>
      </div>
      <div id="rosterList" style="margin-top:8px" class="grid"></div>
    </div>
  </section>

  <!-- SEGUIMIENTO -->
  <section id="viewTrack" class="hide">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Seguimiento de Partidos</strong>
        <button class="btn p hide" id="btnAddMatch">Registrar resultado</button>
      </div>
      <div id="trackList" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- CONFIG -->
  <section id="viewCfg" class="hide">
    <div class="card">
      <strong>Configuración (solo Admin)</strong>
      <p class="muted">Mantener códigos de acceso, cambiar roles, exportar/respaldar datos.</p>
      <div class="row">
        <button class="btn" id="btnExport">Exportar JSON</button>
        <input type="file" id="imp" accept="application/json" class="hide"/>
        <button class="btn" id="btnImport">Importar JSON</button>
        <button class="btn danger" id="btnReset">Limpiar todo</button>
      </div>
    </div>
  </section>

</div>

<!-- MODAL LOGIN -->
<div class="overlay" id="ovLogin">
  <div class="modal" style="max-width:480px">
    <div class="row" style="justify-content:space-between"><strong>Ingresar</strong><button class="bsm" onclick="closeLogin()">Cerrar</button></div>
    <div class="row" style="width:100%">
      <div style="flex:1 1 100%">
        <label>Jugadora</label>
        <select id="lgUser"></select>
      </div>
      <div style="flex:1 1 100%">
        <label>Contraseña del equipo</label>
        <input id="lgPass" type="password" placeholder="••••••"/>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button class="btn primary" id="btnDoLogin">Entrar</button>
    </div>
    <small style="color:var(--mut)">El rol se asigna automáticamente por el plantel. Tu nombre no muestra el rol.</small>
  </div>
</div>

<!-- MODAL EDITOR EVENTO -->
<div class="overlay" id="ovEdit">
  <div class="modal">
    <div class="row" style="justify-content:space-between">
      <div class="row"><strong id="edTitle">Editar evento</strong><span id="teamBadge" class="team"></span></div>
      <div class="row">
        <button class="btn" id="btnICS">.ics</button>
        <button class="btn" id="btnCopy">Copiar WhatsApp</button>
        <button class="btn" id="btnRSVP">Link convocatoria</button>
        <button class="btn danger hide" id="btnDel">Eliminar</button>
        <button class="btn" onclick="closeEdit()">Cerrar</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="att">Asistencia</div>
      <div class="tab" data-tab="det">Detalles</div>
      <div class="tab" data-tab="rsvp">Convocatoria</div>
    </div>

    <!-- ASISTENCIA -->
    <div id="tab_att">
      <div class="row" style="justify-content:space-between;flex-wrap:wrap">
        <div class="row" style="gap:8px">
          <span class="chip ok" id="cntOk">✅ 0</span>
          <span class="chip mid" id="cntMid">❔ 0</span>
          <span class="chip no" id="cntNo">❌ 0</span>
          <span class="chip" id="cntPend">▫️ 0</span>
        </div>
        <div class="row">
          <button class="btn hide" id="btnExportList">Exportar lista</button>
        </div>
      </div>
      <div id="att" class="row" style="gap:6px;margin-top:8px"></div>
    </div>

    <!-- DETALLES -->
    <div id="tab_det" class="hide">
      <div class="row">
        <div style="flex:1;min-width:160px"><label>Tipo</label><select id="eType"><option>Partido</option><option>Entrenamiento</option><option>Cumpleaños</option></select></div>
        <div style="flex:2;min-width:220px"><label>Título</label><input id="eTitle"/></div>
        <div style="flex:1;min-width:160px"><label>Equipo</label><select id="eTeam"><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select></div>
      </div>
      <div class="row">
        <div style="flex:1;min-width:200px"><label>Fecha y hora</label><input id="eDT" type="datetime-local"/></div>
        <div style="flex:1;min-width:200px"><label>Lugar</label><input id="eLoc"/></div>
        <div style="flex:1;min-width:200px"><label>Rival</label><input id="eOpp"/></div>
        <div style="flex:1;min-width:200px"><label>Uniforme</label><select id="eUni"><option value="">—</option><option>Polera azul</option><option>Polera verde lima</option></select></div>
      </div>
    </div>

    <!-- CONVOCATORIA -->
    <div id="tab_rsvp" class="hide">
      <div id="rsvpInfo" style="font-size:13px;color:#334155;margin-bottom:6px"></div>
      <div class="row">
        <button class="btn" id="btnRSVPCopy">Copiar link de convocatoria</button>
        <button class="btn" id="btnCopyMsg">Copiar mensaje WhatsApp</button>
      </div>
    </div>

  </div>
</div>

<!-- MODAL JUGADORA -->
<div class="overlay" id="ovPlayer">
  <div class="modal" style="max-width:720px">
    <div class="row" style="justify-content:space-between"><strong>Editar jugadora</strong><button class="bsm" onclick="closePlayer()">Cerrar</button></div>
    <div class="row">
      <div style="flex:1 1 220px">
        <label>Nombre (no editable)</label>
        <input id="p_name" disabled/>
      </div>
      <div style="flex:1 1 160px">
        <label>Apodo</label>
        <input id="p_nick"/>
      </div>
      <div style="flex:1 1 120px">
        <label>Número</label>
        <input id="p_number" inputmode="numeric"/>
      </div>
      <div style="flex:1 1 180px">
        <label>Nacimiento</label>
        <input id="p_birth" type="date"/>
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <div style="flex:1 1 100%">
        <label>Equipos (multi)</label>
        <div id="chipsTeams" class="row" style="gap:6px"></div>
      </div>
      <div style="flex:1 1 200px">
        <label>Rol</label>
        <select id="p_role"><option>Jugadora</option><option>Capitana</option><option>Admin</option></select>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button class="btn primary" id="btnSavePlayer">Guardar</button>
    </div>
    <small style="color:var(--mut)">Como Jugadora solo puedes editar tu apodo, cumpleaños y número. Equipos/Rol solo Capitana o Admin.</small>
  </div>
</div>

<!-- MODAL SEGUIMIENTO -->
<div class="overlay" id="ovTrack">
  <div class="modal" style="max-width:720px">
    <div class="row" style="justify-content:space-between"><strong id="tkTitle">Registrar resultado</strong><button class="bsm" onclick="closeTrack()">Cerrar</button></div>
    <div class="row">
      <div style="flex:1 1 200px"><label>Fecha</label><input id="tkDate" type="date"/></div>
      <div style="flex:1 1 200px"><label>Equipo</label><select id="tkTeam"><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select></div>
      <div style="flex:1 1 200px"><label>Rival</label><input id="tkOpp"/></div>
      <div style="flex:1 1 140px"><label>Marcador</label><input id="tkScore" placeholder="3-1"/></div>
      <div style="flex:1 1 160px"><label>Resultado</label><select id="tkRes"><option>Victoria</option><option>Empate</option><option>Derrota</option></select></div>
    </div>
    <div style="margin-top:8px">
      <label>Goleadoras (separa por coma, usa apodos o nombres exactos)</label>
      <input id="tkScorers" placeholder="Dani C, Janga, ..."/>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button class="btn primary" id="btnSaveTrack">Guardar</button>
    </div>
  </div>
</div>

<!-- RSVP inline (solo para compartir) -->
<div id="rsvp" class="card hide" style="margin:10px">
  <strong>Convocatoria (vista invitada)</strong>
  <div id="rinfo" style="margin:6px 0;padding:8px;border:1px solid #c8ef7a;background:#eaf7d7;border-radius:10px"></div>
  <div class="row"><select id="rSel"></select>
    <button class="bsm" onclick="setRSVP('Asiste')">✅</button>
    <button class="bsm" onclick="setRSVP('Duda')">❔</button>
    <button class="bsm" onclick="setRSVP('No asiste')">❌</button>
  </div>
  <div class="row"><input id="rNew" placeholder="Agregar jugadora nueva"/><button class="bsm" id="rAdd">➕ Agregar</button></div>
</div>

<!-- Bottom nav móvil -->
<div class="mnav mobile"><div class="in">
  <button data-nav="dash">Dashboard</button>
  <button data-nav="ev">Eventos</button>
  <button id="mNavNew">Nuevo</button>
</div></div>

<script>
/* =========================
   Estado base / sesión
========================= */
const KEY="gm-panel-v3";
let S={
  team:"Golden Moms",
  pass:"golden2025", // contraseña del equipo (puedes cambiarla en Configuración si quieres)
  roster:[
    // nombre, apodo, número, birth, teams, role
    {name:"Ale V", nick:"Ale V", number:"11", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Andre", nick:"Andre", number:"7", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Antonella", nick:"Anto", number:"6", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Aurora", nick:"Aurora", number:"", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Carla", nick:"Carla", number:"", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Caro G", nick:"Caro G", number:"", birth:"", teams:["Golden Moms"], role:"Capitana"},
    {name:"Caro N", nick:"Caro Naso", number:"", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Cata", nick:"Cata", number:"", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Celsa", nick:"Celsa", number:"", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Chica", nick:"Chica", number:"30", birth:"", teams:["Golden Moms"], role:"Capitana"},
    {name:"Consu", nick:"Consu", number:"", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Consu S", nick:"Consu S", number:"", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Cote", nick:"Cote", number:"13", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Dani C", nick:"Dani C", number:"14", birth:"2000-10-10", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Dani J", nick:"Dani J", number:"15", birth:"2000-01-11", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Fabi", nick:"Fabi", number:"16", birth:"", teams:["Golden Moms","Golden Dreams"], role:"Capitana"},
    {name:"Fran", nick:"Fran", number:"", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Gaby", nick:"Gaby", number:"", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Isa", nick:"Isa", number:"19", birth:"2000-10-26", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Jandi", nick:"Jandi", number:"20", birth:"2000-07-14", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Janga", nick:"Janga", number:"21", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Javiera A", nick:"Javiera", number:"22", birth:"2000-01-02", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Javi C", nick:"Javi C", number:"", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Jean", nick:"Jean", number:"", birth:"2000-05-05", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Maca", nick:"Maca", number:"", birth:"2000-10-25", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Male", nick:"Male", number:"", birth:"2000-12-10", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Marce", nick:"Marce", number:"", birth:"2000-03-14", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Myle", nick:"Myle", number:"", birth:"2000-06-03", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Paz", nick:"Paz", number:"", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Pia", nick:"Pia", number:"", birth:"2000-10-21", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Pili", nick:"Pili", number:"", birth:"", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Vale", nick:"Vale", number:"", birth:"2000-10-11", teams:["Golden Moms"], role:"Jugadora"},
    {name:"Vero", nick:"Vero", number:"", birth:"2000-01-29", teams:["Golden Moms"], role:"Jugadora"},
    // Admin para configuración
    {name:"Natalia", nick:"Natalia", number:"", birth:"", teams:["Golden Moms"], role:"Admin"}
  ],
  events:[],
  att:{},       // asistencia por eventoId: { "Nombre": "Asiste|Duda|No asiste" }
  track:[]      // seguimiento partidos
};
let SESSION=null; // {name, role}

/* cargar persistencia */
try{ const t=JSON.parse(localStorage.getItem(KEY)||"{}"); if(t && typeof t==="object"){ S={...S, ...t}; } }catch(e){}
function save(){ localStorage.setItem(KEY, JSON.stringify(S)); }

/* =========================
   Utilidades
========================= */
const TEAMS=["Golden Moms","Golden Dreams","Golden Power"];
function getPlayer(name){ return S.roster.find(p=>p.name===name); }
function savePlayer(p){ const i=S.roster.findIndex(x=>x.name===p.name); if(i>=0) S.roster[i]=p; save(); }
function rosterForTeam(team){ if(!team||team==="Todos") return [...S.roster]; return S.roster.filter(p=>Array.isArray(p.teams)&&p.teams.includes(team)); }
function fmtMonth(d){return d.toLocaleDateString("es-CL",{month:"long",year:"numeric"})}
function toInput(iso){ const d=new Date(iso); const p=n=>String(n).padStart(2,"0"); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}` }
function fromLocalInput(v){ const d=new Date(v); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString(); }
function ensureSeedSchedule(){
  if(S.events.length) return;
  // Entrenamientos Mar/Jue 19:30; Wonder Mom’s Cup Mié 20:00; LIFA Vie 20:00
  const now=new Date();
  function nextDow(dow){const g=(dow-now.getDay()+7)%7||7;const d=new Date(now);d.setDate(now.getDate()+g);d.setHours(0,0,0,0);return d;}
  const tue=nextDow(2), wed=nextDow(3), thu=nextDow(4), fri=nextDow(5);
  function mk(y,m,d,h,mi){const t=new Date(y,m-1,d,h,mi);return new Date(t.getTime()-t.getTimezoneOffset()*60000).toISOString();}
  for(let i=0;i<12;i++){
    const T=new Date(tue);T.setDate(tue.getDate()+7*i);
    const Th=new Date(thu);Th.setDate(thu.getDate()+7*i);
    const W=new Date(wed);W.setDate(wed.getDate()+7*i);
    const F=new Date(fri);F.setDate(fri.getDate()+7*i);
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:mk(T.getFullYear(),T.getMonth()+1,T.getDate(),19,30),location:"Colegio",opponent:"",uniform:""});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:mk(Th.getFullYear(),Th.getMonth()+1,Th.getDate(),19,30),location:"Colegio",opponent:"",uniform:""});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Partido",title:"Wonder Mom’s Cup",team:"Golden Moms",datetime:mk(W.getFullYear(),W.getMonth()+1,W.getDate(),20,0),location:"Universidad de los Andes",opponent:"—",uniform:""});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Partido",title:"Liga LIFA",team:"Golden Moms",datetime:mk(F.getFullYear(),F.getMonth()+1,F.getDate(),20,0),location:"Cancha Oriente, Las Condes",opponent:"—",uniform:""});
  }
  save();
}
ensureSeedSchedule();

/* =========================
   NAV
========================= */
const views={dash:document.getElementById("viewDash"), dashm:document.getElementById("viewDashM"),
  ev:document.getElementById("viewEvents"), roster:document.getElementById("viewRoster"),
  track:document.getElementById("viewTrack"), cfg:document.getElementById("viewCfg")};
function show(name){
  Object.values(views).forEach(v=>v.classList.add("hide"));
  if(name==="dash"){views.dash.classList.remove("hide");views.dashm.classList.remove("hide");}
  else if(name==="ev"){views.ev.classList.remove("hide");}
  else if(name==="roster"){views.roster.classList.remove("hide");}
  else if(name==="track"){views.track.classList.remove("hide");}
  else if(name==="cfg"){views.cfg.classList.remove("hide");}
  window.scrollTo({top:0,behavior:'smooth'});
}
document.querySelectorAll("[data-nav]").forEach(b=>b.onclick=()=>show(b.dataset.nav));
document.getElementById("mNavNew").onclick=()=>{ if(!canEdit()){ alert("Solo Capitana/Admin puede crear eventos."); return; } newEvent(); };

/* =========================
   LOGIN / SESSION
========================= */
function openLogin(){
  const u=document.getElementById("lgUser"); u.innerHTML=S.roster.map(p=>`<option>${p.name}</option>`).join("");
  document.getElementById("lgPass").value="";
  document.getElementById("ovLogin").style.display="flex";
}
function closeLogin(){ document.getElementById("ovLogin").style.display="none"; }
function login(){
  const name=document.getElementById("lgUser").value;
  const pass=document.getElementById("lgPass").value.trim();
  if(pass!==S.pass){ alert("Contraseña incorrecta."); return; }
  const p=getPlayer(name);
  SESSION={name:p.name, role:p.role};
  document.getElementById("btnLogin").classList.add("hide");
  document.getElementById("btnLogout").classList.remove("hide");
  document.getElementById("btnAdmin").classList.toggle("hide", !(SESSION.role==="Admin"));
  document.getElementById("btnNew").classList.toggle("hide", !canEdit());
  document.getElementById("btnNew2").classList.toggle("hide", !canEdit());
  document.getElementById("btnAddPlayer").classList.toggle("hide", !canEdit());
  document.getElementById("btnAddMatch").classList.toggle("hide", !canEdit());
  closeLogin();
  renderAll();
}
function logout(){
  SESSION=null;
  document.getElementById("btnLogin").classList.remove("hide");
  document.getElementById("btnLogout").classList.add("hide");
  document.getElementById("btnAdmin").classList.add("hide");
  document.getElementById("btnNew").classList.add("hide");
  document.getElementById("btnNew2").classList.add("hide");
  document.getElementById("btnAddPlayer").classList.add("hide");
  document.getElementById("btnAddMatch").classList.add("hide");
  renderAll();
}
function canEdit(){ return SESSION && (SESSION.role==="Capitana"||SESSION.role==="Admin"); }
document.getElementById("btnLogin").onclick=openLogin;
document.getElementById("btnLogout").onclick=logout;
document.getElementById("btnDoLogin").onclick=login;

/* =========================
   DASHBOARD & CALENDARIO
========================= */
let view=new Date(); view.setDate(1);
let mview=new Date(); mview.setDate(1);

function buildCells(y,m){ const first=new Date(y,m,1), start=(first.getDay()+6)%7, days=new Date(y,m+1,0).getDate();
  const cells=[]; for(let i=0;i<start;i++) cells.push(null); for(let d=1;d<=days;d++) cells.push(new Date(y,m,d)); while(cells.length%7) cells.push(null); return cells; }

function renderCal(target,label,viewDate, filterType, filterTeam){
  label.textContent=fmtMonth(viewDate);
  const y=viewDate.getFullYear(), m=viewDate.getMonth();
  const cells=buildCells(y,m);
  target.innerHTML="";
  const ev=[...S.events].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
  cells.forEach(dd=>{
    const c=document.createElement("div"); c.className="cell";
    if(dd){
      const n=document.createElement("div"); n.className="day"; n.textContent=dd.getDate(); c.appendChild(n);
      // cumpleaños
      S.roster.forEach(p=>{
        if(!p.birth) return;
        const d=new Date(p.birth); if(d.getMonth()===dd.getMonth() && d.getDate()===dd.getDate()){
          const h=document.createElement("div"); h.className="event"; h.innerHTML=`<span class="tag train">Cumpleaños</span> 🎂 <strong>${p.name}</strong>`;
          c.appendChild(h);
        }
      });
      ev.filter(e=>{
        const d=new Date(e.datetime);
        return d.getFullYear()==dd.getFullYear()&&d.getMonth()==dd.getMonth()&&d.getDate()==dd.getDate();
      }).filter(e=>{
        return (filterType==="Todos"||e.type===filterType) && (filterTeam==="Todos"||(e.team||"Golden Moms")===filterTeam);
      }).forEach(e=>{
        const t=document.createElement("div"); t.className="tag "+(e.type==="Partido"?"match":(e.type==="Entrenamiento"?"train":""));
        t.textContent=e.type; c.appendChild(t);
        const r=document.createElement("div"); r.className="event"; const d=new Date(e.datetime);
        r.innerHTML=`<strong>${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}</strong> ${e.title} <span class="team">${e.team||"Golden Moms"}</span>`;
        r.onclick=()=>openEdit(e.id);
        c.appendChild(r);
      });
    }
    target.appendChild(c);
  });
}

function renderKPIs(){
  const upcoming=[...S.events].filter(e=>new Date(e.datetime)>=new Date()).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
  document.getElementById("kEvents").textContent=upcoming.length;
  document.getElementById("kRoster").textContent=S.roster.length;
  if(upcoming[0]){
    const A=S.att[upcoming[0].id]||{}; const R=rosterForTeam(upcoming[0].team||"Golden Moms");
    document.getElementById("kOk").textContent=R.filter(p=>A[p.name]==="Asiste").length;
    document.getElementById("nextTxt").textContent=new Date(upcoming[0].datetime).toLocaleString('es-CL',{weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) + " · " + (upcoming[0].title||"");
  } else document.getElementById("nextTxt").textContent="";
  document.getElementById("kPlayed").textContent=S.track.length;
}

function renderUpcoming(){
  const box=document.getElementById("upcoming");
  const ev=[...S.events].filter(e=>new Date(e.datetime)>=new Date()).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)).slice(0,10);
  box.innerHTML="";
  ev.forEach(E=>{
    const A=S.att[E.id]||{}; const R=rosterForTeam(E.team||"Golden Moms");
    const ok=R.filter(p=>A[p.name]==="Asiste").length;
    const it=document.createElement("div"); it.className="item";
    const when=new Date(E.datetime).toLocaleString('es-CL',{weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
    it.innerHTML=`<div class="l"><span class="badge">${E.type}</span><div><div class="time">${when}</div><div>${E.title} <span class="badge">${E.team||'Golden Moms'}</span></div></div></div><div><span class="badge">✅ ${ok}</span> <button class="btn">Abrir</button></div>`;
    it.querySelector("button").onclick=()=>openEdit(E.id);
    box.appendChild(it);
  });
}

function renderBdays(){
  const box=document.getElementById("bdayList");
  const now=new Date(); const soon=[];
  for(let i=0;i<40;i++){
    const d=new Date(now); d.setDate(now.getDate()+i);
    S.roster.forEach(p=>{
      if(!p.birth) return; const b=new Date(p.birth);
      if(b.getMonth()===d.getMonth()&&b.getDate()===d.getDate()){
        soon.push({date:new Date(d), name:p.name});
      }
    });
  }
  box.innerHTML=soon.map(x=>`<div class="row" style="justify-content:space-between"><div>🎂 <strong>${x.name}</strong></div><span class="badge">${x.date.toLocaleDateString('es-CL',{weekday:'short',day:'2-digit',month:'short'})}</span></div>`).join("") || "<em>No hay cumpleaños pronto</em>";
}

/* Navegación de mes */
document.getElementById("prev").onclick=()=>{view.setMonth(view.getMonth()-1);renderAll();}
document.getElementById("next").onclick=()=>{view.setMonth(view.getMonth()+1);renderAll();}
document.getElementById("mPrev").onclick=()=>{mview.setMonth(mview.getMonth()-1);renderAll();}
document.getElementById("mNext").onclick=()=>{mview.setMonth(mview.getMonth()+1);renderAll();}

/* Filtros y copiar semana */
function copyWeekToClipboard(){
  const st=(d=>{const n=new Date(d); n.setDate(n.getDate()-((n.getDay()+6)%7)); n.setHours(0,0,0,0); return n;})(new Date());
  const en=new Date(st); en.setDate(st.getDate()+7);
  const L=['*Semana* '+st.toLocaleDateString('es-CL')+' - '+new Date(en.getTime()-86400000).toLocaleDateString('es-CL'),'Equipo: Golden Moms',''];
  S.events.filter(e=>new Date(e.datetime)>=st && new Date(e.datetime)<en)
  .sort((a,b)=>new Date(a.datetime)-new Date(b.datetime))
  .forEach(E=>{
    const w=new Date(E.datetime).toLocaleString('es-CL',{weekday:'short',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
    L.push(`• ${w} — ${E.type}: ${E.title}${E.location?' — '+E.location:''} (${E.team||'Golden Moms'}) ${E.opponent?' — Rival: '+E.opponent:''}${E.uniform?' — Uniforme: '+E.uniform:''}`);
  });
  navigator.clipboard.writeText(L.join('\n')); alert("Semana copiada. Pega en WhatsApp.");
}
document.getElementById("btnCopyWeek").onclick=copyWeekToClipboard;
document.getElementById("btnCopyWeek2").onclick=copyWeekToClipboard;

/* Mostrar/ocultar calendario móvil */
document.getElementById("mToggleCal").onclick=()=>{const w=document.getElementById("mCalWrap"); w.style.display=(w.style.display==='none'||!w.style.display)?'block':'none';};

/* =========================
   EDITOR DE EVENTOS
========================= */
let cur=null;
const tabs=document.querySelectorAll(".tab");
tabs.forEach(t=>t.onclick=()=>{
  tabs.forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  document.getElementById("tab_att").classList.toggle("hide", t.dataset.tab!=="att");
  document.getElementById("tab_det").classList.toggle("hide", t.dataset.tab!=="det");
  document.getElementById("tab_rsvp").classList.toggle("hide", t.dataset.tab!=="rsvp");
});
function openEdit(id){
  const E=S.events.find(x=>x.id===id); if(!E) return;
  cur=id;
  document.getElementById("edTitle").textContent=`${E.type} — ${E.title}`;
  document.getElementById("teamBadge").textContent=E.team||"Golden Moms";
  // permisos
  const can=canEdit();
  document.getElementById("btnDel").classList.toggle("hide", !can);
  document.getElementById("eType").disabled=!can; document.getElementById("eTitle").disabled=!can;
  document.getElementById("eTeam").disabled=!can; document.getElementById("eDT").disabled=!can;
  document.getElementById("eLoc").disabled=!can; document.getElementById("eOpp").disabled=!can; document.getElementById("eUni").disabled=!can;
  // detalles
  document.getElementById("eType").value=E.type||"Entrenamiento";
  document.getElementById("eTitle").value=E.title||"";
  document.getElementById("eTeam").value=E.team||"Golden Moms";
  document.getElementById("eDT").value=toInput(E.datetime);
  document.getElementById("eLoc").value=E.location||"";
  document.getElementById("eOpp").value=E.opponent||"";
  document.getElementById("eUni").value=E.uniform||"";
  // asistencia (vista por rol)
  renderAttendance(E);
  // rsvp
  const when=new Date(E.datetime).toLocaleString('es-CL',{weekday:'long',day:'2-digit',month:'long',hour:'2-digit',minute:'2-digit'});
  document.getElementById("rsvpInfo").textContent = `${E.type} — ${E.title} • ${when}${E.location?' • '+E.location:''} (${E.team||'Golden Moms'})`;
  document.getElementById("ovEdit").style.display="flex";
}
function closeEdit(){ document.getElementById("ovEdit").style.display="none"; }

/* asistencia con privacidad */
function renderAttendance(E){
  const team=E.team||"Golden Moms";
  const R=rosterForTeam(team);
  const A=S.att[E.id]||{};
  const me=SESSION?.name||null;
  const isCap=canEdit();

  const counts={ok:0,mid:0,no:0,blank:0};
  R.forEach(p=>{
    const v=A[p.name]||"";
    if(v==="Asiste") counts.ok++; else if(v==="Duda") counts.mid++; else if(v==="No asiste") counts.no++; else counts.blank++;
  });
  document.getElementById("cntOk").textContent=`✅ ${counts.ok}`;
  document.getElementById("cntMid").textContent=`❔ ${counts.mid}`;
  document.getElementById("cntNo").textContent=`❌ ${counts.no}`;
  document.getElementById("cntPend").textContent=`▫️ ${counts.blank}`;
  document.getElementById("btnExportList").classList.toggle("hide", !isCap);

  const att=document.getElementById("att"); att.innerHTML="";
  const base = isCap ? R : R.filter(p=>p.name===me); // jugadora ve solo su fila

  base.forEach(p=>{
    const v=A[p.name]||"";
    const row=document.createElement("div"); row.className="att";
    // left
    const left=document.createElement("div"); left.style.display="flex"; left.style.alignItems="center"; left.style.gap="8px";
    const nm=document.createElement("div"); nm.textContent=p.name; left.appendChild(nm);
    if(p.birth){
      const bd=new Date(p.birth); const b=document.createElement("span"); b.className="badge-bday";
      b.textContent=`🎂 ${bd.toLocaleDateString('es-CL',{day:'2-digit',month:'short'})}`; left.appendChild(b);
    }
    const wrap=document.createElement("div"); wrap.style.display="flex"; wrap.style.gap="4px"; wrap.style.flexWrap="wrap";
    (p.teams||[]).forEach(t=>{ const s=document.createElement("span"); s.className="badge"; s.textContent=t.replace("Golden ",""); wrap.appendChild(s);});
    left.appendChild(wrap);
    row.appendChild(left);
    // right
    const right=document.createElement("div");
    function mk(lbl,val){
      const b=document.createElement("button"); b.className="bsm"; b.textContent=lbl;
      b.onclick=()=>{
        const AA=S.att[E.id]||{}; AA[p.name]=val; S.att[E.id]=AA; save(); 
        if(!isCap && val==="No asiste"){ closeEdit(); } // jugadora no ve más filas
        renderAttendance(E);
      };
      if(v===val){ if(val==="Asiste") b.style.background=varOk; if(val==="Duda") b.style.background=varMid; if(val==="No asiste") b.style.background=varNo; }
      return b;
    }
    right.appendChild(mk("✅","Asiste"));
    right.appendChild(mk("❔","Duda"));
    right.appendChild(mk("❌","No asiste"));
    row.appendChild(right);

    att.appendChild(row);
  });
}
const varOk="#d9f99d", varMid="#fef9c3", varNo="#fee2e2";

/* cambios en detalles */
["eType","eTitle","eLoc","eOpp","eUni","eTeam"].forEach(id=>{
  document.getElementById(id).addEventListener("change",()=>{
    if(!canEdit()) return;
    const E=S.events.find(x=>x.id===cur); if(!E) return;
    E.type=document.getElementById("eType").value;
    E.title=document.getElementById("eTitle").value;
    E.location=document.getElementById("eLoc").value;
    E.opponent=document.getElementById("eOpp").value;
    E.uniform=document.getElementById("eUni").value;
    E.team=document.getElementById("eTeam").value;
    save();
    renderAll();
    openEdit(E.id); // refresca
  });
});
document.getElementById("eDT").addEventListener("change",()=>{
  if(!canEdit()) return;
  const E=S.events.find(x=>x.id===cur); if(!E) return;
  E.datetime=fromLocalInput(document.getElementById("eDT").value);
  save(); renderAll(); openEdit(E.id);
});
document.getElementById("btnDel").onclick=()=>{ if(!canEdit()) return; const i=S.events.findIndex(x=>x.id===cur); if(i>=0){ S.events.splice(i,1); delete S.att[cur]; save(); closeEdit(); renderAll(); } };

/* Exportar lista (para imprimir) */
document.getElementById("btnExportList").onclick=()=>{
  const E=S.events.find(x=>x.id===cur); if(!E) return;
  const A=S.att[E.id]||{}; const list=rosterForTeam(E.team).filter(p=>A[p.name]==="Asiste");
  const when=new Date(E.datetime).toLocaleString('es-CL',{weekday:'long',day:'2-digit',month:'long',hour:'2-digit',minute:'2-digit'});
  const w=window.open('','_blank');
  const html=`<!DOCTYPE html><html><head><meta charset="utf-8"><style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:24px}
    h1{margin:0 0 6px 0} .sub{color:#334155;margin:0 0 18px 0}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #cbd5e1;margin:4px 6px}
    .row{display:flex;flex-wrap:wrap}
    .box{border:1px solid #e2e8f0;border-radius:12px;padding:12px}
  </style></head><body>
    <h1>${E.type}: ${E.title} (${E.team||'Golden Moms'})</h1>
    <div class="sub">${when}${E.location?' — '+E.location:''}${E.opponent?' — Rival: '+E.opponent:''}</div>
    <div class="box"><strong>Convocadas (${list.length})</strong><div class="row">
      ${list.map(n=>`<span class="pill">✅ ${n.name}</span>`).join('') || '<em>No hay confirmadas aún</em>'}
    </div></div>
    <script>window.print()</script>
  </body></html>`;
  w.document.write(html); w.document.close();
};

/* ICS con 2 alarmas (día anterior y misma mañana) */
function icsDate(d){return new Date(d).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z")}
document.getElementById("btnICS").onclick=()=>{
  const E=S.events.find(x=>x.id===cur); if(!E) return;
  const st=new Date(E.datetime), mins=(E.type=="Partido"?120:90), en=new Date(st.getTime()+mins*60000);
  const dayBefore=new Date(st.getTime()-24*3600*1000);
  const sameDay=new Date(st.getFullYear(),st.getMonth(),st.getDate(),9,0,0);
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//GM//Org//ES','CALSCALE:GREGORIAN','BEGIN:VEVENT',
  'UID:'+E.id+'@gm','DTSTAMP:'+icsDate(new Date()),'DTSTART:'+icsDate(st),'DTEND:'+icsDate(en),
  'SUMMARY:'+E.title+' ('+(E.team||'Golden Moms')+')','LOCATION:'+(E.location||'').replace(/,/g,'\\,'),
  'DESCRIPTION:Uniforme '+(E.uniform||'—')+' | Calcetines: verde lima',
  'BEGIN:VALARM','TRIGGER:-P1D','ACTION:DISPLAY','DESCRIPTION:Recordatorio 24h','END:VALARM',
  'BEGIN:VALARM','TRIGGER:'+icsDate(sameDay),'ACTION:DISPLAY','DESCRIPTION:Recordatorio día del evento','END:VALARM',
  'END:VEVENT','END:VCALENDAR'].join('\r\n');
  const u=URL.createObjectURL(new Blob([lines],{type:"text/calendar"})); const a=document.createElement("a"); a.href=u; a.download=(E.title||"evento")+".ics"; a.click(); URL.revokeObjectURL(u);
};
/* WhatsApp */
document.getElementById("btnCopy").onclick=()=>{
  const E=S.events.find(x=>x.id===cur); if(!E) return; const when=new Date(E.datetime).toLocaleString('es-CL',{weekday:'long',year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
  const A=S.att[E.id]||{}; const R=rosterForTeam(E.team); const L=[];
  L.push(`*${E.type} — ${E.title}* (${E.team||'Golden Moms'})`);
  L.push(`${when}${E.location?' — '+E.location:''}`);
  if(E.opponent) L.push('Rival: '+E.opponent);
  if(E.uniform) L.push('Uniforme: '+E.uniform);
  L.push('Calcetines: verde lima'); L.push('');
  if(canEdit()){
    R.forEach(p=>{const st=A[p.name]||''; const em=st=='Asiste'?'✅':st=='Duda'?'❔':st=='No asiste'?'❌':'▫️'; L.push(`${em} ${p.name} ${st? '('+st+')':''}`);});
  } else {
    // Jugadora solo su estado
    const me=A[SESSION?.name]||'—'; const em=me=='Asiste'?'✅':me=='Duda'?'❔':me=='No asiste'?'❌':'▫️';
    L.push(`${em} ${SESSION?.name||''} ${me? '('+me+')':''}`);
  }
  navigator.clipboard.writeText(L.join('\n')); alert("Resumen copiado. Pega en WhatsApp.");
};
/* Link de convocatoria */
function buildRSVPURL(E){ const payload=encodeURIComponent(JSON.stringify({id:E.id,t:S.team})); return location.origin+location.pathname+'#rsvp='+payload; }
document.getElementById("btnRSVP").onclick=()=>{ const E=S.events.find(x=>x.id===cur); if(!E) return; const url=buildRSVPURL(E); navigator.clipboard.writeText(url); alert('Link copiado (nota: Pages no tiene servidor; cada navegador guarda su propio estado).'); };
document.getElementById("btnRSVPCopy").onclick=()=>{ const E=S.events.find(x=>x.id===cur); if(!E) return; const url=buildRSVPURL(E); navigator.clipboard.writeText(url); alert('Link de convocatoria copiado.'); };
document.getElementById("btnCopyMsg").onclick=()=>{ const E=S.events.find(x=>x.id===cur); if(!E) return; const when=new Date(E.datetime).toLocaleString('es-CL',{weekday:'long',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'}); const url=buildRSVPURL(E); const text=`*${E.type}: ${E.title}* (${E.team||'Golden Moms'})%0A${when} — ${E.location||''}%0AUniforme: ${E.uniform||'—'} · Calcetines: verde lima%0A%0AConfirma aquí: ${url}%0A✅ Asiste  ❔ Duda  ❌ No asiste`; navigator.clipboard.writeText(decodeURIComponent(text)); alert("Mensaje de WhatsApp copiado."); };

/* Nuevo evento */
function newEvent(){
  const now=new Date(); now.setMinutes(0,0,0);
  const id=crypto.randomUUID?.()||(""+Math.random()).slice(2);
  const e={id,type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString(),location:"",opponent:"",uniform:""};
  S.events.push(e); save(); renderAll(); openEdit(id);
}
document.getElementById("btnNew").onclick=newEvent;
document.getElementById("btnNew2").onclick=newEvent;

/* =========================
   PLANTEL
========================= */
function renderRoster(){
  const box=document.getElementById("rosterList"); box.innerHTML="";
  // grid responsive
  S.roster.sort((a,b)=>a.name.localeCompare(b.name)).forEach(p=>{
    const card=document.createElement("div"); card.className="card"; card.style.gridColumn="span 3";
    const bd=p.birth?new Date(p.birth):null;
    card.innerHTML=`
      <div class="row" style="justify-content:space-between">
        <div><strong>${p.name}</strong> ${bd?`<span class="badge-bday">🎂 ${bd.toLocaleDateString('es-CL',{day:'2-digit',month:'short'})}</span>`:""}</div>
        <button class="bsm">Editar</button>
      </div>
      <div class="row" style="gap:6px;margin-top:6px">
        <span class="badge">#${p.number||"—"}</span>
        ${(p.teams||[]).map(t=>`<span class="badge">${t.replace("Golden ","")}</span>`).join("")}
        <span class="badge" style="background:#eef2ff;border-color:#c7d2fe">${p.role}</span>
      </div>`;
    const btn=card.querySelector("button");
    btn.onclick=()=>openPlayerEditor(p.name);
    box.appendChild(card);
  });
}
document.getElementById("btnAddPlayer").onclick=()=>{
  if(!canEdit()) return;
  const name=prompt("Nombre completo de la jugadora:"); if(!name) return;
  if(S.roster.some(p=>p.name===name)) return alert("Ya existe.");
  S.roster.push({name, nick:name, number:"", birth:"", teams:["Golden Moms"], role:"Jugadora"}); save(); renderRoster();
};

/* Editor de jugadora con permisos */
function openPlayerEditor(name){
  const target=getPlayer(name); const modal=document.getElementById("ovPlayer"); modal.style.display="flex";
  const inName=document.getElementById("p_name"), inNick=document.getElementById("p_nick"),
        inNum=document.getElementById("p_number"), inBirth=document.getElementById("p_birth"),
        chips=document.getElementById("chipsTeams"), inRole=document.getElementById("p_role");
  inName.value=target.name; inNick.value=target.nick||""; inNum.value=target.number||""; inBirth.value=target.birth||"";
  chips.innerHTML=TEAMS.map(t=>`<label class="badge"><input type="checkbox" value="${t}" ${ (target.teams||[]).includes(t)?"checked":"" }/> ${t}</label>`).join(" ");
  if(inRole) inRole.value=target.role||"Jugadora";
  const isSelf=(SESSION?.name===target.name); const isCap=canEdit();
  inNick.disabled=!(isSelf || isCap);
  inBirth.disabled=!(isSelf || isCap);
  inNum.disabled=!(isSelf || isCap);
  chips.querySelectorAll("input").forEach(i=>i.disabled=!isCap);
  inRole.disabled=!isCap;
  document.getElementById("btnSavePlayer").onclick=()=>{
    if(isSelf || isCap){ target.nick=inNick.value.trim(); target.birth=inBirth.value; target.number=inNum.value.trim(); }
    if(isCap){ target.teams=[...chips.querySelectorAll("input:checked")].map(i=>i.value); target.role=inRole.value; }
    savePlayer(target); renderRoster(); document.getElementById("ovPlayer").style.display="none";
  };
}
function closePlayer(){ document.getElementById("ovPlayer").style.display="none"; }

/* =========================
   SEGUIMIENTO
========================= */
function renderTrack(){
  const can=canEdit();
  const box=document.getElementById("trackList"); box.innerHTML="";
  S.track.sort((a,b)=>new Date(b.date)-new Date(a.date));
  S.track.forEach((m,i)=>{
    const row=document.createElement("div"); row.className="card";
    row.innerHTML=`<div class="row" style="justify-content:space-between">
      <div><span class="badge">${m.type||'Amistoso'}</span> — ${new Date(m.date).toLocaleDateString('es-CL')} — vs ${m.opp} <span class="badge">${m.team}</span></div>
      <div class="row">${m.score?`<span class="badge">${m.score}</span> <span class="badge">${m.result}</span>`:""} ${can?'<button class="bsm">Editar</button>':''}</div>
    </div>
    ${m.scorers?.length? `<div style="margin-top:6px"><strong>Goleadoras:</strong> ${m.scorers.join(", ")}</div>`:""}`;
    if(can){ row.querySelector("button").onclick=()=>openTrack(i); }
    box.appendChild(row);
  });
}
document.getElementById("btnAddMatch").onclick=()=>openTrack();
function openTrack(idx){
  const can=canEdit(); if(!can) return alert("Solo Capitana/Admin.");
  const modal=document.getElementById("ovTrack"); modal.style.display="flex";
  const m = (idx!=null)? S.track[idx] : {date:new Date().toISOString().slice(0,10), team:"Golden Moms", opp:"", score:"", result:"Victoria", type:"Amistoso", scorers:[]};
  document.getElementById("tkTitle").textContent = idx!=null ? "Editar resultado" : "Registrar resultado";
  tkDate.value=m.date.slice(0,10); tkTeam.value=m.team; tkOpp.value=m.opp; tkScore.value=m.score; tkRes.value=m.result; tkScorers.value=(m.scorers||[]).join(", ");
  document.getElementById("btnSaveTrack").onclick=()=>{
    const obj={date:tkDate.value, team:tkTeam.value, opp:tkOpp.value.trim(), score:tkScore.value.trim(), result:tkRes.value, type:m.type||"Amistoso", scorers:tkScorers.value.split(",").map(s=>s.trim()).filter(Boolean)};
    if(idx!=null) S.track[idx]=obj; else S.track.push(obj); save(); renderTrack(); renderScorers(); modal.style.display="none";
  };
}
function closeTrack(){ document.getElementById("ovTrack").style.display="none"; }
function renderScorers(){
  // puedes sumarizar y mostrar en dashboard si quieres ampliar
}

/* =========================
   CONFIG (Admin)
========================= */
document.getElementById("btnAdmin").onclick=()=>show("cfg");
document.getElementById("btnExport").onclick=()=>{
  const a=document.createElement("a"); const blob=new Blob([JSON.stringify(S,null,2)],{type:"application/json"}); a.href=URL.createObjectURL(blob); a.download="golden-moms.json"; a.click(); URL.revokeObjectURL(a.href);
};
document.getElementById("btnImport").onclick=()=>document.getElementById("imp").click();
document.getElementById("imp").onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); Object.assign(S,data); save(); renderAll(); alert("Importado."); }catch(err){ alert("JSON inválido."); } };
  r.readAsText(f);
};
document.getElementById("btnReset").onclick=()=>{ if(confirm("Esto borra todo el estado local. ¿Continuar?")){ localStorage.removeItem(KEY); location.reload(); } };

/* =========================
   RSVP inline
========================= */
function checkHash(){ const h=location.hash; if(h.startsWith("#rsvp=")){ try{ const p=JSON.parse(decodeURIComponent(h.slice(6))); showRSVP(p.id,p.t);}catch{} } }
function showRSVP(id,t){ const E=S.events.find(x=>x.id==id); if(!E){ alert("Evento no existe en este navegador (Pages sin servidor)."); return; }
  document.getElementById("rinfo").innerHTML = `<strong>${t}</strong><br>${E.type} — ${E.title} (${E.team||'Golden Moms'})<br>${new Date(E.datetime).toLocaleString('es-CL')}${E.location?' — '+E.location:''}`;
  document.getElementById("rsvp").classList.remove("hide"); cur=id; renderRSVPSelect(); window.scrollTo({top:0,behavior:'smooth'}); }
function renderRSVPSelect(){ const s=document.getElementById("rSel"); s.innerHTML=S.roster.map(p=>`<option>${p.name}</option>`).join(""); }
document.getElementById("rAdd").onclick=()=>{ const n=document.getElementById("rNew").value.trim(); if(!n) return; if(!S.roster.find(x=>x.name===n)) S.roster.push({name:n,nick:n,number:"",birth:"",teams:["Golden Moms"],role:"Jugadora"}); save(); renderRSVPSelect(); document.getElementById("rSel").value=n; alert("Agregada: "+n); };
window.setRSVP=function(v){ const E=S.events.find(x=>x.id==cur); if(!E) return; const name=document.getElementById("rSel").value; const A=S.att[E.id]||{}; A[name]=v; S.att[E.id]=A; save(); alert("Confirmado: "+name+" → "+v); };

/* =========================
   RENDER GENERAL
========================= */
function renderCalendars(){
  const fType=document.getElementById("fType").value, fTeam=document.getElementById("fTeam").value;
  renderCal(document.getElementById("grid"), document.getElementById("mlabel"), view, fType, fTeam);
  const fType2=document.getElementById("fType2").value, fTeam2=document.getElementById("fTeam2").value;
  renderCal(document.getElementById("grid2"), document.getElementById("mlabel"), view, fType2, fTeam2);
  renderCal(document.getElementById("mGrid"), document.getElementById("mLabel"), mview, "Todos", "Todos");
}
["fType","fTeam","fType2","fTeam2"].forEach(id=>document.getElementById(id).onchange=renderCalendars);

function renderAll(){
  renderKPIs();
  renderBdays();
  renderCalendars();
  renderUpcoming();
  renderRoster();
  renderTrack();
}

renderAll(); checkHash();

/* abrir login al inicio si no hay sesión */
if(!SESSION){ /* opcional abrir login automáticamente */ }

</script>
</body>
</html>
