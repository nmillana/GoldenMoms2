<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms — Panel (restaurado)</title>
<link rel="icon" href="Logo.webp"/>
<!-- Carga directa del SDK (si está bloqueado, ver consola) -->
<script src="https://unpkg.com/@supabase/supabase-js@2/dist/supabase.min.js"></script>

<style>
:root{
  --blue:#0f3a78; --lime:#9be22d; --ink:#0f172a; --mut:#64748b;
  --b:#e2e8f0; --bg:#f7f8fa;
  --today-border-color: #ff3b3b;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
.top{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.brand{display:flex;gap:10px;align-items:center}
.brand img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)}
.nav{display:flex;gap:8px;align-items:center}
.nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
.nav .tab.active{background:var(--blue);color:#fff}
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;padding:12px;box-shadow:0 8px 20px #0000000a}
.section-note{font-size:12px;color:var(--mut);margin-top:8px;border-left:3px solid #e6edf7;padding-left:8px}

/* Calendar */
.month-bar{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
.month-title{font-weight:800;font-size:12px}
.month-nav{display:flex;gap:6px}
.month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:18px;grid-auto-rows:minmax(90px,auto)}
.week-sep{grid-column:1 / -1;height:8px;background:#000;margin:10px 0;border-radius:4px}
.weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:18px;margin-bottom:8px}
.weekdays div{font-weight:700;color:var(--blue);text-align:center;font-size:10px}

/* day */
.day{
  min-height:90px;background:#fff;border:1px solid var(--b);border-radius:12px;padding:12px;position:relative;display:flex;flex-direction:column;gap:6px;
}
.day-head{display:flex;align-items:center;justify-content:flex-start;gap:8px}
.day-num-box{background:#f1f5f9;border-radius:8px;padding:6px 8px;display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:48px}
.day-n{font-weight:800;color:var(--mut);font-size:16px}

/* TODAY: solo bordear la tarjeta .day con rojo (más grueso) */
.day.today{ border: 3px solid var(--today-border-color); border-radius:12px; }

/* plus button top-right inside day */
.day-add{
  position:absolute; top:10px; right:10px;
  width:36px;height:36px;border-radius:999px;border:1px solid var(--b);
  background:#eef4ff;color:var(--blue);display:inline-flex;align-items:center;justify-content:center;font-size:18px;
  cursor:pointer; z-index:3; box-shadow:0 6px 12px rgba(0,0,0,0.06);
}

/* event chips */
.ev{border-radius:10px;padding:8px;border:1px solid #0001;cursor:pointer;line-height:1.2;word-break:break-word;font-size:10px}
.ev-train{background:#9be22d;color:#0c3200;border-color:#8ed400}
.ev-match{background:#dce9ff;color:#0a2a58;border-color:#b9d0ff}

/* list fallback mobile */
.month-list{display:none;flex-direction:column;gap:12px}
.month-list .day{display:flex;gap:8px;padding:8px;position:relative}
.day-date{min-width:52px;border-radius:8px;background:#f1f5f9;padding:6px 8px;text-align:center}
.modal-bg{position:fixed;inset:0;background:#0006;display:none;z-index:1000;justify-content:center;align-items:flex-start;padding-top:6vh}
.modal{width:min(860px,calc(100% - 24px));background:#fff;border:1px solid var(--b);border-radius:14px;padding:16px}
.input,select{width:100%;padding:10px;border:1px solid var(--b);border-radius:10px}
@media(max-width:420px){ .day-n{font-size:14px} .day-add{width:34px;height:34px;font-size:16px;top:8px;right:8px} .month-grid{gap:10px} }
</style>
</head>
<body>

<!-- Top -->
<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM"/>
    <div><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div class="nav" role="tablist" aria-label="Navegación">
    <button class="tab active" data-view="dash">Dashboard</button>
    <button class="tab" data-view="events">Eventos</button>
    <button class="tab" data-view="roster">Plantel</button>
    <button class="tab" data-view="matches">Partidos</button>
  </div>
</div>

<div class="container">
  <!-- Dashboard -->
  <section id="v-dash">
    <div class="grid" style="display:block">
      <div class="card" style="margin-bottom:12px">
        <h4>Panel</h4>
        <div id="statusMsg" style="font-size:12px;color:var(--mut)">Conectando a Supabase...</div>
      </div>

      <div class="card" style="margin-bottom:12px">
        <h4>Resumen</h4>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="flex:1"><strong>Plantel</strong><div id="kRoster" style="font-size:22px;font-weight:800">0</div></div>
          <div style="flex:1"><strong>Partidos</strong><div id="kGames" style="font-size:22px;font-weight:800">0</div></div>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px">
        <h4>Hoy</h4>
        <div class="section-note">Eventos que ocurren hoy (fecha local).</div>
        <ul id="todayEvents" style="margin:8px 0 0 16px"></ul>
      </div>
    </div>
  </section>

  <!-- Eventos -->
  <section id="v-events" style="display:none">
    <div class="card">
      <div class="month-bar">
        <div class="month-nav">
          <button class="btn" id="btnPrevMonth">◀</button>
          <button class="btn" id="btnToday">Hoy</button>
          <button class="btn" id="btnNextMonth">▶</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="month-title" id="monthTitle">Mes</div>
          <button class="btn" id="btnNewEventTop" style="background:#9be22d;border-color:#7fd410;font-weight:800">Nuevo Evento</button>
        </div>
      </div>

      <div class="section-note">El calendario muestra eventos agrupados por fecha local (YYYY-MM-DD).</div>

      <div class="weekdays"><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div></div>

      <div id="monthGrid" class="month-grid"></div>
      <div id="monthList" class="month-list"></div>
    </div>
  </section>

  <!-- Plantel -->
  <section id="v-roster" style="display:none">
    <div class="card">
      <h4>Plantel</h4>
      <div class="section-note">Listado del plantel (tabla <code>players</code>).</div>
      <div id="rosterGrid" class="grid" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Partidos -->
  <section id="v-matches" style="display:none">
    <div class="card">
      <h4>Partidos jugados</h4>
      <div id="matchesList" style="margin-top:12px"></div>
    </div>
  </section>
</div>

<!-- Modal -->
<div class="modal-bg" id="modalBg" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Evento</h3>
    <div style="margin-top:8px">
      <label>Título</label>
      <input id="f_title" class="input" placeholder="Título">
    </div>
    <div style="margin-top:8px">
      <label>Fecha y hora</label>
      <input id="f_dt" type="datetime-local" class="input">
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:10px;gap:8px">
      <button class="btn" id="btnCancel">Cancelar</button>
      <button class="btn" id="btnSave">Guardar</button>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};

let supa = null;
const statusEl = document.getElementById('statusMsg');

function setStatus(msg, isError=false){
  statusEl.textContent = msg;
  statusEl.style.color = isError ? '#b91c1c' : 'var(--mut)';
}

/* Inicialización simple (vuelve al enfoque original) */
try{
  if(window.supabase && typeof window.supabase.createClient === 'function'){
    supa = window.supabase.createClient(SUPA.url, SUPA.key);
    setStatus('Cliente Supabase inicializado');
  } else {
    setStatus('SDK de Supabase no disponible (CDN bloqueado). Revisa consola.', true);
    console.warn('Supabase SDK not available at window.supabase');
  }
}catch(err){
  console.error('Error creando cliente supabase', err);
  setStatus('Error inicializando Supabase. Revisa consola.', true);
}

/* ---------- Helpers ---------- */
function pad(n){ return n.toString().padStart(2,'0'); }
function localDateYMD(d){ const D=new Date(d); return `${D.getFullYear()}-${pad(D.getMonth()+1)}-${pad(D.getDate())}`; }
function isoToLocalInput(iso){ if(!iso) return ''; const d=new Date(iso); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function localInputToISOWithOffset(inp){ if(!inp) return null; const [d,t] = inp.split('T'); const offMin = -new Date().getTimezoneOffset(); const sign = offMin>=0?'+':'-'; const abs=Math.abs(offMin); const oh=pad(Math.floor(abs/60)); const om=pad(abs%60); return `${d}T${t}:00${sign}${oh}:${om}`; }

/* ---------- Modal handlers ---------- */
const modalBg = document.getElementById('modalBg');
const f_title = document.getElementById('f_title');
const f_dt = document.getElementById('f_dt');
const btnCancel = document.getElementById('btnCancel');
const btnSave = document.getElementById('btnSave');
let editingId = null;

function openModal(opts={}) {
  editingId = null;
  document.getElementById('modalTitle').textContent = opts.existing ? 'Editar evento' : 'Nuevo evento';
  if(opts.existing){
    const e = opts.existing;
    editingId = e.id;
    f_title.value = e.title || '';
    f_dt.value = isoToLocalInput(e.datetime);
  } else {
    f_title.value = '';
    const base = opts.date ? new Date(opts.date) : new Date();
    base.setHours(19,30,0,0);
    f_dt.value = isoToLocalInput(base.toISOString());
  }
  modalBg.style.display = 'flex';
}
function closeModal(){ modalBg.style.display = 'none'; editingId = null; }
modalBg.addEventListener('click', (e)=>{ if(e.target===modalBg) closeModal(); });
btnCancel.addEventListener('click', closeModal);

btnSave.addEventListener('click', async ()=>{
  if(!supa){ alert('No conectado a Supabase'); return; }
  const title = (f_title.value||'').trim();
  if(!title || !f_dt.value){ alert('Completa título y fecha/hora'); return; }
  const datetime = localInputToISOWithOffset(f_dt.value);
  const payload = { title, datetime };
  try{
    if(editingId){
      const { error } = await supa.from('events').update(payload).eq('id', editingId);
      if(error) throw error;
    } else {
      const { error } = await supa.from('events').insert([payload]);
      if(error) throw error;
    }
    closeModal();
    renderMonth();
    renderDash();
  }catch(err){ console.error(err); alert('Error guardando. Revisa consola.'); }
});

/* ---------- Calendar rendering ---------- */
let monthCursor = new Date();
let cachedEvents = [];
const monthGrid = document.getElementById('monthGrid');
const monthList = document.getElementById('monthList');
const monthTitle = document.getElementById('monthTitle');

document.getElementById('btnPrevMonth')?.addEventListener('click', ()=>{ monthCursor.setMonth(monthCursor.getMonth()-1); renderMonth(); });
document.getElementById('btnNextMonth')?.addEventListener('click', ()=>{ monthCursor.setMonth(monthCursor.getMonth()+1); renderMonth(); });
document.getElementById('btnToday')?.addEventListener('click', ()=>{ monthCursor = new Date(); renderMonth(); });
document.getElementById('btnNewEventTop')?.addEventListener('click', ()=> openModal());

function getMonthRange(d){
  const first = new Date(d.getFullYear(), d.getMonth(), 1);
  const last = new Date(d.getFullYear(), d.getMonth()+1, 0);
  let start = new Date(first); let dow = (start.getDay()+6)%7; start.setDate(start.getDate()-dow);
  let end = new Date(last); let dow2 = (end.getDay()+6)%7; end.setDate(end.getDate() + (6-dow2));
  return { start, end };
}

async function fetchEventsRange(start,end){
  if(!supa) return [];
  try{
    const { data, error } = await supa.from('events').select('*').gte('datetime', start.toISOString()).lte('datetime', end.toISOString()).order('datetime', {ascending:true});
    if(error) { console.error(error); return []; }
    return data || [];
  }catch(err){ console.error(err); return []; }
}

function renderMonthTitle(){ const m = monthCursor.toLocaleString('es-CL',{month:'long',year:'numeric'}); monthTitle.textContent = m.charAt(0).toUpperCase()+m.slice(1); }

async function renderMonth(){
  renderMonthTitle();
  const { start, end } = getMonthRange(monthCursor);
  cachedEvents = await fetchEventsRange(start,end);
  if(window.matchMedia('(max-width:420px)').matches){
    monthGrid.style.display = 'none'; monthList.style.display = 'block'; drawMonthList(start,end);
  } else {
    monthList.style.display = 'none'; monthGrid.style.display = ''; drawMonthGrid(start,end);
  }
}

function drawMonthGrid(start,end){
  if(!monthGrid) return;
  monthGrid.innerHTML = '';
  const days=[];
  let d = new Date(start);
  while(d <= end){ days.push(new Date(d)); d.setDate(d.getDate()+1); }
  const todayYMD = localDateYMD(new Date());
  for(const day of days){
    const cell = document.createElement('div'); cell.className='day';
    const head = document.createElement('div'); head.className='day-head';
    const wk = day.toLocaleDateString('es-CL',{weekday:'short'}).replace(/\./g,'');
    const dayStr = localDateYMD(day);
    head.innerHTML = `<div class="day-num-box"><div class="day-wk-grid">${wk}</div><div class="day-n">${pad(day.getDate())}</div></div>`;
    const plus = document.createElement('button'); plus.className='day-add'; plus.innerText = '+'; plus.title='Nuevo evento'; plus.onclick = ()=> openModal({ date: day });
    cell.appendChild(head); cell.appendChild(plus);
    if(dayStr === todayYMD){ cell.classList.add('today'); cell.setAttribute('aria-current','date'); }
    const events = (cachedEvents || []).filter(e => localDateYMD(new Date(e.datetime)) === dayStr);
    for(const e of events){
      const ev = document.createElement('div'); ev.className = 'ev ' + (e.type==='Entrenamiento' ? 'ev-train' : 'ev-match');
      ev.innerHTML = `<div class="title">${e.title}</div>`;
      ev.onclick = ()=> openModal({ existing: e });
      cell.appendChild(ev);
    }
    monthGrid.appendChild(cell);
    if(day.getDay() === 0){ const sep = document.createElement('div'); sep.className='week-sep'; monthGrid.appendChild(sep); }
  }
}

function drawMonthList(start,end){
  if(!monthList) return;
  monthList.innerHTML = '';
  const days=[]; let d = new Date(start);
  while(d<=end){ days.push(new Date(d)); d.setDate(d.getDate()+1); }
  const todayYMD = localDateYMD(new Date());
  for(const day of days){
    const dayStr = localDateYMD(day);
    const events = (cachedEvents || []).filter(e => localDateYMD(new Date(e.datetime)) === dayStr);
    const row = document.createElement('div'); row.className='day';
    if(dayStr === todayYMD){ row.classList.add('today'); row.setAttribute('aria-current','date'); }
    const dateBox = document.createElement('div'); dateBox.className='day-date'; const wk = day.toLocaleDateString('es-CL',{weekday:'short'}).replace(/\./g,'');
    dateBox.innerHTML = `<div class="day-wk">${wk}</div><div class="day-num">${pad(day.getDate())}</div>`;
    const col = document.createElement('div'); col.className='events-column';
    const plus = document.createElement('button'); plus.className='day-add'; plus.innerText='+'; plus.onclick=()=> openModal({ date: day });
    if(events.length){
      for(const e of events){ const ev=document.createElement('div'); ev.className='ev '+(e.type==='Entrenamiento'?'ev-train':'ev-match'); ev.innerHTML=`<div>${e.title}</div>`; ev.onclick=()=>openModal({ existing:e }); col.appendChild(ev); }
    } else {
      const n = document.createElement('div'); n.style.color='var(--mut)'; n.textContent='—'; col.appendChild(n);
    }
    row.appendChild(dateBox); row.appendChild(col); row.appendChild(plus);
    monthList.appendChild(row);
    if(day.getDay()===0){ const sep=document.createElement('div'); sep.className='week-sep'; monthList.appendChild(sep); }
  }
}

/* ---------- Dashboard / roster / matches ---------- */
async function renderDash(){
  try{
    const now = new Date();
    const weekStart = new Date(now); weekStart.setDate(weekStart.getDate() - ((weekStart.getDay()+6)%7));
    const weekEnd = new Date(weekStart); weekEnd.setDate(weekEnd.getDate()+6);
    const todayYMD = localDateYMD(now);

    let evs = [];
    if(supa){
      const { data:events, error } = await supa.from('events').select('*').gte('datetime', weekStart.toISOString()).lte('datetime', weekEnd.toISOString()).order('datetime',{ascending:true});
      if(error){ console.warn('events err', error); evs = []; } else evs = events || [];
    }

    let players = [];
    if(supa){
      try{ const { data:playersList, error } = await supa.from('players').select('*').order('apodo',{ascending:true}); if(error){ console.warn(error); players = []; } else players = playersList || []; }catch(e){ console.warn(e); players = []; }
    }

    document.getElementById('kRoster').textContent = (players||[]).length || 0;
    const matchesPlayed = evs.filter(e=> e.type==='Partido' && new Date(e.datetime) < now);
    document.getElementById('kGames').textContent = matchesPlayed.length;

    const todayEl = document.getElementById('todayEvents'); todayEl.innerHTML = '';
    evs.filter(e => localDateYMD(new Date(e.datetime)) === todayYMD).forEach(e=>{
      const d = new Date(e.datetime);
      const li = document.createElement('li');
      li.innerHTML = `<strong>${e.title}</strong> — ${d.toLocaleString('es-CL',{weekday:'short',hour:'2-digit',minute:'2-digit'})}`;
      todayEl.appendChild(li);
    });
    if(todayEl.innerHTML.trim()==='') todayEl.innerHTML = '<div style="color:var(--mut)">No hay eventos hoy</div>';

    // roster UI
    const rosterGrid = document.getElementById('rosterGrid'); rosterGrid.innerHTML = '';
    if(players && players.length){
      players.forEach(p=>{
        const c = document.createElement('div'); c.className='card'; c.style.marginBottom='10px';
        c.innerHTML = `<div style="font-weight:700">${p.apodo||p.nombre||'Sin nombre'}</div><div style="font-size:13px;color:var(--mut)">${p.posicion||''}</div>`;
        rosterGrid.appendChild(c);
      });
    } else {
      rosterGrid.innerHTML = '<div style="color:var(--mut)">No hay jugadores registrados</div>';
    }

  }catch(err){
    console.error(err);
  }
}

async function renderMatches(){
  const container = document.getElementById('matchesList');
  container.innerHTML = 'Cargando...';
  if(!supa){ container.innerHTML = '<div style="color:var(--mut)">Sin conexión</div>'; return; }
  try{
    const { data, error } = await supa.from('matches').select(`*, events:event_id ( id, title, datetime, team, opponent )`).order('created_at', {ascending:false});
    if(error){ console.warn(error); container.innerHTML = '<div style="color:var(--mut)">No hay registros</div>'; return; }
    if(!data || data.length===0){ container.innerHTML = '<div style="color:var(--mut)">No hay registros</div>'; return; }
    container.innerHTML = data.map(m=>{
      const ev = m.events || {};
      const d = ev.datetime ? new Date(ev.datetime) : null;
      const dateTxt = d ? `${d.toLocaleDateString('es-CL',{day:'2-digit',month:'short'})} ${d.toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'})}` : '';
      return `<div style="border:1px solid var(--b);padding:10px;border-radius:8px;margin-bottom:8px">
        <div style="font-weight:700">${ev.title || 'Partido'}</div><div style="font-size:13px;color:var(--mut)">${dateTxt}</div>
      </div>`;
    }).join('');
  }catch(err){ console.error(err); container.innerHTML = '<div style="color:var(--mut)">Error cargando</div>'; }
}

/* ---------- Nav + view persistence ---------- */
function persistView(view){ try{ localStorage.setItem('gm_view', view); }catch(e){} }
function getPersistedView(){ try{ return localStorage.getItem('gm_view'); }catch(e){ return null; } }

document.querySelectorAll('.nav .tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const view = btn.dataset.view;
    persistView(view);
    showView(view);
  });
});

function showView(v){
  ['dash','events','roster','matches'].forEach(id=>{
    const el = document.getElementById('v-'+id);
    if(el) el.style.display = 'none';
  });
  const target = document.getElementById('v-'+v); if(target) target.style.display = 'block';
  if(v==='dash') renderDash();
  if(v==='events') renderMonth();
  if(v==='matches') renderMatches();
}

/* ---------- bootstrap ---------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  // default to dashboard unless user persisted a view
  const persisted = getPersistedView();
  const initialView = persisted ? persisted : 'dash';
  document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
  const btnToActivate = document.querySelector(`.nav .tab[data-view="${initialView}"]`);
  if(btnToActivate) btnToActivate.classList.add('active');

  showView(initialView);
});
</script>
</body>
</html>
