<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms ‚Äî Plantel (diagn√≥stico)</title>
<link rel="icon" href="Logo.webp"/>
<style>
:root{--blue:#0f3a78;--lime:#9be22d;--mut:#64748b;--b:#e2e8f0}
*{box-sizing:border-box} html,body{margin:0;background:#f7f8fa;color:#0f172a;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
.top{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px;gap:12px}
.logo-wrap{display:flex;flex-direction:column;align-items:center;gap:4px;flex:0 0 56px}
.logo-wrap img{width:44px;height:44px;border-radius:50%;border:2px solid var(--blue)}
.team-name{font-size:11px;color:var(--lime);font-weight:800;text-align:center}
.nav{display:flex;gap:8px;align-items:center;flex:1;justify-content:flex-end}
.nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
.nav .tab.active{background:var(--blue);color:#fff}
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.status{margin:8px 0;padding:10px;border-radius:8px;background:#fff;border:1px solid var(--b);font-size:13px;color:var(--mut)}
.status.error{border-color:#ffb7b7;background:#fff0f0;color:#a00}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;padding:12px}
.section-note{font-size:12px;color:var(--mut);margin-top:8px;border-left:3px solid #e6edf7;padding-left:8px}
#rosterGrid{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));margin-top:12px}
.player-card{padding:12px;border-radius:10px;border:1px solid var(--b);background:#fff;text-align:center;cursor:pointer;min-height:110px;display:flex;flex-direction:column;align-items:center;gap:8px}
.player-avatar{width:64px;height:64px;border-radius:50%;overflow:hidden;background:#f1f5f9;display:flex;align-items:center;justify-content:center}
.player-avatar img{width:100%;height:100%;object-fit:cover}
.player-apodo{font-weight:800;color:var(--blue)}
.player-nombre{font-size:12px;color:var(--mut)}
.btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer}
.btn.p{background:var(--lime);border-color:#a3e635}
.modal-bg{position:fixed;inset:0;background:#0006;display:none;z-index:1200;justify-content:center;align-items:flex-start;padding-top:6vh}
.modal{width:min(880px,calc(100% - 24px));background:#fff;border-radius:12px;padding:16px;border:1px solid var(--b);box-shadow:0 20px 40px rgba(0,0,0,.12);max-height:90vh;overflow:auto}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
@media(max-width:800px){.form-row{grid-template-columns:1fr}}
.input,select,textarea{width:100%;padding:10px;border:1px solid var(--b);border-radius:8px}
.teams-list{display:flex;flex-wrap:wrap;gap:8px}
.team-chip{padding:6px 8px;border-radius:999px;border:1px solid var(--b);cursor:pointer;background:#fff}
.no-data{padding:16px;color:var(--mut);text-align:center}
.footer{padding:16px;text-align:center;color:var(--mut);font-size:12px}
</style>
</head>
<body>

<div class="top">
  <div style="display:flex;align-items:center;gap:10px">
    <div class="logo-wrap"><img src="Logo.webp" alt="GM"><div class="team-name">Golden <span style="color:var(--lime)">Moms</span></div></div>
  </div>
  <div class="nav" role="tablist">
    <button class="tab" data-view="dash">Dashboard</button>
    <button class="tab" data-view="events">Eventos</button>
    <button class="tab active" data-view="roster">Plantel</button>
    <button class="tab" data-view="matches">Partidos</button>
  </div>
</div>

<div class="container">
  <div id="status" class="status">Inicializando‚Ä¶</div>

  <section id="v-roster">
    <div class="card">
      <h4>Plantel</h4>
      <div class="section-note">Haz clic en una jugadora para ver o editar su ficha. Puedes subir una foto (se guardar√° en Storage).</div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div style="font-size:12px;color:var(--mut)">Listado sincronizado con Supabase (tabla <code>players</code>).</div>
        <div><button id="btnAddPlayer" class="btn">Agregar jugadora</button></div>
      </div>

      <div id="rosterGrid"></div>
    </div>
  </section>

  <section id="v-events" style="display:none"><div class="card"><h4>Eventos</h4><div class="no-data">(Secci√≥n eventos)</div></div></section>
  <section id="v-dash" style="display:none"><div class="card"><h4>Dashboard</h4><div class="no-data">(Secci√≥n dashboard)</div></div></section>
  <section id="v-matches" style="display:none"><div class="card"><h4>Partidos</h4><div class="no-data">(Secci√≥n partidos)</div></div></section>
</div>

<div class="footer">Golden Moms ¬∑ hecho con üíö lima & azul</div>

<!-- Modal -->
<div class="modal-bg" id="playerModalBg" aria-hidden="true">
  <div class="modal" role="dialog" id="playerModal">
    <h3 id="playerModalTitle">Ficha</h3>

    <div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:8px">
      <div style="width:120px;height:120px;border-radius:8px;overflow:hidden;background:#f7f9fb;border:1px dashed var(--b);display:flex;align-items:center;justify-content:center" id="playerPhotoPreview"></div>
      <div style="flex:1">
        <div style="margin-bottom:8px">
          <label>Foto (URL)</label>
          <input id="p_foto" class="input" placeholder="https://...">
        </div>
        <div style="margin-bottom:8px">
          <label>Foto (archivo)</label>
          <input id="p_file" type="file" accept="image/*" class="input">
        </div>
      </div>
    </div>

    <div class="form-row">
      <div><label>Nombre completo</label><input id="p_nombre" class="input"></div>
      <div><label>Apodo</label><input id="p_apodo" class="input"></div>
    </div>

    <div class="form-row">
      <div><label>N√∫mero camiseta</label><input id="p_numero" class="input" placeholder="ej: 11"></div>
      <div><label>Rol</label><input id="p_rol" class="input" placeholder="ej: jugadora"></div>
    </div>

    <div class="form-row">
      <div><label>Fecha de nacimiento</label><input id="p_nacimiento" type="date" class="input"></div>
      <div><label>Tel√©fono emergencia</label><input id="p_emergencia" class="input" placeholder="+56 9 ..."></div>
    </div>

    <div class="form-row">
      <div><label>Seguro m√©dico</label><input id="p_seguro" class="input"></div>
      <div>
        <label>Equipos (selecciona 1 o m√°s)</label>
        <div class="teams-list" id="teamsList"></div>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
      <button id="btnDeletePlayer" class="btn" style="display:none">Eliminar</button>
      <button id="btnClosePlayer" class="btn">Cerrar</button>
      <button id="btnSavePlayer" class="btn p">Guardar</button>
    </div>
  </div>
</div>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
/* ---------- CONFIG ---------- */
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};
const BUCKET_NAME = 'player-photos';

const statusEl = document.getElementById('status');
function setStatus(msg, isError = false){
  statusEl.textContent = msg;
  statusEl.className = isError ? 'status error' : 'status';
  console.log('[STATUS]', msg);
}

/* ensure SDK loaded */
if(typeof supabase === 'undefined'){
  setStatus('Error: SDK de Supabase no se carg√≥ (window.supabase undefined). Revisa conexi√≥n CDN.', true);
  console.error('Supabase SDK not available at window.supabase');
}
// create client safely
let supa = null;
try{
  if(typeof supabase !== 'undefined' && typeof supabase.createClient === 'function'){
    supa = supabase.createClient(SUPA.url, SUPA.key);
    setStatus('Conectado a Supabase (cliente creado). Cargando jugadoras‚Ä¶');
    console.log('Supabase client created:', supa);
  } else {
    setStatus('No se pudo inicializar cliente Supabase. Revisa SDK.', true);
  }
}catch(err){
  setStatus('Error inicializando Supabase: ' + (err.message || err), true);
  console.error(err);
}

/* DOM refs */
const rosterGrid = document.getElementById('rosterGrid');
const btnAddPlayer = document.getElementById('btnAddPlayer');
const playerModalBg = document.getElementById('playerModalBg');
const playerPhotoPreview = document.getElementById('playerPhotoPreview');

const p_foto = document.getElementById('p_foto');
const p_file = document.getElementById('p_file');
const p_nombre = document.getElementById('p_nombre');
const p_apodo = document.getElementById('p_apodo');
const p_numero = document.getElementById('p_numero');
const p_rol = document.getElementById('p_rol');
const p_nacimiento = document.getElementById('p_nacimiento');
const p_emergencia = document.getElementById('p_emergencia');
const p_seguro = document.getElementById('p_seguro');
const teamsList = document.getElementById('teamsList');

const btnClosePlayer = document.getElementById('btnClosePlayer');
const btnSavePlayer = document.getElementById('btnSavePlayer');
const btnDeletePlayer = document.getElementById('btnDeletePlayer');

/* state */
let playersCache = [];
let tableColumns = [];
let currentEditing = null;
const TEAM_OPTIONS = ["Golden Moms","Golden Power","Golden Dream"];

/* small helpers */
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function avatarOrPlaceholder(url, name){
  if(url) return url;
  const initials = (name||'').split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase() || 'GM';
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect width='100%' height='100%' fill='#f1f5f9'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='48' fill='#64748b'>${escapeHtml(initials)}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}
function parseTeams(v){
  if(!v) return [];
  if(Array.isArray(v)) return v;
  if(typeof v === 'string'){
    try{ const parsed = JSON.parse(v); if(Array.isArray(parsed)) return parsed; }catch(e){}
    return v.split(',').map(x=>x.trim()).filter(Boolean);
  }
  return [];
}

/* upload helper */
async function uploadFileToStorage(file){
  try{
    if(!file) return null;
    const ext = file.name.split('.').pop();
    const path = `players/${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;
    const { data, error } = await supa.storage.from(BUCKET_NAME).upload(path, file, { upsert: true });
    if(error) throw error;
    const { publicUrl, error: urlErr } = supa.storage.from(BUCKET_NAME).getPublicUrl(path);
    if(urlErr) { console.warn('getPublicUrl err', urlErr); return null; }
    return publicUrl;
  }catch(err){
    console.error('uploadFileToStorage error', err);
    throw err;
  }
}

/* fetch players (safe) */
async function fetchPlayers(){
  try{
    if(!supa){ setStatus('Cliente Supabase no disponible. No se puede cargar players.', true); return []; }
    setStatus('Cargando jugadoras desde Supabase...');
    console.log('fetchPlayers: fetching...');
    const { data, error } = await supa.from('players').select('*').order('apodo', { ascending:true });
    if(error){ throw error; }
    playersCache = (data || []).map(p => ({ ...p, equipos: parseTeams(p.equipos || p.teams || p.equipo) }));
    tableColumns = playersCache.length ? Object.keys(playersCache[0]) : [];
    renderRoster(playersCache);
    setStatus('Jugadoras cargadas: ' + playersCache.length);
    return playersCache;
  }catch(err){
    console.error('fetchPlayers err', err);
    setStatus('Error cargando jugadoras: ' + (err.message || err), true);
    rosterGrid.innerHTML = '<div class="no-data">No se pudieron cargar jugadoras. Revisa consola.</div>';
    return [];
  }
}

/* render roster */
function renderRoster(list){
  try{
    rosterGrid.innerHTML = '';
    if(!list || list.length === 0){ rosterGrid.innerHTML = '<div class="no-data">No hay jugadoras registradas.</div>'; return; }
    const sorted = (list || []).slice().sort((a,b) => (a.apodo || '').toString().toLowerCase().localeCompare((b.apodo || '').toString().toLowerCase()));
    for(const p of sorted){
      const card = document.createElement('div'); card.className='player-card';
      card.dataset.id = p.id || '';
      const av = document.createElement('div'); av.className='player-avatar';
      const img = document.createElement('img'); img.src = avatarOrPlaceholder(p.foto || p.photo || '', p.apodo || p.nombre);
      img.alt = p.apodo || p.nombre || '';
      av.appendChild(img);
      const ap = document.createElement('div'); ap.className='player-apodo'; ap.textContent = p.apodo || (p.nombre||'').split(' ')[0] || 'Sin apodo';
      const nm = document.createElement('div'); nm.className='player-nombre'; nm.textContent = p.nombre || '';
      card.appendChild(av); card.appendChild(ap); card.appendChild(nm);
      card.onclick = ()=> openPlayerModal(p);
      rosterGrid.appendChild(card);
    }
  }catch(err){
    console.error('renderRoster err', err);
    setStatus('Error renderizando roster: ' + (err.message || err), true);
  }
}

/* teams UI */
function renderTeamsUI(selected=[]){
  teamsList.innerHTML = '';
  for(const t of TEAM_OPTIONS){
    const label = document.createElement('label'); label.className='team-chip';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.value=t; cb.style.display='none';
    cb.checked = selected.includes(t);
    label.appendChild(cb);
    const span = document.createElement('span'); span.textContent = t; label.appendChild(span);
    label.style.background = cb.checked ? '#eaffd6' : '#fff';
    label.addEventListener('click', ()=>{ cb.checked = !cb.checked; label.style.background = cb.checked ? '#eaffd6' : '#fff'; });
    teamsList.appendChild(label);
  }
}
function getSelectedTeams(){ return Array.from(teamsList.querySelectorAll('input[type=checkbox]')).filter(i=>i.checked).map(i=>i.value); }

/* modal open/close */
function openPlayerModal(player){
  currentEditing = player ? {...player} : null;
  document.getElementById('playerModalTitle').textContent = player ? `Ficha ‚Äî ${player.apodo || player.nombre || ''}` : 'Agregar jugadora';
  btnDeletePlayer.style.display = player && player.id ? '' : 'none';

  p_foto.value = player?.foto || player?.photo || '';
  p_file.value = '';
  p_nombre.value = player?.nombre || '';
  p_apodo.value = player?.apodo || '';
  p_numero.value = ( (player?.numero_camiseta ?? player?.numero ?? player?.number) ) || '';
  p_rol.value = player?.rol || player?.gm_role || '';
  p_nacimiento.value = player?.fecha_nacimiento ? (player.fecha_nacimiento.split('T')[0] || player.fecha_nacimiento) : '';
  p_emergencia.value = player?.telefono_emergencia || player?.telefono || '';
  p_seguro.value = player?.seguro_medico || player?.seguro || '';
  renderTeamsUI(parseTeams(player?.equipos || player?.teams || player?.equipo || []));
  setPhotoPreview(p_foto.value || '');
  playerModalBg.style.display = 'flex'; playerModalBg.setAttribute('aria-hidden','false');
}
function setPhotoPreview(url){
  playerPhotoPreview.innerHTML = '';
  const img = document.createElement('img'); img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
  img.src = avatarOrPlaceholder(url, p_apodo.value || p_nombre.value);
  playerPhotoPreview.appendChild(img);
}
function closePlayerModal(){ playerModalBg.style.display = 'none'; playerModalBg.setAttribute('aria-hidden','true'); currentEditing = null; }

/* save/delete (dynamic payload) */
async function savePlayer(){
  try{
    if(!supa){ setStatus('No hay conexi√≥n a Supabase para guardar.', true); return; }
    let fotoUrl = (p_foto.value || '').trim() || null;
    if(p_file.files && p_file.files[0]){
      try{ fotoUrl = await uploadFileToStorage(p_file.files[0]); p_foto.value = fotoUrl || ''; }catch(e){ alert('Error subiendo la foto. Revisa consola.'); console.error(e); }
    }

    const map = {
      nombre: p_nombre.value.trim(),
      apodo: p_apodo.value.trim(),
      numero_camiseta: p_numero.value.trim() || null,
      numero: p_numero.value.trim() || null,
      number: p_numero.value.trim() || null,
      rol: p_rol.value.trim(),
      gm_role: p_rol.value.trim(),
      fecha_nacimiento: p_nacimiento.value || null,
      telefono_emergencia: p_emergencia.value.trim() || null,
      telefono: p_emergencia.value.trim() || null,
      seguro_medico: p_seguro.value.trim() || null,
      seguro: p_seguro.value.trim() || null,
      foto: fotoUrl || null,
      equipos: getSelectedTeams()
    };

    const payload = {};
    const columnSet = new Set(tableColumns || []);
    for(const [k,v] of Object.entries(map)){
      if(columnSet.has(k)){
        if(k === 'numero_camiseta' || k === 'number' || k === 'numero'){
          payload[k] = v ? (isNaN(Number(v)) ? v : Number(v)) : null;
        } else if(k === 'equipos'){
          payload[k] = Array.isArray(v) ? v : parseTeams(v);
        } else {
          payload[k] = v;
        }
      }
    }

    if(Object.keys(payload).length === 0){
      alert('No se encontraron columnas mapeables en la tabla "players". Revisa la estructura en Supabase.');
      return;
    }

    setStatus('Guardando jugadora...');
    if(currentEditing && currentEditing.id){
      const { error } = await supa.from('players').update(payload).eq('id', currentEditing.id);
      if(error) throw error;
    } else {
      const { data, error } = await supa.from('players').insert([payload]).select();
      if(error) throw error;
    }
    await fetchPlayers();
    closePlayerModal();
    setStatus('Guardado OK');
  }catch(err){
    console.error('savePlayer err', err);
    setStatus('Error guardando: ' + (err.message || err), true);
    alert('Error guardando. Mira la consola o la barra de estado.');
  }
}

async function deletePlayer(){
  if(!currentEditing || !currentEditing.id) return;
  if(!confirm('Eliminar jugadora?')) return;
  try{
    const { error } = await supa.from('players').delete().eq('id', currentEditing.id);
    if(error) throw error;
    await fetchPlayers();
    closePlayerModal();
    setStatus('Eliminado OK');
  }catch(err){ console.error('delete err', err); setStatus('Error eliminando: ' + (err.message||err), true); alert('Error eliminando. Mira la consola.'); }
}

/* UI wiring */
btnAddPlayer.addEventListener('click', ()=> openPlayerModal(null));
btnClosePlayer.addEventListener('click', closePlayerModal);
btnSavePlayer.addEventListener('click', savePlayer);
btnDeletePlayer.addEventListener('click', deletePlayer);
playerModalBg.addEventListener('click',(e)=>{ if(e.target === playerModalBg) closePlayerModal(); });
p_foto.addEventListener('input', ()=> setPhotoPreview(p_foto.value || ''));

/* tabs wiring + initial view */
function showView(name){
  document.querySelectorAll('.nav .tab').forEach(b=>b.classList.toggle('active', b.dataset.view === name));
  document.querySelectorAll('section[id^="v-"]').forEach(s => s.style.display = 'none');
  const sec = document.getElementById('v-'+name);
  if(sec) sec.style.display = 'block';
  if(name === 'roster') fetchPlayers();
}
document.querySelectorAll('.nav .tab').forEach(btn=> btn.addEventListener('click', ()=> showView(btn.dataset.view)));

/* bootstrap */
document.addEventListener('DOMContentLoaded', async ()=>{
  try{
    // check sdk + client
    if(typeof supabase === 'undefined' || !supa){ setStatus('SDK o cliente Supabase no disponible (ver consola).', true); console.error('Supabase missing or client not initialized'); return; }
    // initial show roster
    showView('roster');
  }catch(err){
    console.error('bootstrap err', err);
    setStatus('Error inicializando UI: ' + (err.message || err), true);
  }
});
</script>
</body>
</html>
