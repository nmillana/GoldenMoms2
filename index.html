<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms ‚Äî Plantel (compact) - routing</title>
<link rel="icon" href="Logo.webp"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{
  --blue:#0f3a78; --lime:#9be22d; --ink:#0f172a; --mut:#64748b;
  --b:#e2e8f0; --bg:#f7f8fa;
  --lime-strong:#7fd410; --blue-strong:#0a2a58;
  --title-size:12px; --content-size:10px; --sub-size:8px; --kpi-number-size:22px;
  --card-radius:12px;
  --player-card-padding:12px;
}

/* base */
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:inherit;text-decoration:none}

/* Buttons */
.btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer;font-size:var(--content-size)}
.btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
.btn.s{background:#f8fafc}

/* Top bar */
.top{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px;overflow:visible;gap:12px}
.brand{display:flex;gap:10px;align-items:center;flex:0 0 auto;}
.brand .logo-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;flex:0 0 56px;width:56px}
.brand img{width:44px;height:44px;border-radius:50%;border:2px solid var(--blue);display:block}
.brand .team-name{font-size:11px;line-height:1;color:var(--lime);font-weight:800;text-align:center;margin-top:0;}
.brand .brand-sub{font-size:11px;color:var(--mut);text-align:center;margin:0}

/* nav: allow it to occupy remaining space and align to right */
.nav{display:flex;gap:8px;flex-wrap:nowrap;align-items:center;overflow-x:auto;padding-bottom:4px;flex:1;justify-content:flex-end}
.nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer;white-space:nowrap;font-size:var(--content-size)}
.nav .tab.active{background:var(--blue);color:#fff}

/* Layout */
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:#fff;border:1px solid var(--b);border-radius:var(--card-radius);box-shadow:0 8px 20px #0000000a;padding:12px; overflow:visible}
.card h4{margin:0 0 8px;font-size:14px;font-weight:700}
.section-note{font-size:var(--sub-size);color:var(--mut);margin-top:8px;border-left:3px solid #e6edf7;padding-left:8px}

/* ROSTER grid + card (compact) */
#rosterGrid{
  display:grid;
  gap:10px;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
}

/* Player card */
.player-card{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  padding:var(--player-card-padding);
  border-radius:10px;
  border:1px solid var(--b);
  background:#fff;
  cursor:pointer;
  transition:transform .12s ease, box-shadow .12s ease;
  text-align:center;
  min-height:120px;
}
.player-card:hover{ transform: translateY(-4px); box-shadow: 0 12px 24px #00000010; }
.player-avatar{
  width:64px;height:64px;border-radius:50%;overflow:hidden;border:3px solid #fff;box-shadow:0 6px 18px #00000008;display:flex;align-items:center;justify-content:center;background:#f1f5f9;
}
.player-avatar img{width:100%;height:100%;object-fit:cover}
.player-apodo{font-weight:800;color:var(--blue);font-size:13px;margin-top:4px}
.player-nombre{font-size:12px;color:var(--mut);margin-bottom:4px}

/* make cards smaller so 4 fit on medium widths */
@media (max-width:1100px){
  #rosterGrid{ grid-template-columns: repeat(4, 1fr); }
  .player-avatar{ width:56px; height:56px; }
  .player-card{ padding:10px; min-height:110px; }
  .player-apodo{font-size:12px}
}

/* medium screens: 4 per row */
@media (max-width:900px){
  #rosterGrid{ grid-template-columns: repeat(4, 1fr); }
  .player-avatar{ width:52px; height:52px; }
  .player-card{ padding:8px; min-height:100px; }
}

/* smaller phones: 2 per row */
@media (max-width:480px){
  #rosterGrid{ grid-template-columns: repeat(2, 1fr); }
  .player-avatar{ width:48px; height:48px; }
  .player-card{ padding:8px; min-height:96px; }
  .nav{gap:6px}
  .brand .logo-wrap{width:48px;flex:0 0 48px}
}

/* Modal styles (player modal kept similar) */
.modal-bg{position:fixed;inset:0;background:#0006;display:none;z-index:1200;justify-content:center;align-items:flex-start;padding-top:6vh;overflow-y:auto;-webkit-overflow-scrolling:touch}
.modal{width: min(880px, calc(100% - 24px));margin: 0 auto;background:#fff;border:1px solid var(--b);border-radius:14px;padding:16px;box-shadow:0 20px 40px #00000022;max-height:90vh; overflow:auto; box-sizing:border-box;}
.modal h3{margin:0 0 10px;font-size:16px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:800px){.form-row{grid-template-columns:1fr}}
.input, select, textarea{width:100%;padding:10px;border:1px solid var(--b);border-radius:10px;background:#fff;font-size:var(--content-size)}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

/* small helpers */
.small-muted{font-size:12px;color:var(--mut)}
.note{font-size:12px;color:var(--mut);margin-top:8px}

/* footer */
footer{font-size:var(--content-size);color:var(--mut);text-align:center;padding:16px}
.kpi-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.kpi{flex:1;min-width:140px;padding:12px;border-radius:10px;background:#f8fafc;border:1px solid #eef6ff;text-align:center}
.kpi .num{font-size:20px;font-weight:800;color:var(--blue)}
.kpi .label{font-size:12px;color:var(--mut);margin-top:6px}
</style>
</head>
<body>

<!-- Top -->
<div class="top">
  <div class="brand">
    <!-- logo + team name stacked to avoid pushing nav -->
    <div class="logo-wrap" aria-hidden="false">
      <img src="Logo.webp" alt="GM"/>
      <div class="team-name"><strong>Golden</strong> <span style="display:block;color:var(--lime);font-weight:800">Moms</span></div>
    </div>
  </div>

  <div style="display:flex;align-items:center;gap:12px">
    <div class="nav" role="tablist" aria-label="Navegaci√≥n">
      <!-- Usamos enlaces hash para que sean linkables/compartibles -->
      <a class="tab" href="#/dash" data-view="dash">Dashboard</a>
      <a class="tab" href="#/events" data-view="events">Eventos</a>
      <a class="tab active" href="#/roster" data-view="roster">Plantel</a>
      <a class="tab" href="#/matches" data-view="matches">Partidos</a>
    </div>
  </div>
</div>

<div class="container">

  <!-- VIEWS: cada section tiene id v-{view} -->
  <!-- DASH -->
  <section id="v-dash" style="display:none">
    <div class="card">
      <h4>Dashboard</h4>
      <div class="section-note">Resumen r√°pido</div>

      <!-- KPIs din√°micos -->
      <div id="dashboardContent">
        <div class="kpi-row">
          <div class="kpi"><div class="num" id="kpiPlayers">‚Äî</div><div class="label">Jugadoras</div></div>
          <div class="kpi"><div class="num" id="kpiEvents">‚Äî</div><div class="label">Eventos pr√≥ximos</div></div>
          <div class="kpi"><div class="num" id="kpiMatches">‚Äî</div><div class="label">Partidos pr√≥ximos</div></div>
        </div>
        <div id="dashboardNotes" style="margin-top:12px;color:var(--mut);font-size:13px"></div>
      </div>

    </div>
  </section>

  <!-- EVENTS -->
  <section id="v-events" style="display:none">
    <div class="card">
      <h4>Eventos</h4>
      <div class="section-note">Calendario y pr√≥ximos eventos</div>
      <div id="eventsList" style="margin-top:12px">Cargando eventos...</div>
    </div>
  </section>

  <!-- ROSTER / PLANTEL -->
  <section id="v-roster">
    <div class="card">
      <h4>Plantel</h4>
      <div class="section-note">Listado del plantel (ordenado por apodo). Haz clic en una jugadora para ver/editar su ficha.</div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div class="note">Puedes agregar o editar jugadoras (guardado en Supabase si est√° configurado).</div>
        <div>
          <button id="btnAddPlayer" class="btn s">Agregar jugadora</button>
        </div>
      </div>

      <div id="rosterGrid" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- MATCHES placeholder -->
  <section id="v-matches" style="display:none">
    <div class="card">
      <h4>Partidos</h4>
      <div class="section-note">Calendario de partidos</div>
      <div id="matchesList" style="margin-top:12px">Cargando partidos...</div>
    </div>
  </section>

</div>

<footer style="text-align:center;padding:16px;color:var(--mut);font-size:var(--content-size)">Golden Moms ¬∑ hecho con üíö lima & azul</footer>

<!-- Player modal (igual que antes) -->
<div class="modal-bg" id="playerModalBg" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true" id="playerModal">
    <h3 id="playerModalTitle">Ficha de jugadora</h3>
    <div style="display:flex;gap:12px;flex-direction:column">
      <div class="player-form-row" style="margin-bottom:10px">
        <div class="player-photo-preview" id="playerPhotoPreview" style="width:120px;height:120px;border-radius:8px;overflow:hidden;background:#f7f9fb;border:1px dashed var(--b);display:flex;align-items:center;justify-content:center"></div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <label>Foto (URL)</label>
          <input id="p_foto" class="input" placeholder="https://.../foto.jpg">
          <label>N√∫mero camiseta</label>
          <input id="p_numero" class="input" placeholder="Ej: 9">
          <label>Rol</label>
          <input id="p_rol" class="input" placeholder="Ej: Delantera">
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Nombre completo</label>
          <input id="p_nombre" class="input" placeholder="Nombre real">
        </div>
        <div>
          <label>Apodo</label>
          <input id="p_apodo" class="input" placeholder="Apodo (orden) ‚Äî p.ej. Dani">
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Fecha de nacimiento</label>
          <input id="p_nacimiento" type="date" class="input">
        </div>
        <div>
          <label>Tel√©fono emergencia</label>
          <input id="p_emergencia" class="input" placeholder="+56 9 ...">
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Seguro m√©dico</label>
          <input id="p_seguro" class="input" placeholder="Nombre del seguro">
        </div>
        <div>
          <label>Equipos (selecciona 1 o m√°s)</label>
          <div class="teams-list" id="teamsList" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        </div>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="btnDeletePlayer" class="btn s" style="display:none">Eliminar</button>
        <button id="btnClosePlayer" class="btn s">Cerrar</button>
        <button id="btnSavePlayer" class="btn p">Guardar</button>
      </div>

    </div>
  </div>
</div>

<script>
/* ---------- Routing por hash: lee y aplica view desde #/view ---------- */
function getHashView(){
  const h = (location.hash || '#/roster').replace(/^#\/?/, '');
  return h || 'roster';
}
function setActiveTabForView(view){
  document.querySelectorAll('.nav .tab').forEach(el=>{
    const v = el.dataset.view || (el.getAttribute('href') || '').replace(/^#\/?/, '');
    if(v === view || (v === '' && view==='dash')) el.classList.add('active'); else el.classList.remove('active');
  });
}

/* loadedViews evita recargar la vista si ya se carg√≥ una vez */
const loadedViews = {};

function showView(view){
  const allowed = ['dash','events','roster','matches'];
  if(!allowed.includes(view)) view = 'roster';
  allowed.forEach(v=>{
    const sec = document.getElementById('v-'+v);
    if(sec) sec.style.display = (v === view) ? 'block' : 'none';
  });
  setActiveTabForView(view);

  // cargar datos espec√≠ficos la primera vez que se muestra la vista
  if(!loadedViews[view]){
    loadedViews[view] = true;
    if(view === 'events') loadEvents();
    if(view === 'dash') loadDashboard();
    if(view === 'matches') loadMatches();
    if(view === 'roster') {
      // actualiza roster
      fetchPlayers().then(renderRoster);
    }
  }
}

/* Cuando el hash cambia, actualizamos vista */
window.addEventListener('hashchange', ()=> {
  const view = getHashView();
  showView(view);
});

/* Inicializamos la vista segun hash (o por defecto) */
document.addEventListener('DOMContentLoaded', ()=> {
  const initial = getHashView();
  if(!location.hash) location.replace('#/roster');
  showView(initial);

  // --- arranque app normal (supabase + roster) ---
  initSupabase().then(()=> {
    renderTeamsList([]);
    // s√≥lo renderizamos roster ahora; las dem√°s vistas se cargar√°n al mostrarse
    fetchPlayers().then(renderRoster);
  });
});

/* Tambi√©n hacemos que los clicks en tabs cambien el hash (por si usas botones en vez de <a>) */
document.querySelectorAll('.nav .tab').forEach(el=>{
  el.addEventListener('click', (e)=>{
    const href = el.getAttribute('href');
    const view = el.dataset.view || (href ? href.replace(/^#\/?/, '') : null);
    if(view){
      if(location.hash !== '#/'+view) {
        location.hash = '#/'+view;
      } else {
        showView(view);
      }
    }
  });
});

/* ---------- Supabase config (igual que antes) ---------- */
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};
let supa = null;
async function initSupabase(timeoutMs = 8000){
  try{
    if(typeof createClient === 'function'){ supa = createClient(SUPA.url, SUPA.key); return supa; }
    if(window.supabase && typeof window.supabase.createClient === 'function'){ supa = window.supabase.createClient(SUPA.url, SUPA.key); return supa; }
    await new Promise((resolve,reject)=>{
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js';
      s.async = true;
      let done=false;
      const to=setTimeout(()=>{ if(!done){ done=true; reject(new Error('timeout cargando supabase')); }}, timeoutMs);
      s.onload=()=>{ if(done) return; done=true; clearTimeout(to); resolve(); };
      s.onerror=()=>{ if(done) return; done=true; clearTimeout(to); reject(new Error('error cargando supabase')); };
      document.head.appendChild(s);
    });
    if(typeof createClient === 'function'){ supa = createClient(SUPA.url, SUPA.key); return supa; }
    if(window.supabase && typeof window.supabase.createClient === 'function'){ supa = window.supabase.createClient(SUPA.url, SUPA.key); return supa; }
    throw new Error('SDK cargado pero no se encontr√≥ createClient');
  }catch(err){ console.warn('initSupabase error:', err); supa = null; return null; }
}

/* ---------- Helpers + minimal roster code (adaptado) ---------- */
function pad(n){return n.toString().padStart(2,'0');}
function localDateYMD(d){ const D=new Date(d); return `${D.getFullYear()}-${pad(D.getMonth()+1)}-${pad(D.getDate())}`; }
function niceDate(d){ if(!d) return ''; const D=new Date(d); return D.toLocaleDateString(); }
function escapeHtml(str){ if(!str && str!==0) return ''; return String(str).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function parseTeamsField(v){
  if(!v) return [];
  if(Array.isArray(v)) return v;
  if(typeof v === 'string'){
    try{ const parsed = JSON.parse(v); if(Array.isArray(parsed)) return parsed; }catch(e){}
    return v.split(',').map(s=>s.trim()).filter(Boolean);
  }
  return [];
}
function avatarUrlOrPlaceholder(url, name){
  if(url) return url;
  const initials = (name||'').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase() || 'G';
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect width='100%' height='100%' fill='#f1f5f9'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='48' fill='#64748b'>${escapeHtml(initials)}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

/* roster DOM refs */
const rosterGrid = document.getElementById('rosterGrid');
const btnAddPlayer = document.getElementById('btnAddPlayer');
const playerModalBg = document.getElementById('playerModalBg');
const playerPhotoPreview = document.getElementById('playerPhotoPreview');
const p_foto = document.getElementById('p_foto');
const p_numero = document.getElementById('p_numero');
const p_rol = document.getElementById('p_rol');
const p_nombre = document.getElementById('p_nombre');
const p_apodo = document.getElementById('p_apodo');
const p_nacimiento = document.getElementById('p_nacimiento');
const p_emergencia = document.getElementById('p_emergencia');
const p_seguro = document.getElementById('p_seguro');
const teamsListContainer = document.getElementById('teamsList');
const btnSavePlayer = document.getElementById('btnSavePlayer');
const btnClosePlayer = document.getElementById('btnClosePlayer');
const btnDeletePlayer = document.getElementById('btnDeletePlayer');
const playerModalTitle = document.getElementById('playerModalTitle');

const TEAM_OPTIONS = ["Golden Moms","Golden Power","Golden Dream"];
let localPlayersCache = [];
let currentEditingPlayer = null;

function renderTeamsList(selected = []){
  teamsListContainer.innerHTML = '';
  for(const t of TEAM_OPTIONS){
    const chip = document.createElement('label');
    chip.className = 'team-chip';
    chip.style.padding = '6px 8px';
    chip.style.borderRadius = '999px';
    chip.style.border = '1px solid var(--b)';
    chip.style.background = selected.includes(t) ? '#eaffd6' : '#fff';
    chip.style.cursor = 'pointer';
    chip.style.fontSize = '12px';
    chip.style.display = 'inline-flex';
    chip.style.alignItems = 'center';
    chip.style.gap = '6px';

    const input = document.createElement('input');
    input.type = 'checkbox';
    input.value = t;
    input.checked = selected.includes(t);
    input.style.display = 'none';
    input.onchange = ()=> { chip.style.background = input.checked ? '#eaffd6' : '#fff'; };

    const span = document.createElement('span'); span.textContent = t;
    chip.appendChild(input);
    chip.appendChild(span);
    chip.addEventListener('click', ()=> { input.checked = !input.checked; input.onchange(); });

    teamsListContainer.appendChild(chip);
  }
}

function getSelectedTeamsFromUI(){
  return Array.from(teamsListContainer.querySelectorAll('input[type=checkbox]')).filter(i=>i.checked).map(i=>i.value);
}

async function fetchPlayers(){
  if(supa){
    try{
      const { data, error } = await supa.from('players').select('*').order('apodo',{ascending:true});
      if(error) { console.warn('Supabase players error', error); return localPlayersCache; }
      const norm = (data || []).map(p => ({ ...p, equipos: parseTeamsField(p.equipos || p.teams || p.equipo) }));
      localPlayersCache = norm;
      return norm;
    }catch(err){ console.warn('fetch players err', err); return localPlayersCache; }
  } else {
    return localPlayersCache;
  }
}

function renderRoster(players){
  rosterGrid.innerHTML = '';
  const sorted = (players || []).slice().sort((a,b)=> (a.apodo||'').toLowerCase().localeCompare((b.apodo||'').toLowerCase()));
  for(const p of sorted){
    const card = document.createElement('div');
    card.className = 'player-card';
    card.setAttribute('data-id', p.id || '');

    const avatarWrap = document.createElement('div'); avatarWrap.className = 'player-avatar';
    const img = document.createElement('img');
    img.src = avatarUrlOrPlaceholder(p.foto || p.photo || '', p.apodo || p.nombre);
    img.alt = p.apodo || p.nombre || 'Jugador';
    avatarWrap.appendChild(img);

    const apodoEl = document.createElement('div'); apodoEl.className='player-apodo'; apodoEl.textContent = p.apodo || (p.nombre||'').split(' ')[0] || 'Sin apodo';
    const nombreEl = document.createElement('div'); nombreEl.className='player-nombre'; nombreEl.textContent = p.nombre || '';

    card.appendChild(avatarWrap);
    card.appendChild(apodoEl);
    card.appendChild(nombreEl);

    card.onclick = ()=> openPlayerModal(p);

    rosterGrid.appendChild(card);
  }
}

/* Player modal */
function setPhotoPreview(url){
  playerPhotoPreview.innerHTML = '';
  const img = document.createElement('img');
  img.src = avatarUrlOrPlaceholder(url, p_apodo.value || p_nombre.value);
  img.style.width = '100%';
  img.style.height = '100%';
  img.style.objectFit = 'cover';
  playerPhotoPreview.appendChild(img);
}

function openPlayerModal(player=null){
  currentEditingPlayer = player ? {...player} : null;
  playerModalTitle.textContent = player ? `Ficha ‚Äî ${player.apodo || player.nombre || ''}` : 'Agregar jugadora';
  btnDeletePlayer.style.display = player && player.id ? '' : 'none';

  p_foto.value = player?.foto || player?.photo || '';
  p_numero.value = player?.numero || player?.number || '';
  p_rol.value = player?.rol || '';
  p_nombre.value = player?.nombre || '';
  p_apodo.value = player?.apodo || '';
  p_nacimiento.value = player?.fecha_nacimiento ? localDateYMD(player.fecha_nacimiento) : (player?.birthdate ? localDateYMD(player.birthdate) : '');
  p_emergencia.value = player?.telefono_emergencia || player?.emergencia || '';
  p_seguro.value = player?.seguro_medico || player?.seguro || '';

  setPhotoPreview(p_foto.value || '');
  renderTeamsList(parseTeamsField(player?.equipos || player?.teams || player?.equipo));
  playerModalBg.style.display = 'flex';
}

function closePlayerModal(){ playerModalBg.style.display = 'none'; currentEditingPlayer = null; }

document.getElementById('btnClosePlayer').addEventListener('click', ()=> closePlayerModal());
playerModalBg.addEventListener('click',(e)=>{ if(e.target===playerModalBg) closePlayerModal(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closePlayerModal(); });

p_foto.addEventListener('input', ()=> setPhotoPreview(p_foto.value || ''));

/* Save player (local fallback or supabase) */
document.getElementById('btnSavePlayer').addEventListener('click', async ()=>{ 
  const payload = {
    nombre: p_nombre.value.trim(),
    apodo: p_apodo.value.trim(),
    numero: p_numero.value.trim(),
    fecha_nacimiento: p_nacimiento.value || null,
    telefono_emergencia: p_emergencia.value.trim(),
    seguro_medico: p_seguro.value.trim(),
    foto: p_foto.value.trim(),
    rol: p_rol.value.trim(),
    equipos: getSelectedTeamsFromUI()
  };
  if(!payload.nombre || !payload.apodo){ alert('Completa Nombre y Apodo'); return; }

  if(supa && currentEditingPlayer && currentEditingPlayer.id){
    try{
      const { error } = await supa.from('players').update(payload).eq('id', currentEditingPlayer.id);
      if(error) throw error;
      const fresh = await fetchPlayers();
      renderRoster(fresh);
      closePlayerModal();
      return;
    }catch(err){ console.warn(err); alert('Error guardando. Revisa consola.'); return; }
  } else if(supa && (!currentEditingPlayer || !currentEditingPlayer.id)){
    try{
      const { data, error } = await supa.from('players').insert([payload]).select();
      if(error) throw error;
      const fresh = await fetchPlayers();
      renderRoster(fresh);
      closePlayerModal();
      return;
    }catch(err){ console.warn(err); alert('Error guardando. Revisa consola.'); return; }
  } else {
    // local fallback
    if(currentEditingPlayer && currentEditingPlayer.id){
      localPlayersCache = localPlayersCache.map(p => p.id === currentEditingPlayer.id ? {...p, ...payload} : p);
    } else {
      const nid = 'local-' + Date.now();
      localPlayersCache.push({ id: nid, ...payload });
    }
    renderRoster(localPlayersCache);
    closePlayerModal();
  }
});

/* delete */
document.getElementById('btnDeletePlayer').addEventListener('click', async ()=>{ 
  if(!currentEditingPlayer || !currentEditingPlayer.id) return;
  if(!confirm('Eliminar jugadora?')) return;
  if(supa){
    try{
      const { error } = await supa.from('players').delete().eq('id', currentEditingPlayer.id);
      if(error) throw error;
      const fresh = await fetchPlayers();
      renderRoster(fresh);
      closePlayerModal();
      return;
    }catch(err){ console.warn(err); alert('Error eliminando. Revisa consola.'); return; }
  } else {
    localPlayersCache = localPlayersCache.filter(p=>p.id !== currentEditingPlayer.id);
    renderRoster(localPlayersCache);
    closePlayerModal();
  }
});

/* add new */
btnAddPlayer.addEventListener('click', ()=> openPlayerModal(null));

/* ---------- VISTAS: carga din√°mica para dash/events/matches ---------- */
async function loadDashboard(){
  const players = await fetchPlayers();
  const playersCount = players ? players.length : 0;
  const kpiPlayersEl = document.getElementById('kpiPlayers');
  const kpiEventsEl = document.getElementById('kpiEvents');
  const kpiMatchesEl = document.getElementById('kpiMatches');
  const notes = document.getElementById('dashboardNotes');

  kpiPlayersEl.textContent = playersCount;

  // eventos (proximos 30 d√≠as) -> fallback local
  let upcomingEvents = [];
  if(supa){
    try{
      const thirty = new Date(); thirty.setDate(thirty.getDate() - 1);
      const { data, error } = await supa.from('events').select('*').order('date',{ascending:true}).limit(10);
      if(!error && data) upcomingEvents = data;
    }catch(e){ console.warn('loadDashboard events err', e); }
  }
  kpiEventsEl.textContent = upcomingEvents.length;

  // matches proximos -> fallback supabase
  let upcomingMatches = [];
  if(supa){
    try{
      const { data, error } = await supa.from('matches').select('*').order('date',{ascending:true}).limit(10);
      if(!error && data) upcomingMatches = data;
    }catch(e){ console.warn('loadDashboard matches err', e); }
  }
  kpiMatchesEl.textContent = upcomingMatches.length;

  notes.innerHTML = `√öltima actualizaci√≥n: ${new Date().toLocaleString()}.`;
}

async function loadEvents(){
  const el = document.getElementById('eventsList');
  if(!el) return;
  el.innerHTML = 'Cargando eventos...';

  if(supa){
    try{
      const { data, error } = await supa.from('events').select('*').order('date',{ascending:true}).limit(50);
      if(error) throw error;
      if(!data || data.length===0){ el.innerHTML = '<div>No hay eventos registrados.</div>'; return; }

      el.innerHTML = '<ul style="margin:0;padding-left:18px">' + data.map(ev=>{
        const title = escapeHtml(ev.title || ev.nombre || 'Sin t√≠tulo');
        const date = niceDate(ev.date || ev.fecha || '');
        const note = ev.note ? ` ‚Äî ${escapeHtml(ev.note)}` : '';
        return `<li style="margin-bottom:8px"><strong>${title}</strong> ‚Äî <span style="color:var(--mut)">${date}</span>${note}</li>`;
      }).join('') + '</ul>';
    }catch(err){
      console.warn(err);
      el.innerHTML = '<div>Error cargando eventos. Revisa consola.</div>';
    }
  } else {
    el.innerHTML = '<div>Modo local: no hay conexi√≥n a Supabase. Configura Supabase o agrega eventos manualmente.</div>';
  }
}

async function loadMatches(){
  const el = document.getElementById('matchesList');
  if(!el) return;
  el.innerHTML = 'Cargando partidos...';
  if(supa){
    try{
      const { data, error } = await supa.from('matches').select('*').order('date',{ascending:true}).limit(50);
      if(error) throw error;
      if(!data || data.length===0){ el.innerHTML = '<div>No hay partidos registrados.</div>'; return; }

      el.innerHTML = '<ul style="margin:0;padding-left:18px">' + data.map(m=>{
        const date = niceDate(m.date || m.fecha || '');
        const vs = escapeHtml(m.opponent || m.rival || m.vs || '‚Äî');
        const loc = m.location ? ` ‚Äî ${escapeHtml(m.location)}` : '';
        return `<li style="margin-bottom:8px"><strong>${date}</strong> ‚Äî ${vs}${loc}</li>`;
      }).join('') + '</ul>';
    }catch(err){
      console.warn(err);
      el.innerHTML = '<div>Error cargando partidos. Revisa consola.</div>';
    }
  } else {
    el.innerHTML = '<div>Modo local: no hay conexi√≥n a Supabase. Configura Supabase o agrega partidos manualmente.</div>';
  }
}

/* ---------- init: seed local players if no supabase ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  if(localPlayersCache.length===0){
    localPlayersCache = [
      { id:'local-1', nombre:'Alejandra Vasquez', apodo:'Ale V', numero:'11', fecha_nacimiento:'1990-10-09', equipos:['Golden Moms'], rol:'Delantera', seguro_medico:'Isapre ABC', telefono_emergencia:'+56 9 1234 5678', foto:'' },
      { id:'local-2', nombre:'Andre Perez', apodo:'Andre', numero:'7', fecha_nacimiento:'1992-05-22', equipos:['Golden Moms','Golden Power'], rol:'Mediocampista', seguro_medico:'Isapre XYZ', telefono_emergencia:'+56 9 8765 4321', foto:'' },
      { id:'local-3', nombre:'Antonella S', apodo:'Antonella', numero:'3', fecha_nacimiento:'1988-12-01', equipos:['Golden Moms','Golden Dream'], rol:'Defensa', seguro_medico:'Fonasa', telefono_emergencia:'+56 9 5555 6666', foto:'' },
      { id:'local-4', nombre:'Camila R', apodo:'Cami', numero:'10', fecha_nacimiento:'1991-07-14', equipos:['Golden Moms'], rol:'Portera', seguro_medico:'Isapre ABC', telefono_emergencia:'+56 9 4444 3333', foto:'' }
    ];
  }
});
</script>
</body>
</html>
