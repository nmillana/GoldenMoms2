<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms — Panel (Plantel mejorado)</title>
<link rel="icon" href="Logo.webp"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{
  --blue:#0f3a78; --lime:#9be22d; --ink:#0f172a; --mut:#64748b;
  --b:#e2e8f0; --bg:#f7f8fa;
  --lime-strong:#7fd410; --blue-strong:#0a2a58;
  --title-size:12px; --content-size:10px; --sub-size:8px; --kpi-number-size:22px;

  --day-bold-size: 16px;
  --day-bold-size-mobile: 14px;

  --week-sep-height: 8px;
  --week-sep-color: #000;
  --today-border-color: #ff3b3b;
  --month-grid-gap: 18px;
  --month-list-gap: 12px;
}

/* base */
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:inherit;text-decoration:none}

/* Buttons */
.btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer;font-size:var(--content-size)}
.btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
.btn.s{background:#f8fafc}

/* Top bar */
.top{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px;overflow:visible}
.brand{display:flex;gap:10px;align-items:center}
.brand img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)}
.brand div{font-size:var(--content-size)}
.nav{display:flex;gap:8px;flex-wrap:nowrap;align-items:center;overflow-x:auto;padding-bottom:4px}
.nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer;white-space:nowrap;font-size:var(--content-size)}
.nav .tab.active{background:var(--blue);color:#fff}

/* Layout */
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 20px #0000000a;padding:12px; overflow:visible}
.card h4{margin:0 0 8px;font-size:14px;font-weight:700}
.kpi h3{margin:0;color:var(--mut);font-size:var(--sub-size)}
.kpi .n{font-size:var(--kpi-number-size);font-weight:800}
.section-note{font-size:var(--sub-size);color:var(--mut);margin-top:8px;border-left:3px solid #e6edf7;padding-left:8px}

/* Calendar (kept from previous version) */
.month-bar{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
.month-title{font-weight:800;font-size:var(--title-size)}
.month-nav{display:flex;gap:6px}
.month-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap: var(--month-grid-gap);
  grid-auto-rows:minmax(90px,auto);
}
.month-grid .week-sep{
  grid-column: 1 / -1;
  height: var(--week-sep-height);
  background: var(--week-sep-color);
  border-radius: 4px;
  margin: 10px 0;
  z-index:0;
}
.weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:var(--month-grid-gap);margin-bottom:8px}
.weekdays div{font-weight:700;color:var(--blue);text-align:center;font-size:var(--content-size)}
.day{min-height:90px;background:#fff;border:1px solid var(--b);border-radius:12px;padding:12px;position:relative;display:flex;flex-direction:column;gap:6px; z-index:0}
.day-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.day-num-box{background:#f1f5f9;border-radius:8px;padding:6px 8px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;min-width:48px;line-height:1;}
.day-num-box .day-wk-grid{font-size:10px;text-transform:lowercase;color:var(--mut)}
.day-num-box .day-n{font-weight:800;color:var(--mut);font-size: var(--day-bold-size);}
/* today */
.day.today{border: 3px solid var(--today-border-color);border-radius:12px;}
.day-add{position:absolute;top:10px;right:10px;width:36px;height:36px;border-radius:999px;border:1px solid var(--b);background:#eef4ff;color:var(--blue);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;line-height:1;box-shadow: 0 4px 8px #00000011;z-index:3;}
.ev{border-radius:10px;padding:8px;border:1px solid #0001;cursor:pointer;line-height:1.2;word-break:break-word;font-size:var(--content-size)}
.ev.ev-train{background:var(--lime-strong);color:#0c3200;border-color:#8ed400}
.ev.ev-match{background:#dce9ff;color:var(--blue-strong);border-color:#b9d0ff}
.month-list{display:none;flex-direction:column;gap:var(--month-list-gap)}
.month-list .day{display:flex;flex-direction:row;align-items:flex-start;gap:8px;padding:8px;min-height:auto;position:relative}
.day-date{min-width:52px;border-radius:8px;background:#f1f5f9;padding:6px 8px;text-align:center;font-weight:700;color:var(--mut);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;line-height:1;font-size:var(--day-bold-size)}
.day-date .day-wk{ font-size: calc(var(--day-bold-size) - 6px); text-transform:lowercase; color:var(--mut); }
.day-date .day-num{ font-size: calc(var(--day-bold-size)); font-weight:800; color:var(--mut); }
.month-list .day.today{ border-color: var(--today-border-color); }
.no-birth { font-size: var(--content-size); color: var(--mut); }

/* Modal styles (for events + player modal) */
.modal-bg{position:fixed;inset:0;background:#0006;display:none;z-index:1200;justify-content:center;align-items:flex-start;padding-top:6vh;overflow-y:auto;-webkit-overflow-scrolling:touch}
.modal{width: min(880px, calc(100% - 24px));margin: 0 auto;background:#fff;border:1px solid var(--b);border-radius:14px;padding:16px;box-shadow:0 20px 40px #00000022;max-height:90vh; overflow:auto; box-sizing:border-box;}
.modal h3{margin:0 0 10px;font-size:16px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:800px){.form-row{grid-template-columns:1fr}}
.input, select, textarea{width:100%;padding:10px;border:1px solid var(--b);border-radius:10px;background:#fff;font-size:var(--content-size)}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

/* ================= ROSTER: tarjetas + modal ================= */
#rosterGrid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap:12px;
}
.player-card{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  padding:12px;
  border-radius:10px;
  border:1px solid var(--b);
  background:#fff;
  cursor:pointer;
  transition:transform .12s ease, box-shadow .12s ease;
}
.player-card:hover{ transform: translateY(-4px); box-shadow: 0 12px 24px #00000010; }
.player-avatar{
  width:84px;height:84px;border-radius:50%;overflow:hidden;border:3px solid #fff;box-shadow:0 6px 18px #00000008;display:flex;align-items:center;justify-content:center;background:#f1f5f9;
}
.player-avatar img{width:100%;height:100%;object-fit:cover}
.player-apodo{font-weight:800;color:var(--blue);font-size:14px}
.player-nombre{font-size:12px;color:var(--mut)}

/* Player modal specific */
.player-form-row{display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:center}
.player-photo-preview{width:120px;height:120px;border-radius:8px;overflow:hidden;background:#f7f9fb;border:1px dashed var(--b);display:flex;align-items:center;justify-content:center}
.player-photo-preview img{width:100%;height:100%;object-fit:cover}

/* teams checkboxes */
.teams-list{display:flex;flex-wrap:wrap;gap:8px}
.team-chip{padding:6px 8px;border-radius:999px;border:1px solid var(--b);background:#fff;font-size:12px;cursor:pointer}
.team-chip input{display:none}

/* small helpers */
.small-muted{font-size:12px;color:var(--mut)}
.note{font-size:12px;color:var(--mut);margin-top:8px}

/* responsive */
@media (max-width:600px){
  .player-form-row{grid-template-columns:1fr}
  .player-photo-preview{width:100%;height:160px}
}

/* footer */
footer{font-size:var(--content-size);color:var(--mut);text-align:center;padding:16px}
</style>
</head>
<body>

<!-- Top -->
<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM"/>
    <div><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <div class="nav" role="tablist" aria-label="Navegación">
      <button class="tab" data-view="dash">Dashboard</button>
      <button class="tab" data-view="events">Eventos</button>
      <button class="tab active" data-view="roster">Plantel</button>
      <button class="tab" data-view="matches">Partidos</button>
    </div>
  </div>
</div>

<div class="container">

  <!-- DASHBOARD (kept minimal for this example) -->
  <section id="v-dash" style="display:none">
    <div class="grid" style="align-items:stretch">
      <div class="card kpi" style="grid-column:span 6;display:flex;flex-direction:column;justify-content:space-between">
        <div>
          <h4>Plantel</h4>
          <div class="n" id="kRoster">0</div>
          <div style="font-size:var(--sub-size);color:var(--mut)">Integrantes registrados</div>
        </div>
      </div>
      <div class="card kpi" style="grid-column:span 6;display:flex;flex-direction:column;justify-content:space-between">
        <div>
          <h4>Partidos jugados</h4>
          <div class="n" id="kGames">0</div>
          <div id="lastMatchSummary" style="font-size:var(--content-size);color:var(--mut)"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- EVENTOS (kept for compatibility; display false by default) -->
  <section id="v-events" style="display:none">
    <div class="card">
      <div class="month-bar">
        <div class="month-nav">
          <button class="btn s" id="btnPrevMonth">◀</button>
          <button class="btn s" id="btnToday">Hoy</button>
          <button class="btn s" id="btnNextMonth">▶</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="month-title" id="monthTitle">Mes</div>
          <button class="btn p" id="btnNewEventTop">Nuevo Evento</button>
        </div>
      </div>
      <div class="section-note">El calendario muestra eventos agrupados por <strong>fecha local</strong> (YYYY-MM-DD).</div>
      <div class="weekdays">
        <div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div>
      </div>
      <div id="monthGrid" class="month-grid"></div>
      <div id="monthList" class="month-list"></div>
    </div>
  </section>

  <!-- ROSTER / PLANTEL -->
  <section id="v-roster">
    <div class="card">
      <h4>Plantel</h4>
      <div class="section-note">Listado del plantel (ordenado por apodo). Haz clic en una jugadora para ver/editar su ficha.</div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div class="note">Puedes agregar o editar jugadoras (guardado en Supabase si está configurado).</div>
        <div>
          <button id="btnAddPlayer" class="btn s">Agregar jugadora</button>
        </div>
      </div>

      <div id="rosterGrid" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- PARTIDOS -->
  <section id="v-matches" style="display:none">
    <div class="card">
      <h4>Partidos jugados</h4>
      <div class="section-note">Registro de partidos y resultados.</div>
      <div id="matchesList" style="margin-top:12px"></div>
    </div>
  </section>
</div>

<footer style="text-align:center;padding:16px;color:var(--mut);font-size:var(--content-size)">Golden Moms · hecho con 💚 lima & azul</footer>

<!-- Player modal -->
<div class="modal-bg" id="playerModalBg" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true" id="playerModal">
    <h3 id="playerModalTitle">Ficha de jugadora</h3>

    <div style="display:flex;gap:12px;flex-direction:column">
      <div class="player-form-row" style="margin-bottom:10px">
        <div class="player-photo-preview" id="playerPhotoPreview">
          <!-- preview img -->
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <label>Foto (URL)</label>
          <input id="p_foto" class="input" placeholder="https://.../foto.jpg">
          <label>Número camiseta</label>
          <input id="p_numero" class="input" placeholder="Ej: 9">
          <label>Rol</label>
          <input id="p_rol" class="input" placeholder="Ej: Delantera">
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Nombre completo</label>
          <input id="p_nombre" class="input" placeholder="Nombre real">
        </div>
        <div>
          <label>Apodo</label>
          <input id="p_apodo" class="input" placeholder="Apodo (orden) — p.ej. Dani">
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Fecha de nacimiento</label>
          <input id="p_nacimiento" type="date" class="input">
        </div>
        <div>
          <label>Teléfono emergencia</label>
          <input id="p_emergencia" class="input" placeholder="+56 9 ...">
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Seguro médico</label>
          <input id="p_seguro" class="input" placeholder="Nombre del seguro">
        </div>
        <div>
          <label>Equipos (selecciona 1 o más)</label>
          <div class="teams-list" id="teamsList">
            <!-- chips inserted by JS -->
          </div>
        </div>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="btnDeletePlayer" class="btn s" style="display:none">Eliminar</button>
        <button id="btnClosePlayer" class="btn s">Cerrar</button>
        <button id="btnSavePlayer" class="btn p">Guardar</button>
      </div>

    </div>
  </div>
</div>

<script>
/* ---------- Supabase config ---------- */
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};
let supa = null;
async function initSupabase(timeoutMs = 8000){
  try{
    if(typeof createClient === 'function'){ supa = createClient(SUPA.url, SUPA.key); return supa; }
    if(window.supabase && typeof window.supabase.createClient === 'function'){ supa = window.supabase.createClient(SUPA.url, SUPA.key); return supa; }
    await new Promise((resolve,reject)=>{
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js';
      s.async = true;
      let done=false;
      const to=setTimeout(()=>{ if(!done){ done=true; reject(new Error('timeout cargando supabase')); }}, timeoutMs);
      s.onload=()=>{ if(done) return; done=true; clearTimeout(to); resolve(); };
      s.onerror=()=>{ if(done) return; done=true; clearTimeout(to); reject(new Error('error cargando supabase')); };
      document.head.appendChild(s);
    });
    if(typeof createClient === 'function'){ supa = createClient(SUPA.url, SUPA.key); return supa; }
    if(window.supabase && typeof window.supabase.createClient === 'function'){ supa = window.supabase.createClient(SUPA.url, SUPA.key); return supa; }
    throw new Error('SDK cargado pero no se encontró createClient');
  }catch(err){ console.warn('initSupabase error:', err); supa = null; return null; }
}

/* ---------- Helpers ---------- */
function escapeHtml(str){ if(!str && str!==0) return ''; return String(str).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function pad(n){return n.toString().padStart(2,'0');}
function localDateYMD(d){ const D=new Date(d); return `${D.getFullYear()}-${pad(D.getMonth()+1)}-${pad(D.getDate())}`; }
function parseTeamsField(v){
  if(!v) return [];
  if(Array.isArray(v)) return v;
  if(typeof v === 'string'){
    try{
      const parsed = JSON.parse(v);
      if(Array.isArray(parsed)) return parsed;
    }catch(e){}
    // fallback split by comma
    return v.split(',').map(s=>s.trim()).filter(Boolean);
  }
  return [];
}

/* ---------- roster DOM refs ---------- */
const rosterGrid = document.getElementById('rosterGrid');
const kRoster = document.getElementById('kRoster');

/* Player modal refs */
const playerModalBg = document.getElementById('playerModalBg');
const playerModal = document.getElementById('playerModal');
const playerModalTitle = document.getElementById('playerModalTitle');
const p_foto = document.getElementById('p_foto');
const p_numero = document.getElementById('p_numero');
const p_rol = document.getElementById('p_rol');
const p_nombre = document.getElementById('p_nombre');
const p_apodo = document.getElementById('p_apodo');
const p_nacimiento = document.getElementById('p_nacimiento');
const p_emergencia = document.getElementById('p_emergencia');
const p_seguro = document.getElementById('p_seguro');
const teamsListContainer = document.getElementById('teamsList');
const playerPhotoPreview = document.getElementById('playerPhotoPreview');
const btnSavePlayer = document.getElementById('btnSavePlayer');
const btnClosePlayer = document.getElementById('btnClosePlayer');
const btnAddPlayer = document.getElementById('btnAddPlayer');
const btnDeletePlayer = document.getElementById('btnDeletePlayer');

let currentEditingPlayer = null; // object or null

// team options requested
const TEAM_OPTIONS = ["Golden Moms","Golden Power","Golden Dream"];

/* in-memory fallback store if supabase not available */
let localPlayersCache = [];

/* ---------- roster rendering & CRUD ---------- */
async function fetchPlayers(){
  if(supa){
    try{
      const { data, error } = await supa.from('players').select('*').order('apodo',{ascending:true});
      if(error){ console.warn('Supabase players error:', error); return localPlayersCache; }
      // normalize teams field
      const norm = (data || []).map(p => ({
        ...p,
        equipos: parseTeamsField(p.equipos || p.teams || p.equipo) // try multiple possible field names
      }));
      // keep a local cache copy
      localPlayersCache = norm;
      return norm;
    }catch(err){
      console.warn('fetchPlayers supa error', err);
      return localPlayersCache;
    }
  } else {
    return localPlayersCache;
  }
}

function avatarUrlOrPlaceholder(url, name){
  if(url) return url;
  // fallback generate simple initials placeholder as data URL (SVG)
  const initials = (name||'').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase() || 'G';
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect width='100%' height='100%' fill='#f1f5f9'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='48' fill='#64748b'>${escapeHtml(initials)}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

function renderRoster(players){
  rosterGrid.innerHTML = '';
  const sorted = (players || []).slice().sort((a,b)=>{
    const A = (a.apodo||'').toString().toLowerCase();
    const B = (b.apodo||'').toString().toLowerCase();
    return A.localeCompare(B);
  });
  kRoster.textContent = sorted.length;
  for(const p of sorted){
    const card = document.createElement('div');
    card.className = 'player-card';
    card.setAttribute('data-id', p.id || '');
    const avatar = document.createElement('div');
    avatar.className = 'player-avatar';
    const img = document.createElement('img');
    img.alt = p.apodo || p.nombre || 'Jugador';
    img.src = avatarUrlOrPlaceholder(p.foto || p.photo || p.avatar, p.apodo || p.nombre);
    avatar.appendChild(img);

    const apodoEl = document.createElement('div'); apodoEl.className='player-apodo'; apodoEl.textContent = p.apodo || (p.nombre||'').split(' ')[0] || 'Sin apodo';
    const nombreEl = document.createElement('div'); nombreEl.className='player-nombre'; nombreEl.textContent = p.nombre || '';

    card.appendChild(avatar);
    card.appendChild(apodoEl);
    card.appendChild(nombreEl);

    card.onclick = ()=> openPlayerModal(p);

    rosterGrid.appendChild(card);
  }
}

/* ---------- Player modal logic ---------- */
function openPlayerModal(player = null){
  currentEditingPlayer = player ? {...player} : null;
  playerModalTitle.textContent = player ? `Ficha — ${player.apodo || player.nombre || ''}` : 'Agregar jugadora';
  btnDeletePlayer.style.display = player && player.id ? '' : 'none';

  // fill fields (fallbacks)
  p_foto.value = player?.foto || player?.photo || player?.avatar || '';
  p_numero.value = player?.numero || player?.numero_camiseta || player?.number || '';
  p_rol.value = player?.rol || '';
  p_nombre.value = player?.nombre || '';
  p_apodo.value = player?.apodo || '';
  p_nacimiento.value = player?.fecha_nacimiento ? localDateYMD(player.fecha_nacimiento) : (player?.birthdate ? localDateYMD(player.birthdate) : '');
  p_emergencia.value = player?.telefono_emergencia || player?.emergencia || player?.telefono || '';
  p_seguro.value = player?.seguro_medico || player?.seguro || '';

  // photo preview
  setPhotoPreview(p_foto.value || '');

  // teams checkboxes
  const existingTeams = parseTeamsField(player?.equipos || player?.teams || player?.equipo);
  renderTeamsList(existingTeams);

  playerModalBg.style.display = 'flex';
  playerModalBg.setAttribute('aria-hidden','false');
}

function closePlayerModal(){
  playerModalBg.style.display = 'none';
  playerModalBg.setAttribute('aria-hidden','true');
  currentEditingPlayer = null;
}

btnClosePlayer.addEventListener('click', ()=> closePlayerModal());
playerModalBg.addEventListener('click',(e)=>{ if(e.target===playerModalBg) closePlayerModal(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closePlayerModal(); });

function setPhotoPreview(url){
  playerPhotoPreview.innerHTML = '';
  const img = document.createElement('img');
  img.src = avatarUrlOrPlaceholder(url, p_apodo.value || p_nombre.value);
  playerPhotoPreview.appendChild(img);
}

/* teams UI */
function renderTeamsList(selected = []){
  teamsListContainer.innerHTML = '';
  for(const t of TEAM_OPTIONS){
    const chip = document.createElement('label');
    chip.className = 'team-chip';
    chip.setAttribute('data-team', t);
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.value = t;
    input.checked = selected.includes(t);
    input.onchange = ()=> { /* visual done by :checked? but we update style manually */ updateTeamChipsVisual(); };
    chip.appendChild(input);
    const span = document.createElement('span');
    span.textContent = t;
    chip.appendChild(span);
    teamsListContainer.appendChild(chip);
  }
  updateTeamChipsVisual();
}
function updateTeamChipsVisual(){
  Array.from(teamsListContainer.querySelectorAll('.team-chip')).forEach(chip=>{
    const cb = chip.querySelector('input[type=checkbox]');
    if(cb && cb.checked){
      chip.style.background = '#eaffd6';
      chip.style.borderColor = '#c7f07a';
      chip.style.color = '#08300b';
    } else {
      chip.style.background = '#fff';
      chip.style.borderColor = 'var(--b)';
      chip.style.color = 'inherit';
    }
  });
}
function getSelectedTeamsFromUI(){
  return Array.from(teamsListContainer.querySelectorAll('input[type=checkbox]')).filter(i=>i.checked).map(i=>i.value);
}

/* Save player (insert or update) */
btnSavePlayer.addEventListener('click', async ()=>{
  const payload = {
    nombre: p_nombre.value.trim(),
    apodo: p_apodo.value.trim(),
    numero: p_numero.value.trim(),
    fecha_nacimiento: p_nacimiento.value || null,
    telefono_emergencia: p_emergencia.value.trim(),
    seguro_medico: p_seguro.value.trim(),
    foto: p_foto.value.trim(),
    rol: p_rol.value.trim(),
    equipos: getSelectedTeamsFromUI()
  };

  // basic validation
  if(!payload.apodo || !payload.nombre){ alert('Completa al menos Nombre y Apodo'); return; }

  if(supa && currentEditingPlayer && currentEditingPlayer.id){
    try{
      const { error } = await supa.from('players').update(payload).eq('id', currentEditingPlayer.id);
      if(error) throw error;
      // refresh
      await refreshAndRenderRoster();
      closePlayerModal();
      return;
    }catch(err){ console.warn('Error updating player', err); alert('Error guardando en Supabase. Revisa consola.'); return; }
  } else if(supa && (!currentEditingPlayer || !currentEditingPlayer.id)){
    // insert new record
    try{
      const { data, error } = await supa.from('players').insert([payload]).select();
      if(error) throw error;
      await refreshAndRenderRoster();
      closePlayerModal();
      return;
    }catch(err){ console.warn('Error inserting player', err); alert('Error guardando en Supabase. Revisa consola.'); return; }
  } else {
    // fallback local (in-memory)
    if(currentEditingPlayer && currentEditingPlayer.id){
      // update local cache by id
      localPlayersCache = localPlayersCache.map(p => p.id === currentEditingPlayer.id ? {...p, ...payload} : p);
    } else {
      // create synthetic id
      const newId = 'local-' + Date.now();
      localPlayersCache.push({ id: newId, ...payload });
    }
    renderRoster(localPlayersCache);
    closePlayerModal();
  }
});

/* Delete player */
btnDeletePlayer.addEventListener('click', async ()=>{
  if(!currentEditingPlayer || !currentEditingPlayer.id) return;
  if(!confirm('Eliminar jugadora?')) return;
  if(supa){
    try{
      const { error } = await supa.from('players').delete().eq('id', currentEditingPlayer.id);
      if(error) throw error;
      await refreshAndRenderRoster();
      closePlayerModal();
      return;
    }catch(err){ console.warn('Error deleting', err); alert('Error eliminando en Supabase. Revisa consola.'); return; }
  } else {
    localPlayersCache = localPlayersCache.filter(p => p.id !== currentEditingPlayer.id);
    renderRoster(localPlayersCache);
    closePlayerModal();
  }
});

/* Add player button */
btnAddPlayer.addEventListener('click', ()=>{
  openPlayerModal(null);
});

/* photo input change updates preview */
p_foto.addEventListener('change', ()=> setPhotoPreview(p_foto.value));

/* ---------- refresh helper ---------- */
async function refreshAndRenderRoster(){
  const players = await fetchPlayers();
  renderRoster(players);
}

/* ---------- init & initial sample data ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  await initSupabase();

  // If supabase not available, seed local demo data so UI is usable
  if(!supa && localPlayersCache.length===0){
    localPlayersCache = [
      { id:'local-1', nombre:'Daniela Cifuentes', apodo:'Dani C', numero:'11', fecha_nacimiento:'1990-10-09', equipos:['Golden Moms'], rol:'Delantera', seguro_medico:'Isapre ABC', telefono_emergencia:'+56 9 1234 5678', foto:'' },
      { id:'local-2', nombre:'Valentina Pérez', apodo:'Vale', numero:'7', fecha_nacimiento:'1992-05-22', equipos:['Golden Moms','Golden Power'], rol:'Mediocampista', seguro_medico:'Isapre XYZ', telefono_emergencia:'+56 9 8765 4321', foto:'' },
      { id:'local-3', nombre:'María López', apodo:'Majo', numero:'3', fecha_nacimiento:'1988-12-01', equipos:['Golden Moms','Golden Dream'], rol:'Defensa', seguro_medico:'Fonasa', telefono_emergencia:'+56 9 5555 6666', foto:'' }
    ];
  }

  // wire nav tabs (persist current view)
  function persistView(view){ try{ localStorage.setItem('gm_view', view); }catch(e){} }
  function getPersistedView(){ try{ return localStorage.getItem('gm_view'); }catch(e){ return null; } }
  document.querySelectorAll('.nav .tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const view = btn.dataset.view;
      persistView(view);
      showView(view);
    });
  });

  // show the roster by default (user wanted to start at dashboard previously, but here user is in Plantel)
  const persisted = getPersistedView();
  const initialView = persisted || 'roster';
  document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
  const btnToActivate = document.querySelector(`.nav .tab[data-view="${initialView}"]`);
  if(btnToActivate) btnToActivate.classList.add('active');
  showView(initialView);

  // render teams list template (so modal uses these options)
  renderTeamsList([]);

  // initial fetch+render
  await refreshAndRenderRoster();
});

/* showView: toggles sections and triggers their data render */
async function showView(v){
  ['dash','events','roster','matches'].forEach(id=>{
    const el = document.getElementById('v-'+id);
    if(el) el.style.display='none';
  });
  const target = document.getElementById('v-'+v) || document.getElementById('v-matches');
  if(target) target.style.display='block';

  if(v === 'roster'){
    // ensure roster fresh
    await refreshAndRenderRoster();
  }
  if(v === 'events'){
    // leave existing events implementation if present
    // (not reimplemented here)
  }
  if(v === 'matches'){
    // not modified in this step
  }
}

/* expose a quick function to update photo preview when apodo/name changes */
p_apodo.addEventListener('input', ()=> setPhotoPreview(p_foto.value || p_apodo.value));
p_nombre.addEventListener('input', ()=> setPhotoPreview(p_foto.value || p_nombre.value));
</script>
</body>
</html>
