<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms ‚Äî Panel</title>
<link rel="icon" href="Logo.webp"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{
  --blue:#0f3a78;--lime:#9be22d;--ink:#0f172a;--mut:#64748b;
  --b:#e2e8f0;--bg:#f7f8fa;--ok:#d9f99d;--mid:#fef9c3;--no:#fee2e2;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:inherit}
.btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer}
.btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
.btn.s{background:#f8fafc}
.badge{font-size:11px;border:1px solid var(--b);border-radius:999px;padding:2px 8px;background:#f8fafc}
.top{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.brand{display:flex;gap:10px;align-items:center}
.brand img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
.nav .tab.active{background:var(--blue);color:#fff}
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 20px #0000000a;padding:12px}
.kpi h3{margin:0;color:var(--mut);font-size:14px}.kpi .n{font-size:22px;font-weight:800}
/* Calendario */
.filters-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
.cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;position:sticky;top:114px;z-index:5;background:#fff;padding:6px 0;border-bottom:1px solid var(--b)}
.cal-head>div{text-align:center;font-weight:700;color:#0f3a78}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.cal-cell{min-height:140px;background:#fff;border:1px solid var(--b);border-radius:12px;padding:8px;overflow:hidden}
.cal-time{font-size:12px;font-weight:700;color:#0f3a78}
.tag{font-size:10px;border:1px solid #0001;border-radius:999px;padding:2px 6px;display:inline-block;margin-bottom:4px}
.match{background:#e0edff;border-color:#b7d1ff;color:#0f3a78}
.train{background:#e9fbd0;border-color:#c6f28a;color:#2d5a00}
.team{font-size:10px;background:#eaf7d7;border:1px solid #c8ef7a;border-radius:999px;padding:1px 6px;margin-left:6px;font-weight:700}
/* Footer */
footer{margin-top:40px;text-align:center;padding:16px;color:var(--mut);font-size:14px}
/* Responsive */
@media (max-width: 900px){
  .grid{grid-template-columns:1fr}
  .cal-head{top:154px}
}
</style>
</head>
<body>

<!-- Top -->
<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM"/>
    <div><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div class="nav">
    <button class="tab active" data-view="dash">Dashboard</button>
    <button class="tab" data-view="events">Eventos</button>
    <button class="tab" data-view="roster">Plantel</button>
    <button class="tab" data-view="track">Seguimiento</button>
  </div>
</div>

<div class="container">
  <!-- DASHBOARD -->
  <section id="v-dash">
    <div class="grid">
      <div class="card kpi" style="grid-column:span 4"><h3>Pr√≥ximos eventos</h3><div class="n" id="kEvents">0</div></div>
      <div class="card kpi" style="grid-column:span 4"><h3>Plantel</h3><div class="n" id="kRoster">0</div></div>
      <div class="card kpi" style="grid-column:span 4"><h3>Partidos jugados</h3><div class="n" id="kGames">0</div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <strong>üéÇ Pr√≥ximos cumplea√±os</strong>
      <ul id="upBirth" style="margin:8px 0 0 16px"></ul>
    </div>

    <div class="card" style="margin-top:12px">
      <strong>üìÖ Hoy</strong>
      <ul id="todayEvents" style="margin:8px 0 0 16px"></ul>
    </div>

    <div class="card" style="margin-top:12px">
      <strong>üìÖ Eventos de la semana</strong>
      <ul id="weekEvents" style="margin:8px 0 0 16px"></ul>
    </div>
  </section>

  <!-- EVENTOS -->
  <section id="v-events" style="display:none">
    <div class="card">
      <div class="filters-row">
        <button class="btn p" id="btnNewEvent">Nuevo Evento</button>
      </div>
      <div class="cal-head"><div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div></div>
      <div id="calGrid" class="cal-grid"></div>
    </div>
  </section>

  <!-- PLANTEL -->
  <section id="v-roster" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Plantel</strong>
        <button id="btnAddPlayer" class="btn s">Agregar jugadora</button>
      </div>
      <div id="rosterGrid" class="grid"></div>
    </div>
  </section>

  <!-- SEGUIMIENTO -->
  <section id="v-track" style="display:none">
    <div class="card">
      <strong>Seguimiento de partidos</strong>
      <div id="trackList"></div>
    </div>
  </section>
</div>

<footer>Golden Moms ¬∑ hecho con üíö lima & azul</footer>

<script>
/* ========= SUPABASE ========= */
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};
const supa = supabase.createClient(SUPA.url, SUPA.key);

/* ========= Helpers de fecha/hora (America/Santiago) ========= */
const CL_TZ = 'America/Santiago';
const fmt = (d, opts={}) => new Intl.DateTimeFormat('es-CL', { timeZone: CL_TZ, ...opts }).format(d);
const parseToLocal = (iso) => new Date(iso); // supabase entrega ISO; mostramos con TZ CL v√≠a Intl

function startOfWeek(d){
  // semana Lunes-Domingo
  const x = new Date(d);
  const day = (x.getDay()+6)%7; // 0=Lun
  x.setHours(0,0,0,0);
  x.setDate(x.getDate()-day);
  return x;
}
function endOfWeek(d){
  const s = startOfWeek(d);
  const e = new Date(s);
  e.setDate(s.getDate()+7);
  return e;
}
function isSameLocalDay(a,b){
  return fmt(a,{year:'numeric',month:'2-digit',day:'2-digit'}) === fmt(b,{year:'numeric',month:'2-digit',day:'2-digit'});
}

/* ========= Navegaci√≥n ========= */
document.querySelectorAll('.nav .tab').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    showView(btn.dataset.view);
  };
});
function showView(v){
  ['dash','events','roster','track'].forEach(id=>document.getElementById('v-'+id).style.display='none');
  document.getElementById('v-'+v).style.display='block';
  if(v==='dash') renderDash();
  if(v==='events') renderEvents();
  if(v==='roster') renderRoster();
  if(v==='track') renderTrack();
}

/* ========= Eventos (lista simple existente) ========= */
async function renderEvents(){
  const {data}=await supa.from("events").select("*").order("datetime",{ascending:true});
  const grid=document.getElementById('calGrid'); grid.innerHTML="";
  (data||[]).forEach(e=>{
    const d=parseToLocal(e.datetime);
    const c=document.createElement("div"); c.className="cal-cell";
    c.innerHTML=`
      <div class="tag ${e.type=='Partido'?'match':'train'}">${e.type}</div>
      <div class="cal-time">${fmt(d,{weekday:'short', hour:'2-digit', minute:'2-digit'})}</div>
      <div><strong>${e.title}</strong> <span class="team">${e.team||''}</span></div>
      <div>üìç ${e.location||""}</div>`;
    grid.appendChild(c);
  });
}

/* ========= Plantel ========= */
async function renderRoster(){
  const {data}=await supa.from("players").select("*");
  const grid=document.getElementById('rosterGrid'); grid.innerHTML="";
  (data||[]).forEach(p=>{
    const c=document.createElement("div"); c.className="card";
    c.innerHTML=`<strong>${p.nombre}</strong><br/>${p.apodo||""}<br/><span>${p.posicion||""}</span>`;
    grid.appendChild(c);
  });
}

/* ========= Seguimiento ========= */
async function renderTrack(){
  const {data}=await supa.from("matches").select("*").order("datetime",{ascending:false});
  const wrap=document.getElementById("trackList"); wrap.innerHTML="";
  (data||[]).forEach(m=>{
    const d=parseToLocal(m.datetime);
    const div=document.createElement("div"); div.className="card";
    div.innerHTML=`<strong>${m.title}</strong><br/>
      ${fmt(d,{weekday:'short',day:'2-digit',month:'short'})}<br/>
      Goleadora: ${m.Goleadora||"-"}`;
    wrap.appendChild(div);
  });
}

/* ========= Crear Evento ========= */
document.getElementById("btnNewEvent").onclick = async () => {
  const title = prompt("T√≠tulo del evento:");
  const datetime = prompt("Fecha y hora (YYYY-MM-DD HH:MM):");
  const type = prompt("Tipo (Entrenamiento o Partido):");
  const team = prompt("Equipo:");
  const location = prompt("Ubicaci√≥n:");
  if(!title || !datetime) return alert("Faltan datos");
  const { error } = await supa.from("events").insert([{ title, datetime, type, team, location }]);
  if(error){ alert("‚ùå Error al guardar: " + error.message); }
  else { alert("‚úÖ Evento guardado"); renderEvents(); renderDash(); }
};

/* ========= Dashboard ========= */
async function renderDash(){
  // Trae TODO pr√≥ximo (desde ahora en adelante)
  const now = new Date();
  const {data:events}=await supa.from("events").select("*").gte("datetime", now.toISOString()).order("datetime",{ascending:true});
  const {data:players}=await supa.from("players").select("*");

  // KPIs
  document.getElementById('kEvents').textContent=events?.length||0;
  document.getElementById('kRoster').textContent=players?.length||0;
  document.getElementById('kGames').textContent=(events||[]).filter(e=>e.type==='Partido' && parseToLocal(e.datetime) < now).length;

  // üéÇ Pr√≥ximos cumplea√±os (usa tu vista si la tienes; si no, filtra por mes actual)
  const list=document.getElementById('upBirth'); list.innerHTML="";
  try{
    // Si existe la vista:
    const { data: bdays, error: bErr } = await supa.from("vw_upcoming_birthdays").select("*").order("proximo_cumple",{ascending:true}).limit(5);
    if(!bErr && bdays && bdays.length){
      bdays.forEach(p=>{
        if(p.proximo_cumple){
          const d=parseToLocal(p.proximo_cumple);
          list.innerHTML += `<li>${p.apodo || p.nombre} ‚Äî ${fmt(d,{day:"2-digit",month:"short"})}</li>`;
        }
      });
    } else {
      // Fallback por si no tienes la vista:
      (players||[]).forEach(p=>{
        if(!p.fecha_nacimiento) return;
        const d=new Date(p.fecha_nacimiento);
        const isSameMonth = (d.getMonth()=== now.getMonth());
        if(isSameMonth && d.getDate()>= now.getDate()){
          list.innerHTML += `<li>${p.apodo || p.nombre} ‚Äî ${fmt(d,{day:"2-digit",month:"short"})}</li>`;
        }
      });
    }
  }catch(err){
    console.error(err);
  }

  // üìÖ Hoy
  const todayUl = document.getElementById('todayEvents'); todayUl.innerHTML='';
  const todayList = (events||[]).filter(e=> isSameLocalDay(parseToLocal(e.datetime), now));
  todayList.forEach(e=>{
    const d=parseToLocal(e.datetime);
    todayUl.innerHTML += `<li><strong>${e.title}</strong> ‚Äî ${fmt(d,{weekday:"short",hour:"2-digit",minute:"2-digit"})} ¬∑ ${e.location||""}</li>`;
  });

  // üìÖ Semana actual (Lun‚ÄìDom)
  const weekUl=document.getElementById('weekEvents'); weekUl.innerHTML="";
  const ws = startOfWeek(now), we = endOfWeek(now);
  (events||[]).forEach(e=>{
    const d=parseToLocal(e.datetime);
    if(d>=ws && d<we){
      weekUl.innerHTML += `<li><strong>${e.title}</strong> ‚Äî ${fmt(d,{weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"})} ¬∑ ${e.location||""}</li>`;
    }
  });
}

/* ========= Inicial ========= */
renderDash();
</script>

</body>
</html>
