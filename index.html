<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms — Panel</title>
<link rel="icon" href="Logo.webp"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{
  --blue:#0f3a78;--lime:#9be22d;--ink:#0f172a;--mut:#64748b;
  --b:#e2e8f0;--bg:#f7f8fa;--ok:#d9f99d;--mid:#fef9c3;--no:#fee2e2;
  --pill:#eef2ff; --pillb:#c7d2fe;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:inherit}
.btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer}
.btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
.btn.s{background:#f8fafc}
.badge{font-size:11px;border:1px solid var(--b);border-radius:999px;padding:2px 8px;background:#f8fafc}
.top{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.brand{display:flex;gap:10px;align-items:center}
.brand img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
.nav .tab.active{background:var(--blue);color:#fff}
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 20px #0000000a;padding:12px}
.kpi h3{margin:0;color:var(--mut);font-size:14px}.kpi .n{font-size:22px;font-weight:800}

/* ====== EVENTOS (vista mensual) ====== */
.cal-wrap{position:relative}
.cal-toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
.cal-month{font-weight:800;font-size:22px}
.cal-head{position:sticky;top:74px;z-index:30;background:var(--bg);display:grid;grid-template-columns:repeat(7,1fr);gap:10px;padding:6px 0 10px;border-bottom:1px solid var(--b)}
.cal-head>div{text-align:center;font-weight:700;color:var(--blue);font-size:14px}
.cal-month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:12px}
.cal-day{min-height:160px;background:#fff;border:1px solid var(--b);border-radius:14px;padding:10px 8px;overflow:hidden;display:flex;flex-direction:column}
.cal-day .dtop{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.dnum{font-weight:800}
.add-mini{width:28px;height:28px;border-radius:50%;border:1px solid var(--b);background:#fff;display:inline-grid;place-items:center;font-weight:800;cursor:pointer}
.ev{border:1px solid var(--pillb);background:var(--pill);border-radius:12px;padding:8px;margin-top:8px}
.ev.train{background:#effad7;border-color:#cde68d}
.ev.match{background:#e8f0ff;border-color:#c7d2fe}
.ev .t{font-weight:700;font-size:13px;color:#0f3a78}
.ev .h{font-size:12px;color:#475569}
.ev .loc{font-size:12px;margin-top:2px}
.dot{display:inline-block;width:4px;height:4px;border-radius:50%;background:#ef4444;margin-right:6px;position:relative;top:-1px}
.sticky-pad{height:6px}

/* Modal */
.modal{position:fixed;inset:0;background:#0006;display:none;align-items:center;justify-content:center;padding:14px;z-index:100}
.modal.show{display:flex}
.sheet{width:min(860px,100%);background:#fff;border-radius:16px;border:1px solid var(--b);box-shadow:0 25px 60px #00000022;overflow:hidden}
.sheet header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--b);font-weight:800}
.form{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:14px}
.form .full{grid-column:1/-1}
label{font-size:12px;color:#475569;font-weight:700;display:block;margin-bottom:4px}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--b);border-radius:10px;background:#fff}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.actions{display:flex;gap:10px;justify-content:flex-end;padding:12px;border-top:1px solid var(--b)}
.note{font-size:12px;color:#64748b}

/* Mobile */
@media (max-width:900px){
  .grid{grid-template-columns:1fr}
  .cal-head{top:114px}
}
@media (max-width:720px){
  .cal-head{top:154px}
  .form{grid-template-columns:1fr}
  .form-row{grid-template-columns:1fr}
  .sheet header{font-size:18px}
}

/* Footer */
footer{margin-top:40px;text-align:center;padding:16px;color:var(--mut);font-size:14px}
</style>
</head>
<body>

<!-- Top -->
<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM"/>
    <div><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div class="nav">
    <button class="tab active" data-view="dash">Dashboard</button>
    <button class="tab" data-view="events">Eventos</button>
    <button class="tab" data-view="roster">Plantel</button>
    <button class="tab" data-view="track">Seguimiento</button>
  </div>
</div>

<div class="container">
  <!-- DASHBOARD -->
  <section id="v-dash">
    <div class="grid">
      <div class="card kpi" style="grid-column:span 3"><h3>Próximos eventos</h3><div class="n" id="kEvents">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h3>Plantel</h3><div class="n" id="kRoster">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h3>Convocadas (próx.)</h3><div class="n" id="kOk">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h3>Partidos jugados</h3><div class="n" id="kGames">0</div></div>
    </div>
    <div class="card" style="margin-top:12px">
      <strong>🎂 Próximos cumpleaños</strong>
      <ul id="upBirth" style="margin:8px 0 0 16px"></ul>
    </div>
    <div class="card" style="margin-top:12px">
      <strong>📅 Eventos de la semana</strong>
      <ul id="weekEvents" style="margin:8px 0 0 16px"></ul>
    </div>
  </section>

  <!-- EVENTOS -->
  <section id="v-events" style="display:none">
    <div class="card cal-wrap">
      <div class="cal-toolbar">
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn s" id="btnToday">Hoy</button>
          <div class="cal-month" id="lblMonth">Mes</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn s" id="btnPrev">◀</button>
          <button class="btn s" id="btnNext">▶</button>
          <button class="btn p" id="btnNewEvent">Nuevo Evento</button>
        </div>
      </div>

      <div class="cal-head">
        <div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div>
      </div>
      <div class="sticky-pad"></div>
      <div id="monthGrid" class="cal-month-grid"></div>
    </div>
  </section>

  <!-- PLANTEL -->
  <section id="v-roster" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Plantel</strong>
        <button id="btnAddPlayer" class="btn s">Agregar jugadora</button>
      </div>
      <div id="rosterGrid" class="grid"></div>
    </div>
  </section>

  <!-- SEGUIMIENTO -->
  <section id="v-track" style="display:none">
    <div class="card">
      <strong>Seguimiento de partidos</strong>
      <div id="trackList"></div>
    </div>
  </section>
</div>

<footer>Golden Moms · hecho con 💚 lima & azul</footer>

<!-- MODAL CREAR/EDITAR -->
<div class="modal" id="evModal">
  <div class="sheet">
    <header>
      <span id="evTitle">Nuevo evento</span>
      <button class="btn s" id="evClose">✕</button>
    </header>
    <div class="form">
      <div class="full">
        <label>Título</label>
        <input id="f_title" placeholder="Ej: Entrenamiento Colegio">
      </div>

      <div>
        <label>Fecha y hora</label>
        <input id="f_datetime" type="datetime-local">
      </div>
      <div>
        <label>Tipo</label>
        <select id="f_type">
          <option>Entrenamiento</option>
          <option>Partido</option>
        </select>
      </div>

      <div>
        <label>Equipo</label>
        <input id="f_team" value="Golden Moms">
      </div>
      <div>
        <label>Rival (si aplica)</label>
        <input id="f_opponent" placeholder="Rivales / Liga">
      </div>

      <div>
        <label>Uniforme</label>
        <select id="f_uniform">
          <option>(definir)</option>
          <option>Polera azul</option>
          <option>Polera verde lima</option>
        </select>
        <div class="note">* Siempre medias verde lima</div>
      </div>
      <div>
        <label>Ubicación</label>
        <input id="f_location" placeholder="Colegio / Cancha / Dirección">
      </div>
    </div>
    <div class="actions">
      <button class="btn s" id="evCancel">Cancelar</button>
      <button class="btn p" id="evSave">Guardar</button>
    </div>
  </div>
</div>

<script>
/* ========= SUPABASE ========= */
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};
const supa = supabase.createClient(SUPA.url, SUPA.key);

/* ========= Navegación ========= */
document.querySelectorAll('.nav .tab').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    showView(btn.dataset.view);
  };
});
function showView(v){
  ['dash','events','roster','track'].forEach(id=>document.getElementById('v-'+id).style.display='none');
  document.getElementById('v-'+v).style.display='block';
  if(v==='dash') renderDash();
  if(v==='events') renderMonth();
  if(v==='roster') renderRoster();
  if(v==='track') renderTrack();
}

/* ========= Util: fechas ========= */
/* Corrige horas: interpreta timestamptz de Supabase como fecha/hora LOCAL (Chile)
   ignorando el offset si viene con +00:00, para evitar corrimientos visuales. */
const parseSupaLocal = (iso) => {
  if(!iso) return null;
  const clean = iso.split(/[Z+]/)[0]; // quita Z o +00:00
  const [d,t] = clean.split('T');
  const [y,m,da] = d.split('-').map(Number);
  const [hh,mm] = (t||'00:00').split(':').map(Number);
  return new Date(y, (m-1), da, hh, mm);
};
const fmtCL = (d, opts={}) =>
  d.toLocaleString('es-CL', { timeZone: 'America/Santiago', ...opts });

/* ========= Dashboard ========= */
async function renderDash(){
  const {data:events}=await supa.from("events").select("*").gte("datetime", new Date().toISOString());
  const {data:players}=await supa.from("players").select("*");

  document.getElementById('kEvents').textContent=events?.length||0;
  document.getElementById('kRoster').textContent=players?.length||0;
  document.getElementById('kOk').textContent=0;
  document.getElementById('kGames').textContent=0;

  // 🎂 Próximos cumpleaños (usando vista que ya tienes)
  try{
    const { data: birthdays } = await supa
      .from("vw_upcoming_birthdays")
      .select("*")
      .order("proximo_cumple", { ascending: true })
      .limit(5);
    const list=document.getElementById('upBirth'); list.innerHTML="";
    (birthdays||[]).forEach(p=>{
      if(p.proximo_cumple){
        const bd=parseSupaLocal(p.proximo_cumple);
        list.innerHTML += `<li>${p.apodo||p.nombre} — ${fmtCL(bd,{day:'2-digit',month:'short'})}</li>`;
      }
    });
  }catch{}

  // 📅 Eventos de la semana (vista)
  try{
    const { data: weekEvents } = await supa
      .from("vw_events_this_week")
      .select("*")
      .order("datetime", { ascending: true });
    const ul=document.getElementById('weekEvents'); ul.innerHTML="";
    (weekEvents||[]).forEach(e=>{
      const d=parseSupaLocal(e.datetime);
      ul.innerHTML += `<li><strong>${e.title}</strong> — ${fmtCL(d,{weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"})}</li>`;
    });
  }catch(e){
    document.getElementById('weekEvents').innerHTML="<li>Error al cargar eventos</li>";
  }
}

/* ========= Plantel & Seguimiento (sin cambios de lógica) ========= */
async function renderRoster(){
  const {data}=await supa.from("players").select("*");
  const grid=document.getElementById('rosterGrid'); grid.innerHTML="";
  (data||[]).forEach(p=>{
    const c=document.createElement("div"); c.className="card";
    c.innerHTML=`<strong>${p.nombre}</strong><br/>${p.apodo||""}<br/><span>${p.posicion||""}</span>`;
    grid.appendChild(c);
  });
}
async function renderTrack(){
  const {data}=await supa.from("matches").select("*").order("datetime",{ascending:false});
  const wrap=document.getElementById("trackList"); wrap.innerHTML="";
  (data||[]).forEach(m=>{
    const d=parseSupaLocal(m.datetime);
    const div=document.createElement("div"); div.className="card";
    div.innerHTML=`<strong>${m.title}</strong><br/>
      ${fmtCL(d,{weekday:'short',day:'2-digit',month:'short'})}<br/>
      Goleadora: ${m.Goleadora||"-"}`;
    wrap.appendChild(div);
  });
}

/* ========= EVENTOS Mensual ========= */
let cur = new Date(); // mes actual
let cacheEvents = [];

const monthLabel = (d)=> fmtCL(d,{month:'long', year:'numeric'});

const mondayIndex = d => (d+6)%7; // transforma Domingo=0 a Lunes=0

const monthBounds = (dt)=>{
  const y = dt.getFullYear(), m = dt.getMonth();
  const first = new Date(y,m,1);
  const last = new Date(y,m+1,0);
  const start = new Date(first); start.setDate(first.getDate() - mondayIndex(first.getDay()));
  const end = new Date(last); end.setDate(last.getDate() + (6 - mondayIndex(last.getDay())));
  return {start, end};
};

async function loadMonthData(){
  const {start,end} = monthBounds(cur);
  const { data } = await supa
    .from("events")
    .select("*")
    .gte("datetime", start.toISOString())
    .lte("datetime", end.toISOString())
    .order("datetime", { ascending: true });
  cacheEvents = (data||[]).map(e => ({...e, _dt: parseSupaLocal(e.datetime)}));
}

function renderMonthGrid(){
  document.getElementById('lblMonth').textContent = monthLabel(cur);
  const {start,end} = monthBounds(cur);
  const grid=document.getElementById('monthGrid'); grid.innerHTML="";
  const day = new Date(start);

  while(day <= end){
    const cell=document.createElement('div'); cell.className='cal-day';
    const dnum = day.getDate();
    const isCurMonth = day.getMonth()===cur.getMonth();
    cell.style.opacity = isCurMonth ? 1 : 0.45;

    const top = document.createElement('div'); top.className='dtop';
    top.innerHTML = `<div class="dnum">${dnum}</div>`;
    const add = document.createElement('button');
    add.className='add-mini'; add.textContent='+';
    add.onclick=()=> openModal({ datetime: new Date(day), title:'', type:'Entrenamiento', team:'Golden Moms', location:'', opponent:'', uniform:'(definir)' });
    top.appendChild(add);
    cell.appendChild(top);

    // eventos del día
    const todays = cacheEvents.filter(ev => ev._dt.toDateString() === day.toDateString());
    todays.forEach(ev=>{
      const wrap=document.createElement('div');
      wrap.className='ev ' + (ev.type==='Partido'?'match':'train');
      const hour = fmtCL(ev._dt,{hour:'2-digit',minute:'2-digit'});
      wrap.innerHTML = `
        <div class="h">${hour} — <span class="t">${ev.title}</span></div>
        <div style="font-size:12px">${ev.team}${ev.opponent?` <span style="color:#64748b">- vs ${ev.opponent}</span>`:''}</div>
        <div class="loc"><span class="dot"></span>${ev.location||''}</div>
      `;
      wrap.onclick=()=> openModal(ev);
      cell.appendChild(wrap);
    });

    grid.appendChild(cell);
    day.setDate(day.getDate()+1);
  }
}

async function renderMonth(){
  await loadMonthData();
  renderMonthGrid();
}

/* Toolbar */
document.getElementById('btnPrev').onclick = async ()=>{ cur.setMonth(cur.getMonth()-1); await renderMonth(); };
document.getElementById('btnNext').onclick = async ()=>{ cur.setMonth(cur.getMonth()+1); await renderMonth(); };
document.getElementById('btnToday').onclick = async ()=>{ cur = new Date(); await renderMonth(); };

/* Botón principal crear */
document.getElementById('btnNewEvent').onclick = ()=> openModal({
  datetime: new Date(),
  title:'', type:'Entrenamiento', team:'Golden Moms', location:'', opponent:'', uniform:'(definir)'
});

/* ========= Modal ========= */
const modal = document.getElementById('evModal');
const closeModal = ()=> modal.classList.remove('show');
document.getElementById('evClose').onclick = closeModal;
document.getElementById('evCancel').onclick = closeModal;

let editingId = null;

function fillForm(ev){
  document.getElementById('evTitle').textContent = editingId ? 'Editar evento' : 'Nuevo evento';
  document.getElementById('f_title').value = ev.title||'';
  document.getElementById('f_type').value = ev.type||'Entrenamiento';
  document.getElementById('f_team').value = ev.team||'Golden Moms';
  document.getElementById('f_opponent').value = ev.opponent||'';
  document.getElementById('f_uniform').value = ev.uniform||'(definir)';
  document.getElementById('f_location').value = ev.location||'';
  // datetime-local (YYYY-MM-DDTHH:MM)
  const d = parseSupaLocal(ev.datetime||ev._dt||new Date());
  const iso = new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
  document.getElementById('f_datetime').value = iso;
}

function openModal(ev){
  editingId = ev.id || null;
  fillForm(ev);
  modal.classList.add('show');
}

async function saveEvent(){
  const t = document.getElementById('f_title').value.trim();
  const dtLocal = new Date(document.getElementById('f_datetime').value);
  const type = document.getElementById('f_type').value;
  const team = document.getElementById('f_team').value.trim();
  const opponent = document.getElementById('f_opponent').value.trim();
  const uniform = document.getElementById('f_uniform').value;
  const location = document.getElementById('f_location').value.trim();

  if(!t || !dtLocal) return alert('Completa título y fecha/hora');

  // Guardamos en UTC correcto:
  const isoUTC = new Date(dtLocal.getTime()-dtLocal.getTimezoneOffset()*60000).toISOString();

  if(editingId){
    const {error} = await supa.from('events').update({
      title:t, datetime: isoUTC, type, team, opponent, uniform, location
    }).eq('id', editingId);
    if(error) return alert('❌ ' + error.message);
  }else{
    const {error} = await supa.from('events').insert([{
      title:t, datetime: isoUTC, type, team, opponent, uniform, location
    }]);
    if(error) return alert('❌ ' + error.message);
  }
  closeModal();
  await renderMonth();
}
document.getElementById('evSave').onclick = saveEvent;

/* ========= Inicial ========= */
renderDash(); // cae en dashboard por defecto
</script>
</body>
</html>
