<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Golden Moms ‚Äî Panel</title>
<link rel="icon" href="Logo.webp">
<style>
:root{
  --blue:#0f3a78;--lime:#9BE22D;--ink:#0f172a;--mut:#64748b;--bg:#f7f8fa;--b:#e2e8f0;--ok:#16a34a;--mid:#f59e0b;--no:#ef4444
}
*{box-sizing:border-box} html,body{margin:0;height:100%}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
a{color:inherit}
.top{position:sticky;top:0;z-index:5;display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 14px;background:#fff;border-bottom:1px solid var(--b)}
.brand{display:flex;gap:10px;align-items:center}
.brand img{width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid var(--blue)}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.tab{border:1px solid var(--b);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
.tab.active{background:var(--blue);color:#fff}
.right{display:flex;gap:8px;align-items:center}
.btn{border:1px solid var(--b);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.p{background:var(--lime);color:#08244a;border-color:#a3e635;font-weight:800}
.btn.d{background:var(--no);color:#fff;border-color:var(--no)}
.container{max-width:1140px;margin:14px auto;padding:0 12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 20px #0000000a;padding:12px}
.kpi h4{margin:0 0 6px 0;color:#334155;font-size:14px}
.kpi .n{font-weight:800;font-size:24px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,input,textarea{width:100%;padding:10px;border:1px solid var(--b);border-radius:10px;background:#fff}
.badge{font-size:11px;border:1px solid #cbd5e1;border-radius:999px;padding:2px 6px;background:#f8fafc}
.chip{font-size:12px;border:1px solid var(--b);border-radius:999px;padding:4px 8px;background:#f8fafc;margin:2px 4px;display:inline-flex;align-items:center;gap:6px}
.chip.ok{background:#d9f99d;border-color:#bef264} .chip.mid{background:#fef9c3;border-color:#fde68a} .chip.no{background:#fee2e2;border-color:#fecaca}
.chip.team{background:#eaf7d7;border-color:#c8ef7a}
.chip.bday{background:#fff3e8;border-color:#ffd7a8}
.grid7{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cell{background:#fff;border:1px solid var(--b);min-height:110px;border-radius:12px;padding:8px;position:relative}
.day{position:absolute;right:8px;top:6px;font-size:11px;color:#94a3b8}
.tag{font-size:10px;border:1px solid #0001;border-radius:999px;padding:2px 6px;display:inline-block;margin-bottom:4px}
.match{background:#e0edff;border-color:#b7d1ff;color:#0f3a78}
.train{background:#e9fbd0;border-color:#c6f28a;color:#2d5a00}
.event{font-size:13px;margin-bottom:6px;cursor:pointer}
.modal-bg{position:fixed;inset:0;background:#0006;display:none;align-items:center;justify-content:center;padding:10px;z-index:10}
.modal{max-width:960px;width:100%;background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 20px 32px #0000002a}
.modal .hd{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--b)}
.modal .bd{padding:12px;max-height:75vh;overflow:auto}
.modal .ft{padding:12px;border-top:1px solid var(--b);display:flex;justify-content:flex-end;gap:8px}
.cols{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-8{grid-column:span 8} .col-12{grid-column:span 12}
.att-row{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--b);border-radius:10px;padding:8px;margin:6px 0;background:#fff}
@media (max-width:900px){
  .desktop-only{display:none}
  .cols{grid-template-columns:repeat(6,1fr)}
  .col-4{grid-column:span 6} .col-6{grid-column:span 6} .col-8{grid-column:span 6} .col-12{grid-column:span 6}
}
.small{font-size:12px;color:#64748b}
.hr{height:1px;background:var(--b);margin:8px 0}
</style>
</head>
<body>
  <div class="top">
    <div class="brand">
      <img src="Logo.webp" alt="GM">
      <strong>Golden <span style="color:var(--lime)">Moms</span></strong>
    </div>
    <div class="nav">
      <button class="tab active" data-tab="dash">Dashboard</button>
      <button class="tab" data-tab="events">Eventos</button>
      <button class="tab" data-tab="roster">Plantel</button>
      <button class="tab" data-tab="track">Seguimiento</button>
      <button class="tab" data-tab="cfg">Configuraci√≥n</button>
    </div>
    <div class="right">
      <span id="roleBadge" class="badge">Invitada</span>
      <button id="btnLogin" class="btn">Entrar</button>
      <button id="btnLogout" class="btn" style="display:none">Salir</button>
    </div>
  </div>

  <div class="container" id="dash">
    <div class="grid">
      <div class="card kpi" style="grid-column:span 3"><h4>Pr√≥ximos eventos</h4><div class="n" id="kEvents">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h4>Plantel</h4><div class="n" id="kRoster">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h4>Convocadas (pr√≥x.)</h4><div class="n" id="kOk">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h4>Partidos jugados</h4><div class="n" id="kPlayed">0</div></div>
    </div>
    <div class="grid" style="margin-top:12px">
      <div class="card" style="grid-column:span 7">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button class="btn" id="mPrev">&larr;</button>
            <div id="mLabel" style="min-width:200px;text-align:center;font-weight:800;color:var(--blue)"></div>
            <button class="btn" id="mNext">&rarr;</button>
          </div>
          <div class="row">
            <select id="fType"><option value="Todos">Tipo: Todos</option><option>Entrenamiento</option><option>Partido</option></select>
            <select id="fTeam"><option value="Todos">Equipo: Todos</option><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select>
            <button class="btn" id="btnCopyWeek">Copiar Semana</button>
            <button class="btn p" id="btnNewEvent">Nuevo Evento</button>
          </div>
        </div>
        <div class="grid7 desktop-only"><div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div></div>
        <div id="grid" class="grid7"></div>
      </div>
      <div class="card" style="grid-column:span 5">
        <div class="row" style="justify-content:space-between">
          <strong>Pr√≥ximos cumplea√±os</strong>
          <span class="small">üéÇ se muestran con etiqueta</span>
        </div>
        <div id="bdayList" style="margin-top:8px"></div>
        <div class="hr"></div>
        <div class="row" style="justify-content:space-between">
          <strong>Goleadoras</strong><span class="small">Top 5</span>
        </div>
        <div id="topScorers" style="margin-top:6px"></div>
      </div>
    </div>
  </div>

  <div class="container" id="events" style="display:none"></div>
  <div class="container" id="roster" style="display:none"></div>
  <div class="container" id="track" style="display:none"></div>
  <div class="container" id="cfg" style="display:none"></div>

  <!-- Generic modal -->
  <div id="modal" class="modal-bg">
    <div class="modal">
      <div class="hd"><strong id="modTitle">Modal</strong><button class="btn" id="modClose">Cerrar</button></div>
      <div class="bd" id="modBody"></div>
      <div class="ft" id="modFoot"></div>
    </div>
  </div>

<script>
/* =============== Estado y utilidades =============== */
const KEY="gm-app-v3";
let S={
  team:"Golden Moms",
  users:[ // nombre, apodo, dorsal, rol, equipos[], nacimiento (dd-mmm), id
    ["Natalia","Chica",30,"admin",["Golden Moms","Golden Dreams","Golden Power"],"20-abr","chica"], // admin
    ["Caro G","","11","capitana",["Golden Moms"],"24-jul","carog"],
    ["Fabi","","16","capitana",["Golden Moms"],"28-ago","fabi"],
    ["Dani J","","15","jugadora",["Golden Moms"],"11-ene","danij"],
    ["Vero","","8","jugadora",["Golden Dreams"],"29-ene","vero"],
    ["Ale V","","14","jugadora",["Golden Moms"],"12-nov","alev"],
    ["Cata","","7","jugadora",["Golden Moms"],"08-dic","cata"],
    ["Maca","","5","jugadora",["Golden Moms"],"25-oct","maca"],
    ["Isa","","19","jugadora",["Golden Moms"],"26-oct","isa"],
    ["Pia","","10","jugadora",["Golden Moms"],"21-oct","pia"],
    ["Vale","","6","jugadora",["Golden Moms"],"11-oct","vale"],
    ["Dani C","","4","jugadora",["Golden Moms"],"10-oct","danic"],
    ["Aurora","","9","jugadora",["Golden Moms"],"12-nov","aurora"],
    ["Male","","3","jugadora",["Golden Moms"],"10-dic","male"],
    ["Carla","","13","jugadora",["Golden Moms"],"13-dic","carla"],
    // agrega las dem√°s si deseas
  ],
  events:[],      // {id,type,title,team,datetime,location,opponent,uniform}
  att:{},         // {eventId: {userId: "Asiste|Duda|No asiste"}}
  track:[],       // {id,date,comp,vs,team,score,goles:[{id,qty}],notes}
  logged:null     // {id,name,role}
};

// Carga estado previo
try{ const kk=JSON.parse(localStorage.getItem(KEY)||"{}"); if(kk && kk.users){ S={...S,...kk}; } }catch{}
// Seed calendario recurrente si no existe
if(!S.events.length){
  function iso(d){ return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString(); }
  function nextDow(dow){const n=new Date(); const g=(dow-n.getDay()+7)%7||7;const d=new Date(n); d.setDate(n.getDate()+g);return d;}
  const tue=nextDow(2), wed=nextDow(3), thu=nextDow(4), fri=nextDow(5);
  for(let i=0;i<12;i++){
    const T=new Date(tue);T.setDate(tue.getDate()+7*i);
    const Th=new Date(thu);Th.setDate(thu.getDate()+7*i);
    const W=new Date(wed);W.setDate(wed.getDate()+7*i);
    const F=new Date(fri);F.setDate(fri.getDate()+7*i);
    S.events.push({id:crypto.randomUUID(),type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:iso(new Date(T.setHours(19,30,0,0))),location:"Colegio",opponent:"",uniform:""});
    S.events.push({id:crypto.randomUUID(),type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:iso(new Date(Th.setHours(19,30,0,0))),location:"Colegio",opponent:"",uniform:""});
    S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Wonder Mom‚Äôs Cup",team:"Golden Moms",datetime:iso(new Date(W.setHours(20,0,0,0))),location:"Universidad de los Andes",opponent:"‚Äî",uniform:""});
    S.events.push({id:crypto.randomUUID(),type:"Partido",title:"Liga LIFA",team:"Golden Moms",datetime:iso(new Date(F.setHours(20,0,0,0))),location:"Cancha Oriente, Las Condes",opponent:"‚Äî",uniform:""});
  }
}
save();

// Helpers
function save(){ localStorage.setItem(KEY, JSON.stringify(S)); }
const $ = sel => document.querySelector(sel);
function fmtMonth(d){return d.toLocaleDateString("es-CL",{month:"long",year:"numeric"})}
function pad(n){return String(n).padStart(2,"0")}
function toInput(iso){const d=new Date(iso);return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`}
function roleOf(id){ return (S.users.find(u=>u[6]==id)||[])[3]||"jugadora"; }
function nameOf(id){ return (S.users.find(u=>u[6]==id)||[])[0]||id; }
function apodoOf(id){ return (S.users.find(u=>u[6]==id)||[])[1]||""; }
function teamsOf(id){ return (S.users.find(u=>u[6]==id)||[])[4]||[]; }
function bdayOf(id){ return (S.users.find(u=>u[6]==id)||[])[5]||""; }

/* =============== Navegaci√≥n =============== */
const tabs=[...document.querySelectorAll(".tab")];
tabs.forEach(t=>t.onclick=()=>{
  tabs.forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  ["dash","events","roster","track","cfg"].forEach(id=>$("#"+id).style.display="none");
  const map={dash:"dash",events:"events",roster:"roster",track:"track",cfg:"cfg"};
  $("#"+map[t.dataset.tab]).style.display="";
  if(t.dataset.tab==="events") renderEvents();
  if(t.dataset.tab==="roster") renderRoster();
  if(t.dataset.tab==="track") renderTrack();
  if(t.dataset.tab==="cfg") renderCfg();
});

/* =============== Login =============== */
$("#btnLogin").onclick=showLogin;
$("#btnLogout").onclick=()=>{ S.logged=null; save(); hydrateSession(); };

function showLogin(){
  const options=S.users.map(u=>`<option value="${u[6]}">${u[0]}</option>`).join("");
  openModal("Entrar", `
    <div class="cols">
      <div class="col-12"><label>Jugador(a)</label><select id="lgUser">${options}</select></div>
      <div class="col-12"><label>C√≥digo de acceso</label><input id="lgCode" placeholder="golden2025"></div>
    </div>
  `, [{id:"ok",txt:"Entrar",cls:"btn p"}], ({close})=>{
    $("#ok").onclick=()=>{
      const id=$("#lgUser").value, code=$("#lgCode").value.trim();
      if(code.toLowerCase()!=="golden2025"){ alert("C√≥digo incorrecto"); return; }
      const u=S.users.find(x=>x[6]==id);
      S.logged={id,u: u[0], role:u[3]};
      save(); close(); hydrateSession();
    };
  });
}

function hydrateSession(){
  const r = S.logged?.role || "Invitada";
  $("#roleBadge").textContent = r.charAt(0).toUpperCase()+r.slice(1);
  $("#btnLogin").style.display = S.logged? "none":"";
  $("#btnLogout").style.display = S.logged? "":"none";
  renderAll();
}

/* =============== Dashboard/calendario =============== */
let view=new Date(); view.setDate(1);
$("#mPrev").onclick=()=>{view.setMonth(view.getMonth()-1); renderCal();}
$("#mNext").onclick=()=>{view.setMonth(view.getMonth()+1); renderCal();}
$("#fType").onchange=renderCal; $("#fTeam").onchange=renderCal;

function buildCells(y,m){ const first=new Date(y,m,1), start=(first.getDay()+6)%7, days=new Date(y,m+1,0).getDate(); const cells=[]; for(let i=0;i<start;i++) cells.push(null); for(let d=1;d<=days;d++) cells.push(new Date(y,m,d)); while(cells.length%7) cells.push(null); return cells; }
function renderCal(){
  $("#mLabel").textContent=fmtMonth(view);
  const y=view.getFullYear(), m=view.getMonth();
  const cells=buildCells(y,m);
  const grid=$("#grid"); grid.innerHTML="";
  const FT=$("#fType").value, TM=$("#fTeam").value;
  const ev=[...S.events].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
  cells.forEach(dd=>{
    const c=document.createElement("div"); c.className="cell";
    if(dd){ const n=document.createElement("div"); n.className="day"; n.textContent=dd.getDate(); c.appendChild(n);
      ev.filter(e=>{const d=new Date(e.datetime);return d.getFullYear()==dd.getFullYear()&&d.getMonth()==dd.getMonth()&&d.getDate()==dd.getDate();})
        .filter(e=>(FT=="Todos"||e.type==FT)&&(TM=="Todos"||e.team==TM))
        .forEach(e=>{
          const t=document.createElement("div"); t.className="tag "+(e.type=="Partido"?"match":"train"); t.textContent=e.type; c.appendChild(t);
          const r=document.createElement("div"); r.className="event"; const d=new Date(e.datetime);
          r.innerHTML=`<strong>${pad(d.getHours())}:${pad(d.getMinutes())}</strong> ${e.title} <span class="chip team">${e.team}</span>`;
          r.onclick=()=>openEvent(e.id);
          c.appendChild(r);
        });
    }
    grid.appendChild(c);
  });
  renderKPIs();
}

function renderKPIs(){
  const upcoming=[...S.events].filter(e=>new Date(e.datetime)>=new Date()).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
  $("#kEvents").textContent=upcoming.length;
  $("#kRoster").textContent=S.users.length;
  if(upcoming[0]){ const A=S.att[upcoming[0].id]||{}; $("#kOk").textContent=Object.values(A).filter(v=>v==="Asiste").length; }
  $("#kPlayed").textContent=S.track.length;
}
$("#btnCopyWeek").onclick=()=>{
  const st=new Date(); const day=(st.getDay()+6)%7; const monday=new Date(st); monday.setDate(st.getDate()-(day)); monday.setHours(0,0,0,0);
  const en=new Date(monday); en.setDate(monday.getDate()+7);
  const list=S.events.filter(e=>new Date(e.datetime)>=monday && new Date(e.datetime)<en).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime))
    .map(E=>`${new Date(E.datetime).toLocaleString('es-CL',{weekday:'short',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})} ‚Äî ${E.type}: ${E.title} (${E.team}) ${E.location?'‚Äî '+E.location:''}`).join("\n");
  navigator.clipboard.writeText(`*Semana* ${monday.toLocaleDateString('es-CL')} - ${new Date(en.getTime()-86400000).toLocaleDateString('es-CL')}\n${list}`);
  alert("Semana copiada.");
};

function renderBirthdays(){
  const box=$("#bdayList"); box.innerHTML="";
  // pr√≥ximos 30 d√≠as
  const now=new Date();
  const items=S.users.map(u=>{
    const [d,mon]=u[5].split("-"); const monIdx={"ene":0,"feb":1,"mar":2,"abr":3,"may":4,"jun":5,"jul":6,"ago":7,"sep":8,"oct":9,"nov":10,"dic":11}[mon];
    if(monIdx==null) return null;
    const dt=new Date(now.getFullYear(),monIdx,parseInt(d));
    if(dt<now) dt.setFullYear(now.getFullYear()+1);
    const diff=(dt-now)/(86400000);
    return {name:u[0], id:u[6], dt, in:diff};
  }).filter(Boolean).sort((a,b)=>a.in-b.in).slice(0,8);
  items.forEach(x=>{
    const r=document.createElement("div");
    r.className="att-row";
    r.innerHTML=`<div><span class="chip bday">üéÇ</span> <strong>${x.name}</strong></div><div class="small">${x.dt.toLocaleDateString('es-CL',{weekday:'short',day:'2-digit',month:'short'})}</div>`;
    box.appendChild(r);
  });
}

function renderTopScorers(){
  const map={}; // id -> goals
  S.track.forEach(t=>t.goles.forEach(g=>map[g.id]=(map[g.id]||0)+g.qty));
  const top=Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const box=$("#topScorers"); box.innerHTML="";
  top.forEach(([id,qty])=>{
    const r=document.createElement("div");
    r.className="att-row";
    r.innerHTML=`<div><strong>${nameOf(id)}</strong> <span class="chip">${apodoOf(id)||""}</span></div><div class="badge">${qty} gol(es)</div>`;
    box.appendChild(r);
  });
}

/* =============== Eventos (tabla alternativa) =============== */
$("#btnNewEvent").onclick=()=>editEvent();
function renderEvents(){
  // Vista simple de lista + bot√≥n nuevo (mantengo calendario principal en Dashboard)
  const c=$("#events"); c.innerHTML="";
  const head=document.createElement("div"); head.className="row"; head.style.justifyContent="space-between";
  head.innerHTML=`<strong>Lista de eventos</strong><button class="btn p" id="eNew">Nuevo Evento</button>`;
  c.appendChild(head);
  $("#eNew").onclick=()=>editEvent();
  const box=document.createElement("div"); box.className="card"; c.appendChild(box);
  const list=[...S.events].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
  list.forEach(E=>{
    const r=document.createElement("div"); r.className="att-row";
    r.innerHTML=`<div><span class="badge">${E.type}</span> <strong>${E.title}</strong> <span class="chip team">${E.team}</span><div class="small">${new Date(E.datetime).toLocaleString('es-CL')}</div></div>
      <div class="row"><button class="btn" data-id="${E.id}">Abrir</button></div>`;
    r.querySelector("button").onclick=()=>openEvent(E.id);
    box.appendChild(r);
  });
}

/* =============== Modal Evento =============== */
function openEvent(id){ const E=S.events.find(e=>e.id==id); if(!E){alert("Evento no existe"); return;}
  const role=S.logged?.role||"invitada"; const uid=S.logged?.id;
  const A=S.att[id]||{};
  const counts={ok:0,mid:0,no:0}; Object.values(A).forEach(v=>{if(v==="Asiste")counts.ok++; else if(v==="Duda")counts.mid++; else if(v==="No asiste")counts.no++;});
  const onlySelf = (role==="jugadora");
  const title=`${E.type} ‚Äî ${E.title}`;
  const body = `
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <div><span id="evTeam" class="chip team">${E.team}</span></div>
      <div class="row">
        <button class="btn" id="btnCopy">Copiar WhatsApp</button>
        <button class="btn" id="btnRSVP">Link convocatoria</button>
        <button class="btn" id="btnICS">.ics</button>
        ${role!=="jugadora"?`<button class="btn d" id="btnDel">Eliminar</button>`:""}
      </div>
    </div>
    <div class="cols">
      <div class="col-4"><label>Tipo</label><select id="eType"><option>Entrenamiento</option><option>Partido</option></select></div>
      <div class="col-8"><label>T√≠tulo</label><input id="eTitle"></div>
      <div class="col-6"><label>Fecha y hora</label><input type="datetime-local" id="eDT"></div>
      <div class="col-6"><label>Equipo</label><select id="eTeam"><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select></div>
      <div class="col-6"><label>Lugar</label><input id="eLoc"></div>
      <div class="col-6"><label>Rival</label><input id="eOpp"></div>
      <div class="col-6"><label>Uniforme</label><select id="eUni"><option value="">‚Äî</option><option>Polera azul</option><option>Polera verde lima</option></select></div>
      <div class="col-6"><label>Conteo</label>
        <div class="row"><span class="chip ok">‚úÖ ${counts.ok}</span><span class="chip mid">‚ùî ${counts.mid}</span><span class="chip no">‚ùå ${counts.no}</span></div>
      </div>
    </div>
    <div class="hr"></div>
    <div><strong>Asistencia</strong></div>
    <div id="attBox"></div>
    <div class="hr"></div>
    <div><strong>Convocatoria</strong><div class="small" id="rsvpInfo">${new Date(E.datetime).toLocaleString('es-CL')} ${E.location?("‚Äî "+E.location):""}</div></div>
  `;
  openModal(title, body, [{id:"save",txt:"Guardar",cls:"btn p"}], ({close})=>{
    // init fields
    $("#eType").value=E.type; $("#eTitle").value=E.title; $("#eDT").value=toInput(E.datetime);
    $("#eTeam").value=E.team; $("#eLoc").value=E.location||""; $("#eOpp").value=E.opponent||""; $("#eUni").value=E.uniform||"";
    if(role==="jugadora"){ ["eType","eTitle","eDT","eTeam","eLoc","eOpp","eUni"].forEach(id=>$("#"+id).disabled=true); }
    // asistencia
    const box=$("#attBox"); box.innerHTML="";
    const list = (onlySelf ? S.users.filter(u=>u[6]==uid) : S.users.filter(u=>E.team==="Todos" || u[4].includes(E.team)));
    list.forEach(u=>{
      const st=A[u[6]]||"";
      const row=document.createElement("div"); row.className="att-row";
      row.innerHTML=`<div><strong>${u[0]}</strong> ${u[1]?`<span class="badge">${u[1]}</span>`:""} ${u[5]?`<span class="chip bday">üéÇ ${u[5]}</span>`:""} ${u[4].map(t=>`<span class="chip team">${t}</span>`).join("")}</div>
      <div class="row">
        <button class="btn" data-v="Asiste">‚úÖ</button>
        <button class="btn" data-v="Duda">‚ùî</button>
        <button class="btn" data-v="No asiste">‚ùå</button>
      </div>`;
      [...row.querySelectorAll("button")].forEach(b=>b.onclick=()=>{
        const AA=S.att[id]||{}; AA[u[6]]=b.dataset.v; S.att[id]=AA; save(); openEvent(id); // re-render
      });
      if(st==="Asiste") row.style.background="#f0fbda";
      if(st==="Duda") row.style.background="#fff7d6";
      if(st==="No asiste") row.style.background="#ffe8e8";
      box.appendChild(row);
    });
    // acciones
    $("#save").onclick=()=>{ if(role==="jugadora"){ close(); return; }
      E.type=$("#eType").value; E.title=$("#eTitle").value; E.datetime=new Date($("#eDT").value).toISOString();
      E.team=$("#eTeam").value; E.location=$("#eLoc").value; E.opponent=$("#eOpp").value; E.uniform=$("#eUni").value; save(); renderAll(); close();
    };
    $("#btnDel")&&($("#btnDel").onclick=()=>{ if(confirm("¬øEliminar evento?")){ S.events=S.events.filter(x=>x.id!=id); delete S.att[id]; save(); renderAll(); close(); }});
    $("#btnCopy").onclick=()=>{
      const when=new Date(E.datetime).toLocaleString('es-CL',{weekday:'long',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
      const url=location.origin+location.pathname+"#rsvp="+encodeURIComponent(JSON.stringify({id:E.id,t:S.team}));
      const text = `*${E.type}: ${E.title}* (${E.team})%0A${when} ‚Äî ${E.location||''}%0AUniforme: ${E.uniform||'‚Äî'} ¬∑ Calcetines: verde lima%0A%0AConfirma aqu√≠: ${url}%0A‚úÖ Asiste  ‚ùî Duda  ‚ùå No asiste`;
      navigator.clipboard.writeText(decodeURIComponent(text));
      alert("Mensaje copiado para WhatsApp.");
    };
    $("#btnRSVP").onclick=()=>{ const url=location.origin+location.pathname+"#rsvp="+encodeURIComponent(JSON.stringify({id:E.id,t:S.team})); navigator.clipboard.writeText(url); alert("Link copiado."); };
    $("#btnICS").onclick=()=>{ // con 2 alarmas
      function icsDate(d){return new Date(d).toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z")}
      const st=new Date(E.datetime), mins=(E.type=="Partido"?120:90), en=new Date(st.getTime()+mins*60000);
      const lines=[
        'BEGIN:VCALENDAR','VERSION:2.0','CALSCALE:GREGORIAN','PRODID:-//Golden Moms//ES',
        'BEGIN:VEVENT','UID:'+E.id+'@gm','DTSTAMP:'+icsDate(new Date()),
        'DTSTART:'+icsDate(st),'DTEND:'+icsDate(en),
        'SUMMARY:'+E.title+' ('+E.team+')',
        'LOCATION:'+(E.location||'').replace(/,/g,'\\,'),
        'DESCRIPTION:Uniforme '+(E.uniform||'‚Äî')+' | Calcetines: verde lima',
        'BEGIN:VALARM','ACTION:DISPLAY','DESCRIPTION:Recordatorio d√≠a del evento','TRIGGER:-PT120M','END:VALARM',
        'BEGIN:VALARM','ACTION:DISPLAY','DESCRIPTION:Recordatorio d√≠a anterior','TRIGGER:-P1D','END:VALARM',
        'END:VEVENT','END:VCALENDAR'
      ].join('\r\n');
      const u=URL.createObjectURL(new Blob([lines],{type:"text/calendar"})); const a=document.createElement("a"); a.href=u; a.download=(E.title||"evento")+".ics"; a.click(); URL.revokeObjectURL(u);
    };
  });
}

function editEvent(){
  if(!S.logged || (S.logged.role==="jugadora")){ alert("Solo capitana o admin."); return; }
  const id=crypto.randomUUID();
  const now=new Date(); now.setMinutes(0,0,0);
  const E={id,type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString(),location:"",opponent:"",uniform:""};
  S.events.push(E); save(); openEvent(id);
}

/* =============== Plantel =============== */
function renderRoster(){
  const c=$("#roster"); c.innerHTML="";
  const box=document.createElement("div"); box.className="grid";
  S.users.sort((a,b)=>a[0].localeCompare(b[0])).forEach(u=>{
    const card=document.createElement("div"); card.className="card"; card.style.gridColumn="span 4";
    const me=S.logged?.id===u[6]; const canEdit=(S.logged && (S.logged.role!=="jugadora" || me));
    card.innerHTML=`
      <div class="row" style="justify-content:space-between">
        <div><strong>${u[0]}</strong> ${u[1]?`<span class="badge">${u[1]}</span>`:""} ${u[5]?`<span class="chip bday">üéÇ ${u[5]}</span>`:""}</div>
        <div class="small">${u[3]}</div>
      </div>
      <div class="row" style="margin:6px 0">
        <span class="chip">#${u[2]||"‚Äî"}</span>
        ${u[4].map(t=>`<span class="chip team">${t}</span>`).join("")}
      </div>
      ${canEdit?`<button class="btn" data-id="${u[6]}">Editar</button>`:""}
    `;
    const b=card.querySelector("button"); if(b) b.onclick=()=>editPlayer(u[6]);
    box.appendChild(card);
  });
  c.appendChild(box);
}
function editPlayer(id){
  const u=S.users.find(x=>x[6]==id); if(!u) return;
  const me=S.logged?.id===id; const isAdminCap=(S.logged && S.logged.role!=="jugadora");
  openModal("Editar jugadora",`
    <div class="cols">
      <div class="col-6"><label>Nombre</label><input id="pName" value="${u[0]}" ${!isAdminCap?'disabled':''}></div>
      <div class="col-6"><label>N√∫mero</label><input id="pNum" value="${u[2]||''}"></div>
      <div class="col-6"><label>Apodo</label><input id="pNick" value="${u[1]||''}"></div>
      <div class="col-6"><label>Nacimiento (dd-mmm)</label><input id="pBday" value="${u[5]||''}" placeholder="10-oct"></div>
      <div class="col-6"><label>Equipos (Ctrl/Cmd para multi)</label>
        <select id="pTeams" multiple size="3">
          ${["Golden Moms","Golden Dreams","Golden Power"].map(t=>`<option ${u[4].includes(t)?'selected':''}>${t}</option>`).join("")}
        </select>
      </div>
      <div class="col-6"><label>Rol</label>
        <select id="pRole" ${!isAdminCap?'disabled':''}>
          ${["jugadora","capitana","admin"].map(r=>`<option ${u[3]===r?'selected':''}>${r}</option>`).join("")}
        </select>
      </div>
    </div>
  `,[{id:"save",txt:"Guardar",cls:"btn p"}],({close})=>{
    $("#save").onclick=()=>{
      // Restricci√≥n: jugadora s√≥lo puede editar su apodo, cumplea√±os, n√∫mero
      if(!isAdminCap && !me){ alert("Sin permisos."); return; }
      if(isAdminCap){ u[0]=$("#pName").value.trim(); u[3]=$("#pRole").value; }
      u[2]=$("#pNum").value.trim(); u[1]=$("#pNick").value.trim(); u[5]=$("#pBday").value.trim();
      if(isAdminCap){ u[4]=[...$("#pTeams").selectedOptions].map(o=>o.value); }
      save(); renderRoster(); renderAll(); close();
    };
  });
}

/* =============== Seguimiento =============== */
function renderTrack(){
  const c=$("#track"); c.innerHTML="";
  const head=document.createElement("div"); head.className="row"; head.style.justifyContent="space-between";
  head.innerHTML=`<strong>Seguimiento de Partidos</strong>${(S.logged && S.logged.role!=="jugadora")?`<button class="btn p" id="tNew">Nuevo registro</button>`:""}`;
  c.appendChild(head);
  $("#tNew")&&($("#tNew").onclick=()=>editTrack());
  const box=document.createElement("div"); box.className="card"; c.appendChild(box);
  if(!S.track.length){ box.innerHTML="<div class='small'>A√∫n no hay registros.</div>"; return; }
  S.track.forEach(T=>{
    const r=document.createElement("div"); r.className="att-row";
    const goals=T.goles.map(g=>`${nameOf(g.id)} (${g.qty})`).join(", ");
    r.innerHTML=`<div><strong>${T.comp||"‚Äî"}</strong> ‚Äî <span class="badge">${new Date(T.date).toLocaleDateString('es-CL')}</span> ‚Äî vs ${T.vs||"‚Äî"} <span class="chip team">${T.team}</span> <span class="badge">${T.score||"‚Äî"}</span><div class="small">${goals}</div></div>
      ${(S.logged && S.logged.role!=="jugadora")?`<button class="btn" data-id="${T.id}">Editar</button>`:""}`;
    const b=r.querySelector("button"); if(b) b.onclick=()=>editTrack(T.id);
    box.appendChild(r);
  });
}
function editTrack(id){
  if(!S.logged || S.logged.role==="jugadora"){ alert("Solo capitana/admin."); return; }
  const T = id? S.track.find(x=>x.id==id) : {id:crypto.randomUUID(),date:new Date().toISOString(),comp:"Amistoso",vs:"",team:"Golden Moms",score:"",goles:[],notes:""};
  openModal((id?"Editar":"Nuevo")+" registro",`
    <div class="cols">
      <div class="col-4"><label>Fecha</label><input type="date" id="tDate" value="${toInput(T.date).slice(0,10)}"></div>
      <div class="col-4"><label>Competencia</label><input id="tComp" value="${T.comp||''}" placeholder="LIFA / Wonder Mom‚Äôs / Amistoso"></div>
      <div class="col-4"><label>Rival</label><input id="tVs" value="${T.vs||''}"></div>
      <div class="col-4"><label>Equipo</label><select id="tTeam"><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select></div>
      <div class="col-4"><label>Marcador (ej 3-1)</label><input id="tScore" value="${T.score||''}"></div>
      <div class="col-12"><label>Goles</label>
        <div id="gList"></div>
        <button class="btn" id="gAdd">Agregar goleadora</button>
      </div>
      <div class="col-12"><label>Notas</label><textarea id="tNotes">${T.notes||''}</textarea></div>
    </div>
  `,[{id:"save",txt:"Guardar",cls:"btn p"}],({close})=>{
    $("#tTeam").value=T.team;
    function drawGoals(){
      const box=$("#gList"); box.innerHTML="";
      T.goles.forEach((g,i)=>{
        const row=document.createElement("div"); row.className="row";
        row.innerHTML=`<select data-i="${i}" class="gSel">${S.users.map(u=>`<option value="${u[6]}" ${u[6]==g.id?'selected':''}>${u[0]}</option>`).join("")}</select>
          <input class="gQty" data-i="${i}" type="number" min="1" value="${g.qty||1}" style="width:100px">
          <button class="btn d" data-i="${i}">√ó</button>`;
        row.querySelector(".gSel").onchange=(e)=>{T.goles[e.target.dataset.i].id=e.target.value;};
        row.querySelector(".gQty").oninput=(e)=>{T.goles[e.target.dataset.i].qty=parseInt(e.target.value)||1;};
        row.querySelector("button").onclick=(e)=>{T.goles.splice(e.target.dataset.i,1); drawGoals();};
        box.appendChild(row);
      });
    }
    $("#gAdd").onclick=()=>{ T.goles.push({id:S.users[0][6],qty:1}); drawGoals(); };
    drawGoals();
    $("#save").onclick=()=>{
      T.date = new Date($("#tDate").value).toISOString();
      T.comp=$("#tComp").value.trim(); T.vs=$("#tVs").value.trim(); T.team=$("#tTeam").value; T.score=$("#tScore").value.trim(); T.notes=$("#tNotes").value.trim();
      if(!id) S.track.push(T); save(); renderTopScorers(); renderTrack(); renderKPIs(); close();
    };
  });
}

/* =============== Configuraci√≥n (m√≠nima) =============== */
function renderCfg(){
  const c=$("#cfg"); c.innerHTML="";
  const card=document.createElement("div"); card.className="card";
  card.innerHTML=`
    <div class="row" style="justify-content:space-between">
      <strong>Configuraci√≥n</strong>
      <span class="small">Solo admin</span>
    </div>
    <div class="hr"></div>
    <div class="row"><div>Logo usado:</div><img src="Logo.webp" alt="logo" style="height:36px;border:1px solid var(--b);border-radius:6px"></div>
    <div class="small">El resto de par√°metros est√°n codificados en este archivo para uso en GitHub Pages (sin servidor).</div>
  `;
  c.appendChild(card);
}

/* =============== Modal generador =============== */
function openModal(title, html, actions, after){
  const bg=$("#modal"); $("#modTitle").textContent=title; $("#modBody").innerHTML=html;
  const foot=$("#modFoot"); foot.innerHTML=""; (actions||[]).forEach(a=>{ const b=document.createElement("button"); b.id=a.id; b.className=a.cls||"btn"; b.textContent=a.txt; foot.appendChild(b); });
  function close(){ bg.style.display="none"; }
  $("#modClose").onclick=close; bg.style.display="flex";
  after && after({close});
}

/* =============== Render global =============== */
function renderAll(){ renderCal(); renderBirthdays(); renderTopScorers(); if($(".tab.active").dataset.tab==="roster") renderRoster(); if($(".tab.active").dataset.tab==="track") renderTrack(); }

/* =============== RSVP hash (jugadora) =============== */
function checkHash(){
  const h=location.hash; if(h.startsWith("#rsvp=")){ try{ const p=JSON.parse(decodeURIComponent(h.slice(6))); const E=S.events.find(x=>x.id==p.id); if(!E) return;
    openEvent(E.id);
  }catch{} }
}

/* =============== Inicio =============== */
hydrateSession(); renderAll(); checkHash();
</script>
</body>
</html>
