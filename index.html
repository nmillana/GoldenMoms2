<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms — Panel</title>
<link rel="icon" href="Logo.webp"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{
  --blue:#0f3a78; --lime:#9be22d; --ink:#0f172a; --mut:#64748b;
  --b:#e2e8f0; --bg:#f7f8fa; --ok:#d9f99d; --mid:#fef9c3; --no:#fee2e2;
  --lime-strong:#7fd410; --blue-strong:#0a2a58;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:inherit;text-decoration:none}
.btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer}
.btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
.btn.s{background:#f8fafc}
.badge{font-size:11px;border:1px solid var(--b);border-radius:999px;padding:2px 8px;background:#f8fafc}
.top{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.brand{display:flex;gap:10px;align-items:center}
.brand img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)}
.nav{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
.nav .tab.active{background:var(--blue);color:#fff}
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 20px #0000000a;padding:12px}
.kpi h3{margin:0;color:var(--mut);font-size:14px}.kpi .n{font-size:22px;font-weight:800}

/* Top action buttons */
.top-actions{display:flex;gap:8px;align-items:center}

/* ====== EVENTOS (Calendario mensual) ====== */
.month-bar{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:10px}
.month-title{font-weight:800;font-size:22px}
.month-nav{display:flex;gap:6px}
.month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
.weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-bottom:8px}
.weekdays div{font-weight:700;color:var(--blue);text-align:center}

.day{min-height:140px;background:#fff;border:1px solid var(--b);border-radius:12px;padding:8px;position:relative;display:flex;flex-direction:column;gap:6px}
.day-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.day-n{font-weight:700;color:var(--mut)}
.day-add{border:none;background:#eef4ff;color:var(--blue);width:26px;height:26px;border-radius:999px;cursor:pointer}
.ev{border-radius:10px;padding:8px;border:1px solid #0001;cursor:pointer;line-height:1.2}
.ev.ev-train{background:var(--lime-strong);color:#0c3200;border-color:#8ed400}
.ev.ev-match{background:#dce9ff;color:var(--blue-strong);border-color:#b9d0ff}
.ev .title{font-weight:600}

/* Modal */
.modal-bg{position:fixed;inset:0;background:#0006;display:none;align-items:center;justify-content:center;z-index:60}
.modal{width:min(860px,calc(100vw - 24px));background:#fff;border:1px solid var(--b);border-radius:14px;padding:16px;box-shadow:0 20px 40px #00000022}
.modal h3{margin:0 0 10px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:800px){.form-row{grid-template-columns:1fr}}
.input, select, textarea{width:100%;padding:10px;border:1px solid var(--b);border-radius:10px;background:#fff}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

/* small helper text to explain sections (for non-developers) */
.section-note{font-size:13px;color:var(--mut);margin-top:8px;border-left:3px solid #e6edf7;padding-left:8px}

/* Tooltip preview (next events) */
.next-preview {
  position:relative;
}
.preview-box{
  position:absolute;
  right:0;
  top:42px;
  min-width:260px;
  background:#fff;border:1px solid var(--b);box-shadow:0 8px 20px rgba(0,0,0,0.12);padding:10px;border-radius:10px;display:none;z-index:80;
}
.preview-box ul{margin:0;padding:0 0 0 12px}
.preview-item{padding:6px 0;border-bottom:1px dashed #eee}
.preview-item:last-child{border-bottom:0}

/* Filters row */
.filter-row{display:flex;gap:8px;align-items:center;margin-top:8px}
.filter-btn{padding:6px 10px;border-radius:999px;border:1px solid var(--b);background:#fff;cursor:pointer;font-size:13px}
.filter-btn.active{background:var(--blue);color:#fff;border-color:var(--blue-strong)}

/* responsive */
@media (max-width: 900px){
  .grid{grid-template-columns:1fr}
  .month-grid, .weekdays{gap:6px}
  .day{min-height:120px}
  .preview-box{left:6px;right:auto;top:48px}
}
</style>
</head>
<body>

<!-- Top -->
<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM"/>
    <div><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <div class="nav">
      <button class="tab active" data-view="dash">Dashboard</button>
      <button class="tab" data-view="events">Eventos</button>
      <button class="tab" data-view="roster">Plantel</button>
      <button class="tab" data-view="track">Seguimiento</button>
    </div>
    <div class="top-actions" style="margin-left:12px">
      <!-- CTAs rápidos -->
      <button class="btn p" id="ctaNewEvent" title="Crear nuevo evento">+ Nuevo evento</button>
      <button class="btn s" id="ctaRoster" title="Ir a administrar plantel">Administrar plantel</button>
    </div>
  </div>
</div>

<div class="container">

  <!-- ====== SECCIÓN: DASHBOARD ====== -->
  <section id="v-dash">
    <!-- KPI row: Próximo evento / Plantel / Partidos jugados -->
    <div class="grid" style="align-items:stretch">
      <div class="card kpi next-preview" style="grid-column:span 4;display:flex;flex-direction:column;justify-content:space-between;position:relative">
        <div>
          <h3 style="margin-bottom:6px">Próximo evento</h3>
          <div id="nextEvent" style="font-weight:700;cursor:default"></div>
          <div id="nextEventCount" style="font-size:12px;color:var(--mut)"></div>
        </div>
        <div style="margin-top:8px;display:flex;justify-content:flex-end">
          <button class="btn s" onclick="showView('events')">Ver calendario</button>
        </div>

        <!-- PREVIEW: aparece al hover por JS -->
        <div class="preview-box" id="nextPreviewBox" aria-hidden="true">
          <div style="font-weight:700;margin-bottom:6px">Próximos eventos</div>
          <ul id="nextPreviewList"></ul>
          <div style="text-align:right;margin-top:8px"><button class="btn s" onclick="showView('events')">Ver más</button></div>
        </div>
      </div>

      <div class="card kpi" style="grid-column:span 4;display:flex;flex-direction:column;justify-content:space-between">
        <div>
          <h3 style="margin-bottom:6px">Plantel</h3>
          <div class="n" id="kRoster">0</div>
          <div style="font-size:12px;color:var(--mut)">Integrantes registrados</div>
        </div>
        <div style="margin-top:8px;display:flex;justify-content:flex-end">
          <button class="btn s" onclick="showView('roster')">Administrar plantel</button>
        </div>
      </div>

      <div class="card kpi" style="grid-column:span 4;display:flex;flex-direction:column;justify-content:space-between">
        <div>
          <h3 style="margin-bottom:6px">Partidos jugados</h3>
          <div class="n" id="kGames">0</div>
          <div id="lastMatchSummary" style="font-size:12px;color:var(--mut)"></div>
        </div>
        <div style="margin-top:8px;display:flex;justify-content:flex-end">
          <button class="btn s" onclick="showView('events')">Ver partidos</button>
        </div>
      </div>
    </div>

    <!-- Row: Cumpleaños hoy + Próximos cumpleaños + Hoy (detalles) -->
    <div class="grid" style="margin-top:12px;grid-template-columns:repeat(12,1fr);gap:12px">
      <div class="card" style="grid-column:span 4">
        <h4>🎂 Cumpleaños — Hoy</h4>
        <div class="section-note">Personas del plantel que cumplen hoy</div>
        <div id="birthToday" style="margin-top:8px">—</div>
      </div>

      <div class="card" style="grid-column:span 4">
        <h4>🎉 Próximos cumpleaños</h4>
        <div class="section-note">Lista con los próximos 5 cumpleaños.</div>
        <ul id="upBirth" style="margin:8px 0 0 16px"></ul>
      </div>

      <div class="card" style="grid-column:span 4">
        <h4>📅 Hoy</h4>
        <div class="section-note">Eventos que ocurren hoy (comparación por fecha local).</div>

        <!-- FILTERS: nuevo control para filtrar Hoy / Semana -->
        <div class="filter-row" style="margin-bottom:6px">
          <div style="font-size:13px;color:var(--mut);margin-right:8px">Filtrar:</div>
          <button class="filter-btn active" id="filter_all">Todos</button>
          <button class="filter-btn" id="filter_matches">Sólo Partidos</button>
          <button class="filter-btn" id="filter_train">Sólo Entrenamientos</button>
        </div>

        <ul id="todayEvents" style="margin:8px 0 0 16px"></ul>
      </div>

      <div class="card" style="grid-column:span 12;margin-top:12px">
        <h4>📅 Eventos de la semana</h4>
        <div class="section-note">Eventos de la semana actual (lunes a domingo).</div>
        <ul id="weekEvents" style="margin:8px 0 0 16px"></ul>
      </div>
    </div>
  </section>

  <!-- ====== SECCIÓN: EVENTOS (Calendario mensual) ====== -->
  <section id="v-events" style="display:none">
    <div class="card">
      <div class="month-bar">
        <div class="month-nav">
          <button class="btn s" id="btnPrevMonth">◀</button>
          <button class="btn s" id="btnToday">Hoy</button>
          <button class="btn s" id="btnNextMonth">▶</button>
        </div>
        <div class="month-title" id="monthTitle">Mes</div>
        <button class="btn p" id="btnNewEventTop">Nuevo Evento</button>
      </div>

      <div class="section-note">El calendario muestra eventos agrupados por <strong>fecha local</strong> (YYYY-MM-DD) para evitar el desplazamiento de día causado por la conversión UTC.</div>

      <div class="weekdays">
        <div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div>
      </div>
      <div id="monthGrid" class="month-grid"></div>
    </div>
  </section>

  <!-- ====== SECCIÓN: PLANTEL ====== -->
  <section id="v-roster" style="display:none">
    <div class="card">
      <h4>Plantel</h4>
      <div class="section-note">Aquí verás listado del plantel (traído de la tabla <code>players</code>).</div>
      <div id="rosterGrid" class="grid" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- ====== SECCIÓN: SEGUIMIENTO ====== -->
  <section id="v-track" style="display:none">
    <div class="card">
      <h4>Seguimiento de partidos</h4>
      <div class="section-note">Panel para métricas de seguimiento (placeholder).</div>
      <div id="trackList" style="margin-top:8px"></div>
    </div>
  </section>
</div>

<footer style="text-align:center;padding:16px;color:var(--mut);font-size:14px">Golden Moms · hecho con 💚 lima & azul</footer>

<!-- MODAL EVENTO -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h3 id="modalTitle">Nuevo evento</h3>
    <div class="form-row">
      <div>
        <label>Título</label>
        <input id="f_title" class="input" placeholder="Ej: Entrenamiento Colegio">
      </div>
      <div>
        <label>Tipo</label>
        <select id="f_type" class="input">
          <option>Entrenamiento</option>
          <option>Partido</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div>
        <label>Fecha y hora</label>
        <input id="f_dt" type="datetime-local" class="input">
      </div>
      <div>
        <label>Equipo</label>
        <input id="f_team" class="input" value="Golden Moms">
      </div>
    </div>
    <div class="form-row">
      <div>
        <label>Rival (si aplica)</label>
        <input id="f_opponent" class="input" placeholder="Rivales / Liga">
      </div>
      <div>
        <label>Uniforme</label>
        <select id="f_uniform" class="input">
          <option value="">(definir)</option>
          <option>Polera azul — * medias verde lima</option>
          <option>Polera verde lima — * medias verde lima</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div>
        <label>Ubicación</label>
        <input id="f_location" class="input" placeholder="Colegio / Cancha / Dirección">
      </div>
      <div>
        <label>&nbsp;</label>
        <div class="modal-actions">
          <button class="btn s" id="btnDelete" style="margin-right:auto;display:none">Eliminar</button>
          <button class="btn s" id="btnCancel">Cancelar</button>
          <button class="btn p" id="btnSave">Guardar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= SUPABASE ========= */
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};
const supa = supabase.createClient(SUPA.url, SUPA.key);

/* ========= Navegación (no tocar) ========= */
document.querySelectorAll('.nav .tab').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    showView(btn.dataset.view);
  };
});
function showView(v){
  ['dash','events','roster','track'].forEach(id=>document.getElementById('v-'+id).style.display='none');
  document.getElementById('v-'+v).style.display='block';
  if(v==='dash') renderDash();
  if(v==='events') renderMonth();
}

/* ===== util ===== */
function pad(n){return n.toString().padStart(2,'0');}

/* === TZ helpers: mantener la hora local al guardar/editar === */
/* Convierte 'YYYY-MM-DDTHH:MM' (datetime-local) a ISO con offset local: 2025-08-30T21:00:00-04:00 */
function localInputToISOWithOffset(inp){
  if(!inp) return null;
  const [d, t] = inp.split('T');
  const offMin = -new Date().getTimezoneOffset(); // ej: -240 => -04:00
  const sign = offMin >= 0 ? '+' : '-';
  const abs = Math.abs(offMin);
  const oh = pad(Math.floor(abs/60));
  const om = pad(abs%60);
  return `${d}T${t}:00${sign}${oh}:${om}`;
}
/* Convierte ISO (con Z u offset) a valor para datetime-local en la zona local */
function isoToLocalInput(iso){
  if(!iso) return '';
  const d = new Date(iso);
  const y = d.getFullYear();
  const m = pad(d.getMonth()+1);
  const da = pad(d.getDate());
  const hh = pad(d.getHours());
  const mm = pad(d.getMinutes());
  return `${y}-${m}-${da}T${hh}:${mm}`;
}

/* ---------- NUEVO: comparador por FECHA LOCAL (YYYY-MM-DD) ----------
   Usamos esto en la UI para agrupar/mostrar eventos por día local.
   Evita que un evento guardado como "2025-08-30T21:00 -04:00" aparezca en UTC como 2025-08-31
*/
function localDateYMD(d){
  const D = new Date(d);
  return `${D.getFullYear()}-${pad(D.getMonth()+1)}-${pad(D.getDate())}`;
}

/* ========= EVENTOS (calendario) ========= */
let monthCursor = new Date(); // apunta al mes actual para navegar
let cachedEvents = []; // del mes en pantalla
let lastFetchedEvents = []; // eventos traídos por renderDash (para preview y filtros)
let currentFilter = 'all'; // 'all' | 'Partido' | 'Entrenamiento'
const monthTitle = document.getElementById('monthTitle');
const monthGrid = document.getElementById('monthGrid');
document.getElementById('btnPrevMonth').onclick=()=>{ monthCursor.setMonth(monthCursor.getMonth()-1); renderMonth(); };
document.getElementById('btnNextMonth').onclick=()=>{ monthCursor.setMonth(monthCursor.getMonth()+1); renderMonth(); };
document.getElementById('btnToday').onclick=()=>{ monthCursor = new Date(); renderMonth(); };
document.getElementById('btnNewEventTop').onclick=()=>openModal();
document.getElementById('ctaNewEvent').onclick=()=>openModal();
document.getElementById('ctaRoster').onclick=()=>showView('roster');

/* Rango del mes (lunes a domingo “cuadrado”) */
function getMonthRange(d){
  const first = new Date(d.getFullYear(), d.getMonth(), 1);
  const last = new Date(d.getFullYear(), d.getMonth()+1, 0);
  let start = new Date(first);
  let dow = (start.getDay()+6)%7; // 0=Lunes
  start.setDate(start.getDate()-dow);
  let end = new Date(last);
  let dow2 = (end.getDay()+6)%7;
  end.setDate(end.getDate() + (6-dow2));
  return {start, end};
}

async function fetchEventsRange(start,end){
  const {data, error} = await supa
    .from("events")
    .select("*")
    .gte("datetime", start.toISOString())
    .lte("datetime", end.toISOString())
    .order("datetime", {ascending:true});
  if(error){ console.error(error); return []; }
  return data || [];
}

function renderMonthTitle(){
  const m = monthCursor.toLocaleString('es-CL',{month:'long',year:'numeric'});
  monthTitle.textContent = m.charAt(0).toUpperCase()+m.slice(1);
}

async function renderMonth(){
  renderMonthTitle();
  const {start,end} = getMonthRange(monthCursor);
  cachedEvents = await fetchEventsRange(start,end);
  drawMonthGrid(start,end);
}

function drawMonthGrid(start,end){
  monthGrid.innerHTML='';
  const days = [];
  let d = new Date(start);
  while(d<=end){
    days.push(new Date(d));
    d.setDate(d.getDate()+1);
  }
  for(const day of days){
    const cell = document.createElement('div');
    cell.className='day';
    const head = document.createElement('div');
    head.className='day-head';
    head.innerHTML = `<div class="day-n">${pad(day.getDate())}</div>
      <button class="day-add" title="Nuevo evento">+</button>`;
    head.querySelector('.day-add').onclick=()=>openModal({ date: day });
    cell.appendChild(head);

    // ---- comparar por FECHA LOCAL (YYYY-MM-DD)
    const dayStrLocal = localDateYMD(day);
    const events = cachedEvents.filter(e => {
      const ed = new Date(e.datetime);
      return localDateYMD(ed) === dayStrLocal;
    });

    for(const e of events){
      const ev = document.createElement('div');
      ev.className='ev '+(e.type==='Entrenamiento'?'ev-train':'ev-match');
      ev.innerHTML = `<div class="title">${e.title}</div>`;
      ev.onclick=()=>openModal({ existing:e });
      cell.appendChild(ev);
    }
    monthGrid.appendChild(cell);
  }
}

/* ========= Modal de evento ========= */
const modalBg = document.getElementById('modalBg');
const f_title = document.getElementById('f_title');
const f_type = document.getElementById('f_type');
const f_dt   = document.getElementById('f_dt');
const f_team = document.getElementById('f_team');
const f_opponent = document.getElementById('f_opponent');
const f_uniform  = document.getElementById('f_uniform');
const f_location = document.getElementById('f_location');
const btnDelete = document.getElementById('btnDelete');
const btnCancel = document.getElementById('btnCancel');
const btnSave   = document.getElementById('btnSave');

let editingId = null;

function openModal(opts={}){
  document.getElementById('modalTitle').textContent = opts.existing ? 'Editar evento' : 'Nuevo evento';
  editingId = null;
  if(opts.existing){
    const e = opts.existing;
    editingId = e.id;
    f_title.value = e.title||'';
    f_type.value  = e.type||'Entrenamiento';
    f_dt.value    = isoToLocalInput(e.datetime); // muestra hora local correcta en el input
    f_team.value  = e.team||'Golden Moms';
    f_opponent.value = e.opponent||'';
    f_uniform.value  = e.uniform||'';
    f_location.value = e.location||'';
    btnDelete.style.display='';
  }else{
    f_title.value = '';
    f_type.value  = 'Entrenamiento';
    // si viene con fecha del día + set hora 19:30 por comodidad
    const base = opts.date ? new Date(opts.date) : new Date();
    base.setHours(19,30,0,0);
    f_dt.value = isoToLocalInput(base.toISOString());
    f_team.value  = 'Golden Moms';
    f_opponent.value = '';
    f_uniform.value  = '';
    f_location.value = '';
    btnDelete.style.display='none';
  }
  modalBg.style.display='flex';
}
btnCancel.onclick=()=>modalBg.style.display='none';
btnDelete.onclick=async()=>{
  if(!editingId) return;
  const ok = confirm('¿Eliminar este evento?');
  if(!ok) return;
  const {error} = await supa.from('events').delete().eq('id', editingId);
  if(error) alert('Error al eliminar: '+error.message);
  modalBg.style.display='none';
  renderMonth();
  renderDash();
};
btnSave.onclick=async()=>{
  const title = f_title.value.trim();
  const type  = f_type.value;
  const team  = f_team.value.trim();
  const opponent = f_opponent.value.trim();
  const uniform  = f_uniform.value;
  const location = f_location.value.trim();

  if(!title || !f_dt.value){ alert('Completa título y fecha/hora'); return; }

  // ⬇️ Guardar con offset local para que NO cambie la hora al recuperar desde DB
  const datetime = localInputToISOWithOffset(f_dt.value);

  const payload = { title, type, team, opponent, uniform, location, datetime };

  let error;
  if(editingId){
    ({error} = await supa.from('events').update(payload).eq('id', editingId));
  }else{
    ({error} = await supa.from('events').insert([payload]));
  }
  if(error){ alert('Error al guardar: '+error.message); return; }
  modalBg.style.display='none';
  renderMonth();
  renderDash();
};

/* ========= Dashboard básico (hoy/semana + birthdays) ========= */
async function renderDash(){
  try{
    const now = new Date();
    const weekStart = new Date(now);
    weekStart.setDate(weekStart.getDate() - ((weekStart.getDay()+6)%7)); // lunes
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate()+6);

    // fecha local comparator
    const todayStrLocal = localDateYMD(now);

    // traer eventos de la semana (para mostrar hoy/semana y calcular próximo evento)
    const {data:events} = await supa.from("events")
      .select("*")
      .gte("datetime", weekStart.toISOString())
      .lte("datetime", weekEnd.toISOString())
      .order("datetime",{ascending:true});

    lastFetchedEvents = events || [];

    // traer jugadores
    const {data:players} = await supa.from("players").select("*");

    // KPI: Plantel
    document.getElementById('kRoster').textContent = (players||[]).length || 0;

    // KPI: Partidos jugados (contar partidos con fecha < now)
    const matchesPlayed = (lastFetchedEvents||[]).filter(e => e.type === 'Partido' && new Date(e.datetime) < now);
    document.getElementById('kGames').textContent = matchesPlayed.length;
    // último partido jugado (más reciente)
    if(matchesPlayed.length>0){
      const last = matchesPlayed.sort((a,b)=> new Date(b.datetime) - new Date(a.datetime))[0];
      const d = new Date(last.datetime);
      document.getElementById('lastMatchSummary').textContent = `${last.title} — ${d.toLocaleDateString('es-CL',{day:'2-digit',month:'short'})}`;
    }else{
      document.getElementById('lastMatchSummary').textContent = 'Sin partidos jugados aún';
    }

    // Próximo evento + conteo próximos (filtrar por >= now)
    const upcomingEvents = (lastFetchedEvents||[]).filter(e => new Date(e.datetime) >= now).sort((a,b)=> new Date(a.datetime) - new Date(b.datetime));
    const upcomingCount = upcomingEvents.length;
    if(upcomingCount>0){
      const n = upcomingEvents[0];
      const nd = new Date(n.datetime);
      document.getElementById('nextEvent').innerHTML = `<div>${n.title}</div><div style="font-size:13px;color:var(--mut)">${nd.toLocaleString('es-CL',{weekday:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'})}</div>`;
      document.getElementById('nextEventCount').textContent = `${upcomingCount} evento(s) en la semana`;
    }else{
      document.getElementById('nextEvent').textContent = 'No hay eventos próximos esta semana';
      document.getElementById('nextEventCount').textContent = '';
    }

    // actualizar preview (nueva funcionalidad)
    updateNextPreview(upcomingEvents);

    // cumpleaños: usamos vista vw_upcoming_birthdays si existe
    const upB = document.getElementById("upBirth"); upB.innerHTML="";
    const birthTodayEl = document.getElementById('birthToday'); birthTodayEl.innerHTML = '—';
    try{
      const { data:vw } = await supa.from("vw_upcoming_birthdays").select("*").order("proximo_cumple",{ascending:true}).limit(10);
      if(vw && vw.length>0){
        // list upcoming
        vw.forEach(p=>{
          if(p.proximo_cumple){
            const bd=new Date(p.proximo_cumple);
            upB.innerHTML += `<li>${p.apodo||p.nombre} — ${bd.toLocaleDateString("es-CL",{day:"2-digit",month:"short"})}</li>`;
          }
        });
        // today birthdays
        const todayList = vw.filter(p => p.proximo_cumple && localDateYMD(new Date(p.proximo_cumple)) === todayStrLocal);
        if(todayList.length>0){
          birthTodayEl.innerHTML = '<ul style="margin:6px 0 0 16px">' + todayList.map(p=>`<li><strong>${p.apodo||p.nombre}</strong> — ${p.edad? p.edad+' años':''}</li>`).join('') + '</ul>';
        }else{
          birthTodayEl.innerHTML = '<div style="color:var(--mut)">Hoy no hay cumpleaños</div>';
        }
      }else{
        // fallback: si no hay vista, mostrar mensaje
        upB.innerHTML = '<li style="color:var(--mut)">No hay datos de cumpleaños</li>';
        birthTodayEl.innerHTML = '<div style="color:var(--mut)">Hoy no hay cumpleaños</div>';
      }
    }catch(e){
      console.warn('Error trayendo cumpleaños', e);
      upB.innerHTML = '<li style="color:var(--mut)">Error cargando datos</li>';
      birthTodayEl.innerHTML = '<div style="color:var(--mut)">Hoy no hay cumpleaños</div>';
    }

    // RENDER LISTS (aplican filtros)
    updateEventLists();

  }catch(err){
    console.error(err);
    // Mostrar mensajes amigables si algo falla
    document.getElementById('nextEvent').textContent = 'Error cargando eventos';
    document.getElementById('nextEventCount').textContent = '';
    document.getElementById('birthToday').innerHTML = '<div style="color:var(--mut)">Error cargando cumpleaños</div>';
  }
}

/* ========== NUEVAS FUNCIONES: Preview y filtros ========== */

// actualiza el listado pequeño que aparece al hacer hover sobre el KPI 'Próximo evento'
function updateNextPreview(upcomingEvents){
  const listEl = document.getElementById('nextPreviewList');
  const box = document.getElementById('nextPreviewBox');
  listEl.innerHTML = '';
  const items = (upcomingEvents || []).slice(0,3);
  if(items.length===0){
    listEl.innerHTML = '<li style="color:var(--mut)">No hay eventos próximos</li>';
  }else{
    items.forEach(it=>{
      const d = new Date(it.datetime);
      const txt = `${it.title} — ${d.toLocaleString('es-CL',{weekday:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'})}`;
      const li = document.createElement('li');
      li.className = 'preview-item';
      li.textContent = txt;
      listEl.appendChild(li);
    });
  }
  // hover handlers: mostrar la caja cuando el ratón entra y ocultar al salir
  const previewParent = document.querySelector('.next-preview');
  previewParent.onmouseenter = ()=> { box.style.display='block'; box.setAttribute('aria-hidden','false'); };
  previewParent.onmouseleave = ()=> { box.style.display='none'; box.setAttribute('aria-hidden','true'); };
}

// establece filter y reaplica
function setEventFilter(filter){
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  if(filter === 'all') document.getElementById('filter_all').classList.add('active');
  if(filter === 'Partido') document.getElementById('filter_matches').classList.add('active');
  if(filter === 'Entrenamiento') document.getElementById('filter_train').classList.add('active');
  updateEventLists();
}

// renderiza las listas 'Hoy' y 'Semana' desde lastFetchedEvents aplicando currentFilter
function updateEventLists(){
  const now = new Date();
  const todayStrLocal = localDateYMD(now);

  const events = lastFetchedEvents || [];

  const filtered = events.filter(e => {
    if(currentFilter === 'all') return true;
    return e.type === currentFilter;
  });

  // HOY
  const todayEl = document.getElementById('todayEvents'); todayEl.innerHTML = '';
  filtered.filter(e => localDateYMD(new Date(e.datetime)) === todayStrLocal)
    .forEach(e=>{
      const d=new Date(e.datetime);
      todayEl.innerHTML += `<li><strong>${e.title}</strong> — ${d.toLocaleString("es-CL",{weekday:'short',hour:'2-digit',minute:'2-digit'})}</li>`;
    });
  if(todayEl.innerHTML.trim() === '') todayEl.innerHTML = '<div style="color:var(--mut)">No hay eventos hoy según el filtro</div>';

  // SEMANA
  const wEl = document.getElementById('weekEvents'); wEl.innerHTML = '';
  filtered.forEach(e=>{
    const d = new Date(e.datetime);
    wEl.innerHTML += `<li><strong>${e.title}</strong> — ${d.toLocaleString("es-CL",{weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"})}</li>`;
  });
  if(wEl.innerHTML.trim() === '') wEl.innerHTML = '<div style="color:var(--mut)">No hay eventos en la semana según el filtro</div>';
}

/* ========== Bind filtros UI ========== */
document.getElementById('filter_all').onclick = ()=> setEventFilter('all');
document.getElementById('filter_matches').onclick = ()=> setEventFilter('Partido');
document.getElementById('filter_train').onclick = ()=> setEventFilter('Entrenamiento');

/* ========= Inicial ========= */
showView('dash'); // arranque
renderDash();
</script>
</body>
</html>
