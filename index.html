<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms â€” Panel</title>
<link rel="icon" href="Logo.webp"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{
  --blue:#0f3a78; --lime:#9be22d; --ink:#0f172a; --mut:#64748b;
  --b:#e2e8f0; --bg:#f7f8fa;
  --lime-strong:#7fd410; --blue-strong:#0a2a58;
  --title-size:12px; --content-size:10px; --sub-size:8px; --kpi-number-size:22px;
  --day-bold-size: 16px;
  --day-bold-size-mobile: 14px;
  --week-sep-height: 8px;
  --week-sep-color: #000;
  --today-border-color: #ff3b3b;
  --month-grid-gap: 18px;
  --month-list-gap: 12px;
  --card-radius:12px;
}

/* base */
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:inherit;text-decoration:none}

/* Buttons */
.btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer;font-size:var(--content-size)}
.btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
.btn.s{background:#f8fafc}

/* Top bar */
.top{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px;overflow:visible}
.brand{display:flex;gap:10px;align-items:center}
.brand img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)}
.brand div{font-size:var(--content-size)}
.nav{display:flex;gap:8px;flex-wrap:nowrap;align-items:center;overflow-x:auto;padding-bottom:4px}
.nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer;white-space:nowrap;font-size:var(--content-size)}
.nav .tab.active{background:var(--blue);color:#fff}

/* Layout */
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:#fff;border:1px solid var(--b);border-radius:var(--card-radius);box-shadow:0 8px 20px #0000000a;padding:12px; overflow:visible}
.card h4{margin:0 0 8px;font-size:14px;font-weight:700}
.kpi h3{margin:0;color:var(--mut);font-size:var(--sub-size)}
.kpi .n{font-size:var(--kpi-number-size);font-weight:800}
.section-note{font-size:var(--sub-size);color:var(--mut);margin-top:8px;border-left:3px solid #e6edf7;padding-left:8px}

/* Calendar (kept original styles, unchanged) */
.month-bar{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
.month-title{font-weight:800;font-size:var(--title-size)}
.month-nav{display:flex;gap:6px}
.month-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap: var(--month-grid-gap);
  grid-auto-rows:minmax(90px,auto);
}
.month-grid .week-sep{
  grid-column: 1 / -1;
  height: var(--week-sep-height);
  background: var(--week-sep-color);
  border-radius: 4px;
  margin: 10px 0;
  z-index:0;
}

/* day cell */
.day{
  min-height:90px;
  background:#fff;
  border:1px solid var(--b);
  border-radius:12px;
  padding:12px;
  position:relative;
  display:flex;
  flex-direction:column;
  gap:6px;
  z-index:0;
}
.day-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.day-num-box{
  background:#f1f5f9;
  border-radius:8px;
  padding:6px 8px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:2px;
  min-width:48px;
  line-height:1;
}
.day-num-box .day-wk-grid{font-size:10px;text-transform:lowercase;color:var(--mut)}
.day-num-box .day-n{font-weight:800;color:var(--mut);font-size: var(--day-bold-size);}

.day.today{ border: 3px solid var(--today-border-color); border-radius:12px; }

.day-add{
  position:absolute; top:10px; right:10px; width:36px; height:36px; border-radius:999px;
  border:1px solid var(--b); background:#eef4ff; color:var(--blue); display:inline-flex; align-items:center; justify-content:center; cursor:pointer; font-size:18px; line-height:1; box-shadow: 0 4px 8px #00000011; z-index:3;
}

/* evento chips */
.ev{border-radius:10px;padding:8px;border:1px solid #0001;cursor:pointer;line-height:1.2;word-break:break-word;font-size:var(--content-size)}
.ev.ev-train{background:var(--lime-strong);color:#0c3200;border-color:#8ed400}
.ev.ev-match{background:#dce9ff;color:var(--blue-strong);border-color:#b9d0ff}

/* Month list */
.month-list{display:none;flex-direction:column;gap:var(--month-list-gap)}
.month-list .day{display:flex;flex-direction:row;align-items:flex-start;gap:8px;padding:8px;min-height:auto;position:relative}
.day-date{
  min-width:52px;border-radius:8px;background:#f1f5f9;padding:6px 8px;text-align:center;font-weight:700;color:var(--mut);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;line-height:1;font-size:var(--day-bold-size);
}
.month-list .day.today{ border-color: var(--today-border-color); }

/* Modal */
.modal-bg{ position:fixed; inset:0; background:#0006; display:none; z-index:1000; justify-content:center; align-items:center; padding:12px; overflow-y:auto; -webkit-overflow-scrolling:touch; }
.modal{ width: min(920px, calc(100% - 32px)); margin:0 auto; background:#fff; border:1px solid var(--b); border-radius:14px; padding:16px; box-shadow:0 20px 40px #00000022; max-height:calc(100vh - 48px); overflow:auto; box-sizing:border-box; }
@media (max-width:520px){ .modal{ width: calc(100% - 24px); padding:12px; border-radius:12px; } }

/* forms */
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:800px){.form-row{grid-template-columns:1fr}}
.input, select, textarea{width:100%;padding:10px;border:1px solid var(--b);border-radius:10px;background:#fff;font-size:var(--content-size)}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

/* roster */
#rosterGrid{ display:grid; grid-template-columns: repeat(12,1fr); gap:12px; align-items:start; }
.player-photo{ width:64px; height:64px; border-radius:50%; object-fit:cover; border:2px solid #fff; box-shadow:0 6px 18px #00000010; background:#f1f5f9; flex:0 0 64px; }
.jersey-placeholder{ width:64px; height:64px; border-radius:50%; background:#eef2ff; display:flex; align-items:center; justify-content:center; border:2px solid #fff; font-weight:800; color:var(--blue); font-size:18px; box-shadow:0 6px 18px #00000010; flex:0 0 64px; }

/* small helpers */
.meta-small{ font-size:12px; color:var(--mut); margin-top:6px; }
.no-birth { font-size:var(--content-size); color:var(--mut); }

/* ===== PARTIDOS: added styles ===== */
.match-row{ border:1px solid var(--b); border-radius:10px; padding:12px; margin-bottom:10px; display:grid; grid-template-columns: 1fr 360px; gap:12px; align-items:start; }
.match-head{font-weight:700}
.match-meta{font-size:12px;color:var(--mut);margin-top:4px}
.match-right{display:flex; flex-direction:column; gap:8px; align-items:flex-end}
.match-form{display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; width:100%;}
.match-form textarea{grid-column: 1 / -1; min-height:80px; resize:vertical}
.match-actions{display:flex; gap:8px; justify-content:flex-end; width:100%}
.match-compact { font-size:13px; margin-top:8px; color:var(--mut) }
@media (max-width:900px){ .match-row{ grid-template-columns: 1fr; } .match-right{ align-items:stretch; } .match-form{ grid-template-columns: 1fr 1fr; } }
@media (max-width:480px){ .match-actions{ flex-direction:row; justify-content:flex-start; gap:8px} .match-form textarea{ min-height:70px; } .match-right{ margin-top:8px } }
select[multiple]{ min-height:120px; }
.empty-msg{ color:var(--mut); padding:12px; text-align:center }
.chev { transition: transform .18s ease; } .chev.open { transform: rotate(180deg); }
</style>
</head>
<body>

<!-- Top -->
<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM"/>
    <div><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <div class="nav" role="tablist" aria-label="NavegaciÃ³n">
      <button class="tab active" data-view="dash">Dashboard</button>
      <button class="tab" data-view="events">Eventos</button>
      <button class="tab" data-view="roster">Plantel</button>
      <button class="tab" data-view="matches">Partidos</button>
    </div>
  </div>
</div>

<div class="container">

  <!-- DASHBOARD -->
  <section id="v-dash">
    <div class="grid" style="align-items:stretch">
      <div class="card kpi" style="grid-column:span 6;display:flex;flex-direction:column;justify-content:space-between">
        <div>
          <h4>Plantel</h4>
          <div class="n" id="kRoster">0</div>
          <div style="font-size:var(--sub-size);color:var(--mut)">Integrantes registrados</div>
        </div>
      </div>

      <div class="card kpi" style="grid-column:span 6;display:flex;flex-direction:column;justify-content:space-between">
        <div>
          <h4>Partidos jugados</h4>
          <div class="n" id="kGames">0</div>
          <div id="lastMatchSummary" style="font-size:var(--content-size);color:var(--mut)"></div>
        </div>
        <div style="margin-top:8px;display:flex;justify-content:flex-end">
          <button class="btn s" onclick="showView('matches')">Ir a partidos</button>
        </div>
      </div>
    </div>

    <div class="grid cards-dashboard" style="margin-top:12px;grid-template-columns:repeat(12,1fr);gap:12px">
      <div class="card card-hoy" style="grid-column:span 4">
        <h4>ðŸ“… Hoy</h4>
        <div class="section-note">Eventos que ocurren hoy (fecha local).</div>
        <ul id="todayEvents" style="margin:8px 0 0 16px"></ul>
      </div>

      <div class="card card-birth-today" style="grid-column:span 4">
        <h4>ðŸŽ‚ CumpleaÃ±os â€” Hoy</h4>
        <div class="section-note">Personas del plantel que cumplen hoy</div>
        <div id="birthToday" style="margin-top:8px">â€”</div>
      </div>

      <div class="card card-week" style="grid-column:span 12;margin-top:12px">
        <h4>ðŸ“… Eventos de la semana</h4>
        <div class="section-note">Eventos de la semana actual (lunes a domingo).</div>
        <ul id="weekEvents" style="margin:8px 0 0 16px"></ul>
      </div>

      <div class="card card-birth-next" style="grid-column:span 4;margin-top:0">
        <h4>ðŸŽ‰ PrÃ³ximos cumpleaÃ±os</h4>
        <div class="section-note">Lista con los prÃ³ximos 5 cumpleaÃ±os.</div>
        <ul id="upBirth" style="margin:8px 0 0 16px"></ul>
      </div>
    </div>
  </section>

  <!-- EVENTOS -->
  <section id="v-events" style="display:none">
    <div class="card">
      <div class="month-bar">
        <div class="month-nav">
          <button class="btn s" id="btnPrevMonth">â—€</button>
          <button class="btn s" id="btnToday">Hoy</button>
          <button class="btn s" id="btnNextMonth">â–¶</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="month-title" id="monthTitle">Mes</div>
          <button class="btn p" id="btnNewEventTop">Nuevo Evento</button>
        </div>
      </div>

      <div class="section-note">El calendario muestra eventos agrupados por <strong>fecha local</strong> (YYYY-MM-DD).</div>

      <div id="monthGrid" class="month-grid"></div>
      <div id="monthList" class="month-list"></div>
    </div>
  </section>

  <!-- PLANTEL -->
  <section id="v-roster" style="display:none">
    <div class="card">
      <h4>Plantel</h4>
      <div class="section-note">Listado del plantel (tabla <code>players</code>) â€” toca una tarjeta para ver/editar.</div>
      <div id="rosterGrid" class="grid" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- PARTIDOS -->
  <section id="v-matches" style="display:none">
    <div class="card">
      <h4>Partidos jugados</h4>
      <div class="section-note">Registro de partidos: goles, diferencia y goleadoras/asistencias.</div>
      <div id="matchesList" style="margin-top:12px"></div>
    </div>
  </section>
</div>

<footer style="text-align:center;padding:16px;color:var(--mut);font-size:var(--content-size)">Golden Moms Â· hecho con ðŸ’š lima & azul</footer>

<!-- MODAL EVENTOS: mantengo completo (igual que tu versiÃ³n original) -->
<div class="modal-bg" id="modalBg" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Nuevo evento</h3>
    <div class="form-row">
      <div>
        <label>TÃ­tulo</label>
        <input id="f_title" class="input" placeholder="Ej: Entrenamiento Colegio">
      </div>
      <div>
        <label>Tipo</label>
        <select id="f_type" class="input">
          <option>Entrenamiento</option>
          <option>Partido</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>Fecha y hora</label>
        <input id="f_dt" type="datetime-local" class="input">
      </div>
      <div>
        <label>Equipo</label>
        <input id="f_team" class="input" value="Golden Moms">
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>Rival (si aplica)</label>
        <input id="f_opponent" class="input" placeholder="Rivales / Liga">
      </div>
      <div>
        <label>Uniforme</label>
        <select id="f_uniform" class="input">
          <option value="">(definir)</option>
          <option>Polera azul â€” * medias verde lima</option>
          <option>Polera verde lima â€” * medias verde lima</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>UbicaciÃ³n</label>
        <input id="f_location" class="input" placeholder="Colegio / Cancha / DirecciÃ³n">
      </div>
      <div>
        <div id="matchExtra" style="display:none">
          <label>Goles a favor</label>
          <input id="f_goals_for" class="input" type="number" min="0" placeholder="Goles a favor">
          <label style="margin-top:8px">Goles en contra</label>
          <input id="f_goals_against" class="input" type="number" min="0" placeholder="Goles en contra">
        </div>
      </div>
    </div>

    <div class="form-row" id="matchPeopleRow" style="display:none">
      <div>
        <label>Goleadoras (coma-separadas)</label>
        <input id="f_scorers" class="input" placeholder="Nombre1, Nombre2">
      </div>
      <div>
        <label>Asistencias (coma-separadas)</label>
        <input id="f_assists" class="input" placeholder="NombreA, NombreB">
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>&nbsp;</label>
        <div class="modal-actions">
          <button class="btn s" id="btnDelete" style="margin-right:auto;display:none">Eliminar</button>
          <button class="btn s" id="btnCancel">Cancelar</button>
          <button class="btn p" id="btnSave">Guardar</button>
        </div>
      </div>
      <div></div>
    </div>
  </div>
</div>

<!-- PLAYER modal: mantengo completo -->
<div class="modal-bg" id="playerModalBg" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="playerModalTitle">
    <h3 id="playerModalTitle">Jugadora</h3>

    <div style="display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:start">
      <div>
        <img id="p_img_preview" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect fill='%23f1f5f9' width='100%25' height='100%25'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='14' fill='%2364748b'>Sin foto</text></svg>" alt="foto" style="width:120px;height:120px;border-radius:8px;object-fit:cover;border:1px solid var(--b)" />
        <div class="meta-small">La foto se edita directamente en Supabase (manual)</div>
      </div>

      <div>
        <div class="form-row">
          <div>
            <label>Apodo</label>
            <input id="p_apodo" class="input" placeholder="Apodo (ej: Ale)"/>
          </div>
          <div>
            <label>Nombre completo</label>
            <input id="p_nombre" class="input" placeholder="Nombre (ej: Alejandra PÃ©rez)"/>
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div>
            <label>NÃºmero de camiseta</label>
            <input id="p_numero" class="input" placeholder="14" type="number" min="0"/>
          </div>
          <div>
            <label>Rol / PosiciÃ³n</label>
            <select id="p_rol" class="input"></select>
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div>
            <label>Equipos</label>
            <select id="p_equipos_select" class="input" multiple style="height:110px;padding:8px;overflow:auto"></select>
            <div style="margin-top:6px">
              <input id="p_equipos_extra" class="input" placeholder="Agregar equipos (separados por coma), opcional" />
              <div class="meta-small">Selecciona varios equipos (Ctrl/Cmd+click) o escribe nombres nuevos arriba.</div>
            </div>
          </div>

          <div>
            <label>Estado</label>
            <select id="p_estado" class="input"></select>
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div>
            <label>Fecha y nacimiento</label>
            <input id="p_fecha_nac" class="input" type="date"/>
          </div>
          <div>
            <label>Celular</label>
            <input id="p_celular" class="input" placeholder="+56 9 ..."/>
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div>
            <label>Tel. emergencia</label>
            <input id="p_telemer" class="input" placeholder="TelÃ©fono de emergencia"/>
          </div>
          <div>
            <label>Mail</label>
            <input id="p_email" class="input" placeholder="email@ejemplo.com"/>
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div>
            <label>RUT</label>
            <input id="p_rut" class="input" placeholder="RUT"/>
          </div>
          <div>
            <label>Seguro mÃ©dico</label>
            <input id="p_seguro" class="input" placeholder="Nombre seguro"/>
          </div>
        </div>

        <div class="form-row" style="margin-top:8px">
          <div>
            <label>Curso hijos / nota</label>
            <input id="p_curso_hijos" class="input" placeholder="Curso hijos (si aplica)"/>
          </div>
          <div></div>
        </div>

        <div class="modal-actions" style="margin-top:12px">
          <button class="btn s" id="btnDeletePlayer" style="margin-right:auto">Eliminar</button>
          <button class="btn s" id="btnCancelPlayer">Cancelar</button>
          <button class="btn p" id="btnSavePlayer">Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Supabase config ---------- */
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};
let supa = null;
async function initSupabase(timeoutMs = 8000){
  try{
    if(typeof createClient === 'function'){ supa = createClient(SUPA.url, SUPA.key); return supa; }
    if(window.supabase && typeof window.supabase.createClient === 'function'){ supa = window.supabase.createClient(SUPA.url, SUPA.key); return supa; }
    await new Promise((resolve,reject)=>{
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js';
      s.async = true;
      let done=false;
      const to=setTimeout(()=>{ if(!done){ done=true; reject(new Error('timeout cargando supabase')); }}, timeoutMs);
      s.onload=()=>{ if(done) return; done=true; clearTimeout(to); resolve(); };
      s.onerror=()=>{ if(done) return; done=true; clearTimeout(to); reject(new Error('error cargando supabase')); };
      document.head.appendChild(s);
    });
    if(typeof createClient === 'function'){ supa = createClient(SUPA.url, SUPA.key); return supa; }
    if(window.supabase && typeof window.supabase.createClient === 'function'){ supa = window.supabase.createClient(SUPA.url, SUPA.key); return supa; }
    throw new Error('SDK cargado pero no se encontrÃ³ createClient');
  }catch(err){ console.error('initSupabase error:', err); supa = null; return null; }
}

/* ---------- Helpers ---------- */
function pad(n){return n.toString().padStart(2,'0');}
function localInputToISOWithOffset(inp){ if(!inp) return null; const [d,t]=inp.split('T'); const offMin = -new Date().getTimezoneOffset(); const sign = offMin>=0?'+':'-'; const abs=Math.abs(offMin); const oh=pad(Math.floor(abs/60)); const om=pad(abs%60); return `${d}T${t}:00${sign}${oh}:${om}`; }
function isoToLocalInput(iso){ if(!iso) return ''; const d=new Date(iso); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function isoToLocalDateInput(iso){ if(!iso) return ''; const d=new Date(iso); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function localDateYMD(d){ const D=new Date(d); return `${D.getFullYear()}-${pad(D.getMonth()+1)}-${pad(D.getDate())}`; }

/* ---------- DOM refs & modal handlers (events) ---------- */
const modalBg = document.getElementById('modalBg');
const f_title = document.getElementById('f_title');
const f_type = document.getElementById('f_type');
const f_dt   = document.getElementById('f_dt');
const f_team = document.getElementById('f_team');
const f_opponent = document.getElementById('f_opponent');
const f_uniform  = document.getElementById('f_uniform');
const f_location = document.getElementById('f_location');
const f_goals_for = document.getElementById('f_goals_for');
const f_goals_against = document.getElementById('f_goals_against');
const f_scorers = document.getElementById('f_scorers');
const f_assists = document.getElementById('f_assists');
const matchExtra = document.getElementById('matchExtra');
const matchPeopleRow = document.getElementById('matchPeopleRow');
const btnDelete = document.getElementById('btnDelete');
const btnCancel = document.getElementById('btnCancel');
const btnSave   = document.getElementById('btnSave');

let editingId = null;

function openModal(opts={}) {
  document.getElementById('modalTitle').textContent = opts.existing ? 'Editar evento' : 'Nuevo evento';
  editingId = null;
  if(opts.existing){
    const e = opts.existing;
    editingId = e.id;
    f_title.value = e.title||'';
    f_type.value  = e.type||'Entrenamiento';
    f_dt.value    = isoToLocalInput(e.datetime);
    f_team.value  = e.team||'Golden Moms';
    f_opponent.value = e.opponent||'';
    f_uniform.value  = e.uniform||'';
    f_location.value = e.location||'';
    if(matchExtra) matchExtra.style.display = 'none';
    if(matchPeopleRow) matchPeopleRow.style.display = 'none';
    btnDelete.style.display='';
  }else{
    editingId = null;
    f_title.value = '';
    f_type.value  = 'Entrenamiento';
    const base = opts.date ? new Date(opts.date) : new Date();
    base.setHours(19,30,0,0);
    f_dt.value = isoToLocalInput(base.toISOString());
    f_team.value  = 'Golden Moms';
    f_opponent.value = '';
    f_uniform.value  = '';
    f_location.value = '';
    if(matchExtra) matchExtra.style.display = 'none';
    if(matchPeopleRow) matchPeopleRow.style.display = 'none';
    btnDelete.style.display='none';
    if(f_goals_for) f_goals_for.value=''; if(f_goals_against) f_goals_against.value=''; if(f_scorers) f_scorers.value=''; if(f_assists) f_assists.value='';
  }
  modalBg.style.display = 'flex';
  modalBg.setAttribute('aria-hidden','false');
}

function closeModal(){
  modalBg.style.display = 'none';
  modalBg.setAttribute('aria-hidden','true');
  editingId = null;
}
modalBg.addEventListener('click', (e) => { if (e.target === modalBg) closeModal(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
btnCancel.addEventListener('click', ()=> closeModal());

btnDelete.addEventListener('click', async ()=>{ 
  if(!editingId) return;
  if(!confirm('Â¿Eliminar este evento?')) return;
  if(!supa){ alert('No conectado a Supabase.'); closeModal(); return; }
  try{
    await supa.from('events').delete().eq('id', editingId);
    await supa.from('matches').delete().eq('event_id', editingId);
  }catch(err){
    console.warn('Error eliminando', err);
    alert('Error eliminado. Revisa consola.');
  }
  closeModal();
  renderMonth();
  renderDash();
});

btnSave.addEventListener('click', async ()=>{
  const title = f_title.value.trim();
  const type  = f_type.value;
  const team  = f_team.value.trim();
  const opponent = f_opponent.value.trim();
  const uniform  = f_uniform.value;
  const location = f_location.value.trim();
  if(!title || !f_dt.value){ alert('Completa tÃ­tulo y fecha/hora'); return; }
  if(!supa){ alert('No conectado a Supabase. Revisa la consola.'); closeModal(); return; }

  const datetime = localInputToISOWithOffset(f_dt.value);
  const payloadEvent = { title, type, team, opponent, uniform, location, datetime };

  try{
    if(editingId){
      const { error } = await supa.from('events').update(payloadEvent).eq('id', editingId);
      if(error) throw error;
    } else {
      const { data:inserted, error } = await supa.from('events').insert([payloadEvent]).select();
      if(error) throw error;
      const newEvent = inserted && inserted[0];
      if(type === 'Partido' && newEvent){
        const goalsFor = f_goals_for && f_goals_for.value ? parseInt(f_goals_for.value) : null;
        const goalsAgainst = f_goals_against && f_goals_against.value ? parseInt(f_goals_against.value) : null;
        const diff = (goalsFor!=null && goalsAgainst!=null) ? (goalsFor - goalsAgainst) : null;
        const matchPayload = {
          event_id: newEvent.id,
          goals_for: goalsFor,
          goals_against: goalsAgainst,
          goal_difference: diff,
          scorers: f_scorers && f_scorers.value ? f_scorers.value.split(',').map(s=>s.trim()).filter(Boolean) : [],
          assists: f_assists && f_assists.value ? f_assists.value.split(',').map(s=>s.trim()).filter(Boolean) : []
        };
        try{ await supa.from('matches').insert([matchPayload]); }catch(err){ console.warn('Error guardando match', err); }
      }
    }
  }catch(err){
    alert('Error al guardar: '+(err.message||err));
    console.error(err);
    return;
  }

  closeModal();
  renderMonth();
  renderDash();
});

/* ---------- calendar & rendering (kept intact) ---------- */
let monthCursor = new Date();
let cachedEvents = [];
const monthTitle = document.getElementById('monthTitle');
const monthGrid = document.getElementById('monthGrid');
const monthList = document.getElementById('monthList');

function getMonthRange(d){
  const first = new Date(d.getFullYear(), d.getMonth(), 1);
  const last = new Date(d.getFullYear(), d.getMonth()+1, 0);
  let start = new Date(first);
  let dow = (start.getDay()+6)%7;
  start.setDate(start.getDate()-dow);
  let end = new Date(last);
  let dow2 = (end.getDay()+6)%7;
  end.setDate(end.getDate() + (6-dow2));
  return {start, end};
}

async function fetchEventsRange(start,end){
  if(!supa){ console.warn('fetchEventsRange: Supabase no disponible'); return []; }
  try{
    const {data, error} = await supa.from("events").select("*").gte("datetime", start.toISOString()).lte("datetime", end.toISOString()).order("datetime", {ascending:true});
    if(error){ console.error(error); return []; }
    return data || [];
  }catch(err){ console.error('fetchEventsRange error', err); return []; }
}

function renderMonthTitle(){
  const m = monthCursor.toLocaleString('es-CL',{month:'long',year:'numeric'});
  monthTitle.textContent = m.charAt(0).toUpperCase()+m.slice(1);
}

async function renderMonth(){
  renderMonthTitle();
  const {start,end} = getMonthRange(monthCursor);
  cachedEvents = await fetchEventsRange(start,end);
  if(window.matchMedia('(max-width:420px)').matches){
    if(monthGrid) monthGrid.style.display = 'none';
    if(monthList) monthList.style.display = 'block';
    drawMonthList(start,end);
  } else {
    if(monthList) monthList.style.display = 'none';
    if(monthGrid) monthGrid.style.display = '';
    drawMonthGrid(start,end);
  }
}

function drawMonthGrid(start,end){
  if(!monthGrid) return;
  monthGrid.innerHTML='';
  const days = [];
  let d = new Date(start);
  while(d<=end){
    days.push(new Date(d));
    d.setDate(d.getDate()+1);
  }

  const todayYMD = localDateYMD(new Date());

  for(const day of days){
    const cell = document.createElement('div');
    cell.className='day';
    const head = document.createElement('div');
    head.className='day-head';

    const wk = day.toLocaleDateString('es-CL',{weekday:'short'}).replace(/\./g,''); // "lun", "mar", etc.
    const dayStrLocal = localDateYMD(day);
    const isToday = dayStrLocal === todayYMD;

    head.innerHTML = `<div class="day-num-box">
        <div class="day-wk-grid">${wk}</div>
        <div class="day-n">${pad(day.getDate())}</div>
      </div>
      `;

    const plusBtn = document.createElement('button');
    plusBtn.className = 'day-add';
    plusBtn.title = 'Nuevo evento';
    plusBtn.innerText = '+';
    plusBtn.onclick = ()=> openModal({ date: day });

    head.querySelectorAll && cell.appendChild(head);
    cell.appendChild(head);
    cell.appendChild(plusBtn);

    if(isToday){
      cell.classList.add('today');
      cell.setAttribute('aria-current','date');
    }

    const events = (cachedEvents || []).filter(e => localDateYMD(new Date(e.datetime)) === dayStrLocal);

    for(const e of events){
      const ev = document.createElement('div');
      ev.className='ev '+(e.type==='Entrenamiento'?'ev-train':'ev-match');
      ev.innerHTML = `<div class="title">${e.title}</div>`;
      ev.onclick=()=>openModal({ existing:e });
      cell.appendChild(ev);
    }
    monthGrid.appendChild(cell);
    if(day.getDay() === 0){
      const sep = document.createElement('div');
      sep.className = 'week-sep';
      monthGrid.appendChild(sep);
    }
  }
}

function drawMonthList(start,end){
  if(!monthList) return;
  monthList.innerHTML='';
  const days=[];
  let d=new Date(start);
  while(d<=end){ days.push(new Date(d)); d.setDate(d.getDate()+1); }

  const todayYMD = localDateYMD(new Date());

  for(const day of days){
    const dayStrLocal = localDateYMD(day);
    const events = (cachedEvents || []).filter(e => localDateYMD(new Date(e.datetime)) === dayStrLocal);
    const row = document.createElement('div'); row.className='day';

    if(dayStrLocal === todayYMD){
      row.classList.add('today');
      row.setAttribute('aria-current','date');
    }

    const dateBox = document.createElement('div'); dateBox.className='day-date';
    const wk = day.toLocaleDateString('es-CL',{weekday:'short'}).replace(/\./g,''); // "lun", "mar", etc.
    dateBox.innerHTML = `<div class="day-wk">${wk}</div><div class="day-num">${pad(day.getDate())}</div>`;

    const col = document.createElement('div'); col.className='events-column';

    const plus = document.createElement('button');
    plus.className = 'day-add';
    plus.title = 'Nuevo evento';
    plus.innerText = '+';
    plus.onclick = ()=> openModal({ date: day });

    if(events.length){
      for(const e of events){
        const ev = document.createElement('div'); ev.className='ev '+(e.type==='Entrenamiento'?'ev-train':'ev-match');
        ev.innerHTML = `<div class="title">${e.title}</div>`;
        ev.onclick=()=> openModal({ existing:e });
        col.appendChild(ev);
      }
    } else {
      const n = document.createElement('div'); n.style.color='var(--mut)'; n.style.fontSize='var(--content-size)'; n.innerText='â€”';
      col.appendChild(n);
    }

    row.appendChild(dateBox);
    row.appendChild(col);
    row.appendChild(plus);
    monthList.appendChild(row);

    if(day.getDay() === 0){
      const sep = document.createElement('div');
      sep.className = 'week-sep';
      monthList.appendChild(sep);
    }
  }
}

/* ---------- dashboard & roster (kept intact) ---------- */
async function renderDash(){
  try{
    const now = new Date();
    const weekStart = new Date(now);
    weekStart.setDate(weekStart.getDate() - ((weekStart.getDay()+6)%7));
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate()+6);
    const todayStrLocal = localDateYMD(now);

    let evs = [];
    if(supa){
      const {data:events, error} = await supa.from("events").select("*").gte("datetime", weekStart.toISOString()).lte("datetime", weekEnd.toISOString()).order("datetime",{ascending:true});
      if(error){ console.warn('renderDash events error', error); evs = []; } else evs = events || [];
    } else evs = [];

    let players = [];
    if(supa){
      try{ const resPlayers = await supa.from("players").select("*"); if(resPlayers && resPlayers.data) players = resPlayers.data; }catch(err){ console.warn('Error cargando players', err); players = []; }
    } else players = [];
    document.getElementById('kRoster').textContent = (players||[]).length || 0;

    const matchesPlayed = evs.filter(e=> e.type==='Partido' && new Date(e.datetime) < now);
    document.getElementById('kGames').textContent = matchesPlayed.length;
    if(matchesPlayed.length>0){
      const last = matchesPlayed.sort((a,b)=> new Date(b.datetime)-new Date(a.datetime))[0];
      const d = new Date(last.datetime);
      document.getElementById('lastMatchSummary').textContent = `${last.title} â€” ${d.toLocaleDateString('es-CL',{day:'2-digit',month:'short'})}`;
    } else {
      document.getElementById('lastMatchSummary').textContent = 'Sin partidos jugados aÃºn';
    }

    const upB = document.getElementById("upBirth"); upB.innerHTML = '';
    const birthTodayEl = document.getElementById('birthToday'); birthTodayEl.innerHTML = 'â€”';
    try{
      if(supa){
        const { data:vw, error:vwErr } = await supa.from("vw_upcoming_birthdays").select("*").order("proximo_cumple",{ascending:true}).limit(5);
        if(vw && vw.length){
          const seen = new Set();
          const uniq = [];
          for(const p of vw){
            if(!seen.has(p.id)){
              seen.add(p.id);
              uniq.push(p);
              if(uniq.length>=5) break;
            }
          }
          uniq.forEach(p=>{
            if(p.proximo_cumple){
              const bd = new Date(p.proximo_cumple);
              const li = document.createElement('li');
              li.innerHTML = `${p.apodo||p.nombre} â€” ${bd.toLocaleDateString("es-CL",{day:"2-digit",month:"short"})}`;
              upB.appendChild(li);
            }
          });
          const todayList = uniq.filter(p => p.proximo_cumple && localDateYMD(new Date(p.proximo_cumple)) === todayStrLocal);
          if(todayList.length>0){
            birthTodayEl.innerHTML = '<ul style="margin:6px 0 0 16px">' + todayList.map(p=>`<li><strong>${p.apodo||p.nombre}</strong> ${p.edad? 'â€” '+p.edad+' aÃ±os':''}</li>`).join('') + '</ul>';
          } else {
            birthTodayEl.innerHTML = '<div class="no-birth">Hoy no hay cumpleaÃ±os</div>';
          }
        } else {
          upB.innerHTML = '<li style="color:var(--mut)">No hay datos de cumpleaÃ±os</li>';
          birthTodayEl.innerHTML = '<div class="no-birth">Hoy no hay cumpleaÃ±os</div>';
        }
      } else {
        upB.innerHTML = '<li style="color:var(--mut)">Sin conexiÃ³n â€” no se pudieron cargar cumpleaÃ±os</li>';
        birthTodayEl.innerHTML = '<div class="no-birth">Hoy no hay cumpleaÃ±os (offline)</div>';
      }
    }catch(err){
      console.warn('Error trayendo cumpleaÃ±os', err);
      upB.innerHTML = '<li style="color:var(--mut)">Error cargando datos</li>';
      birthTodayEl.innerHTML = '<div class="no-birth">Hoy no hay cumpleaÃ±os</div>';
    }

    const todayEl = document.getElementById('todayEvents'); todayEl.innerHTML = '';
    evs.filter(e => localDateYMD(new Date(e.datetime)) === todayStrLocal)
      .forEach(e=>{
        const d = new Date(e.datetime);
        const li = document.createElement('li');
        li.innerHTML = `<strong>${e.title}</strong> â€” ${d.toLocaleString("es-CL",{weekday:'short',hour:'2-digit',minute:'2-digit'})}`;
        todayEl.appendChild(li);
      });
    if(todayEl.innerHTML.trim()==='') todayEl.innerHTML = '<div style="color:var(--mut)">No hay eventos hoy</div>';

    const wEl = document.getElementById('weekEvents'); wEl.innerHTML = '';
    evs.forEach(e=>{
      const d = new Date(e.datetime);
      const li = document.createElement('li');
      li.innerHTML = `<strong>${e.title}</strong> â€” ${d.toLocaleString("es-CL",{weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"})}`;
      wEl.appendChild(li);
    });
    if(wEl.innerHTML.trim()==='') wEl.innerHTML = '<div style="color:var(--mut)">No hay eventos esta semana</div>';

    /* ---------- ROSTER rendering: only photo, apodo, nombre (click opens modal) ---------- */
    const rosterGrid = document.getElementById('rosterGrid'); rosterGrid.innerHTML = '';
    try{
      if(supa){
        const { data:playersList } = await supa.from('players').select('*').order('apodo',{ascending:true});
        if(playersList && playersList.length){
          playersList.forEach(p=>{
            const c = document.createElement('div');
            c.className = 'card';
            c.onclick = ()=> openPlayerModal(p);

            if(p.foto){
              const img = document.createElement('img');
              img.className = 'player-photo';
              img.src = p.foto;
              img.alt = p.apodo || p.nombre || 'Jugador';
              c.appendChild(img);
            } else {
              const ph = document.createElement('div');
              ph.className = 'jersey-placeholder';
              ph.textContent = p.numero_camiseta ? String(p.numero_camiseta) : 'ðŸ‘•';
              c.appendChild(ph);
            }

            const text = document.createElement('div');
            text.className = 'roster-text';
            const ap = document.createElement('div'); ap.className = 'roster-apodo'; ap.textContent = p.apodo || 'Sin apodo';
            const nm = document.createElement('div'); nm.className = 'roster-nombre'; nm.textContent = p.nombre ? `(${p.nombre})` : '';
            text.appendChild(ap); text.appendChild(nm);

            c.appendChild(text);
            rosterGrid.appendChild(c);
          });
        } else rosterGrid.innerHTML = '<div style="color:var(--mut)">No hay jugadores registrados</div>';
      } else rosterGrid.innerHTML = '<div style="color:var(--mut)">Sin conexiÃ³n â€” no se pudo cargar plantel</div>';
    }catch(err){
      console.warn('Error cargando roster', err);
      rosterGrid.innerHTML = '<div style="color:var(--mut)">Error cargando plantel</div>';
    }

  }catch(err){
    console.error(err);
    document.getElementById('birthToday').innerHTML = '<div class="no-birth">Hoy no hay cumpleaÃ±os</div>';
  }
}

/* ====== PARTIDOS: funciones aÃ±adidas (responsive + histÃ³rico por mes) ====== */
/* cache de plantel */
let PLAYERS_CACHE = null; // [{id, label, nombre, apodo}, ...]
let PLAYERS_MAP = null;   // id -> etiqueta visible

async function loadPlayersCache(){
  if(PLAYERS_CACHE) return PLAYERS_CACHE;
  if(!supa) return [];
  const { data, error } = await supa.from('players').select('id, apodo, nombre').order('apodo',{ascending:true});
  if(error){ console.warn('loadPlayersCache error', error); return []; }
  PLAYERS_CACHE = (data||[]).map(p=>{
    const label = p.apodo?.trim() || p.nombre?.trim() || 'Sin nombre';
    return { id: p.id, label, nombre: p.nombre||'', apodo: p.apodo||'' };
  });
  PLAYERS_MAP = Object.fromEntries(PLAYERS_CACHE.map(p=>[p.id, p.label]));
  return PLAYERS_CACHE;
}

function labelsFromIds(ids){
  if(!ids || !ids.length) return 'â€”';
  return ids.map(i=> PLAYERS_MAP?.[i] || i).join(', ');
}

async function upsertMatchByEventId(eventId, payload){
  const { data:existing, error:e1 } = await supa.from('matches').select('id').eq('event_id', eventId).limit(1);
  if(e1){ console.warn('select matches error', e1); }
  if(existing && existing.length){
    const { error } = await supa.from('matches').update(payload).eq('event_id', eventId);
    return { error };
  }else{
    const { error } = await supa.from('matches').insert([{ event_id: eventId, ...payload }]);
    return { error };
  }
}

/* renderMatches: upcoming + historic (grouped by month) */
async function renderMatches(){
  const container = document.getElementById('matchesList');
  container.innerHTML = 'Cargando...';

  if(!supa){ container.innerHTML = '<div style="color:var(--mut)">Sin conexiÃ³n â€” no se pueden cargar partidos</div>'; return; }

  try{
    // traer eventos tipo Partido
    const { data:events = [], error: evErr } = await supa.from('events')
      .select('id, title, datetime, team, opponent, location, type')
      .eq('type','Partido')
      .order('datetime',{ascending:true});
    if(evErr){ throw evErr; }

    // traer matches
    const { data:matches = [], error: mErr } = await supa.from('matches')
      .select('id, event_id, goals_for, goals_against, goal_difference, observation, scorer_ids, scorers');
    if(mErr){ console.warn('matches select error', mErr); }

    const byEvent = {};
    (matches||[]).forEach(m=>{ byEvent[m.event_id] = m; });

    // separar upcoming y past
    const now = new Date();
    const upcoming = (events || []).filter(e => !e.datetime || new Date(e.datetime) >= now).sort((a,b)=> new Date(a.datetime) - new Date(b.datetime));
    const past = (events || []).filter(e => e.datetime && new Date(e.datetime) < now).sort((a,b)=> new Date(b.datetime) - new Date(a.datetime));

    // carga players
    await loadPlayersCache();

    // render
    container.innerHTML = '';

    // PrÃ³ximos
    const upTitle = document.createElement('div'); upTitle.className='match-head'; upTitle.style.marginBottom='6px'; upTitle.textContent = 'PrÃ³ximos partidos';
    container.appendChild(upTitle);
    if(upcoming.length===0){
      const e = document.createElement('div'); e.className='empty-msg'; e.textContent='No hay partidos prÃ³ximos.'; container.appendChild(e);
    } else {
      for(const ev of upcoming){
        const m = byEvent[ev.id] || {};
        container.appendChild(createMatchRow(ev,m,false));
      }
    }

    // HistÃ³rico agrupado por mes
    const histTitle = document.createElement('div'); histTitle.className='match-head'; histTitle.style.margin='14px 0 6px 0'; histTitle.textContent = 'HistÃ³rico por mes';
    container.appendChild(histTitle);
    if(past.length===0){
      const e = document.createElement('div'); e.className='empty-msg'; e.textContent='No hay partidos en el histÃ³rico.'; container.appendChild(e);
    } else {
      const groups = {};
      for(const ev of past){
        const d = new Date(ev.datetime);
        const key = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
        if(!groups[key]) groups[key] = { events: [], date: d };
        groups[key].events.push(ev);
      }
      const keys = Object.keys(groups).sort((a,b)=> a<b?1:-1);
      keys.forEach((key, idx)=>{
        const g = groups[key];
        const monthLabel = g.date.toLocaleDateString('es-CL',{month:'short', year:'numeric'});
        const node = document.createElement('div'); node.className='month-accordion';
        const header = document.createElement('div'); header.className='month-header';
        header.innerHTML = `<div><strong>${monthLabel}</strong> <span class="month-count">Â· ${g.events.length} partido(s)</span></div><div style="display:flex;align-items:center;gap:8px"><button class="btn s" aria-expanded="false">${idx===0?'Colapsar':'Expandir'}</button><span class="chev ${idx===0?'open':''}">&#9660;</span></div>`;
        const body = document.createElement('div'); body.className='month-body'; body.style.display = idx===0 ? 'block' : 'none';
        g.events.sort((a,b)=> new Date(b.datetime) - new Date(a.datetime)).forEach(ev=> body.appendChild(createMatchRow(ev, byEvent[ev.id]||{}, true)));
        header.addEventListener('click', ()=>{
          const visible = body.style.display !== 'none';
          body.style.display = visible ? 'none' : 'block';
          const btn = header.querySelector('button'); const chev = header.querySelector('.chev');
          btn.textContent = visible ? 'Expandir' : 'Colapsar';
          if(chev) chev.classList.toggle('open', !visible);
          header.scrollIntoView({behavior:'smooth', block:'center'});
        });
        node.appendChild(header); node.appendChild(body); container.appendChild(node);
      });
    }

  }catch(err){
    console.error('renderMatches error', err);
    container.innerHTML = '<div style="color:var(--mut)">Error cargando partidos</div>';
  }
}

/* crea la fila de partido con editor (usa PLAYERS_CACHE) */
function createMatchRow(ev, m, isPast){
  const row = document.createElement('div'); row.className='match-row';
  const d = ev.datetime ? new Date(ev.datetime) : null;
  const dateTxt = d ? d.toLocaleDateString('es-CL',{weekday:'short', day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'}) : '';

  const left = document.createElement('div');
  left.innerHTML = `<div class="match-head">${ev.title || ((ev.team||'GM') + (ev.opponent? (' vs '+ev.opponent) : ''))}</div>
    <div class="match-meta">${dateTxt}${ev.location ? ' Â· ' + ev.location : ''}</div>
    <div class="match-compact">
      <div><strong>Marcador</strong>: ${m.goals_for ?? 'â€”'} : ${m.goals_against ?? 'â€”'} ${m.goal_difference!=null ? '(Dif: '+m.goal_difference+')' : ''}</div>
      <div style="margin-top:6px"><strong>Goleadoras</strong>: ${renderScorersText(m)}</div>
      <div style="margin-top:6px"><strong>ObservaciÃ³n</strong>: ${m.observation ? escapeHtml(m.observation) : 'â€”'}</div>
    </div>`;

  const right = document.createElement('div'); right.className='match-right';
  const form = document.createElement('div'); form.className='match-form';

  const inputGF = document.createElement('input'); inputGF.type='number'; inputGF.min='0'; inputGF.placeholder='Goles a favor'; inputGF.value = (m.goals_for != null) ? m.goals_for : '';
  const inputGA = document.createElement('input'); inputGA.type='number'; inputGA.min='0'; inputGA.placeholder='Goles en contra'; inputGA.value = (m.goals_against != null) ? m.goals_against : '';

  const scorerSel = document.createElement('select'); scorerSel.multiple = true; scorerSel.setAttribute('aria-label','Seleccionar goleadoras');
  const preIds = Array.isArray(m.scorer_ids) ? m.scorer_ids : [];
  (PLAYERS_CACHE || []).forEach(p=>{ const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.label; if(preIds.includes(p.id)) opt.selected=true; scorerSel.appendChild(opt); });

  const obs = document.createElement('textarea'); obs.placeholder='ObservaciÃ³n del partido'; obs.value = m.observation || '';

  const actions = document.createElement('div'); actions.className='match-actions';
  const btnClear = document.createElement('button'); btnClear.className='btn s'; btnClear.textContent='Borrar marcador';
  btnClear.onclick = async ()=>{ try{ await upsertMatchByEventId(ev.id, { goals_for:null, goals_against:null, goal_difference:null, observation:null, scorer_ids:[] }); await renderMatches(); await renderDash(); }catch(err){ alert('Error borrando: '+(err.message||err)); console.error(err); } };

  const btnSave = document.createElement('button'); btnSave.className='btn p'; btnSave.textContent='Guardar';
  btnSave.onclick = async ()=>{ try{ const gf = inputGF.value===''?null:Number(inputGF.value); const ga = inputGA.value===''?null:Number(inputGA.value); const diff = (gf!=null && ga!=null)?(gf-ga):null; const ids = Array.from(scorerSel.selectedOptions).map(o=>o.value); const payload = { goals_for:gf, goals_against:ga, goal_difference:diff, observation: obs.value.trim()||null, scorer_ids: ids }; const { error } = await upsertMatchByEventId(ev.id, payload); if(error){ alert('Error al guardar: '+error.message); return; } await renderMatches(); await renderDash(); }catch(err){ alert('Error guardando: '+(err.message||err)); console.error(err); } };

  actions.appendChild(btnClear); actions.appendChild(btnSave);

  form.appendChild(inputGF); form.appendChild(inputGA); form.appendChild(scorerSel); form.appendChild(obs);
  right.appendChild(form); right.appendChild(actions);
  row.appendChild(left); row.appendChild(right);
  return row;
}

function renderScorersText(m){
  if(!m) return 'â€”';
  if(Array.isArray(m.scorer_ids) && m.scorer_ids.length && PLAYERS_MAP){
    return m.scorer_ids.map(id => PLAYERS_MAP[id] || id).join(', ');
  }
  if(Array.isArray(m.scorers) && m.scorers.length) return m.scorers.join(', ');
  return 'â€”';
}
function escapeHtml(s){ if(!s) return s; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------- PLAYER modal logic & teams multi-select & enums (kept intact) ---------- */
const playerModalBg = document.getElementById('playerModalBg');
const p_img_preview = document.getElementById('p_img_preview');
const p_apodo = document.getElementById('p_apodo');
const p_nombre = document.getElementById('p_nombre');
const p_numero = document.getElementById('p_numero');
const p_rol = document.getElementById('p_rol');
const p_equipos_extra = document.getElementById('p_equipos_extra');
const p_fecha_nac = document.getElementById('p_fecha_nac');
const p_celular = document.getElementById('p_celular');
const p_telemer = document.getElementById('p_telemer');
const p_email = document.getElementById('p_email');
const p_rut = document.getElementById('p_rut');
const p_seguro = document.getElementById('p_seguro');
const p_curso_hijos = document.getElementById('p_curso_hijos');
const btnSavePlayer = document.getElementById('btnSavePlayer');
const btnDeletePlayer = document.getElementById('btnDeletePlayer');
const btnCancelPlayer = document.getElementById('btnCancelPlayer');

let currentPlayerId = null;
let teamsCache = null;

const DEFAULT_TEAMS = ['Golden Moms','Golden Dream','Golden Power'];
const DEFAULT_ESTADOS = ['activo','reposo'];
const DEFAULT_ROLES = ['jugadora','capitana','dt','admin'];

async function loadTeamsOptions(selectedCsv){
  const sel = document.getElementById('p_equipos_select');
  sel.innerHTML = '';
  try{
    let set = new Set(DEFAULT_TEAMS);
    if(supa){
      if(!teamsCache){
        const { data } = await supa.from('players').select('equipos');
        (data||[]).forEach(r=>{
          if(r && r.equipos){
            r.equipos.split(',').map(s=>s.trim()).filter(Boolean).forEach(t=>set.add(t));
          }
        });
        teamsCache = Array.from(set).sort();
      } else {
        teamsCache.forEach(t=>set.add(t));
      }
    }
    const arr = Array.from(set).sort();
    arr.forEach(t=>{
      const o = document.createElement('option');
      o.value = t; o.textContent = t;
      sel.appendChild(o);
    });
    const selected = (selectedCsv||'').split(',').map(s=>s.trim()).filter(Boolean);
    for(const opt of sel.options){ if(selected.includes(opt.value)) opt.selected = true; }
    const extras = selected.filter(s=> !arr.includes(s) );
    p_equipos_extra.value = extras.join(', ');
  }catch(err){
    console.warn('loadTeamsOptions error', err);
    const fallbackArr = Array.from(new Set([ ...DEFAULT_TEAMS, ...(selectedCsv ? selectedCsv.split(',').map(x=>x.trim()) : []) ])).sort();
    fallbackArr.forEach(t=>{
      const o = document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o);
    });
    const selected = (selectedCsv||'').split(',').map(s=>s.trim()).filter(Boolean);
    for(const opt of sel.options){ if(selected.includes(opt.value)) opt.selected = true; }
    const extras = selected.filter(s=> !fallbackArr.includes(s) );
    p_equipos_extra.value = extras.join(', ');
  }
}

async function loadEnums(selectedEstado, selectedRol){
  const estadoSel = document.getElementById('p_estado');
  const rolSel = document.getElementById('p_rol');
  estadoSel.innerHTML = '';
  rolSel.innerHTML = '';
  try{
    let estadosSet = new Set(DEFAULT_ESTADOS);
    let rolesSet = new Set(DEFAULT_ROLES);
    if(supa){
      const { data } = await supa.from('players').select('Estado, rol');
      (data||[]).forEach(r=>{
        if(r && r.Estado) estadosSet.add(r.Estado);
        if(r && r.rol) rolesSet.add(r.rol);
      });
    }
    const estadosArr = Array.from(estadosSet).filter(Boolean).sort();
    const rolesArr = Array.from(rolesSet).filter(Boolean).sort();
    const emptyOpt = document.createElement('option'); emptyOpt.value = ''; emptyOpt.textContent = '(definir)';
    estadoSel.appendChild(emptyOpt.cloneNode(true));
    estadosArr.forEach(e=>{
      const o = document.createElement('option'); o.value = e; o.textContent = e;
      if(selectedEstado && selectedEstado === e) o.selected = true;
      estadoSel.appendChild(o);
    });
    rolSel.appendChild(emptyOpt.cloneNode(true));
    rolesArr.forEach(r=>{
      const o = document.createElement('option'); o.value = r; o.textContent = r;
      if(selectedRol && selectedRol === r) o.selected = true;
      rolSel.appendChild(o);
    });
    if(selectedEstado && !estadosArr.includes(selectedEstado)){
      const o = document.createElement('option'); o.value = selectedEstado; o.textContent = selectedEstado; o.selected=true;
      estadoSel.appendChild(o);
    }
    if(selectedRol && !rolesArr.includes(selectedRol)){
      const o = document.createElement('option'); o.value = selectedRol; o.textContent = selectedRol; o.selected=true;
      rolSel.appendChild(o);
    }
  }catch(err){
    console.warn('loadEnums error', err);
    const estadosArr = DEFAULT_ESTADOS;
    const rolesArr = DEFAULT_ROLES;
    const emptyOpt = document.createElement('option'); emptyOpt.value = ''; emptyOpt.textContent = '(definir)';
    estadoSel.appendChild(emptyOpt.cloneNode(true));
    estadosArr.forEach(e=>{ const o=document.createElement('option'); o.value=e; o.textContent=e; if(selectedEstado===e) o.selected=true; estadoSel.appendChild(o); });
    rolSel.appendChild(emptyOpt.cloneNode(true));
    rolesArr.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; if(selectedRol===r) o.selected=true; rolSel.appendChild(o); });
  }
}

function openPlayerModal(player){
  currentPlayerId = player.id;
  document.getElementById('playerModalTitle').textContent = player.apodo ? `${player.apodo} (${player.nombre || ''})` : (player.nombre || 'Jugadora');
  p_img_preview.src = player.foto || "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect fill='%23f1f5f9' width='100%25' height='100%25'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='14' fill='%2364748b'>Sin foto</text></svg>";
  p_apodo.value = player.apodo || '';
  p_nombre.value = player.nombre || '';
  p_numero.value = player.numero_camiseta != null ? player.numero_camiseta : '';
  loadEnums(player.Estado || player.estado || '', player.rol || '');
  const equiposCsv = player.equipos || '';
  loadTeamsOptions(equiposCsv);
  p_fecha_nac.value = player.fecha_nacimiento ? isoToLocalDateInput(player.fecha_nacimiento) : '';
  p_celular.value = player.celular || '';
  p_telemer.value = player.Telefono_emergencia || '';
  p_email.value = player.email || '';
  p_rut.value = player.Rut || '';
  p_seguro.value = player.Seguro_Medico || '';
  p_curso_hijos.value = player.Curso_hijos || '';
  playerModalBg.style.display = 'flex';
  playerModalBg.setAttribute('aria-hidden','false');
}

function closePlayerModal(){ 
  playerModalBg.style.display = 'none';
  playerModalBg.setAttribute('aria-hidden','true');
  currentPlayerId = null;
}
btnCancelPlayer.addEventListener('click', ()=> closePlayerModal());
playerModalBg.addEventListener('click', (e)=>{ if(e.target === playerModalBg) closePlayerModal(); });

btnSavePlayer.addEventListener('click', async ()=>{
  if(!supa){ alert('No conectado a Supabase.'); return; }
  if(!currentPlayerId){ alert('No hay jugadora seleccionada'); return; }

  const sel = document.getElementById('p_equipos_select');
  const selected = Array.from(sel.selectedOptions).map(o=>o.value.trim()).filter(Boolean);
  const extraTxt = p_equipos_extra.value || '';
  const extra = extraTxt.split(',').map(s=>s.trim()).filter(Boolean);
  const all = Array.from(new Set([...(selected||[]), ...extra]));
  const equiposCsv = all.length ? all.join(',') : null;

  const payload = {
    apodo: p_apodo.value.trim() || null,
    nombre: p_nombre.value.trim() || null,
    numero_camiseta: p_numero.value !== '' ? (isNaN(Number(p_numero.value)) ? null : Number(p_numero.value)) : null,
    rol: document.getElementById('p_rol').value || null,
    equipos: equiposCsv,
    Estado: document.getElementById('p_estado').value || null,
    fecha_nacimiento: p_fecha_nac.value ? new Date(p_fecha_nac.value).toISOString() : null,
    celular: p_celular.value.trim() || null,
    Telefono_emergencia: p_telemer.value.trim() || null,
    email: p_email.value.trim() || null,
    Rut: p_rut.value.trim() || null,
    Seguro_Medico: p_seguro.value.trim() || null,
    Curso_hijos: p_curso_hijos.value.trim() || null
  };

  try{
    const { error } = await supa.from('players').update(payload).eq('id', currentPlayerId);
    if(error) throw error;
    closePlayerModal();
    renderMonth();
    renderDash();
  }catch(err){
    console.error('Error actualizando player:', err);
    alert('Error guardando cambios. Revisa consola.');
  }
});

btnDeletePlayer.addEventListener('click', async ()=>{
  if(!currentPlayerId) return;
  if(!confirm('Â¿Eliminar a esta jugadora? Esta acciÃ³n no se puede deshacer.')) return;
  try{
    const { error } = await supa.from('players').delete().eq('id', currentPlayerId);
    if(error) throw error;
    closePlayerModal();
    renderMonth();
    renderDash();
  }catch(err){
    console.error('Error eliminando player:', err);
    alert('Error eliminando. Revisa consola.');
  }
});

/* ---------- init ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  await initSupabase();

  // Nav buttons wiring + persist view on click
  document.querySelectorAll('.nav .tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const view = btn.dataset.view;
      try{ localStorage.setItem('gm_view', view); }catch(e){}
      showView(view);
    });
  });

  const persisted = (function(){ try{ return localStorage.getItem('gm_view'); }catch(e){return null;} })();
  const activeTab = document.querySelector('.nav .tab.active');
  const initialView = persisted || (activeTab ? activeTab.dataset.view : 'dash');
  document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
  const btnToActivate = document.querySelector(`.nav .tab[data-view="${initialView}"]`);
  if(btnToActivate) btnToActivate.classList.add('active');

  showView(initialView);
  closeModal();
});

/* showView */
function showView(v){
  ['dash','events','roster','matches'].forEach(id=>{
    const el = document.getElementById('v-'+id);
    if(el) el.style.display='none';
  });
  const target = document.getElementById('v-'+v) || document.getElementById('v-matches');
  if(target) target.style.display='block';
  if(v==='dash') renderDash();
  if(v==='events') renderMonth();
  if(v==='matches') renderMatches();
  if(v==='roster') renderDash(); // renderDash refreshes roster
}
</script>
</body>
</html>
