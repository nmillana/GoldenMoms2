<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms — Plantel (simple)</title>
<link rel="icon" href="Logo.webp"/>
<style>
  :root{--blue:#0f3a78;--lime:#9be22d;--mut:#64748b;--b:#e2e8f0}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,Arial,sans-serif;background:#f7f8fa;color:#0f172a}
  .top{display:flex;align-items:center;gap:12px;padding:12px;background:#fff;border-bottom:1px solid var(--b)}
  .logo{display:flex;align-items:center;gap:10px}
  .logo img{width:44px;height:44px;border-radius:50%}
  .nav{margin-left:auto;display:flex;gap:8px}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--b);background:#fff;cursor:pointer}
  .tab.active{background:var(--blue);color:#fff}
  .wrap{max-width:900px;margin:18px auto;padding:0 12px}
  .card{background:#fff;border:1px solid var(--b);border-radius:12px;padding:12px}
  #status{margin:10px 0;padding:10px;border-radius:8px;background:#fff;border:1px solid var(--b);color:var(--mut)}
  #roster{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-top:12px}
  .player{background:#fff;border:1px solid var(--b);border-radius:10px;padding:10px;text-align:center;cursor:pointer}
  .avatar{width:64px;height:64px;border-radius:50%;overflow:hidden;margin:0 auto 8px;background:#f1f5f9;display:flex;align-items:center;justify-content:center}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .apodo{font-weight:700;color:var(--blue)}
  .nombre{font-size:13px;color:var(--mut)}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid var(--b);background:#fff;cursor:pointer}
  .btn.p{background:var(--lime);border-color:#a3e635}
  /* modal */
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:flex-start;justify-content:center;padding-top:6vh;z-index:999}
  .modal{width:min(720px,96%);background:#fff;border-radius:12px;padding:14px;border:1px solid var(--b)}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
  .input{width:100%;padding:8px;border-radius:8px;border:1px solid var(--b)}
  .team-list{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:6px 8px;border-radius:999px;border:1px solid var(--b);cursor:pointer}
  .chip.sel{background:#eaffd6}
  .small{font-size:13px;color:var(--mut)}
</style>
</head>
<body>

<div class="top">
  <div class="logo"><img src="Logo.webp" alt="GM"><div><strong>Golden</strong><div style="color:var(--lime);font-weight:800">Moms</div></div></div>
  <div class="nav"><div class="tab active">Plantel</div></div>
</div>

<div class="wrap">
  <div id="status">Iniciando...</div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><h3 style="margin:0">Plantel</h3><div class="small">Listado sincronizado con Supabase (tabla <code>players</code>).</div></div>
      <button id="addBtn" class="btn">Agregar jugadora</button>
    </div>

    <div id="roster" aria-live="polite"></div>
  </div>
</div>

<!-- modal -->
<div class="modal-bg" id="modalBg" aria-hidden="true">
  <div class="modal" role="dialog">
    <h3 id="modalTitle">Ficha</h3>
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
      <div style="width:100px;height:100px;border-radius:10px;overflow:hidden;background:#f7f9fb;display:flex;align-items:center;justify-content:center" id="photoPreview"></div>
      <div style="flex:1">
        <input id="fotoUrl" class="input" placeholder="URL foto (opcional)">
        <input id="fotoFile" type="file" accept="image/*" style="margin-top:8px">
      </div>
    </div>

    <div class="form-row">
      <div><input id="nombre" class="input" placeholder="Nombre completo"></div>
      <div><input id="apodo" class="input" placeholder="Apodo"></div>
    </div>

    <div class="form-row">
      <div><input id="numero" class="input" placeholder="Número camiseta"></div>
      <div><input id="rol" class="input" placeholder="Rol"></div>
    </div>

    <div class="form-row">
      <div><input id="nacimiento" type="date" class="input"></div>
      <div><input id="telefono" class="input" placeholder="Teléfono emergencia"></div>
    </div>

    <div style="margin-bottom:8px">
      <input id="seguro" class="input" placeholder="Seguro médico (opcional)">
    </div>

    <div style="margin-bottom:8px">
      <div class="small">Equipos (selecciona uno o más)</div>
      <div id="teams" class="team-list" style="margin-top:6px"></div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button id="delBtn" class="btn" style="display:none">Eliminar</button>
      <button id="closeBtn" class="btn">Cerrar</button>
      <button id="saveBtn" class="btn p">Guardar</button>
    </div>
  </div>
</div>

<!-- supabase SDK (usar CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

<script>
/* ---------- CONFIG (tus datos) ---------- */
const SUPA_URL = "https://xglojvvbgaivwbpdxvne.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw";
const BUCKET = "player-photos"; // ajusta si tu bucket tiene otro nombre

/* ---------- referencias DOM ---------- */
const statusEl = document.getElementById('status');
const rosterEl = document.getElementById('roster');
const addBtn = document.getElementById('addBtn');
const modalBg = document.getElementById('modalBg');
const modalTitle = document.getElementById('modalTitle');
const photoPreview = document.getElementById('photoPreview');
const fotoUrl = document.getElementById('fotoUrl');
const fotoFile = document.getElementById('fotoFile');
const nombre = document.getElementById('nombre');
const apodo = document.getElementById('apodo');
const numero = document.getElementById('numero');
const rol = document.getElementById('rol');
const nacimiento = document.getElementById('nacimiento');
const telefono = document.getElementById('telefono');
const seguro = document.getElementById('seguro');
const teamsEl = document.getElementById('teams');
const saveBtn = document.getElementById('saveBtn');
const closeBtn = document.getElementById('closeBtn');
const delBtn = document.getElementById('delBtn');

const TEAM_OPTIONS = ["Golden Moms","Golden Power","Golden Dream"];

/* ---------- init supabase ---------- */
let supa = null;
try{
  supa = supabase.createClient(SUPA_URL, SUPA_KEY);
}catch(e){
  statusEl.textContent = 'Error inicializando Supabase. Revisa consola.';
  console.error(e);
}

function setStatus(txt, err=false){
  statusEl.textContent = txt;
  statusEl.style.borderColor = err ? '#ffc0c0' : '#e2e8f0';
}

/* ---------- helpers ---------- */
function avatarOrSVG(url,name){
  if(url) return url;
  const initials = (name||'').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase() || 'GM';
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect width='100%' height='100%' fill='#f1f5f9'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='48' fill='#64748b'>${initials}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

function renderTeams(selected=[]){
  teamsEl.innerHTML = '';
  TEAM_OPTIONS.forEach(t=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'chip' + (selected.includes(t) ? ' sel' : '');
    btn.textContent = t;
    btn.onclick = ()=>{ btn.classList.toggle('sel'); };
    teamsEl.appendChild(btn);
  });
}
function getSelectedTeams(){ return Array.from(teamsEl.querySelectorAll('.chip.sel')).map(b=>b.textContent.trim()); }

/* ---------- CRUD ---------- */
async function fetchPlayers(){
  try{
    setStatus('Cargando jugadoras…');
    const { data, error } = await supa.from('players').select('*').order('apodo', { ascending:true });
    if(error) throw error;
    renderRoster(data || []);
    setStatus('Jugadoras cargadas: ' + ((data && data.length) || 0));
  }catch(err){
    console.error(err);
    setStatus('Error cargando jugadoras. Revisa consola.', true);
  }
}

function renderRoster(players){
  rosterEl.innerHTML = '';
  if(!players || players.length === 0){
    rosterEl.innerHTML = '<div class="small">No hay jugadoras registradas.</div>'; return;
  }
  players.forEach(p=>{
    const d = document.createElement('div'); d.className='player';
    d.dataset.id = p.id || '';
    const av = document.createElement('div'); av.className='avatar';
    const img = document.createElement('img'); img.src = avatarOrSVG(p.foto || p.photo || '', p.apodo || p.nombre);
    av.appendChild(img);
    const a = document.createElement('div'); a.className='apodo'; a.textContent = p.apodo || (p.nombre||'').split(' ')[0] || 'Sin apodo';
    const n = document.createElement('div'); n.className='nombre'; n.textContent = p.nombre || '';
    d.appendChild(av); d.appendChild(a); d.appendChild(n);
    d.onclick = ()=> openModal(p);
    rosterEl.appendChild(d);
  });
}

/* modal */
let editing = null;
function openModal(player){
  editing = player || null;
  modalTitle.textContent = player ? `Ficha — ${player.apodo || player.nombre}` : 'Agregar jugadora';
  delBtn.style.display = player && player.id ? '' : 'none';
  fotoUrl.value = player?.foto || player?.photo || '';
  fotoFile.value = '';
  nombre.value = player?.nombre || '';
  apodo.value = player?.apodo || '';
  numero.value = (player && (player.numero_camiseta || player.numero || player.number)) || '';
  rol.value = player?.rol || player?.gm_role || '';
  nacimiento.value = player?.fecha_nacimiento ? (player.fecha_nacimiento.split('T')[0]||player.fecha_nacimiento) : '';
  telefono.value = player?.telefono_emergencia || player?.telefono || '';
  seguro.value = player?.seguro_medico || player?.seguro || '';
  renderTeams(Array.isArray(player?.equipos) ? player.equipos : (typeof player?.equipos === 'string' ? JSON.parse(player.equipos || '[]') : []));
  setPreview(fotoUrl.value);
  modalBg.style.display = 'flex'; modalBg.setAttribute('aria-hidden','false');
}
function closeModal(){ modalBg.style.display = 'none'; modalBg.setAttribute('aria-hidden','true'); editing = null; }

/* preview */
function setPreview(url){
  photoPreview.innerHTML = '';
  const img = document.createElement('img'); img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
  img.src = avatarOrSVG(url, apodo.value || nombre.value);
  photoPreview.appendChild(img);
}

/* upload file to storage and return public url */
async function uploadFile(file){
  if(!file) return null;
  try{
    const ext = file.name.split('.').pop();
    const path = `players/${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;
    const { data, error } = await supa.storage.from(BUCKET).upload(path, file, { upsert: true });
    if(error) throw error;
    const { publicUrl, error: urlErr } = supa.storage.from(BUCKET).getPublicUrl(path);
    if(urlErr) throw urlErr;
    return publicUrl;
  }catch(err){
    console.error('Upload error', err);
    throw err;
  }
}

/* save (insert or update) */
saveBtn.addEventListener('click', async ()=>{
  try{
    setStatus('Guardando…');
    let foto = fotoUrl.value.trim() || null;
    if(fotoFile.files && fotoFile.files[0]){
      foto = await uploadFile(fotoFile.files[0]);
      fotoUrl.value = foto || '';
    }
    const payload = {
      nombre: nombre.value.trim() || null,
      apodo: apodo.value.trim() || null,
      numero_camiseta: numero.value ? Number(numero.value) : null,
      rol: rol.value.trim() || null,
      fecha_nacimiento: nacimiento.value || null,
      telefono_emergencia: telefono.value.trim() || null,
      seguro_medico: seguro.value.trim() || null,
      foto: foto || null,
      equipos: getSelectedTeams()
    };
    if(editing && editing.id){
      const { error } = await supa.from('players').update(payload).eq('id', editing.id);
      if(error) throw error;
      setStatus('Actualizado OK');
    } else {
      const { data, error } = await supa.from('players').insert([payload]).select();
      if(error) throw error;
      setStatus('Creado OK');
    }
    await fetchPlayers();
    closeModal();
  }catch(err){
    console.error(err);
    setStatus('Error guardando. Revisa consola.', true);
    alert('Error guardando: ' + (err.message || err));
  }
});

/* delete */
delBtn.addEventListener('click', async ()=>{
  if(!editing || !editing.id) return;
  if(!confirm('Eliminar jugadora?')) return;
  try{
    const { error } = await supa.from('players').delete().eq('id', editing.id);
    if(error) throw error;
    setStatus('Eliminado OK');
    await fetchPlayers();
    closeModal();
  }catch(err){
    console.error(err);
    setStatus('Error eliminando', true);
  }
});

/* UI wiring */
addBtn.addEventListener('click', ()=> openModal(null));
closeBtn.addEventListener('click', closeModal);
fotoUrl.addEventListener('input', ()=> setPreview(fotoUrl.value || ''));

/* bootstrap */
(async function init(){
  if(!supa){ setStatus('SDK no disponible. Revisa CDN o carga local supabase.min.js', true); return; }
  setStatus('Conectando a Supabase…');
  try{
    await fetchPlayers();
  }catch(e){
    console.error(e);
  }
})();
</script>
</body>
</html>
