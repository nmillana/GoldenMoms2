<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms â€” Panel (fix modal)</title>
<link rel="icon" href="Logo.webp"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{
  --blue:#0f3a78; --lime:#9be22d; --ink:#0f172a; --mut:#64748b;
  --b:#e2e8f0; --bg:#f7f8fa;
  --title-size:12px; --content-size:10px; --sub-size:8px; --kpi-number-size:22px;
  --lime-strong:#7fd410; --blue-strong:#0a2a58;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:inherit;text-decoration:none}
.btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer;font-size:var(--content-size)}
.btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
.btn.s{background:#f8fafc}

/* top / nav */
.top{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.brand{display:flex;gap:10px;align-items:center}
.brand img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)}
.nav{display:flex;gap:8px;flex-wrap:nowrap;align-items:center;overflow-x:auto;padding-bottom:4px}
.nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer;white-space:nowrap;font-size:var(--content-size)}
.nav .tab.active{background:var(--blue);color:#fff}

/* layout */
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 20px #0000000a;padding:12px}
.card h4{margin:0 0 8px;font-size:var(--title-size)}
.kpi h3{margin:0;color:var(--mut);font-size:var(--sub-size)}
.kpi .n{font-size:var(--kpi-number-size);font-weight:800}
.section-note{font-size:var(--sub-size);color:var(--mut);margin-top:8px;border-left:3px solid #e6edf7;padding-left:8px}

/* calendar */
.month-bar{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
.month-title{font-weight:800;font-size:var(--title-size)}
.month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;grid-auto-rows:minmax(90px,auto)}
.weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-bottom:8px}
.weekdays div{font-weight:700;color:var(--blue);text-align:center;font-size:var(--content-size)}
.day{min-height:90px;background:#fff;border:1px solid var(--b);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:6px}

/* modal â€” oculto por defecto (IMPORTANT) */
.modal-bg{
  position:fixed;inset:0;background:#0006;display:none;z-index:1000;
  justify-content:center;align-items:flex-start;padding-top:6vh;overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
.modal{
  width:min(860px,calc(100% - 24px));margin:0 auto;background:#fff;border:1px solid var(--b);border-radius:14px;padding:16px;box-shadow:0 20px 40px #00000022;
  max-height:90vh;overflow:auto;box-sizing:border-box;
}
.modal h3{margin:0 0 10px;font-size:var(--title-size)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:800px){.form-row{grid-template-columns:1fr}}
.input,select,textarea{width:100%;padding:10px;border:1px solid var(--b);border-radius:10px;background:#fff;font-size:var(--content-size)}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

/* lists */
ul{margin:6px 0 6px 18px;padding:0;font-size:var(--content-size)}
li{margin-bottom:6px;font-size:var(--content-size);line-height:1.2}

/* responsive */
@media(max-width:900px){.grid{grid-template-columns:1fr}.month-grid,.weekdays{gap:6px}.day{min-height:100px;padding:6px}}
@media(max-width:420px){.month-grid{display:none}.weekdays{display:none}}
</style>
</head>
<body>

<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM"/>
    <div><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div>
    <div class="nav" role="tablist" aria-label="NavegaciÃ³n">
      <button class="tab active" data-view="dash">Dashboard</button>
      <button class="tab" data-view="events">Eventos</button>
      <button class="tab" data-view="roster">Plantel</button>
      <button class="tab" data-view="matches">Partidos</button>
    </div>
  </div>
</div>

<div class="container">
  <!-- DASH -->
  <section id="v-dash">
    <div class="grid" style="align-items:stretch">
      <div class="card kpi" style="grid-column:span 6">
        <h3>Plantel</h3>
        <div class="n" id="kRoster">0</div>
        <div style="font-size:var(--sub-size);color:var(--mut)">Integrantes registrados</div>
      </div>
      <div class="card kpi" style="grid-column:span 6">
        <h3>Partidos jugados</h3>
        <div class="n" id="kGames">0</div>
        <div id="lastMatchSummary" style="font-size:var(--content-size);color:var(--mut)"></div>
      </div>
    </div>

    <div class="grid cards-dashboard" style="margin-top:12px;grid-template-columns:repeat(12,1fr);gap:12px">
      <div class="card card-birth-today" style="grid-column:span 12;">
        <h4>ðŸŽ‚ CumpleaÃ±os â€” Hoy</h4>
        <div class="section-note">Personas del plantel que cumplen hoy</div>
        <div id="birthToday" style="margin-top:8px;color:var(--mut);font-size:var(--content-size)">â€”</div>
      </div>

      <div class="card card-birth-next" style="grid-column:span 12;">
        <h4>ðŸŽ‰ PrÃ³ximos cumpleaÃ±os</h4>
        <div class="section-note">Lista con los prÃ³ximos 5 cumpleaÃ±os.</div>
        <ul id="upBirth" style="margin:8px 0 0 16px"></ul>
      </div>

      <div class="card card-hoy" style="grid-column:span 12;">
        <h4>ðŸ“… Hoy</h4>
        <div class="section-note">Eventos que ocurren hoy (fecha local).</div>
        <ul id="todayEvents" style="margin:8px 0 0 16px"></ul>
      </div>

      <div class="card card-week" style="grid-column:span 12;margin-top:12px">
        <h4>ðŸ“… Eventos de la semana</h4>
        <div class="section-note">Eventos de la semana actual (lunes a domingo).</div>
        <ul id="weekEvents" style="margin:8px 0 0 16px"></ul>
      </div>
    </div>
  </section>

  <!-- EVENTS -->
  <section id="v-events" style="display:none">
    <div class="card">
      <div class="month-bar">
        <div class="month-nav">
          <button class="btn s" id="btnPrevMonth">â—€</button>
          <button class="btn s" id="btnToday">Hoy</button>
          <button class="btn s" id="btnNextMonth">â–¶</button>
        </div>
        <div class="month-title" id="monthTitle">Mes</div>
      </div>
      <div class="section-note">El calendario muestra eventos agrupados por <strong>fecha local</strong>.</div>
      <div class="weekdays"><div>Lun</div><div>Mar</div><div>MiÃ©</div><div>Jue</div><div>Vie</div><div>SÃ¡b</div><div>Dom</div></div>
      <div id="monthGrid" class="month-grid"></div>
    </div>
  </section>

  <!-- ROSTER -->
  <section id="v-roster" style="display:none">
    <div class="card">
      <h4>Plantel</h4>
      <div class="section-note">Listado del plantel (tabla <code>players</code>).</div>
      <div id="rosterGrid" class="grid" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- MATCHES -->
  <section id="v-matches" style="display:none">
    <div class="card">
      <h4>Partidos jugados</h4>
      <div class="section-note">Registro de partidos.</div>
      <div id="matchesList" style="margin-top:12px"></div>
    </div>
  </section>
</div>

<footer style="text-align:center;padding:16px;color:var(--mut);font-size:var(--content-size)">Golden Moms Â· hecho con ðŸ’š lima & azul</footer>

<!-- MODAL: oculto por defecto -->
<div class="modal-bg" id="modalBg" aria-hidden="true" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Nuevo evento</h3>

    <div class="form-row">
      <div>
        <label>TÃ­tulo</label>
        <input id="f_title" class="input" placeholder="Ej: Entrenamiento Colegio">
      </div>
      <div>
        <label>Tipo</label>
        <select id="f_type" class="input"><option>Entrenamiento</option><option>Partido</option></select>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>Fecha y hora</label>
        <input id="f_dt" type="datetime-local" class="input">
      </div>
      <div>
        <label>Equipo</label>
        <input id="f_team" class="input" value="Golden Moms">
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>Rival (si aplica)</label>
        <input id="f_opponent" class="input" placeholder="Rivales / Liga">
      </div>
      <div>
        <label>Uniforme</label>
        <select id="f_uniform" class="input"><option value="">(definir)</option><option>Polera azul â€” * medias verde lima</option><option>Polera verde lima â€” * medias verde lima</option></select>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>UbicaciÃ³n</label>
        <input id="f_location" class="input" placeholder="Colegio / Cancha / DirecciÃ³n">
      </div>
      <div>
        <div id="matchExtra" style="display:none">
          <label>Goles a favor</label>
          <input id="f_goals_for" class="input" type="number" min="0" placeholder="Goles a favor">
          <label style="margin-top:8px">Goles en contra</label>
          <input id="f_goals_against" class="input" type="number" min="0" placeholder="Goles en contra">
        </div>
      </div>
    </div>

    <div class="form-row" id="matchPeopleRow" style="display:none">
      <div>
        <label>Goleadoras (coma-separadas)</label>
        <input id="f_scorers" class="input" placeholder="Nombre1, Nombre2">
      </div>
      <div>
        <label>Asistencias (coma-separadas)</label>
        <input id="f_assists" class="input" placeholder="NombreA, NombreB">
      </div>
    </div>

    <div class="form-row">
      <div>
        <div class="modal-actions">
          <button class="btn s" id="btnDelete" style="margin-right:auto;display:none">Eliminar</button>
          <button class="btn s" id="btnCancel">Cancelar</button>
          <button class="btn p" id="btnSave">Guardar</button>
        </div>
      </div>
      <div></div>
    </div>
  </div>
</div>

<script>
/* ---------- Supabase config ------------- */
const SUPA = {
  url: "https://xglojvvbgaivwbpdxvne.supabase.co",
  key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnbG9qdnZiZ2FpdndicGR4dm5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMjEzMjQsImV4cCI6MjA3MDY5NzMyNH0.vQOBuvphgm0iue-lybJoBVhyai7RtRp8Tfn-hGIKKgw"
};
let supa = null;
async function initSupabase(timeoutMs = 8000){
  try{
    if(typeof createClient === 'function'){ supa = createClient(SUPA.url, SUPA.key); return supa; }
    if(window.supabase && typeof window.supabase.createClient === 'function'){ supa = window.supabase.createClient(SUPA.url, SUPA.key); return supa; }
    await new Promise((resolve,reject)=>{
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js';
      s.async = true;
      let done=false;
      const to=setTimeout(()=>{ if(!done){ done=true; reject(new Error('timeout cargando supabase')); }}, timeoutMs);
      s.onload=()=>{ if(done) return; done=true; clearTimeout(to); resolve(); };
      s.onerror=()=>{ if(done) return; done=true; clearTimeout(to); reject(new Error('error cargando supabase')); };
      document.head.appendChild(s);
    });
    if(typeof createClient === 'function'){ supa = createClient(SUPA.url, SUPA.key); return supa; }
    if(window.supabase && typeof window.supabase.createClient === 'function'){ supa = window.supabase.createClient(SUPA.url, SUPA.key); return supa; }
    throw new Error('SDK cargado pero no se encontrÃ³ createClient');
  }catch(err){ console.error('initSupabase error:', err); supa = null; return null; }
}

/* ---------- Helpers ---------- */
function pad(n){return n.toString().padStart(2,'0');}
function localInputToISOWithOffset(inp){ if(!inp) return null; const [d,t]=inp.split('T'); const offMin = -new Date().getTimezoneOffset(); const sign = offMin>=0?'+':'-'; const abs=Math.abs(offMin); const oh=pad(Math.floor(abs/60)); const om=pad(abs%60); return `${d}T${t}:00${sign}${oh}:${om}`; }
function isoToLocalInput(iso){ if(!iso) return ''; const d=new Date(iso); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function localDateYMD(d){ const D=new Date(d); return `${D.getFullYear()}-${pad(D.getMonth()+1)}-${pad(D.getDate())}`; }

/* ---------- DOM refs & modal handlers ---------- */
const modalBg = document.getElementById('modalBg');
const f_title = document.getElementById('f_title');
const f_type = document.getElementById('f_type');
const f_dt   = document.getElementById('f_dt');
const f_team = document.getElementById('f_team');
const f_opponent = document.getElementById('f_opponent');
const f_uniform  = document.getElementById('f_uniform');
const f_location = document.getElementById('f_location');
const f_goals_for = document.getElementById('f_goals_for');
const f_goals_against = document.getElementById('f_goals_against');
const f_scorers = document.getElementById('f_scorers');
const f_assists = document.getElementById('f_assists');
const matchExtra = document.getElementById('matchExtra');
const matchPeopleRow = document.getElementById('matchPeopleRow');
const btnDelete = document.getElementById('btnDelete');
const btnCancel = document.getElementById('btnCancel');
const btnSave   = document.getElementById('btnSave');

let editingId = null;

function openModal(opts={}) {
  document.getElementById('modalTitle').textContent = opts.existing ? 'Editar evento' : 'Nuevo evento';
  editingId = null;
  if(opts.existing){
    const e = opts.existing;
    editingId = e.id;
    f_title.value = e.title||'';
    f_type.value  = e.type||'Entrenamiento';
    f_dt.value    = isoToLocalInput(e.datetime);
    f_team.value  = e.team||'Golden Moms';
    f_opponent.value = e.opponent||'';
    f_uniform.value  = e.uniform||'';
    f_location.value = e.location||'';
    // ocultamos campos match al editar (solicitud)
    if(matchExtra) matchExtra.style.display='none';
    if(matchPeopleRow) matchPeopleRow.style.display='none';
    if(f_goals_for) f_goals_for.value='';
    if(f_goals_against) f_goals_against.value='';
    if(f_scorers) f_scorers.value='';
    if(f_assists) f_assists.value='';
    btnDelete.style.display='';
  }else{
    editingId = null;
    f_title.value = '';
    f_type.value  = 'Entrenamiento';
    const base = opts.date ? new Date(opts.date) : new Date();
    base.setHours(19,30,0,0);
    f_dt.value = isoToLocalInput(base.toISOString());
    f_team.value  = 'Golden Moms';
    f_opponent.value = '';
    f_uniform.value  = '';
    f_location.value = '';
    if(f_goals_for) f_goals_for.value='';
    if(f_goals_against) f_goals_against.value='';
    if(f_scorers) f_scorers.value='';
    if(f_assists) f_assists.value='';
    btnDelete.style.display='none';
    // mostrar campos match solo si es NEW y tipo Partido
    if(f_type.value==='Partido'){ if(matchExtra) matchExtra.style.display=''; if(matchPeopleRow) matchPeopleRow.style.display=''; } else { if(matchExtra) matchExtra.style.display='none'; if(matchPeopleRow) matchPeopleRow.style.display='none'; }
  }
  modalBg.style.display = 'flex';
  modalBg.setAttribute('aria-hidden','false');
}

function closeModal(){
  modalBg.style.display = 'none';
  modalBg.setAttribute('aria-hidden','true');
  editingId = null;
}

/* listeners */
modalBg.addEventListener('click', (e)=>{ if(e.target === modalBg) closeModal(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
btnCancel.addEventListener('click', ()=> closeModal());

btnDelete.addEventListener('click', async ()=>{
  if(!editingId) return;
  if(!confirm('Â¿Eliminar este evento?')) return;
  if(!supa){ alert('No conectado a Supabase.'); closeModal(); return; }
  try{ await supa.from('events').delete().eq('id', editingId); await supa.from('matches').delete().eq('event_id', editingId); }catch(err){ console.warn('Error eliminando', err); alert('Error eliminando. Revisa consola.'); }
  closeModal(); renderMonth(); renderDash();
});

btnSave.addEventListener('click', async ()=>{
  const title = f_title.value.trim();
  const type  = f_type.value;
  const team  = f_team.value.trim();
  const opponent = f_opponent.value.trim();
  const uniform  = f_uniform.value;
  const location = f_location.value.trim();
  if(!title || !f_dt.value){ alert('Completa tÃ­tulo y fecha/hora'); return; }
  if(!supa){ alert('No conectado a Supabase. Revisa la consola.'); closeModal(); return; }

  const datetime = localInputToISOWithOffset(f_dt.value);
  const payloadEvent = { title, type, team, opponent, uniform, location, datetime };

  try{
    if(editingId){
      const { error } = await supa.from('events').update(payloadEvent).eq('id', editingId);
      if(error) throw error;
    } else {
      const { data:inserted, error } = await supa.from('events').insert([payloadEvent]).select();
      if(error) throw error;
      const newEvent = inserted && inserted[0];
      if(type === 'Partido' && newEvent){
        const goalsFor = f_goals_for && f_goals_for.value ? parseInt(f_goals_for.value) : null;
        const goalsAgainst = f_goals_against && f_goals_against.value ? parseInt(f_goals_against.value) : null;
        const diff = (goalsFor!=null && goalsAgainst!=null) ? (goalsFor - goalsAgainst) : null;
        const matchPayload = {
          event_id: newEvent.id,
          goals_for: goalsFor,
          goals_against: goalsAgainst,
          goal_difference: diff,
          scorers: f_scorers && f_scorers.value ? f_scorers.value.split(',').map(s=>s.trim()).filter(Boolean) : [],
          assists: f_assists && f_assists.value ? f_assists.value.split(',').map(s=>s.trim()).filter(Boolean) : []
        };
        try{ await supa.from('matches').insert([matchPayload]); }catch(err){ console.warn('Error guardando match', err); }
      }
    }
  }catch(err){ alert('Error al guardar: '+(err.message||err)); console.error(err); return; }

  closeModal(); renderMonth(); renderDash();
});

/* ---------- calendar & rendering (resumido) ---------- */
let monthCursor = new Date();
let cachedEvents = [];
const monthTitle = document.getElementById('monthTitle');
const monthGrid = document.getElementById('monthGrid');

document.getElementById('btnPrevMonth')?.addEventListener('click', ()=>{ monthCursor.setMonth(monthCursor.getMonth()-1); renderMonth(); });
document.getElementById('btnNextMonth')?.addEventListener('click', ()=>{ monthCursor.setMonth(monthCursor.getMonth()+1); renderMonth(); });
document.getElementById('btnToday')?.addEventListener('click', ()=>{ monthCursor = new Date(); renderMonth(); });

function getMonthRange(d){ const first=new Date(d.getFullYear(),d.getMonth(),1); const last=new Date(d.getFullYear(),d.getMonth()+1,0); let start=new Date(first); let dow=(start.getDay()+6)%7; start.setDate(start.getDate()-dow); let end=new Date(last); let dow2=(end.getDay()+6)%7; end.setDate(end.getDate()+(6-dow2)); return {start,end}; }

async function fetchEventsRange(start,end){
  if(!supa){ console.warn('fetchEventsRange: no supa'); return []; }
  try{ const {data,error} = await supa.from("events").select("*").gte("datetime", start.toISOString()).lte("datetime", end.toISOString()).order("datetime",{ascending:true}); if(error){ console.error(error); return []; } return data||[]; }catch(err){ console.error(err); return []; }
}

function renderMonthTitle(){ const m = monthCursor.toLocaleString('es-CL',{month:'long',year:'numeric'}); monthTitle.textContent = m.charAt(0).toUpperCase()+m.slice(1); }

async function renderMonth(){
  renderMonthTitle();
  const {start,end} = getMonthRange(monthCursor);
  cachedEvents = await fetchEventsRange(start,end);
  drawMonthGrid(start,end);
}

function drawMonthGrid(start,end){
  if(!monthGrid) return;
  monthGrid.innerHTML='';
  const days=[]; let d=new Date(start);
  while(d<=end){ days.push(new Date(d)); d.setDate(d.getDate()+1); }
  for(const day of days){
    const cell=document.createElement('div'); cell.className='day';
    const head=document.createElement('div'); head.className='day-head';
    head.innerHTML = `<div class="day-n">${pad(day.getDate())}</div><button class="day-add" title="Nuevo evento">+</button>`;
    head.querySelector('.day-add').onclick=()=> openModal({ date: day });
    cell.appendChild(head);
    const dayStrLocal = localDateYMD(day);
    const events = (cachedEvents||[]).filter(e => localDateYMD(new Date(e.datetime)) === dayStrLocal);
    for(const e of events){
      const ev = document.createElement('div'); ev.className='ev '+(e.type==='Entrenamiento'?'ev-train':'ev-match');
      ev.innerHTML = `<div class="title">${e.title}</div>`;
      ev.onclick=()=> openModal({ existing:e });
      cell.appendChild(ev);
    }
    monthGrid.appendChild(cell);
  }
}

/* ---------- dashboard & roster & matches (parcial, igual lÃ³gica) ---------- */
async function renderDash(){
  try{
    const now=new Date();
    const weekStart=new Date(now); weekStart.setDate(weekStart.getDate()-((weekStart.getDay()+6)%7)); const weekEnd=new Date(weekStart); weekEnd.setDate(weekEnd.getDate()+6);
    const todayStrLocal = localDateYMD(now);

    let evs=[];
    if(supa){ const {data:events, error} = await supa.from("events").select("*").gte("datetime", weekStart.toISOString()).lte("datetime", weekEnd.toISOString()).order("datetime",{ascending:true}); if(!error) evs = events||[]; else { console.warn(error); evs=[]; } }

    // players
    let players = [];
    if(supa){
      try{ const resPlayers = await supa.from("players").select("*"); if(resPlayers && resPlayers.data) players = resPlayers.data; }catch(err){ console.warn('Error players',err); }
    }
    document.getElementById('kRoster').textContent = (players||[]).length || 0;

    const matchesPlayed = evs.filter(e=> e.type==='Partido' && new Date(e.datetime) < now);
    document.getElementById('kGames').textContent = matchesPlayed.length;
    if(matchesPlayed.length>0){ const last = matchesPlayed.sort((a,b)=> new Date(b.datetime)-new Date(a.datetime))[0]; const d=new Date(last.datetime); document.getElementById('lastMatchSummary').textContent = `${last.title} â€” ${d.toLocaleDateString('es-CL',{day:'2-digit',month:'short'})}`; } else { document.getElementById('lastMatchSummary').textContent = 'Sin partidos jugados aÃºn'; }

    // birthdays
    const upB = document.getElementById("upBirth"); upB.innerHTML=''; const birthTodayEl = document.getElementById('birthToday'); birthTodayEl.innerHTML='â€”';
    try{
      if(supa){
        const { data:vw, error:vwErr } = await supa.from("vw_upcoming_birthdays").select("*").order("proximo_cumple",{ascending:true}).limit(5);
        if(!vwErr && vw && vw.length){
          vw.slice(0,5).forEach(p=>{ if(p.proximo_cumple){ const bd=new Date(p.proximo_cumple); const li=document.createElement('li'); li.innerHTML = `${p.apodo||p.nombre} â€” ${bd.toLocaleDateString("es-CL",{day:"2-digit",month:"short"})}`; upB.appendChild(li); }});
        } else {
          upB.innerHTML = '<li style="color:var(--mut)">No hay datos de cumpleaÃ±os</li>';
        }
      } else {
        upB.innerHTML = '<li style="color:var(--mut)">Sin conexiÃ³n â€” no se pudieron cargar cumpleaÃ±os</li>';
      }
    }catch(err){ console.warn('Error birthdays',err); upB.innerHTML = '<li style="color:var(--mut)">Error cargando datos</li>'; }

    // today events
    const todayEl = document.getElementById('todayEvents'); todayEl.innerHTML='';
    evs.filter(e => localDateYMD(new Date(e.datetime)) === todayStrLocal).forEach(e=>{ const d=new Date(e.datetime); const li=document.createElement('li'); li.innerHTML=`<strong>${e.title}</strong> â€” ${d.toLocaleString("es-CL",{weekday:'short',hour:'2-digit',minute:'2-digit'})}`; todayEl.appendChild(li); });
    if(todayEl.innerHTML.trim()==='') todayEl.innerHTML = '<div style="color:var(--mut)">No hay eventos hoy</div>';

    // week events
    const wEl = document.getElementById('weekEvents'); wEl.innerHTML='';
    evs.forEach(e=>{ const d=new Date(e.datetime); const li=document.createElement('li'); li.innerHTML = `<strong>${e.title}</strong> â€” ${d.toLocaleString("es-CL",{weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"})}`; wEl.appendChild(li); });
    if(wEl.innerHTML.trim()==='') wEl.innerHTML = '<div style="color:var(--mut)">No hay eventos esta semana</div>';

    // roster preview
    const rosterGrid = document.getElementById('rosterGrid'); rosterGrid.innerHTML='';
    try{
      if(supa){
        const { data:playersList } = await supa.from('players').select('*').order('nombre',{ascending:true});
        if(playersList && playersList.length){ playersList.forEach(p=>{ const c=document.createElement('div'); c.className='card'; c.style.gridColumn='span 3'; c.innerHTML = `<div style="font-weight:700">${p.apodo||p.nombre||'Sin nombre'}</div><div style="font-size:13px;color:var(--mut)">${p.posicion||''} ${p.edad? 'â€” '+p.edad+' aÃ±os':''}</div>`; rosterGrid.appendChild(c); }); }
        else rosterGrid.innerHTML = '<div style="color:var(--mut)">No hay jugadores registrados</div>';
      } else rosterGrid.innerHTML = '<div style="color:var(--mut)">Sin conexiÃ³n â€” no se pudo cargar plantel</div>';
    }catch(err){ console.warn('Error roster',err); rosterGrid.innerHTML = '<div style="color:var(--mut)">Error cargando plantel</div>'; }

  }catch(err){ console.error(err); }
}

async function renderMatches(){
  const container = document.getElementById('matchesList'); container.innerHTML='Cargando...';
  try{
    if(!supa){ container.innerHTML = '<div style="color:var(--mut)">Sin conexiÃ³n â€” no se pueden cargar partidos</div>'; return; }
    const { data, error } = await supa.from('matches').select(`*, events:event_id ( id, title, datetime, team, opponent )`).order('created_at', {ascending:false});
    if(error){
      console.warn('Error matches', error);
      container.innerHTML = '<div style="color:var(--mut)">No hay registros de partidos.</div>';
      return;
    }
    if(!data || data.length===0){ container.innerHTML = '<div style="color:var(--mut)">No hay registros de partidos.</div>'; return; }
    container.innerHTML = data.map(m=>{ const ev=m.events||{}; const d = ev.datetime? new Date(ev.datetime):null; const dateTxt = d? `${d.toLocaleDateString('es-CL',{day:'2-digit',month:'short'})} ${d.toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'})}`:''; const scorers = (m.scorers||[]).join(', ')||'â€”'; const assists = (m.assists||[]).join(', ')||'â€”'; return `<div style="border:1px solid var(--b);padding:10px;border-radius:8px;margin-bottom:8px"><div style="font-weight:700">${ev.title||'Partido'}</div><div style="font-size:13px;color:var(--mut)">${dateTxt}</div><div style="margin-top:6px">Resultado: <strong>${m.goals_for ?? 'â€”'}</strong> â€” <strong>${m.goals_against ?? 'â€”'}</strong> (Dif: ${m.goal_difference ?? 'â€”'})</div><div style="margin-top:6px"><strong>Goleadoras:</strong> ${scorers}</div><div style="margin-top:4px"><strong>Asistencias:</strong> ${assists}</div></div>`; }).join('');
  }catch(err){ console.error('renderMatches error', err); container.innerHTML = '<div style="color:var(--mut)">Error cargando partidos</div>'; }
}

/* ---------- init ---------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  await initSupabase();
  // attach nav tabs
  document.querySelectorAll('.nav .tab').forEach(btn=>{
    btn.onclick=()=>{ document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); showView(btn.dataset.view); };
  });
  // show dash and ensure modal is closed
  showView('dash');
  closeModal(); // ensure hidden
});

/* showView */
function showView(v){
  ['dash','events','roster','matches'].forEach(id=>{ const el=document.getElementById('v-'+id); if(el) el.style.display='none'; });
  const target = document.getElementById('v-'+v) || document.getElementById('v-matches');
  if(target) target.style.display='block';
  if(v==='dash') renderDash();
  if(v==='events') renderMonth();
  if(v==='matches') renderMatches();
}
</script>
</body>
</html>
