<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Golden Moms ‚Äî Panel</title>
<link rel="icon" href="Logo.webp"/>
<style>
:root{
  --blue:#0f3a78;--lime:#9be22d;--ink:#0f172a;--mut:#64748b;
  --b:#e2e8f0;--bg:#f7f8fa;--ok:#d9f99d;--mid:#fef9c3;--no:#fee2e2;
}
*{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
a{color:inherit}
.btn{border:1px solid var(--b);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer}
.btn.p{background:var(--lime);border-color:#a3e635;font-weight:800}
.btn.s{background:#f8fafc}
.badge{font-size:11px;border:1px solid var(--b);border-radius:999px;padding:2px 8px;background:#f8fafc}
.top{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.brand{display:flex;gap:10px;align-items:center}
.brand img{width:32px;height:32px;border-radius:50%;border:2px solid var(--blue)}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.nav .tab{border:1px solid var(--b);border-radius:999px;padding:8px 12px;background:#fff;cursor:pointer}
.nav .tab.active{background:var(--blue);color:#fff}
.container{max-width:1200px;margin:14px auto;padding:0 12px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;box-shadow:0 8px 20px #0000000a;padding:12px}
.kpi h3{margin:0;color:var(--mut);font-size:14px}.kpi .n{font-size:22px;font-weight:800}

/* Calendario */
.filters-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
.filters-row label{font-size:12px;color:#334155;margin-left:6px}
.filters-row select{padding:8px;border:1px solid var(--b);border-radius:10px}
.cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;position:sticky;top:114px;z-index:5;background:#fff;padding:6px 0;border-bottom:1px solid var(--b)}
.cal-head>div{text-align:center;font-weight:700;color:#0f3a78}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.cal-cell{min-height:140px;background:#fff;border:1px solid var(--b);border-radius:12px;padding:8px;overflow:hidden}
.cal-time{font-size:12px;font-weight:700;color:#0f3a78}
.tag{font-size:10px;border:1px solid #0001;border-radius:999px;padding:2px 6px;display:inline-block;margin-bottom:4px}
.match{background:#e0edff;border-color:#b7d1ff;color:#0f3a78}
.train{background:#e9fbd0;border-color:#c6f28a;color:#2d5a00}
.team{font-size:10px;background:#eaf7d7;border:1px solid #c8ef7a;border-radius:999px;padding:1px 6px;margin-left:6px;font-weight:700}

/* Modales */
.overlay{position:fixed;inset:0;background:#0006;display:none;align-items:center;justify-content:center;z-index:40}
.modal{width:min(900px,96vw);max-height:90vh;overflow:auto;background:#fff;border-radius:14px;border:1px solid var(--b);padding:14px}

/* Asistencia */
.att{border:1px solid var(--b);border-radius:12px;padding:8px;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.chip{padding:6px 10px;border-radius:999px;border:1px solid var(--b);background:#f8fafc;font-weight:700;font-size:12px}
.chip.ok{background:var(--ok);border-color:#bef264}.chip.mid{background:var(--mid);border-color:#fde68a}.chip.no{background:var(--no);border-color:#fecaca}

/* Roster */
.roster{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.pcard{border:1px solid var(--b);border-radius:12px;padding:10px;background:#fff}
.phead{display:flex;gap:10px;align-items:center}
.pimg{width:56px;height:56px;border-radius:50%;background:#eee;border:2px solid var(--blue)}
.small{font-size:12px;color:var(--mut)}
.tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}

/* Responsive */
@media (max-width: 900px){
  .grid{grid-template-columns:1fr}
  .cal-head{top:154px}
  .roster{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<!-- Top -->
<div class="top">
  <div class="brand">
    <img src="Logo.webp" alt="GM"/>
    <div><strong>Golden</strong> <span style="color:var(--lime);font-weight:800">Moms</span></div>
  </div>
  <div class="nav">
    <button class="tab active" data-view="dash">Dashboard</button>
    <button class="tab" data-view="events">Eventos</button>
    <button class="tab" data-view="roster">Plantel</button>
    <button class="tab" data-view="track">Seguimiento</button>
    <button class="tab" data-view="conf">Configuraci√≥n</button>
    <span id="roleBadge" class="badge">Invitada</span>
    <button id="btnLogin" class="btn s">Entrar</button>
    <button id="btnLogout" class="btn s" style="display:none">Salir</button>
  </div>
</div>

<div class="container">
  <!-- DASHBOARD -->
  <section id="v-dash">
    <div class="grid">
      <div class="card kpi" style="grid-column:span 3"><h3>Pr√≥ximos eventos</h3><div class="n" id="kEvents">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h3>Plantel</h3><div class="n" id="kRoster">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h3>Convocadas (pr√≥x.)</h3><div class="n" id="kOk">0</div></div>
      <div class="card kpi" style="grid-column:span 3"><h3>Partidos jugados</h3><div class="n" id="kGames">0</div></div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="card" style="grid-column:span 6">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Pr√≥ximos cumplea√±os <span class="small">(üéÇ se muestran con etiqueta)</span></strong>
        </div>
        <ul id="upBirth" style="margin:8px 0 0 16px"></ul>
      </div>

      <div class="card" style="grid-column:span 6">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Goleadoras</strong><span class="small">Top 5</span>
        </div>
        <ol id="topScorers" style="margin-top:8px"></ol>
      </div>
    </div>
  </section>

  <!-- EVENTOS -->
  <section id="v-events" style="display:none">
    <div class="card">
      <div class="filters-row">
        <button class="btn s" id="mPrev">&larr;</button>
        <div id="mLabel" style="min-width:200px;text-align:center;font-weight:800;color:#0f3a78"></div>
        <button class="btn s" id="mNext">&rarr;</button>

        <label>Tipo:</label>
        <select id="filterType">
          <option value="Todos">Todos</option>
          <option>Entrenamiento</option>
          <option>Partido</option>
        </select>

        <label>Equipo:</label>
        <select id="filterTeam">
          <option value="Todos">Todos</option>
          <option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option>
        </select>

        <span style="flex:1"></span>
        <button class="btn s" id="btnCopyWeek">Copiar Semana</button>
        <button class="btn p" id="btnNew">Nuevo Evento</button>
      </div>

      <div class="cal-head"><div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div></div>
      <div id="calGrid" class="cal-grid"></div>
    </div>
  </section>

  <!-- PLANTEL -->
  <section id="v-roster" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Plantel</strong>
        <button id="btnAddPlayer" class="btn s">Agregar jugadora</button>
      </div>
      <div id="rosterGrid" class="roster"></div>
    </div>
  </section>

  <!-- SEGUIMIENTO -->
  <section id="v-track" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Seguimiento de partidos</strong>
        <button id="btnTrackNew" class="btn p">Nuevo registro</button>
      </div>
      <div id="trackList"></div>
    </div>
  </section>

  <!-- CONFIG -->
  <section id="v-conf" style="display:none">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Configuraci√≥n (solo Admin)</strong>
        <button id="cfgSaveBtn" class="btn p">Guardar</button>
      </div>

      <div class="grid">
        <div class="card" style="grid-column:span 12">
          <strong>Roles</strong>
          <div id="rolesWrap" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- MODAL LOGIN -->
<div id="ovLogin" class="overlay"><div class="modal">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <strong>Acceso</strong>
    <button class="btn s" onclick="ovLogin.style.display='none'">Cerrar</button>
  </div>
  <div class="grid">
    <div class="card" style="grid-column:span 12">
      <label>Nombre</label>
      <select id="lgName" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"></select>
      <label style="margin-top:8px">C√≥digo de acceso</label>
      <input id="lgCode" type="password" placeholder="golden2025" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"/>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="doLogin">Entrar</button>
      </div>
      <div class="small" style="margin-top:6px;color:var(--mut)">El rol se obtiene del plantel. C√≥digo √∫nico del equipo.</div>
    </div>
  </div>
</div></div>

<!-- MODAL EVENTO -->
<div id="ovEvent" class="overlay"><div class="modal">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong id="evTitleHead">Editar evento</strong> <span id="evTeamBadge" class="team">Golden Moms</span></div>
    <div style="display:flex;gap:6px">
      <button class="btn s" id="btnICS">.ics</button>
      <button class="btn s" id="btnCopyMsg">Copiar WhatsApp</button>
      <button class="btn s" id="btnRSVP">Link convocatoria</button>
      <button class="btn" id="btnDel" style="background:#ef4444;border-color:#ef4444;color:#fff">Eliminar</button>
      <button class="btn s" onclick="ovEvent.style.display='none'">Cerrar</button>
    </div>
  </div>
  <div class="grid" style="margin-top:8px">
    <div class="card" style="grid-column:span 12">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div style="flex:1;min-width:160px"><label>Tipo</label><select id="eType"><option>Entrenamiento</option><option>Partido</option></select></div>
        <div style="flex:2;min-width:240px"><label>T√≠tulo</label><input id="eTitle" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"/></div>
        <div style="flex:1;min-width:180px"><label>Equipo</label><select id="eTeam"><option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option></select></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <div style="flex:1;min-width:180px"><label>Fecha y hora</label><input id="eDT" type="datetime-local" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"/></div>
        <div style="flex:1;min-width:180px"><label>Lugar</label><input id="eLoc" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"/></div>
        <div style="flex:1;min-width:180px"><label>Rival</label><input id="eOpp" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"/></div>
        <div style="flex:1;min-width:180px"><label>Uniforme</label><select id="eUni"><option value="">‚Äî</option><option>Polera azul</option><option>Polera verde lima</option></select></div>
      </div>
    </div>

    <div class="card" style="grid-column:span 12">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
        <div style="font-weight:800">Asistencia</div>
        <div id="countBox" class="counts"></div>
      </div>
      <div id="att"></div>
    </div>
  </div>
</div></div>

<!-- MODAL JUGADORA -->
<div id="ovPlayer" class="overlay"><div class="modal">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <strong id="pHdr">Editar jugadora</strong>
    <button class="btn s" onclick="ovPlayer.style.display='none'">Cerrar</button>
  </div>
  <div class="grid" style="margin-top:8px">
    <div class="card" style="grid-column:span 12">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div style="flex:1;min-width:180px"><label>Nombre</label><input id="pName" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"/></div>
        <div style="flex:1;min-width:160px"><label>Apodo</label><input id="pNick" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"/></div>
        <div style="flex:1;min-width:120px"><label>N√∫mero</label><input id="pNum" type="number" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"/></div>
        <div style="flex:1;min-width:160px"><label>Nacimiento</label><input id="pBirth" type="date" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"/></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <div style="flex:2;min-width:260px">
          <label>Equipos (Ctrl/Cmd para multi)</label>
          <select id="pTeams" multiple size="3" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px">
            <option>Golden Moms</option><option>Golden Dreams</option><option>Golden Power</option>
          </select>
        </div>
        <div style="flex:1;min-width:160px">
          <label>Rol</label>
          <select id="pRole" class="admin-only" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px">
            <option value="jugadora">Jugadora</option>
            <option value="capitana">Capitana</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
        <button id="pSave" class="btn p">Guardar</button>
      </div>
    </div>
  </div>
</div></div>

<!-- MODAL SEGUIMIENTO -->
<div id="ovTrack" class="overlay"><div class="modal">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <strong>Nuevo registro</strong>
    <button class="btn s" onclick="ovTrack.style.display='none'">Cerrar</button>
  </div>
  <div class="grid" style="margin-top:8px">
    <div class="card" style="grid-column:span 12">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div style="flex:1;min-width:180px"><label>Fecha</label><input id="tDate" type="date" class="admin-only" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"/></div>
        <div style="flex:1;min-width:220px"><label>Competici√≥n</label><input id="tComp" class="admin-only" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"/></div>
        <div style="flex:1;min-width:180px"><label>Rival</label><input id="tOpp" class="admin-only" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"/></div>
        <div style="flex:1;min-width:160px"><label>GF</label><input id="tGF" type="number" class="admin-only" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"/></div>
        <div style="flex:1;min-width:160px"><label>GC</label><input id="tGA" type="number" class="admin-only" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"/></div>
      </div>

      <div style="margin-top:8px">
        <label>Goles</label><br/>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <select id="trackScorer" style="padding:10px;border:1px solid var(--b);border-radius:10px"></select>
          <button class="btn s" id="tAddGoal">Agregar goleadora</button>
        </div>
        <div id="tGoals" class="tags" style="margin-top:6px"></div>
      </div>

      <div style="margin-top:8px">
        <label>Notas</label>
        <textarea id="tNotes" rows="3" style="width:100%;padding:10px;border:1px solid var(--b);border-radius:10px"></textarea>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
        <button id="btnTrackSave" class="btn p">Guardar</button>
      </div>
    </div>
  </div>
</div></div>

<script>
/* ====== Estado base (persistente) ====== */
const KEY="gm-full-v3";
let S={
  team:"Golden Moms",
  roster:[],   // {name,nick,num,birth(YYYY-MM-DD),teams[],role}
  events:[],   // {id,type,title,team,datetime,location,opponent,uniform,scorers[],track?}
  att:{},      // asistencia por eventId: { [playerName]: "Asiste"|"Duda"|"No asiste" }
  results:[]   // historial extra si quieres
};
try{const x=JSON.parse(localStorage.getItem(KEY)||"{}"); if(x && typeof x==="object") S={...S,...x};}catch{}
function save(){ localStorage.setItem(KEY, JSON.stringify(S)); }

/* ====== Seed inicial si vac√≠o ====== */
if(!S.roster.length){
  // Base de plantel con roles (Chica = Admin). Multi-equipo permitido.
  const base=[
    ["Ale V","Ale V",11,"2000-11-12",["Golden Moms"],"jugadora"],
    ["Andre","Andre",12,"","Golden Moms","jugadora"],
    ["Antonella","Anto",30,"2000-02-06",["Golden Moms"],"jugadora"],
    ["Aurora","Aurora",7,"","Golden Moms","jugadora"],
    ["Carla","Carla",9,"2000-12-13",["Golden Moms"],"jugadora"],
    ["Caro G","Caro G",14,"2000-07-24",["Golden Moms","Golden Dreams"],"capitana"],
    ["Caro N","Caro Naso",6,"2000-04-07",["Golden Moms"],"jugadora"],
    ["Cata","Cata",8,"2000-12-08",["Golden Moms"],"jugadora"],
    ["Celsa","Celsa",27,"","Golden Moms","jugadora"],
    ["Chica","Chica",30,"2000-04-20",["Golden Moms","Golden Power"],"admin"],  // Admin
    ["Consu","Consu",21,"2000-12-23",["Golden Moms"],"jugadora"],
    ["Consu S","Consu S",22,"","Golden Moms","jugadora"],
    ["Cote","Cote",13,"","Golden Moms","jugadora"],
    ["Dani C","Dani C",10,"2000-10-10",["Golden Moms"],"jugadora"],
    ["Dani J","Dani J",11,"2000-01-11",["Golden Moms","Golden Power"],"capitana"],
    ["Fabi","Fabi",16,"2000-08-28",["Golden Moms"],"jugadora"],
    ["Fran","Fran",17,"2000-06-21",["Golden Moms"],"jugadora"],
    ["Gaby","Gaby",18,"","Golden Moms","jugadora"],
    ["Isa","Isa",26,"2000-10-26",["Golden Moms"],"jugadora"],
    ["Jandi","Jandi",20,"2000-07-14",["Golden Moms"],"jugadora"],
    ["Janga","Janga",21,"2000-08-20",["Golden Moms"],"jugadora"],
    ["Javiera A","Javiera A",22,"","Golden Moms","jugadora"],
    ["Javi C","Javi C",23,"","Golden Moms","jugadora"],
    ["Jean","Jean",5,"2000-05-05",["Golden Moms"],"jugadora"],
    ["Maca","Maca",25,"2000-10-25",["Golden Moms"],"jugadora"],
    ["Male","Male",24,"2000-12-10",["Golden Moms"],"jugadora"],
    ["Marce","Marce",14,"2000-03-14",["Golden Moms"],"jugadora"],
    ["Myle","Myle",3,"2000-06-03",["Golden Moms"],"jugadora"],
    ["Paz","Paz",0,"","Golden Moms","jugadora"],
    ["Pia","Pia",0,"2000-10-21",["Golden Moms"],"jugadora"],
    ["Pili","Pili",0,"","Golden Moms","jugadora"],
    ["Vale","Vale",0,"2000-10-11",["Golden Moms"],"jugadora"],
    ["Vero","Vero",0,"2000-01-29",["Golden Moms"],"jugadora"],
  ];
  S.roster=base.map(r=>({
    name:r[0],nick:r[1],num:r[2],birth:r[3],teams:Array.isArray(r[4])?r[4]:[r[4]],role:r[5]
  }));
  // Semillas de calendario (semanales)
  seedRecurring();
  save();
}
function seedRecurring(){
  function mk(y,m,d,h,mi){const t=new Date(y,m-1,d,h,mi);return new Date(t.getTime()-t.getTimezoneOffset()*60000).toISOString();}
  function nextDow(dow){const n=new Date(), g=(dow-n.getDay()+7)%7||7;const d=new Date(n);d.setDate(n.getDate()+g);return d;}
  const tue=nextDow(2), wed=nextDow(3), thu=nextDow(4), fri=nextDow(5);
  for(let i=0;i<8;i++){
    const T=new Date(tue);T.setDate(tue.getDate()+7*i);
    const Th=new Date(thu);Th.setDate(thu.getDate()+7*i);
    const W=new Date(wed);W.setDate(wed.getDate()+7*i);
    const F=new Date(fri);F.setDate(fri.getDate()+7*i);
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:mk(T.getFullYear(),T.getMonth()+1,T.getDate(),19,30),location:"Colegio",opponent:"",uniform:""});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:mk(Th.getFullYear(),Th.getMonth()+1,Th.getDate(),19,30),location:"Colegio",opponent:"",uniform:""});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Partido",title:"Wonder Mom‚Äôs Cup",team:"Golden Moms",datetime:mk(W.getFullYear(),W.getMonth()+1,W.getDate(),20,0),location:"Universidad de los Andes",opponent:"‚Äî",uniform:""});
    S.events.push({id:crypto.randomUUID?.()||(""+Math.random()).slice(2),type:"Partido",title:"Liga LIFA",team:"Golden Moms",datetime:mk(F.getFullYear(),F.getMonth()+1,F.getDate(),20,0),location:"Cancha Oriente, Las Condes",opponent:"‚Äî",uniform:""});
  }
}

/* ====== Sesi√≥n / Login ====== */
let SESSION = JSON.parse(localStorage.getItem(KEY+"-session")||"null");
const roleBadge = document.getElementById('roleBadge');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const ovLogin = document.getElementById('ovLogin');

btnLogin.onclick=()=>{fillLogin(); ovLogin.style.display='flex';};
btnLogout.onclick=()=>{SESSION=null;localStorage.removeItem(KEY+"-session");syncRoleUI();alert("Sesi√≥n cerrada");};

function fillLogin(){
  const sel=document.getElementById('lgName'); sel.innerHTML=S.roster.map(p=>`<option>${p.name}</option>`).join('');
}
document.getElementById('doLogin').onclick=()=>{
  const name=document.getElementById('lgName').value;
  const code=(document.getElementById('lgCode').value||'').trim().toLowerCase();
  if(code!=="golden2025"){ alert("C√≥digo incorrecto"); return; }
  const me=S.roster.find(p=>p.name===name); if(!me){ alert("No encontrado"); return; }
  SESSION={name:me.name,role:me.role}; localStorage.setItem(KEY+"-session",JSON.stringify(SESSION));
  ovLogin.style.display='none'; syncRoleUI(); renderAll();
};
function syncRoleUI(){
  const r=SESSION?.role||"Invitada";
  roleBadge.textContent = (SESSION? (SESSION.name+" ‚Äî "+r):"Invitada");
  btnLogin.style.display = SESSION? "none":"inline-flex";
  btnLogout.style.display = SESSION? "inline-flex":"none";
  // proteger configuraci√≥n y edici√≥n avanzada
  document.querySelectorAll('.admin-only').forEach(el => { el.disabled = !(SESSION && SESSION.role==='admin'); });
}

/* ====== Navegaci√≥n ====== */
document.querySelectorAll('.nav .tab').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.nav .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    showView(btn.dataset.view);
  };
});
function showView(v){
  ['dash','events','roster','track','conf'].forEach(id=>document.getElementById('v-'+id).style.display='none');
  document.getElementById('v-'+v).style.display='block';
  if(v==='events'){ renderCalendar(); }
  if(v==='roster'){ renderRoster(); }
  if(v==='track'){ renderTrack(); }
  if(v==='conf'){ renderConfig(); }
}

/* ====== Dashboard ====== */
function renderDash(){
  const upcoming = [...S.events].filter(e=>new Date(e.datetime)>=new Date()).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
  document.getElementById('kEvents').textContent=upcoming.length;
  document.getElementById('kRoster').textContent=S.roster.length;
  if(upcoming[0]){
    const A=S.att[upcoming[0].id]||{}; document.getElementById('kOk').textContent=S.roster.filter(p=>A[p.name]==="Asiste").length;
  } else document.getElementById('kOk').textContent='0';
  document.getElementById('kGames').textContent=S.events.filter(e=>e.type==='Partido' && (e.scorers||[]).length>=0).length;
  // Birthdays pr√≥ximos (30 d√≠as)
  const list=document.getElementById('upBirth'); list.innerHTML='';
  const now=new Date();
  const items = S.roster.filter(p=>p.birth).map(p=>{
    const d = new Date(now.getFullYear()+"-"+p.birth.slice(5));
    if(d<now){ d.setFullYear(now.getFullYear()+1); }
    return {name:p.name,when:d};
  }).filter(x => (x.when - now) <= 30*86400000).sort((a,b)=>a.when-b.when);
  items.forEach(it=>{
    list.innerHTML += `<li>üéÇ <strong>${it.name}</strong> ‚Äî ${it.when.toLocaleDateString('es-CL',{weekday:'short',day:'2-digit',month:'short'})}</li>`;
  });
  updateTopScorers();
}

/* ====== Calendario ====== */
const calGrid=document.getElementById('calGrid');
const mLabel=document.getElementById('mLabel');
let view=new Date(); view.setDate(1);
document.getElementById('mPrev').onclick=()=>{view.setMonth(view.getMonth()-1);renderCalendar();};
document.getElementById('mNext').onclick=()=>{view.setMonth(view.getMonth()+1);renderCalendar();};
document.getElementById('filterType').onchange=renderCalendar;
document.getElementById('filterTeam').onchange=renderCalendar;

function renderCalendar(){
  mLabel.textContent=view.toLocaleDateString('es-CL',{month:'long',year:'numeric'});
  const y=view.getFullYear(), m=view.getMonth();
  const first=new Date(y,m,1), start=(first.getDay()+6)%7, days=new Date(y,m+1,0).getDate();
  const cells=[]; for(let i=0;i<start;i++) cells.push(null); for(let d=1;d<=days;d++) cells.push(new Date(y,m,d)); while(cells.length%7) cells.push(null);
  const FT=document.getElementById('filterType').value, TM=document.getElementById('filterTeam').value;
  calGrid.innerHTML='';
  cells.forEach(dd=>{
    const c=document.createElement('div'); c.className='cal-cell';
    if(dd){
      const day = document.createElement('div'); day.style.cssText="position:relative;font-size:12px;color:#94a3b8;margin-bottom:4px";
      day.textContent = String(dd.getDate()).padStart(2,"0"); c.appendChild(day);
      // eventos del d√≠a
      S.events.filter(e=>{const d=new Date(e.datetime);return d.getFullYear()==dd.getFullYear() && d.getMonth()==dd.getMonth() && d.getDate()==dd.getDate();})
      .filter(e=>(FT=="Todos"||e.type==FT)&&(TM=="Todos"||(e.team||"Golden Moms")==TM))
      .sort((a,b)=>new Date(a.datetime)-new Date(b.datetime))
      .forEach(e=>{
        const d=new Date(e.datetime);
        const tag=document.createElement('div'); tag.className='tag '+(e.type=='Partido'?'match':'train'); tag.textContent=e.type; c.appendChild(tag);
        const row=document.createElement('div');
        row.innerHTML = `<span class="cal-time">${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}</span> ${e.title} <span class="team">${e.team||'Golden Moms'}</span>`;
        row.style.cursor='pointer'; row.onclick=()=>openEvent(e.id); c.appendChild(row);
      });
      // cumplea√±os del d√≠a
      S.roster.forEach(p=>{
        if(!p.birth) return;
        const bd=new Date(y+"-"+p.birth.slice(5));
        if(bd.getDate()==dd.getDate() && bd.getMonth()==dd.getMonth()){
          const chip=document.createElement('div'); chip.className='tag'; chip.style.background="#fff0e5"; chip.textContent="üéÇ "+p.name; c.appendChild(chip);
        }
      });
    }
    calGrid.appendChild(c);
  });
}
document.getElementById('btnCopyWeek').onclick=()=>{
  const txt=buildWeekSummary(); if(!txt){alert("No hay eventos en la semana.");return;}
  navigator.clipboard.writeText(txt).then(()=>alert("Semana copiada. Pega en WhatsApp."));
};
function nextMon(d){const day=(d.getDay()+6)%7; const diff=(7-day)%7; const nd=new Date(d); nd.setDate(d.getDate()+diff); nd.setHours(0,0,0,0); return nd;}
function buildWeekSummary(){
  const st=nextMon(new Date()), en=new Date(st); en.setDate(st.getDate()+7);
  const arr=S.events.filter(e=>{const d=new Date(e.datetime); return d>=st && d<en;}).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
  if(!arr.length) return "";
  const L=['*Semana* '+st.toLocaleDateString('es-CL')+' - '+new Date(en.getTime()-86400000).toLocaleDateString('es-CL'),'Equipo: '+S.team,''];
  arr.forEach(E=>{
    const w=new Date(E.datetime).toLocaleString('es-CL',{weekday:'short',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
    L.push(`‚Ä¢ ${w} ‚Äî ${E.type}: ${E.title}${E.location?' ‚Äî '+E.location:''} (${E.team||'Golden Moms'}) ${E.opponent?' ‚Äî Rival: '+E.opponent:''}${E.uniform?' ‚Äî Uniforme: '+E.uniform:''}`);
  });
  return L.join('\n');
}

/* ====== Editor Evento ====== */
const ovEvent=document.getElementById('ovEvent');
const eType=document.getElementById('eType'), eTitle=document.getElementById('eTitle'), eDT=document.getElementById('eDT'),
      eLoc=document.getElementById('eLoc'), eOpp=document.getElementById('eOpp'), eUni=document.getElementById('eUni'), eTeam=document.getElementById('eTeam'),
      evTeamBadge=document.getElementById('evTeamBadge'), countBox=document.getElementById('countBox'), attBox=document.getElementById('att');

let CUR=null;
document.getElementById('btnNew').onclick=()=>{
  const now=new Date(); now.setMinutes(0,0,0);
  const id=crypto.randomUUID?.()||(""+Math.random()).slice(2);
  const e={id,type:"Entrenamiento",title:"Entrenamiento",team:"Golden Moms",datetime:new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString(),location:"",opponent:"",uniform:""};
  S.events.push(e); save(); CUR=id; openEvent(id);
};
function openEvent(id){
  const E=S.events.find(x=>x.id==id); if(!E) return; CUR=id;
  document.getElementById('evTitleHead').textContent = (E.type+" ‚Äî "+E.title);
  eType.value=E.type; eTitle.value=E.title; eTeam.value=E.team||"Golden Moms"; evTeamBadge.textContent=eTeam.value;
  eDT.value=toInput(E.datetime); eLoc.value=E.location||""; eOpp.value=E.opponent||""; eUni.value=E.uniform||"";
  renderAttendanceForRole();
  ovEvent.style.display='flex';
}
function toInput(iso){const d=new Date(iso);const p=n=>String(n).padStart(2,"0");return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`}
[eType,eTitle,eLoc,eOpp,eUni,eTeam].forEach(el=>el.addEventListener("change",()=>{
  const E=S.events.find(x=>x.id==CUR); if(!E) return;
  E.type=eType.value; E.title=eTitle.value; E.location=eLoc.value; E.opponent=eOpp.value; E.uniform=eUni.value; E.team=eTeam.value;
  evTeamBadge.textContent=E.team; save(); renderCalendar(); renderAttendanceForRole();
}));
eDT.addEventListener("change",()=>{const E=S.events.find(x=>x.id==CUR); if(!E) return; const d=new Date(eDT.value); E.datetime=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString(); save(); renderCalendar(); renderAttendanceForRole();});

document.getElementById('btnDel').onclick=()=>{ if(!confirm("¬øEliminar evento?")) return; const i=S.events.findIndex(x=>x.id==CUR); if(i>=0){ S.events.splice(i,1); delete S.att[CUR]; save(); renderCalendar(); ovEvent.style.display='none'; } };

// asistencia
function renderAttendanceForRole(){
  const s=SESSION||{};
  if(s.role==='jugadora'){ renderAttendance(true); }
  else { renderAttendance(false); }
}
function renderAttendance(justMine){
  const E=S.events.find(x=>x.id==CUR); if(!E) return;
  const team = eTeam.value;
  const pool = (team==='Todos') ? S.roster : S.roster.filter(p => (p.teams||[]).includes(team));
  const A=S.att[E.id]||{}; const counts={ok:0,mid:0,no:0,blank:0};
  pool.forEach(p=>{const v=A[p.name]; if(v=="Asiste") counts.ok++; else if(v=="Duda") counts.mid++; else if(v=="No asiste") counts.no++; else counts.blank++;});
  countBox.innerHTML=`<span class="chip ok">‚úÖ ${counts.ok}</span> <span class="chip mid">‚ùî ${counts.mid}</span> <span class="chip no">‚ùå ${counts.no}</span> <span class="chip">‚ñ´Ô∏è ${counts.blank}</span>`;
  attBox.innerHTML='';
  pool.forEach(p=>{
    if(justMine && SESSION?.name !== p.name) return;
    const row=document.createElement('div'); row.className='att';
    const left=document.createElement('div'); 
    left.innerHTML = `<strong>${p.name}</strong> ${p.birth?'<span class="badge">üéÇ '+new Date(p.birth).toLocaleDateString('es-CL',{day:'2-digit',month:'short'})+'</span>':''} <span class="badge">'+(p.teams||[]).join(', ')+'</span>`;
    const btns=document.createElement('div');
    function mk(lbl,val){const b=document.createElement('button'); b.className='btn s'; b.textContent=lbl; b.onclick=()=>{const AA=S.att[E.id]||{}; AA[p.name]=val; S.att[E.id]=AA; save(); renderAttendance(justMine);}; return b;}
    const b1=mk("‚úÖ","Asiste"), b2=mk("‚ùî","Duda"), b3=mk("‚ùå","No asiste");
    const v=A[p.name]; if(v=="Asiste") b1.style.background= "var(--ok)"; if(v=="Duda") b2.style.background="var(--mid)"; if(v=="No asiste") b3.style.background="var(--no)";
    btns.appendChild(b1);btns.appendChild(b2);btns.appendChild(b3);
    row.append
